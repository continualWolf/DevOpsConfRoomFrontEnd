/**
 * IMPORTANT NOTE:
 *
 * This file is licensed only for the use of Apple developers in providing MusicKit Web Services,
 * and is subject to the Apple Media Services Terms and Conditions and the Apple Developer Program
 * License Agreement. You may not copy, modify, re-host, or create derivative works of this file or the
 * accompanying Documentation, or any part thereof, including any updates, without Apple's written consent.
 *
 * ACKNOWLEDGEMENTS:
 * https://js-cdn.music.apple.com/musickit/v1/acknowledgements.txt
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MusicKit={})}(this,(function(e){"use strict";var t=void 0!==typeof self?self:this;function formatArtworkURL(e,t,r){return t=t||e.height||100,r=r||e.width||100,window.devicePixelRatio>=1.5&&(r*=2,t*=2),e.url.replace("{h}",""+t).replace("{w}",""+r).replace("{f}","jpeg")}var r="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){const t=new Map;return function(...r){const n=function(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n];if("object"==typeof i)try{t.push(JSON.stringify(i))}catch(r){t.push(`[object ${Object.prototype.toString.call(i)}]`)}else t.push(String(i))}return t.join("|")}(r);if(t.has(n))return t.get(n);const i=e(...r);return t.set(n,i),i}}function generateUUID(){let e=strRandomizer()+strRandomizer();for(;e.length<16;)e+=strRandomizer();return e.slice(0,16)}function strRandomizer(){return Math.random().toString(16).substring(2)}function isLibraryType(e){if(void 0===e)return!1;const t="string"==typeof e?e:e.id;return/^[a|i|l|p]{1}\.[a-zA-Z0-9-]+$/.test(t)}const n=memoize(e=>/^(a\.)?[a-zA-Z0-9]+$/.test(e));function detectNodeEnvironment(){var e,t,r,n;return void 0!==(null===(r=globalThis)||void 0===r||null===(t=r.process)||void 0===t||null===(e=t.versions)||void 0===e?void 0:e.node)||void 0!==(null===(n=globalThis)||void 0===n?void 0:n.FastBoot)}function isNodeEnvironment$1(){return detectNodeEnvironment()}const i=memoize(detectNodeEnvironment()?e=>r.from(e,"base64").toString("binary"):e=>window.atob(e));memoize(detectNodeEnvironment()?e=>r.from(e).toString("base64"):e=>window.btoa(e));const debounce=(e,t=250,r={isImmediate:!1})=>{let n;return function(...i){const o=this,a=r.isImmediate&&void 0===n;void 0!==n&&clearTimeout(n),n=setTimeout((function(){n=void 0,r.isImmediate||e.apply(o,i)}),t),a&&e.apply(o,i)}},arrayEquals=(e,t)=>!!e&&!!t&&[].every.call(e,(e,r)=>e===t[r]),o=memoize(e=>{const t=i(e);return a(t)});function ensureArray(e=[]){return Array.isArray(e)?e:[e]}const a=memoize(e=>{const t=e.length,r=new ArrayBuffer(t),n=new Uint8Array(r);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n}),s=memoize(e=>{const t=e.length,r=new ArrayBuffer(2*t),n=new Uint16Array(r);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n}),l=memoize(e=>{let t,r,n,i,o,a,s,l=0;const c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let d="";for(;l<e.length;)t=e[l++],r=l<e.length?e[l++]:Number.NaN,n=l<e.length?e[l++]:Number.NaN,i=t>>2,o=(3&t)<<4|r>>4,a=(15&r)<<2|n>>6,s=63&n,isNaN(r)?a=s=64:isNaN(n)&&(s=64),d+=c.charAt(i)+c.charAt(o)+c.charAt(a)+c.charAt(s);return d}),c=/\/(?:([a-z]{2})\/)?(album|artist|episode|movie|music-video|playlist|podcast|post|season|show|song|station)\/(?:[^/]*\/)?(?:id)?(\d+|[a-z]{2}\.[a-z0-9-]+|umc.cmc.[a-zA-Z0-9]+)(?:.*(?:[?|&]i=(\d+)).*)?.*$/i;function parseMediaURL(e){const t=e.match(c)||[];let[,r,n,i,o]=t;"music-video"===n&&(n="musicVideo"),-1!==["album","playlist"].indexOf(n)&&o?(n="song",i=o):"podcast"===n&&o&&(n="episode",i=o);return{storefrontId:r,kind:n,contentId:i,itemId:o}}function formattedMediaURL(e){const t=parseMediaURL(e),{storefrontId:r,kind:n,contentId:i}=t;if([r,n,i].some(e=>void 0===e))throw new TypeError("Invalid Media URL: "+e);const o=!!i&&i.startsWith("umc.");return{storefrontId:r,kind:n,contentId:i,isUTS:o}}const d=/^http(?:s)?\:\/\/(?:itunes|(embed\.)?(music|podcasts|tv))\.apple\.com/i,u=["allow-forms","allow-popups","allow-same-origin","allow-scripts","allow-storage-access-by-user-activation","allow-top-navigation-by-user-activation"],p=["autoplay *","encrypted-media *","fullscreen *","clipboard-write"];var h=function(e){return e[e.none=0]="none",e[e.preview=1]="preview",e[e.unencryptedFull=2]="unencryptedFull",e[e.encryptedFull=3]="encryptedFull",e}({}),y=function(e){return e[e.none=0]="none",e[e.loading=1]="loading",e[e.ready=2]="ready",e[e.playing=3]="playing",e[e.ended=4]="ended",e[e.unavailable=5]="unavailable",e[e.restricted=6]="restricted",e[e.error=7]="error",e[e.unsupported=8]="unsupported",e}({});function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function deepClone(e){const t=Object.prototype.toString.call(e).toLowerCase().slice(8,-1);switch(t){case"set":return new Set([...e].map(e=>deepClone(e)));case"map":return new Map([...e].map(([e,t])=>[deepClone(e),deepClone(t)]));case"date":return new Date(e.getTime());case"regexp":{const t=e,r="string"==typeof t.flags?t.flags:[t.global?"g":void 0,t.ignoreCase?"i":void 0,t.multiline?"m":void 0,t.sticky?"y":void 0,t.unicode?"u":void 0].filter(e=>void 0!==e).join("");return RegExp(e.source,r)}case"arraybuffer":{const t=e;if("function"==typeof t.slice)return t.slice(0);{const r=new e.constructor(t.byteLength);return new Uint8Array(r).set(new Uint8Array(t)),r}}case"dataview":case"int8array":case"uint8array":case"uint8clampedarray":case"int16array":case"uint16array":case"int32array":case"uint32array":case"float32array":case"float64array":case"bigint64array":case"biguint64array":{const r=e;return new(0,r.constructor)(deepClone(r.buffer),r.byteOffset,"dataview"===t?r.byteLength:r.length)}case"array":case"object":{const t=Array.isArray(e)?[]:{};for(const r in e)hasOwn(e,r)&&(t[r]=deepClone(e[r]));return t}default:return e}}function transform$a(e,t,r=!1){return r&&(e=Object.keys(e).reduce((t,r)=>(t[e[r]]=r,t),{})),Object.keys(e).reduce((r,n)=>{const i=e[n],o="function"==typeof i?i():function(e,t){return t.split(".").reduce((e,t)=>{if(void 0!==e)return e[t]},e)}(t,i);return o&&function(e,t,r){t.split(".").reduce((t,n,i,o)=>{const a=i===o.length-1,s=hasOwn(t,n),l=t[n]instanceof Object,c=null===t[n];if(!a&&s&&(!l||c))throw new TypeError(`Value at ${o.slice(0,i+1).join(".")} in keypath is not an Object.`);return a?(t[n]=r,e):s?t[n]:t[n]={}},e)}(r,n,o),r},{})}function getCookie(e="",t=document.cookie){const r=t.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(r)return r[1]}function setCookie(e,t,r="",n=14,i,o){const a=new Date;i=null!=i?i:window;const s=(o=null!=o?o:/\./.test(i.location.hostname)?i.location.hostname:"").length>0?`domain=${o}; `:"";a.setTime(a.getTime()+24*n*60*60*1e3);let l="";"https:"===i.location.protocol&&(l="; secure"),i.document.cookie=`${e}=${t}; expires=${a.toUTCString()}; ${s}path=${r}${l}`}function removeCookie(e,t,r){setCookie(e,"","/",0,t,r)}function hasSessionStorage(){let e=!1;try{e="undefined"!=typeof sessionStorage}catch(t){}return e}function getSessionStorage(){let e;return hasSessionStorage()&&(e=sessionStorage),e}function hasLocalStorage(){let e=!1;try{e="undefined"!=typeof localStorage}catch(t){}return e}function getLocalStorage(){let e;return hasLocalStorage()&&(e=localStorage),e}function getJsonFromLocalStorage(e){const t=function(e){if(!hasLocalStorage())return;const t=getLocalStorage().getItem(e);return null!==t?t:void 0}(e);if(t)try{return JSON.parse(t)}catch(r){return}}function _define_property$1S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Notifications{get shouldStorageDispatch(){return"undefined"!=typeof window&&hasSessionStorage()&&this.dispatchNamespace}addEventListener(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].push(t)}dispatchEvent(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].forEach(e=>e(t))}dispatchDistributedEvent(e,t){if(this.dispatchEvent(e,t),this.shouldStorageDispatch){var r;const n=`${this.dispatchNamespace}:${e}`;null===(r=getSessionStorage())||void 0===r||r.setItem(n,JSON.stringify(t))}}removeEventListener(e,t){if(Array.isArray(this._eventRegistry[e])){const r=this._eventRegistry[e].indexOf(t);this._eventRegistry[e].splice(r,1)}}_handleGlobalStorageEvent(e){var t;if(this.dispatchNamespace&&(null===(t=e.key)||void 0===t?void 0:t.startsWith(this.dispatchNamespace+":"))){const t=e.key.substring(this.dispatchNamespace.length+1);this.dispatchEvent(t,JSON.parse(e.newValue))}}constructor(e=[],t){_define_property$1S(this,"dispatchNamespace",void 0),_define_property$1S(this,"_eventRegistry",{}),e.forEach(e=>{this._eventRegistry[e]=[]}),t&&t.namespace&&(this.dispatchNamespace="com.apple."+t.namespace),this.shouldStorageDispatch&&(this._handleGlobalStorageEvent=this._handleGlobalStorageEvent.bind(this),window.addEventListener("storage",this._handleGlobalStorageEvent))}}let isMergeableObject=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){let t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===f}(e)}(e)};let f="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function defaultArrayMerge(e,t,r){return e.concat(t).map((function(e){return cloneUnlessOtherwiseSpecified(e,r)}))}function getKeys(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return e.propertyIsEnumerable(t)})):[]}(e))}function mergeObject(e,t,r){let n={};return r.isMergeableObject(e)&&getKeys(e).forEach((function(t){n[t]=cloneUnlessOtherwiseSpecified(e[t],r)})),getKeys(t).forEach((function(i){r.isMergeableObject(t[i])&&e[i]?n[i]=function(e,t){if(!t.customMerge)return deepmerge;let r=t.customMerge(e);return"function"==typeof r?r:deepmerge}(i,r)(e[i],t[i],r):n[i]=cloneUnlessOtherwiseSpecified(t[i],r)})),n}function deepmerge(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge,r.isMergeableObject=r.isMergeableObject||isMergeableObject;let n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject(e,t,r):cloneUnlessOtherwiseSpecified(t,r)}deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return deepmerge(e,r,t)}),{})};const isDataRecord=e=>!(!e||"function"!=typeof e.hasAttributes||"function"!=typeof e.hasRelationships||"function"!=typeof e.hasViews||"function"!=typeof e.serialize);function _define_property$1R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class DeveloperToken{get isExpired(){return this.expiration<Date.now()}_decode(e){return JSON.parse(i(e))}constructor(e){if(_define_property$1R(this,"token",void 0),_define_property$1R(this,"expiration",void 0),_define_property$1R(this,"keyId",void 0),_define_property$1R(this,"teamId",void 0),this.token=e,!e||!/^[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}/i.test(e))throw new Error("Invalid token.");const[t,r]=e.split("."),{exp:n,iss:i}=this._decode(r);if(this.expiration=1e3*n,this.isExpired)throw new Error("Initialized with an expired token.");this.teamId=i;const{kid:o}=this._decode(t);this.keyId=o}}function _define_property$1Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const _={INVALID_ERROR_ID:"INVALID_ERROR_ID",INVALID_ERROR_REASON:"INVALID_ERROR_REASON",ACCESS_DENIED:"ACCESS_DENIED",AGE_GATE:"AGE_GATE",AUTHORIZATION_ERROR:"AUTHORIZATION_ERROR",BUFFER_STALLED_ERROR:"BUFFER_STALLED_ERROR",CONFIGURATION_ERROR:"CONFIGURATION_ERROR",CONTENT_EQUIVALENT:"CONTENT_EQUIVALENT",CONTENT_RESTRICTED:"CONTENT_RESTRICTED",CONTENT_UNAVAILABLE:"CONTENT_UNAVAILABLE",CONTENT_UNSUPPORTED:"CONTENT_UNSUPPORTED",DEVICE_LIMIT:"DEVICE_LIMIT",GEO_BLOCK:"GEO_BLOCK",INVALID_ARGUMENTS:"INVALID_ARGUMENTS",PLAYREADY_CBC_ENCRYPTION_ERROR:"PLAYREADY_CBC_ENCRYPTION_ERROR",MEDIA_CERTIFICATE:"MEDIA_CERTIFICATE",MEDIA_DESCRIPTOR:"MEDIA_DESCRIPTOR",MEDIA_LICENSE:"MEDIA_LICENSE",MEDIA_KEY:"MEDIA_KEY",MEDIA_PLAYBACK:"MEDIA_PLAYBACK",MEDIA_SESSION:"MEDIA_SESSION",NETWORK_ERROR:"NETWORK_ERROR",NOT_FOUND:"NOT_FOUND",NOT_IMPLEMENTED:"NOT_IMPLEMENTED",PARSE_ERROR:"PARSE_ERROR",PLAY_ACTIVITY:"PLAY_ACTIVITY",REQUEST_ERROR:"REQUEST_ERROR",QUOTA_EXCEEDED:"QUOTA_EXCEEDED",SERVER_ERROR:"SERVER_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",STREAM_UPSELL:"STREAM_UPSELL",SUBSCRIPTION_ERROR:"SUBSCRIPTION_ERROR",TOKEN_EXPIRED:"TOKEN_EXPIRED",UNAUTHORIZED_ERROR:"UNAUTHORIZED_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR",UNSUPPORTED_ERROR:"UNSUPPORTED_ERROR",USER_INTERACTION_REQUIRED:"USER_INTERACTION_REQUIRED",INTERNAL_ERROR:"INTERNAL_ERROR",OUTPUT_RESTRICTED:"OUTPUT_RESTRICTED",WIDEVINE_CDM_EXPIRED:"WIDEVINE_CDM_EXPIRED"},v={400:_.REQUEST_ERROR,401:_.UNAUTHORIZED_ERROR,403:_.ACCESS_DENIED,404:_.NOT_FOUND,405:_.NOT_FOUND,413:_.REQUEST_ERROR,414:_.REQUEST_ERROR,429:_.QUOTA_EXCEEDED,500:_.SERVER_ERROR,501:_.NOT_FOUND,503:_.SERVICE_UNAVAILABLE},m={"-1003":_.MEDIA_LICENSE,"-1004":_.DEVICE_LIMIT,"-1017":_.GEO_BLOCK,1010:_.NOT_FOUND,2002:_.AUTHORIZATION_ERROR,2034:_.TOKEN_EXPIRED,3059:_.DEVICE_LIMIT,3063:_.SUBSCRIPTION_ERROR,3076:_.CONTENT_UNAVAILABLE,3082:_.CONTENT_RESTRICTED,3084:_.STREAM_UPSELL,5002:_.SERVER_ERROR,180202:_.PLAYREADY_CBC_ENCRYPTION_ERROR,190121:_.WIDEVINE_CDM_EXPIRED};const g=new Set([_.CONTENT_EQUIVALENT,_.CONTENT_UNAVAILABLE,_.CONTENT_UNSUPPORTED,_.SERVER_ERROR,_.SUBSCRIPTION_ERROR,_.UNSUPPORTED_ERROR,_.USER_INTERACTION_REQUIRED]);function isMKError(e){return void 0!==e&&e instanceof MKUniqueError}class MKUniqueError extends Error{static isMKError(e){return isMKError(e)}get errorCode(){return this.reason}constructor(e,t,r){if("string"!=typeof(n=e)||!/mk-[0-9]{3,}/.test(n))throw new MKUniqueError("mk-000",_.INVALID_ERROR_ID,{description:"Invalid error id format: "+e});var n;if(void 0===t||!(t in _))throw new MKUniqueError("mk-001",_.INVALID_ERROR_REASON,"Invalid error reason: "+t);"string"==typeof(r=null!=r?r:{})?r={description:r}:r instanceof Error&&(r={origin:r}),void 0===r.description&&void 0!==r.origin&&(r.description=isMKError(r.origin)?r.origin.description:r.origin.message);let i=`[${e}] ${t}`;var o;void 0!==r.description&&(i+="; "+r.description),super(i),_define_property$1Q(this,"isMKError",!0),_define_property$1Q(this,"id",void 0),_define_property$1Q(this,"reason",void 0),_define_property$1Q(this,"description",void 0),_define_property$1Q(this,"origin",void 0),_define_property$1Q(this,"data",void 0),this.name="MKError",this.id=e,this.reason=t,this.description=null!==(o=r.description)&&void 0!==o?o:"",this.origin=r.origin,this.data=r.data}}_define_property$1Q(MKUniqueError,"Reason",_),Object.assign(MKUniqueError,_);class MKError extends MKUniqueError{static playActivityError(e){return new this(_.PLAY_ACTIVITY,e)}static parseError(e){return new this(_.PARSE_ERROR,e)}static responseError(e){const{status:t,statusText:r}=e,n=new this(v[t]||_.NETWORK_ERROR,r||""+t);return n.data=e,n}static serverError(e){return new MKServerDialogError(e)}static internalError(e){return new this(_.INTERNAL_ERROR,e)}constructor(e,t){g.has(e)&&(t=null!=t?t:e),super("mk-007",e,{description:t})}}class MKServerDialogError extends MKError{get response(){return this.data}get dialog(){return this.response.dialog}constructor(e,t){var r,n,i,o;var a,s,l,c;super(m[null!==(i=e.failureType)&&void 0!==i?i:0]||m[null!==(o=e.errorCode)&&void 0!==o?o:0]||m[e.status]||t||_.UNKNOWN_ERROR,null!==(c=null!==(l=null!==(s=null!==(a=null===(r=e.dialog)||void 0===r?void 0:r.message)&&void 0!==a?a:e.customerMessage)&&void 0!==s?s:e.message)&&void 0!==l?l:e.errorMessage)&&void 0!==c?c:""),this.data=e,void 0!==this.dialog&&"string"==typeof(null===(n=this.dialog.okButtonAction)||void 0===n?void 0:n.url)&&(this.dialog.okButtonAction.url=this.dialog.okButtonAction.url.replace(/[&?](?:challenge|key-system|uri|user-initiated)=[^&]+/gim,""))}}function flattenAll$1(e){return function(e,t=1){if("function"==typeof Array.prototype.flat)return Array.prototype.flat.call(e,t);if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Array.isArray(e)||(e=Array.from(e)),function flat(e,t){return t<=0?e.slice():Array.prototype.reduce.call(e,(function(e,r){return Array.isArray(r)?e.concat(flat(r,t-1)):[...e,r]}),[])}(e,t)}(e,1/0)}function invoke(e){return void 0===e||(e=>"function"!=typeof e)(e)?e:e()}function isObject$3(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function isFunction$3(e){return"function"==typeof e}function isString$3(e){return"string"==typeof e}function isEmptyString$3(e,t){return isString$3(e)?0===(!1!==(null==t?void 0:t.trim)?e.trim():e).length:!1===(null==t?void 0:t.strict)}function _define_property$1P(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$K(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1P(e,t,r[t])}))}return e}function _object_spread_props$s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const b=function(e){return"boolean"==typeof e}(S=isEmptyString$3)?!S:function(...e){return!S(...e)};var S;function formatPrimitive$1(e,t){const r=t.path.map((e,r)=>0===r?t.encode(e):`[${t.encode(e)}]`).join("");return null===e?r:`${r}=${t.encode(e)}`}const P={comma:function(e,t){return formatPrimitive$1(e.join(","),t)},repeat:function(e,t){return e.map(e=>formatPrimitive$1(String(e),t)).filter(e=>e.length>0).join("&")},bracket:function(e,t){return e.map((function(e){return t.next(e,_object_spread_props$s(_object_spread$K({},t),{path:[...t.path,""]}))})).filter(b).join("&")},index:function(e,t){return e.map((function(e,r){return t.next(e,_object_spread_props$s(_object_spread$K({},t),{path:[...t.path,String(r)]}))})).filter(b).join("&")}},k={bracket:function(e,t){return Object.keys(e).sort(t.sort).map((function(r){return t.next(e[r],_object_spread_props$s(_object_spread$K({},t),{path:t.path.concat(r)}))})).filter(b).join("&")}},DEFAULT_ENCODER$1=e=>encodeURIComponent(String(e)),STRING_ENCODER=e=>String(e);function encodeQueryParameters(e,t){if(!e)return"";let r="";if(!0===(null==t?void 0:t.prefix)?r="?":isString$3(null==t?void 0:t.prefix)&&(r=t.prefix),isString$3(e))return r+e.replace(/^[?&]+/,"");var n;const i=isFunction$3(null==t?void 0:t.arrayFormat)?t.arrayFormat:P[null!==(n=null==t?void 0:t.arrayFormat)&&void 0!==n?n:"comma"];var o;const a=isFunction$3(null==t?void 0:t.objectFormat)?t.objectFormat:k[null!==(o=null==t?void 0:t.objectFormat)&&void 0!==o?o:"bracket"];var s;const l=null!==(s=null==t?void 0:t.sort)&&void 0!==s?s:(...e)=>0;let c=DEFAULT_ENCODER$1;isFunction$3(null==t?void 0:t.encode)?c=t.encode:!1===(null==t?void 0:t.encode)&&(c=STRING_ENCODER);const d=a(e,{path:[],next:function(e,r){return function(e,t){return void 0===e&&!1!==(null==t?void 0:t.skipUndefined)||(null===e&&!1!==(null==t?void 0:t.skipNull)||!(!isEmptyString$3(e)||!1===(null==t?void 0:t.skipEmptyString)))}(e,t)?"":isObject$3(e)?a(e,r):Array.isArray(e)?i(e,r):formatPrimitive$1(e,r)},encode:c,sort:l});return""===d?"":r+d}function joinURLPath$1(...e){const t=flattenAll$1(e).map(e=>e instanceof URL?e.pathname:e).filter(e=>"string"==typeof e&&0!==e.trim().length);if(0===t.length)return"";let r=t[0];for(let n=1;n<t.length;n++)r=r.replace(/[/]+$/,"")+"/"+t[n].replace(/^[/]+/,"");return/^([a-z][a-z0-9\-_+]+)?:\/\//i.test(r)||(r="/"+r.replace(/^[/]+/,"")),r}function splitURLPath(e){e instanceof URL&&(e=e.pathname);const t=[],r=e.lastIndexOf("#");-1!==r&&(t.unshift(e.slice(r)),e=e.slice(0,r));const n=e.lastIndexOf("?");return-1!==n&&(t.unshift(e.slice(n)),e=e.slice(0,n)),[...e.split(RegExp("(?<![/:]+)\\/+")),...t].filter(e=>0!==e.trim().length)}function parseQueryParams(e){if(!e||e.startsWith("http")&&!e.includes("?"))return{};try{var t;return function(e,t="&",r=(e=>e)){if("string"!=typeof e)return{};return e.split(t).map(e=>e.trim().split("=",2)).reduce((e,t)=>{const[n,i]=t;return""===n&&void 0===i||(e[r(n)]=r(i),void 0===i&&(e[r(n)]=void 0)),e},{})}(null!==(t=e.split("?")[1])&&void 0!==t?t:e,"&",decodeURIComponent)}catch(r){return{}}}function buildURL(e,t,r){isObject$3(t)&&(r=t,t="");const n=joinURLPath$1([e,null!=t?t:""]);let i="?";n.endsWith("&")||n.endsWith("?")?i="":n.includes("?")&&(i="&");return n+(void 0!==r?encodeQueryParameters(r,{prefix:i}):"")}function parseVersion(e){const t={version:e.toLowerCase()},r=e.toLowerCase().split(".").filter(e=>!!e);if(r.length<=1&&!/^\d+$/.test(r[0]))return t;const n=parseInt(r[0],10),i=parseInt(r[1],10),o=parseInt(r[2],10);return Number.isNaN(n)||(t.major=n,Number.isNaN(i)||(t.minor=i),Number.isNaN(o)||(t.patch=o)),t}function applyRules(e,t,r){const{userAgent:n}=null!=t?t:{};if("string"!=typeof n||""===n.trim())return r;for(const i of e){const e=i.slice(0,-1),o=i[i.length-1];let a=null;for(const i of e)if(a=n.match(i),null!==a){Object.assign(r,o(a,t,r));break}if(null!==a)break}return r}function _define_property$1O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$J(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1O(e,t,r[t])}))}return e}function _object_spread_props$r(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const T={browser:[[/^(itunes|music|tv)\/([\w.]+)\s/i,e=>_object_spread_props$r(_object_spread$J({name:"webview",variant:e[1].trim().toLowerCase().replace(/(music|tv)/i,"$1.app")},parseVersion(e[2])),{mobile:!1})],[/(?:(?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w.]+);)/i,e=>_object_spread$J({name:"webview",variant:"facebook",mobile:!0},parseVersion(e[1]))],[/(instagram|snapchat)[/ ]([-\w.]+)/i,e=>_object_spread$J({name:"webview",variant:e[1].trim().toLowerCase(),mobile:!0},parseVersion(e[2]))],[/musical_ly(?:.+app_?version\/|_)([\w.]+)/i,e=>_object_spread$J({name:"webview",variant:"tiktok",mobile:!0},parseVersion(e[1]))],[/twitter/i,()=>({name:"webview",variant:"twitter",mobile:!0})],[/ wv\).+?(?:version|chrome)\/([\w.]+)/i,e=>_object_spread$J({name:"webview",mobile:!0},parseVersion(e[1]))],[/electron\/([\w.]+) safari/i,e=>_object_spread$J({name:"electron",mobile:!1},parseVersion(e[1]))],[/tesla\/(.*?(20\d\d\.([-\w.])+))/i,e=>_object_spread_props$r(_object_spread$J({name:"other",variant:"tesla",mobile:!1},parseVersion(e[2])),{version:e[1]})],[/(samsung|huawei)browser\/([-\w.]+)/i,e=>_object_spread$J({name:"other",variant:e[1].trim().toLowerCase().replace(/browser/i,""),mobile:!0},parseVersion(e[2]))],[/yabrowser\/([-\w.]+)/i,e=>_object_spread$J({name:"other",variant:"yandex",mobile:!1},parseVersion(e[1]))],[/(brave|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w.]+)/i,(e,{userAgent:t})=>_object_spread$J({name:"other",variant:e[1].trim().toLowerCase(),mobile:/mobile/i.test(t)},parseVersion(e[2].replace(/-/g,".")))],[/edg(e|ios|a)?\/([\w.]+)/i,e=>{var t;return _object_spread$J({name:"edge",mobile:/(edgios|edga)/i.test(null!==(t=e[1])&&void 0!==t?t:"")},parseVersion(e[2]))}],[/trident.+rv[: ]([\w.]{1,9})\b.+like gecko/i,e=>_object_spread$J({name:"ie",mobile:!1},parseVersion(e[1]))],[/opr\/([\w.]+)/i,/opera mini\/([-\w.]+)/i,/opera [mobiletab]{3,6}\b.+version\/([-\w.]+)/i,/opera(?:.+version\/|[/ ]+)([\w.]+)/i,e=>_object_spread$J({name:"opera",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))],[/headlesschrome(?:\/([\w.]+)| )/i,e=>_object_spread$J({name:"chrome",variant:"headless",mobile:!1},parseVersion(e[1]))],[/\b(?:crmo|crios)\/([\w.]+)/i,e=>_object_spread$J({name:"chrome",mobile:!0},parseVersion(e[1]))],[/chrome(?: browser)?\/v?([\w.]+)( mobile)?/i,e=>{var t;return _object_spread$J({name:"chrome",mobile:/mobile/i.test(null!==(t=e[2])&&void 0!==t?t:"")},parseVersion(e[1]))}],[/\bfocus\/([\w.]+)/i,e=>_object_spread$J({name:"firefox",variant:"focus",mobile:!0},parseVersion(e[1]))],[/fxios\/([\w.-]+)/i,/(?:mobile|tablet);.*(?:firefox)\/([\w.-]+)/i,e=>_object_spread$J({name:"firefox",mobile:!0},parseVersion(e[1]))],[/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[/ ]?([\w.+]+)/i,e=>_object_spread$J({name:"firefox",variant:e[1].trim().toLowerCase(),mobile:!1},parseVersion(e[2]))],[/(?:firefox)\/([\w.]+)/i,/(?:mozilla)\/([\w.]+) .+rv:.+gecko\/\d+/i,e=>_object_spread$J({name:"firefox",mobile:!1},parseVersion(e[1]))],[/version\/([\w.,]+) .*mobile(?:\/\w+ | ?)safari/i,/version\/([\w.,]+) .*(safari)/i,/webkit.+?(?:mobile ?safari|safari)(?:\/([\w.]+))/i,e=>_object_spread$J({name:"safari",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))]],engine:[[/webkit\/(?:537\.36).+chrome\/(?!27)([\w.]+)/i,e=>_object_spread$J({name:"blink"},parseVersion(e[1]))],[/windows.+ edge\/([\w.]+)/i,e=>_object_spread$J({name:"blink"},parseVersion(e[1]))],[/presto\/([\w.]+)/i,e=>_object_spread$J({name:"presto"},parseVersion(e[2]))],[/trident\/([\w.]+)/i,e=>_object_spread$J({name:"trident"},parseVersion(e[1]))],[/gecko\/([\w.]+)/i,e=>_object_spread$J({name:"gecko"},parseVersion(e[1]))],[/(khtml|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w.]+)/i,e=>_object_spread$J({name:"other"},parseVersion(e[2]))],[/webkit\/([\w.]+)/i,e=>_object_spread$J({name:"webkit"},parseVersion(e[1]))]],os:[[/microsoft windows (vista|xp)/i,/windows nt 6\.2; (arm)/i,/windows (?:phone(?: os)?|mobile)[/ ]?([\d.\w ]*)/i,/windows[/ ]?([ntce\d. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d.]+)/i,e=>_object_spread$J({name:"windows"},parseVersion(e[1]))],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[/ ])([\d.]+)/i,e=>_object_spread$J({name:"ios"},parseVersion(e[1].replace(/_/g,".")))],[/mac(?:intosh;?)? os x ?([\d._]+)/i,e=>_object_spread$J({name:"macos"},parseVersion(e[1].replace(/_/g,".")))],[/cros [\w]+(?:\)| ([\w.]+)\b)/i,e=>_object_spread$J({name:"chromeos"},parseVersion(e[1]))],[/(?:android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-/ ]?([\w.]*)/i,/droid ([\w.]+|[\d+])\b.+(android[- ]x86|harmonyos)/i,e=>_object_spread$J({name:"android"},parseVersion(e[1]))],[/linux/i,()=>({name:"linux"})]]};function parseUserAgent(e,t){var r;var n;return function(e,t){let r=e;for(const n of t)r=n(r);return r}({navigator:e,ua:null!==(r=null==e?void 0:e.userAgent)&&void 0!==r?r:"",extensions:[],browser:applyRules(T.browser,e,{name:"unknown",mobile:!1}),engine:applyRules(T.engine,e,{name:"unknown"}),os:applyRules(T.os,e,{name:"unknown"})},null!==(n=null==t?void 0:t.extensions)&&void 0!==n?n:[])}function _define_property$1N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$I(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1N(e,t,r[t])}))}return e}function _object_spread_props$q(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function flagsExtension(e){let t=e.os.name;const r="android"===e.os.name;let n="macos"===e.os.name,i="ios"===e.os.name;var o;const a="ipados"===t||i&&/ipad/i.test(e.ua)||n&&(null!==(o=e.navigator.maxTouchPoints)&&void 0!==o?o:0)>=2;a&&(t="ipados",i=!1,n=!1);const s=_object_spread_props$q(_object_spread$I({},e.browser),{isUnknown:"unknown"===e.browser.name,isSafari:"safari"===e.browser.name,isChrome:"chrome"===e.browser.name,isFirefox:"firefox"===e.browser.name,isEdge:"edge"===e.browser.name,isWebView:"webview"===e.browser.name,isOther:"other"===e.browser.name,isMobile:e.browser.mobile||i||a||r||!1}),l=_object_spread_props$q(_object_spread$I({},e.engine),{isUnknown:"unknown"===e.engine.name,isWebKit:"webkit"===e.engine.name,isBlink:"blink"===e.engine.name,isGecko:"gecko"===e.engine.name}),c=_object_spread_props$q(_object_spread$I({},e.os),{name:t,isUnknown:"unknown"===e.os.name,isLinux:"linux"===e.os.name,isWindows:"windows"===e.os.name,isMacOS:n,isAndroid:r,isIOS:i,isIPadOS:a});return _object_spread_props$q(_object_spread$I({},e),{extensions:[...e.extensions,"flags"],browser:s,os:c,engine:l})}let E;function getGlobal(){if(void 0===E){function exists(e){return e&&e.Math===Math&&e}E=exists("object"==typeof globalThis&&globalThis)||exists("object"==typeof window&&window)||function(){return this}()||Function("return this")()}return E}function asyncGeneratorStep$1k(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1k(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1k(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1k(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function isBrowserEnvironment(){return _isBrowserEnvironment.apply(this,arguments)}function _isBrowserEnvironment(){return(_isBrowserEnvironment=_async_to_generator$1k((function*(){return void 0!==getGlobal().navigator}))).apply(this,arguments)}function asyncGeneratorStep$1j(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1j(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1j(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1j(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function isNodeEnvironment(){return _isNodeEnvironment.apply(this,arguments)}function _isNodeEnvironment(){return(_isNodeEnvironment=_async_to_generator$1j((function*(){var e,t;return void 0!==(null===(t=getGlobal().process)||void 0===t||null===(e=t.versions)||void 0===e?void 0:e.node)}))).apply(this,arguments)}function asyncGeneratorStep$1i(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1i(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1i(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1i(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$H(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1M(e,t,r[t])}))}return e}const w={playready:"com.microsoft.playready",widevine:"com.widevine.alpha",clearkey:"org.w3.clearkey",fairplay:"com.apple.fps"},I="com.apple.fps.1_0",A="com.microsoft.playready";function detectEMESupport(){return _detectEMESupport.apply(this,arguments)}function _detectEMESupport(){return(_detectEMESupport=_async_to_generator$1i((function*(){var e;const t=getGlobal();return void 0!==(null===(e=t.navigator)||void 0===e?void 0:e.requestMediaKeySystemAccess)&&void 0!==t.MediaKeys&&void 0!==t.MediaKeySystemAccess}))).apply(this,arguments)}function detectLegacyKeySystems(e){return _detectLegacyKeySystems.apply(this,arguments)}function _detectLegacyKeySystems(){return(_detectLegacyKeySystems=_async_to_generator$1i((function*(e){var t,r,n;const i=null!==(n=null==e?void 0:e.contentType)&&void 0!==n?n:'video/mp4; codecs="avc1.42E01E"',o=[],a=getGlobal();return"function"==typeof(null===(t=a.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported)&&!0===a.WebKitMediaKeys.isTypeSupported(I,i)&&o.push("fairplay_legacy"),"function"==typeof(null===(r=a.MSMediaKeys)||void 0===r?void 0:r.isTypeSupported)&&!0===a.MSMediaKeys.isTypeSupported(A,i)&&o.push("playready_legacy"),o}))).apply(this,arguments)}function supportsEMEConfiguration(e,t){return _supportsEMEConfiguration.apply(this,arguments)}function _supportsEMEConfiguration(){return(_supportsEMEConfiguration=_async_to_generator$1i((function*(e,t){const r=_object_spread$H({initDataTypes:["keyids","cenc"]},t);if(void 0===r.audioCapabilities&&void 0===r.videoCapabilities)throw new Error("Configuration should at least include a audioCapabilities or videoCapabilities key");const n=-1!==e.indexOf(".")?e:w[e];if(void 0===n)return!1;var i,o;const a=[...null!==(i=r.audioCapabilities)&&void 0!==i?i:[],...null!==(o=r.videoCapabilities)&&void 0!==o?o:[]].map(({contentType:e})=>e);try{const e=(yield navigator.requestMediaKeySystemAccess(n,[r])).getConfiguration();var s,l;const t=[...null!==(s=e.audioCapabilities)&&void 0!==s?s:[],...null!==(l=e.videoCapabilities)&&void 0!==l?l:[]].map(({contentType:e})=>e);return a.every(e=>t.includes(e))}catch(xe){if(xe instanceof DOMException&&("NotSupportedError"===xe.name||"SecurityError"===xe.name))return!1;throw xe}}))).apply(this,arguments)}function detectEMEKeySystems(e){return _detectEMEKeySystems.apply(this,arguments)}function _detectEMEKeySystems(){return(_detectEMEKeySystems=_async_to_generator$1i((function*(e){const t=[];if((yield isNodeEnvironment())||!(yield detectEMESupport()))return t;function buildCapability(e){return"string"==typeof e?{contentType:e}:e}const r=void 0!==(null==e?void 0:e.videoCapability)?[buildCapability(e.videoCapability)]:[buildCapability('video/mp4; codecs="avc1.42E01E"')],n=void 0!==(null==e?void 0:e.audioCapability)?[buildCapability(e.audioCapability)]:[];for(const[i,o]of Object.entries(w))(yield supportsEMEConfiguration(o,{videoCapabilities:r,audioCapabilities:n}))&&t.push(i);return t}))).apply(this,arguments)}function asyncGeneratorStep$1h(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1h(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1h(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1h(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMMSSupport(){return _detectMMSSupport.apply(this,arguments)}function _detectMMSSupport(){return(_detectMMSSupport=_async_to_generator$1h((function*(){var e,t,r,n;const i=getGlobal(),o=void 0!==i.ManagedMediaSource,a="function"==typeof(null===(t=i.ManagedSourceBuffer)||void 0===t||null===(e=t.prototype)||void 0===e?void 0:e.appendBuffer)&&"function"==typeof(null===(n=i.ManagedSourceBuffer)||void 0===n||null===(r=n.prototype)||void 0===r?void 0:r.remove);return o&&a}))).apply(this,arguments)}function asyncGeneratorStep$1g(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1g(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1g(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1g(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMSESupport(){return _detectMSESupport.apply(this,arguments)}function _detectMSESupport(){return(_detectMSESupport=_async_to_generator$1g((function*(){return void 0!==getGlobal().MediaSource&&void 0!==getGlobal().SourceBuffer}))).apply(this,arguments)}function asyncGeneratorStep$1f(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1f(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1f(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1f(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectPictureInPictureSupport(){return _detectPictureInPictureSupport.apply(this,arguments)}function _detectPictureInPictureSupport(){return(_detectPictureInPictureSupport=_async_to_generator$1f((function*(){var e;if(yield isNodeEnvironment())return!1;const t=document.createElement("video");return void 0!==(null==t?void 0:t.webkitSupportsPresentationMode)&&"function"==typeof(null==t?void 0:t.webkitSetPresentationMode)||void 0!==(null===(e=document)||void 0===e?void 0:e.pictureInPictureEnabled)}))).apply(this,arguments)}function asyncGeneratorStep$1e(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1e(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1e(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1e(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _detect(){return(_detect=_async_to_generator$1e((function*(){var e;const t=null===(e=globalThis)||void 0===e?void 0:e.window;var r;const n=null!==(r=null==t?void 0:t.navigator)&&void 0!==r?r:{userAgent:"",maxTouchPoints:0},i=yield isBrowserEnvironment(),o=yield isNodeEnvironment(),a=yield detectEMEKeySystems(),s=yield detectLegacyKeySystems();let l=void 0;return a.includes("fairplay")&&(l="fairplay"),a.includes("playready")&&(l="playready"),a.includes("widevine")&&(l="widevine"),{userAgent:yield parseUserAgent(n,{extensions:[flagsExtension]}),isBrowserEnvironment:i,isNodeEnvironment:o,isPictureInPictureSupported:yield detectPictureInPictureSupport(),isMMSSupported:yield detectMMSSupport(),isMSESupported:yield detectMSESupport(),isEMESupported:yield detectEMESupport(),isDRMAvailable:void 0!==l,availableKeySystems:a,preferredKeySystem:l,hasWebKitMediaKeysSupport:s.includes("fairplay_legacy"),hasMSMediaKeysSupport:s.includes("playready_legacy")}}))).apply(this,arguments)}class RuntimeEnvironment{get isConfigured(){return this.configured}get userAgent(){return this.config.userAgent}get ua(){return this.userAgent.ua}get isNodeEnvironment(){return this.config.isNodeEnvironment}get isBrowserEnvironment(){return this.config.isBrowserEnvironment}get isPictureInPictureSupported(){return this.config.isPictureInPictureSupported}get isMMSSupported(){return this.config.isMMSSupported}get isMSESupported(){return this.config.isMSESupported}get isEMESupported(){return this.config.isEMESupported}get isDRMAvailable(){return this.config.isDRMAvailable}get availableKeySystems(){return this.config.availableKeySystems}get preferredKeySystem(){return this.config.preferredKeySystem}get hasWebKitMediaKeysSupport(){return this.config.hasWebKitMediaKeysSupport}get hasMSMediaKeysSupport(){return this.config.hasMSMediaKeysSupport}get browser(){return this.userAgent.browser}get engine(){return this.userAgent.engine}get os(){return this.userAgent.os}get isMobile(){return this.browser.isMobile}static detect(){var e=this;return _async_to_generator$1e((function*(){return new e(yield function(){return _detect.apply(this,arguments)}())}))()}configure(e){for(const[t,r]of Object.entries(e))this.config[t]=r;this.configured=!0}constructor(e){_define_property$1L(this,"configured",!1),_define_property$1L(this,"config",void 0),this.config=e,this.configured=!0}}function dasherize(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").replace(/(^-+)|(-+$)/,"").toLowerCase()}const O={};function findOrCreate(e,t){const r=e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(e,t)=>t.toUpperCase());if(hasOwn(O,r)){const n=O[r];if(t!==n.constructor)throw new Error(`DevFlag ${e} was already registered with a different type (${n.constructor.name})`);return n}const n=new t(e);return Object.defineProperty(O,r,{configurable:!0,enumerable:!0,get:function(){return n},set:function(e){n.set(e)}}),n}class LocalStorageDevFlag{get value(){return this.get()}get configured(){return void 0!==this.value}read(){var e,t;const r=null!==(t=null===(e=getLocalStorage())||void 0===e?void 0:e.getItem(this.key))&&void 0!==t?t:null;return null!==r?r:void 0}write(e){var t;null===(t=getLocalStorage())||void 0===t||t.setItem(this.key,e)}clear(){var e;null===(e=getLocalStorage())||void 0===e||e.removeItem(this.key)}constructor(e){if(function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"key",void 0),"string"!=typeof e||""===e.trim())throw new Error("DevFlag requires a non-empty string key");this.key=e}}class StringDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){return this.read()}set(e){"string"!=typeof e&&console.warn("Value for StringDevFlag should be a string"),this.write(e)}}class BooleanDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){const e=this.read();if(void 0!==e)return"1"===e||"true"===e.toLowerCase()}set(e){"boolean"==typeof e?this.write(!0===e?"1":"0"):console.warn("Value for BooleanDevFlag should be a boolean")}get enabled(){return!0===this.get()}enable(){this.set(!0)}disable(){this.set(!1)}toggle(){this.set(!this.get())}}class JsonDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){const e=this.read();if(void 0!==e)try{return JSON.parse(e)}catch(xe){return}}set(e){this.write(JSON.stringify(e))}prop(e){if(void 0!==this.value)return this.value[e]}}const R=new Map;function pluralizeMediaType(e){if(R.has(e))return R.get(e);let t=dasherize(e);return e.endsWith("y")?t=t.substring(0,t.length-1)+"ies":t.endsWith("s")||(t+="s"),R.set(e,t),t}class PubSub{publish(e,t){const r=this.getSubscribersForType(e);void 0!==r&&r.forEach(r=>{r(e,t)})}subscribe(e,t){this.getSubscribersForType(e,!0).push(t)}subscribeOnce(e,t){const onceCallback=(e,r)=>{this.unsubscribe(e,onceCallback),t(e,r)};this.subscribe(e,onceCallback)}unsubscribe(e,t){const r=this.getSubscribersForType(e);if(void 0!==r)for(let n=0;n<r.length;n++)if(r[n]===t){r.splice(n,1);break}}clear(e){void 0===e?this.events={}:delete this.events[e]}getSubscribersForType(e,t=!1){return void 0===this.events[e]&&t&&(this.events[e]=[]),this.events[e]}constructor(){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"events",Object.create(null))}}function asyncGeneratorStep$1d(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1d(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1d(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1d(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class RequestManager{static create(e){var t=this;return _async_to_generator$1d((function*(){return new t(e)}))()}get fetch(){if(void 0===this.fetchFunction)throw new MKError(MKError.Reason.INTERNAL_ERROR,"Could not find fetch implementation");return this.fetchFunction}get isConfigured(){return this.configured}configure(e){void 0!==(null==e?void 0:e.fetchFunction)&&(this.fetchFunction=e.fetchFunction),this.configured=!0}buildURL(e,t,r){return new URL(buildURL(e,t,r))}buildHeaders(...e){return flattenAll$1(e).reduce((function(e,t){let r;return r=t instanceof Headers||t instanceof Map?Array.from(t.entries()):Object.entries(t),r.map(([t,r])=>{void 0===r?e.delete(t):e.set(t,r)}),e}),new Headers)}buildRequest(e,t){return new Request(new URL(e),t)}fetchText(e){var t=this;return _async_to_generator$1d((function*(){let r;try{r=yield t.fetch(e)}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.text()}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as text for "+r)}}))()}fetchJSON(e){var t=this;return _async_to_generator$1d((function*(){let r;try{r=yield t.fetch(e)}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.json()}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as JSON for "+r)}}))()}fetchArrayBuffer(e){var t=this;return _async_to_generator$1d((function*(){let r;try{r=yield t.fetch(e)}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.arrayBuffer()}catch(xe){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as ArrayBuffer for "+r)}}))()}constructor(e){var t;_define_property$1I(this,"configured",!1),_define_property$1I(this,"fetchFunction",void 0!==(null===(t=globalThis)||void 0===t?void 0:t.fetch)?fetch.bind(globalThis):void 0),this.configure(null!=e?e:{})}}const $=new Map;function singularizeMediaType(e){if($.has(e))return $.get(e);let t=dasherize(e);return t.endsWith("s")&&(t=t.slice(0,-1)),$.set(e,t),t}const C={AFG:"143610",AGO:"143564",AIA:"143538",ALB:"143575",AND:"143611",ARE:"143481",ARG:"143505",ARM:"143524",ATG:"143540",AUS:"143460",AUT:"143445",AZE:"143568",BEL:"143446",BEN:"143576",BFA:"143578",BGD:"143490",BGR:"143526",BHR:"143559",BHS:"143539",BIH:"143612",BLR:"143565",BLZ:"143555",BMU:"143542",BOL:"143556",BRA:"143503",BRB:"143541",BRN:"143560",BTN:"143577",BWA:"143525",CAF:"143623",CAN:"143455",CHE:"143459",CHL:"143483",CHN:"143465",CIV:"143527",CMR:"143574",COD:"143613",COG:"143582",COL:"143501",CPV:"143580",CRI:"143495",CYM:"143544",CYP:"143557",CZE:"143489",DEU:"143443",DMA:"143545",DNK:"143458",DOM:"143508",DZA:"143563",ECU:"143509",EGY:"143516",ESP:"143454",EST:"143518",ETH:"143569",FIN:"143447",FJI:"143583",FRA:"143442",FSM:"143591",GAB:"143614",GBR:"143444",GEO:"143615",GHA:"143573",GIN:"143616",GMB:"143584",GNB:"143585",GRC:"143448",GRD:"143546",GTM:"143504",GUY:"143553",HKG:"143463",HND:"143510",HRV:"143494",HUN:"143482",IDN:"143476",IND:"143467",IRL:"143449",IRQ:"143617",ISL:"143558",ISR:"143491",ITA:"143450",JAM:"143511",JOR:"143528",JPN:"143462",KAZ:"143517",KEN:"143529",KGZ:"143586",KHM:"143579",KNA:"143548",KOR:"143466",KWT:"143493",LAO:"143587",LBN:"143497",LBR:"143588",LBY:"143567",LCA:"143549",LIE:"143522",LKA:"143486",LTU:"143520",LUX:"143451",LVA:"143519",MAC:"143515",MAR:"143620",MCO:"143618",MDA:"143523",MDG:"143531",MDV:"143488",MEX:"143468",MKD:"143530",MLI:"143532",MLT:"143521",MMR:"143570",MNE:"143619",MNG:"143592",MOZ:"143593",MRT:"143590",MSR:"143547",MUS:"143533",MWI:"143589",MYS:"143473",NAM:"143594",NER:"143534",NGA:"143561",NIC:"143512",NLD:"143452",NOR:"143457",NPL:"143484",NRU:"143606",NZL:"143461",OMN:"143562",PAK:"143477",PAN:"143485",PER:"143507",PHL:"143474",PLW:"143595",PNG:"143597",POL:"143478",PRT:"143453",PRY:"143513",PSE:"143596",QAT:"143498",ROU:"143487",RUS:"143469",RWA:"143621",SAU:"143479",SEN:"143535",SGP:"143464",SLB:"143601",SLE:"143600",SLV:"143506",SRB:"143500",STP:"143598",SUR:"143554",SVK:"143496",SVN:"143499",SWE:"143456",SWZ:"143602",SYC:"143599",TCA:"143552",TCD:"143581",THA:"143475",TJK:"143603",TKM:"143604",TON:"143608",TTO:"143551",TUN:"143536",TUR:"143480",TWN:"143470",TZA:"143572",UGA:"143537",UKR:"143492",URY:"143514",USA:"143441",UZB:"143566",VCT:"143550",VEN:"143502",VGB:"143543",VNM:"143471",VUT:"143609",WSM:"143607",XKX:"143624",YEM:"143571",ZAF:"143472",ZMB:"143622",ZWE:"143605"};function asyncGeneratorStep$1c(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1c(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1c(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1c(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const M={AW:"ABW",AF:"AFG",AO:"AGO",AI:"AIA",AX:"ALA",AL:"ALB",AD:"AND",AE:"ARE",AR:"ARG",AM:"ARM",AS:"ASM",AQ:"ATA",TF:"ATF",AG:"ATG",AU:"AUS",AT:"AUT",AZ:"AZE",BI:"BDI",BE:"BEL",BJ:"BEN",BQ:"BES",BF:"BFA",BD:"BGD",BG:"BGR",BH:"BHR",BS:"BHS",BA:"BIH",BL:"BLM",BY:"BLR",BZ:"BLZ",BM:"BMU",BO:"BOL",BR:"BRA",BB:"BRB",BN:"BRN",BT:"BTN",BV:"BVT",BW:"BWA",CF:"CAF",CA:"CAN",CC:"CCK",CH:"CHE",CL:"CHL",CN:"CHN",CI:"CIV",CM:"CMR",CD:"COD",CG:"COG",CK:"COK",CO:"COL",KM:"COM",CV:"CPV",CR:"CRI",CU:"CUB",CW:"CUW",CX:"CXR",KY:"CYM",CY:"CYP",CZ:"CZE",DE:"DEU",DJ:"DJI",DM:"DMA",DK:"DNK",DO:"DOM",DZ:"DZA",EC:"ECU",EG:"EGY",ER:"ERI",EH:"ESH",ES:"ESP",EE:"EST",ET:"ETH",FI:"FIN",FJ:"FJI",FK:"FLK",FR:"FRA",FO:"FRO",FM:"FSM",GA:"GAB",GB:"GBR",GE:"GEO",GG:"GGY",GH:"GHA",GI:"GIB",GN:"GIN",GP:"GLP",GM:"GMB",GW:"GNB",GQ:"GNQ",GR:"GRC",GD:"GRD",GL:"GRL",GT:"GTM",GF:"GUF",GU:"GUM",GY:"GUY",HK:"HKG",HM:"HMD",HN:"HND",HR:"HRV",HT:"HTI",HU:"HUN",ID:"IDN",IM:"IMN",IN:"IND",IO:"IOT",IE:"IRL",IR:"IRN",IQ:"IRQ",IS:"ISL",IL:"ISR",IT:"ITA",JM:"JAM",JE:"JEY",JO:"JOR",JP:"JPN",KZ:"KAZ",KE:"KEN",KG:"KGZ",KH:"KHM",KI:"KIR",KN:"KNA",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LR:"LBR",LY:"LBY",LC:"LCA",LI:"LIE",LK:"LKA",LS:"LSO",LT:"LTU",LU:"LUX",LV:"LVA",MO:"MAC",MF:"MAF",MA:"MAR",MC:"MCO",MD:"MDA",MG:"MDG",MV:"MDV",MX:"MEX",MH:"MHL",MK:"MKD",ML:"MLI",MT:"MLT",MM:"MMR",ME:"MNE",MN:"MNG",MP:"MNP",MZ:"MOZ",MR:"MRT",MS:"MSR",MQ:"MTQ",MU:"MUS",MW:"MWI",MY:"MYS",YT:"MYT",NA:"NAM",NC:"NCL",NE:"NER",NF:"NFK",NG:"NGA",NI:"NIC",NU:"NIU",NL:"NLD",NO:"NOR",NP:"NPL",NR:"NRU",NZ:"NZL",OM:"OMN",PK:"PAK",PA:"PAN",PN:"PCN",PE:"PER",PH:"PHL",PW:"PLW",PG:"PNG",PL:"POL",PR:"PRI",KP:"PRK",PT:"PRT",PY:"PRY",PS:"PSE",PF:"PYF",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",SA:"SAU",SD:"SDN",SN:"SEN",SG:"SGP",GS:"SGS",SH:"SHN",SJ:"SJM",SB:"SLB",SL:"SLE",SV:"SLV",SM:"SMR",SO:"SOM",PM:"SPM",RS:"SRB",SS:"SSD",ST:"STP",SR:"SUR",SK:"SVK",SI:"SVN",SE:"SWE",SZ:"SWZ",SX:"SXM",SC:"SYC",SY:"SYR",TC:"TCA",TD:"TCD",TG:"TGO",TH:"THA",TJ:"TJK",TK:"TKL",TM:"TKM",TL:"TLS",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TV:"TUV",TW:"TWN",TZ:"TZA",UG:"UGA",UA:"UKR",UM:"UMI",UY:"URY",US:"USA",UZ:"UZB",VA:"VAT",VC:"VCT",VE:"VEN",VG:"VGB",VI:"VIR",VN:"VNM",VU:"VUT",WF:"WLF",WS:"WSM",XK:"XKX",YE:"YEM",ZA:"ZAF",ZM:"ZMB",ZW:"ZWE"};const D={af:48,sq:1,ar:34,eu:1,bg:49,be:1,ca:42,zh:19,"zh-tw":18,"zh-cn":19,"zh-hk":45,"zh-sg":19,hr:41,cs:22,da:11,nl:10,"nl-be":65,en:1,"en-us":1,"en-eg":26,"en-au":27,"en-gb":2,"en-ca":6,"en-nz":27,"en-ie":26,"en-za":26,"en-jm":26,"en-bz":26,"en-tt":26,"en-001":26,et:30,fo:1,fa:59,fi:12,fr:3,"fr-ca":5,gd:2,de:4,"de-ch":57,el:23,he:36,hi:50,hu:21,is:31,id:37,it:7,ja:9,ko:13,lv:33,lt:32,mk:1,mt:1,no:14,nb:14,nn:14,pl:20,"pt-br":15,pt:24,rm:1,ro:39,ru:16,sr:1,sk:40,sl:52,es:8,"es-mx":28,"es-419":44,sv:17,th:35,ts:1,tn:1,tr:25,uk:29,ur:55,ve:1,vi:43,xh:1,yi:1,zu:56,ms:38,iw:36,lo:46,tl:47,kk:51,ta:53,te:54,bn:58,ga:60,ht:61,la:62,pa:63,sa:64};let x="Music-User-Token";function getLanguages(){if("undefined"==typeof navigator)return[];if(navigator.languages)return navigator.languages;const e=navigator.language||navigator.userLanguage;return e?[e]:[]}x="Media-User-Token";const L=["apps.apple.com","books.apple.com","fitness.apple.com","music.apple.com","podcasts.apple.com","tv.apple.com"];function determineBaseCookieDomain(e){let t=e;return e&&L.some((function(r){if(e.endsWith("."+r))return t=r,!0})),t}const N=new Set(["apps","books","music","podcasts","tv"]),U=/\.apple\.com$/;function getCommerceHostname(e,t){!t&&"undefined"!=typeof location&&location.hostname&&(t=location);let r=e+".itunes.apple.com";if(!t)return r;const n=function(e){if(!e||!U.test(e))return;const t=e.split(".");let r=t[t.length-3];const n=r;if(r&&r.includes("-")){const e=r.split("-");r=e[e.length-1]}return N.has(r)?n:void 0}(t.hostname);return n&&(r=`${e}.${n}.apple.com`),r}function buildQueryParams(e={app:"music",p:"subscribe"}){return void 0===e.app&&(e.app="music"),void 0===e.p&&(e.p="subscribe"),Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}var j=function(e){return e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token",e}({}),F=function(e){return e[e.MUSIC=0]="MUSIC",e[e.PODCAST=1]="PODCAST",e[e.TV=2]="TV",e}({});const B={[F.TV]:"com.apple.onboarding.tvappweb",[F.MUSIC]:"com.apple.onboarding.musicappweb",[F.PODCAST]:"com.apple.onboarding.podcastsweb"},V={[F.TV]:"pltvcid",[F.MUSIC]:"pldfltcid",[F.PODCAST]:"pldfltcid"},q={"com.apple.onboarding.tvappweb":1,"com.apple.onboarding.musicappweb":1,"com.apple.onboarding.podcastsweb":1},G={CRITICAL:50,ERROR:40,WARNING:30,NOTICE:20,INFO:10,DEBUG:2,TRACE:1,NONE:0};const H={OFF:"NONE",0:"NONE","+":"INFO","++":"DEBUG",V:"DEBUG",D:"DEBUG",VERBOSE:"DEBUG",VV:"TRACE",SILLY:"TRACE","*":"TRACE"};function getLoggingLevel(e,t={}){if("number"==typeof e)return function(e){return"number"==typeof e&&Object.values(G).includes(e)}(e)?e:void 0;let r=e.toUpperCase();return t.allowShorthands&&void 0!==H[r]&&(r=H[r]),function(e){return"string"==typeof e&&void 0!==G[e.toUpperCase()]}(r)?G[r]:void 0}function getLoggingLevelName(e){for(const[t,r]of Object.entries(G))if(e===r)return t}function walk(e,t){const r=[e];for(;r.length>0;){const e=r.shift();void 0!==e&&(r.push(...e.children),t(e))}}function _define_property$1H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$G(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1H(e,t,r[t])}))}return e}function _object_spread_props$p(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _define_property1$1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const W=G.ERROR,DEFAULT_POLICY=(e,t)=>e!==G.NONE&&t>=e;class Logger$1{get parent(){return this._parent}get children(){return Array.from(this._children.values())}get namespace(){return void 0===this._parent?this.name:this._parent.namespace+"/"+this.name}get enabled(){return this.level!==G.NONE}get level(){var e,t,r;return null!==(r=null!==(t=this._level)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.level)&&void 0!==r?r:W}get levelName(){var e;return null!==(e=getLoggingLevelName(this.level))&&void 0!==e?e:"UNKNOWN"}get levelPolicy(){var e,t,r;return null!==(r=null!==(t=this._levelPolicy)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.levelPolicy)&&void 0!==r?r:DEFAULT_POLICY}get handlers(){var e,t,r;return null!==(r=null!==(t=this._handlers)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.handlers)&&void 0!==r?r:{}}isEnabledFor(e){return this.levelPolicy(this.level,e)}setLevel(e){const t=getLoggingLevel(e);void 0!==t&&(this._level=t)}clearLevel(){this._level=void 0}setLevelPolicy(e){this._levelPolicy=e}clearLevelPolicy(){this._levelPolicy=void 0}addHandler(e,t){this._handlers||(this._handlers={}),this._handlers[e]=t}hasHandler(e){var t;return void 0!==(null===(t=this._handlers)||void 0===t?void 0:t[e])}removeHandler(e){void 0!==this._handlers&&(delete this._handlers[e],0===Object.keys(this._handlers).length&&this.clearHandlers())}clearHandlers(){this._handlers=void 0}createChild(e,t){const r=this._children.get(e);return void 0!==r?r:new Logger$1(e,_object_spread_props$p(_object_spread$G({},t),{parent:this}))}linkChild(e){if(void 0!==e.parent&&e.parent!==this)throw new Error(`Logger '${e.name}' is already a child of a different parent ('${e.parent.name}')`);const t=this._children.get(e.name);if(void 0!==t&&t!==e)throw new Error(`A child with name '${e.name}' is already registered`);return void 0===t&&(this._children.set(e.name,e),e.linkParent(this)),e}unlinkChild(e){const t=this._children.get(e.name);return t===e&&(this._children.delete(e.name),t.unlinkParent()),e}getByName(e){return this._children.get(e)}getByNamespace(e){return function(e,t,r="/"){if(""===(t=t.trim())||"*"===t)return e;const n=t.split(r);n[0].trim()===e.name&&n.shift();if(0===n.length)return e;let i=e;for(;void 0!==i&&n.length>0;){const e=n.shift();i=i.getByName(e.trim())}return i}(this,e)}linkParent(e){return this.parent!==e&&(this.unlinkParent(),this._parent=e,e.linkChild(this)),this}unlinkParent(){return void 0!==this._parent&&(this._parent.unlinkChild(this),this._parent=void 0),this}log(e,t,...r){const n=getLoggingLevel(e);void 0!==n&&this.logRecord({time:Date.now(),namespace:this.namespace,level:n,message:t,args:r})}logRecord(e){if(!this.levelPolicy(this.level,e.level))return;const t=_object_spread$G({namespace:this.namespace},e);for(const r of Object.values(this.handlers))r.process(t)}error(e,...t){this.log(G.ERROR,e,...t)}warning(e,...t){this.log(G.WARNING,e,...t)}warn(e,...t){this.warning(e,...t)}info(e,...t){this.log(G.INFO,e,...t)}debug(e,...t){this.log(G.DEBUG,e,...t)}trace(e,...t){this.log(G.TRACE,e,...t)}constructor(e,t){_define_property1$1(this,"name",void 0),_define_property1$1(this,"_parent",void 0),_define_property1$1(this,"_children",new Map),_define_property1$1(this,"_level",void 0),_define_property1$1(this,"_levelPolicy",void 0),_define_property1$1(this,"_handlers",void 0),this.name=e,this._levelPolicy=null==t?void 0:t.levelPolicy,this._handlers=null==t?void 0:t.handlers,void 0!==(null==t?void 0:t.parent)&&this.linkParent(t.parent),void 0!==(null==t?void 0:t.level)&&this.setLevel(t.level)}}function _define_property$1G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class CallbackHandler{process(e){this.enabled&&void 0!==this.callback&&this.callback(e)}constructor(e,t={}){var r;_define_property$1G(this,"enabled",void 0),_define_property$1G(this,"callback",void 0),this.callback=e,this.enabled=null===(r=t.enabled)||void 0===r||r}}const z=/%{([^}]+)}/gi,Y={timestamp:e=>String(e.time),time:e=>String(e.time),datetime:e=>new Date(e.time).toISOString(),date:e=>new Date(e.time).toISOString(),level:e=>String(e.level),levelname:e=>{var t;return null!==(t=getLoggingLevelName(e.level))&&void 0!==t?t:"UNKNOWN"},message:e=>e.message,name:e=>e.namespace.split("/").pop(),namespace:e=>e.namespace};function _define_property$1F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Q=new Map([[G.CRITICAL,"error"],[G.ERROR,"error"],[G.WARNING,"warn"],[G.NOTICE,"warn"],[G.INFO,"log"],[G.DEBUG,"debug"]]),J=(X="%{datetime} %{levelname} - [%{namespace}] %{message}",function(e){return X.replace(z,(function(t,r){return r=r.toLowerCase(),void 0!==Y[r]?Y[r](e):t}))});var X;const Z=new Logger$1("storekit");function asyncGeneratorStep$1b(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Dispatch{get source(){return this._source}set source(e){if(!e&&this._source)return this._source.removeEventListener("message",this.handle),void(this._source=void 0);e.addEventListener("message",this.handle),this._source=e}apply(e,t){if(!this.destination)throw new Error("No destination");const r=this._sequence++,n=new Promise((e,t)=>{this._registry[r]={resolve:e,reject:t}});return this.send(this.destination,{jsonrpc:"2.0",id:r,method:e,params:t}),n}call(e,...t){return this.apply(e,t)}handleRequest(e){var t,r=this;return(t=function*(){const t={jsonrpc:"2.0",id:e.id},n=r.methods[e.method];if(!n)return Object.assign(t,{error:{code:-32601,message:"Method not found"}});try{const r=yield n.apply(void 0,ensureArray(e.params));return Object.assign(t,{result:r})}catch(xe){return Object.assign(t,{error:{code:xe.code||-32603,message:xe.message}})}},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$1b(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1b(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}handleResponse(e){const t=this._registry[e.id];delete this._registry[e.id],t&&(e.error?t.reject(Object.assign(Error(),e.error)):t.resolve(e.result))}send(e,t){e.postMessage(t,e.window===e?this.origin:void 0)}constructor(e={}){_define_property$1E(this,"destination",void 0),_define_property$1E(this,"origin",void 0),_define_property$1E(this,"methods",void 0),_define_property$1E(this,"_registry",{}),_define_property$1E(this,"_sequence",0),_define_property$1E(this,"_source",void 0),_define_property$1E(this,"handle",e=>{e.data&&"2.0"===e.data.jsonrpc&&("*"!==this.origin&&this.origin!==e.origin||(e.data.method&&this.destination?this.handleRequest(e.data).then(e=>{this.send(this.destination,e)}):(hasOwn(e.data,"result")||e.data.error)&&this.handleResponse(e.data)))}),this.destination=e.destination,this.methods=e.methods||{},this.origin=e.origin||"*",e.source&&(this.source=e.source)}}function asyncGeneratorStep$1a(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$1a(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1a(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1a(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$F(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1D(e,t,r[t])}))}return e}function _object_spread_props$o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}var ee=function(e){return e[e.UNAVAILABLE=-1]="UNAVAILABLE",e[e.NOT_DETERMINED=0]="NOT_DETERMINED",e[e.DENIED=1]="DENIED",e[e.RESTRICTED=2]="RESTRICTED",e[e.AUTHORIZED=3]="AUTHORIZED",e}({});function validateToken(e){return"string"==typeof e&&e.length>0}const te=`https://${getCommerceHostname("buy")}/commerce/account/authenticateMusicKitRequest`,re="https://authorize.music.apple.com",ne=/^https?:\/\/(.+\.)*(apple\.com|apps\.mzstatic\.com)(\/[\w\d]+)*$/;var ie=function(e){return e[e.AUTHORIZE=0]="AUTHORIZE",e[e.SUBSCRIBE=1]="SUBSCRIBE",e}({});class ServiceSetupView{get isServiceView(){return/(authorize\.(.+\.)*apple\.com)/i.test(window.location.hostname)||window&&window.name===this.target||!1}focus(){this._window&&window.focus&&this._window.focus()}load(e={action:0}){var t=this;return _async_to_generator$1a((function*(){return 1===e.action?t._subscribeAction(e.parameters):t._authorizeAction(e.parameters)}))()}present(e="",t){const{height:r,left:n,top:i,width:o}=this._calculateClientDimensions(),a={height:650,menubar:"no",resizable:"no",scrollbars:"no",status:"no",toolbar:"no",width:650},s=_object_spread$F(_object_spread_props$o(_object_spread$F({},a),{left:o/2-a.width/2+n,top:r/2-a.height/2+i}),t),l=Object.keys(s).map(e=>`${e}=${s[e]}`).join(",");return/trident|msie/i.test(navigator.userAgent)?(this._window=window.open(window.location.href,this.target,l)||void 0,this._window.location.href=e):this._window=window.open(e,this.target,l)||void 0,/\bedge\b/i.test(navigator.userAgent)&&(this._window.opener=self),this.focus(),this._window}_startPollingForWindowClosed(e){this._window&&void 0===this._windowClosedInterval&&(this._windowClosedInterval=setInterval(()=>{var t;(null===(t=this._window)||void 0===t?void 0:t.closed)&&(this._stopPollingForWindowClosed(),e())},500))}_stopPollingForWindowClosed(){void 0!==this._windowClosedInterval&&(clearInterval(this._windowClosedInterval),this._windowClosedInterval=void 0)}_authorizeAction(e={}){var t=this;return _async_to_generator$1a((function*(){var r;let n,i;const o=(null===(r=window.location)||void 0===r?void 0:r.href)||"";return"GET"===t.authenticateMethod?i=`${re}/woa?${buildQueryParams(_object_spread_props$o(_object_spread$F({},t.deeplinkParameters),{a:btoa(t._thirdPartyInfo()),referrer:o}))}`:(n=t._buildFormElement(te),document.body.appendChild(n)),new Promise((r,o)=>{const a=t.present(i);t._startPollingForWindowClosed(()=>{o(0)}),t.dispatch=new Dispatch({methods:{authorize:function(e,t,n){if(validateToken(e)){r({restricted:t&&"1"===t,userToken:e,cid:n})}else o(0)},close:function(){},decline:function(){o(1)},switchUserId:function(){o(0)},thirdPartyInfo:()=>t._thirdPartyInfo(t.developerToken,_object_spread$F({},t.deeplinkParameters,e)),unavailable:function(){o(-1)}},origin:re,source:window,destination:a}),n&&n.submit()})}))()}_buildFormElement(e,t=this.target,r=this.developerToken){const n=document.createElement("form");n.setAttribute("method","post"),n.setAttribute("action",e),n.setAttribute("target",t),n.style.display="none";const i=document.createElement("input");i.setAttribute("name","jwtToken"),i.setAttribute("value",r),n.appendChild(i);const o=document.createElement("input");o.setAttribute("name","isWebPlayer"),o.setAttribute("value","true"),n.appendChild(o);const a=document.createElement("input");return a.setAttribute("name","LogoURL"),a.setAttribute("value",""),n.appendChild(a),n}_calculateClientDimensions(e=window){return{height:e.innerHeight?e.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left:e.screenLeft?e.screenLeft:screen.availLeft||screen.left,top:e.screenTop?e.screenTop:screen.availTop||screen.top,width:e.innerWidth?e.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width}}_subscribeAction(e={}){var t=this;return _async_to_generator$1a((function*(){return Object.assign(e,t.deeplinkParameters),new Promise((r,n)=>{const i="https://authorize.music.apple.com/upsell?"+buildQueryParams(e);t.present(i),window.addEventListener("message",({data:e,origin:t,source:i})=>{const{closeWindow:o,launchClient:a}="string"==typeof e?JSON.parse(e):e;t&&!ne.test(t)||(a?0===a.supported?n("Unable to subscribe on this platform."):r(a):n("Subscribe action error."))})})}))()}_thirdPartyInfo(e=this.developerToken,t){let r=this.iconURL;const n=window.location.host||document.referrer,i=[...[].slice.call(document.querySelectorAll('link[rel="apple-music-app-icon"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon-precomposed"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon"]'))];if(i&&i[0]&&i[0].href){const e=i.find(e=>!!e.sizes&&"120x120"===e.sizes.value);var o;r=null!==(o=null==e?void 0:e.href)&&void 0!==o?o:i[0].href}return JSON.stringify({thirdPartyIconURL:r,thirdPartyName:n,thirdPartyParameters:t,thirdPartyToken:e})}constructor(e,t={}){if(_define_property$1D(this,"developerToken",void 0),_define_property$1D(this,"authenticateMethod",void 0),_define_property$1D(this,"deeplinkParameters",void 0),_define_property$1D(this,"iconURL",void 0),_define_property$1D(this,"target",void 0),_define_property$1D(this,"dispatch",void 0),_define_property$1D(this,"_window",void 0),_define_property$1D(this,"_windowClosedInterval",void 0),this.developerToken=e,this.authenticateMethod="GET",this.target="apple-music-service-view",this.deeplinkParameters=t&&t.deeplinkParameters||{},this.iconURL=t&&t.iconURL,this.authenticateMethod=t&&t.authenticateMethod||"GET",this.isServiceView&&window.opener!==window){var r;const e=null===(r=getSessionStorage())||void 0===r?void 0:r.getItem("ac"),t=null!=e?new URL(e).origin:void 0;var n;if(t)this.dispatch=new Dispatch({destination:null!==(n=window.opener)&&void 0!==n?n:void 0,origin:t,source:window})}}}function asyncGeneratorStep$19(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$19(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$19(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$19(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1C(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var oe=function(e){return e.ID="us",e.LANGUAGE_TAG="en-gb",e}({});function _fetchStorefronts(){return(_fetchStorefronts=_async_to_generator$19((function*(e,t="https://api.music.apple.com/v1"){const r=new Headers({Authorization:"Bearer "+e}),n=yield fetch(t+"/storefronts",{headers:r}),i=yield n.json();return i.errors?Promise.reject(i.errors):i.data}))).apply(this,arguments)}class Storefront{static inferFromLanguages(e,t=getLanguages()){return _async_to_generator$19((function*(){const r=yield function(e){return _fetchStorefronts.apply(this,arguments)}(e),n=r.map(e=>e.id),i=t[0]||"en-US",[o,a]=i.toLowerCase().split(/-|_/),s=n.includes(a)?a:"us";return r.find(e=>e.id===s)}))()}constructor(e,t,r){_define_property$1C(this,"id",void 0),_define_property$1C(this,"attributes",void 0),_define_property$1C(this,"href",void 0),_define_property$1C(this,"type",void 0),this.id=e,this.attributes=t,this.type="storefronts",this.href=r||`/v1/${this.type}/${e}`}}function asyncGeneratorStep$18(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1B(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ae=["music.apple.com","podcasts.apple.com","tv.apple.com","apps.apple.com"],se=["mut-refresh",j.DEFAULT_CID,j.STOREFRONT_COUNTRY_CODE,j.TV_CID,j.USER_TOKEN],le=new Map([["signIn","/auth/v2/web"],["signOut","/auth/v2/web/logout"],["refresh","/auth/v2/web/refresh"]]);class Reflector{onUserTokenChange(){const e=this.getUserToken(),t=this.previousUserToken!==e;if(this.previousUserToken=e,Z.debug("Reflector.onUserTokenChange hasChanged?",t),t)return e?this.reflect():this.clear()}skipJsCookieWrite(e){return se.includes(e)}refresh(){if(!this.allowMultiReflection)return;const e=getCookie("mut-refresh");return getCookie(j.USER_TOKEN)&&!e?this.makeRequests("refresh"):void 0}reflect(){if(this.allowMultiReflection)return this.makeRequests("signIn");{const e=se.map(e=>getCookie(e));this.clearAppleComCookies(),se.forEach((t,r)=>{const n=e[r],i=getCookie(t);n&&!i&&(Z.debug("Reflector.reflect calling setCookie",t,n),setCookie(t,n,"/",166,void 0,determineBaseCookieDomain(this.hostname)))})}}clear(){if(this.allowMultiReflection)return this.makeRequests("signOut");Z.debug("Reflector nothing to clear, no allowMultiReflection")}makeRequests(e){var t,r=this;return(t=function*(){Z.debug("Reflector makeRequests()",e);try{const n=le.get(e);for(const e of ae){const i=`https://auth.${e}${n}`;Z.debug("Reflector.makeRequests for",i);try{yield fetch(i,{headers:{Authorization:"Bearer "+r.developerToken},method:"POST",credentials:"include"})}catch(t){Z.error("Reflector fetch failed for ",i,t)}}r.clearAppleComCookies()}catch(t){Z.error("Reflector makeRequests failed",t)}Z.debug("Reflector calling onRequestsComplete"),r.onRequestsComplete()},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$18(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$18(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}clearAppleComCookies(){Z.debug("Reflector.clearAppleComCookies"),se.forEach(e=>removeCookie(e,void 0,"apple.com"))}constructor({hostname:e,developerToken:t,getUserToken:r,startingUserToken:n,onRequestsComplete:i,allowMultiReflection:o}){_define_property$1B(this,"developerToken",void 0),_define_property$1B(this,"getUserToken",void 0),_define_property$1B(this,"onRequestsComplete",void 0),_define_property$1B(this,"allowMultiReflection",!1),_define_property$1B(this,"previousUserToken",void 0),_define_property$1B(this,"hostname",void 0),this.hostname=e,this.developerToken=t,this.getUserToken=r,this.previousUserToken=n,this.onRequestsComplete=i,this.allowMultiReflection=o&&function(e){if(!e)return!1;for(const t of ae)if(t===e||e.endsWith("."+t))return!0;return!1}(this.hostname),this.onUserTokenChange=this.onUserTokenChange.bind(this),Z.debug("Reflector allowMultiReflection?",this.allowMultiReflection)}}function asyncGeneratorStep$17(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$17(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$17(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$17(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1A(e,t,r[t])}))}return e}function _ts_metadata$s(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var ce=function(e){return e.authorizationStatusDidChange="authorizationStatusDidChange",e.authorizationStatusWillChange="authorizationStatusWillChange",e.eligibleForSubscribeView="eligibleForSubscribeView",e.needsGDPRDidChange="needsGDPRDidChange",e.storefrontCountryCodeDidChange="storefrontCountryCodeDidChange",e.storefrontIdentifierDidChange="storefrontIdentifierDidChange",e.userTokenDidChange="userTokenDidChange",e}({});j.DEFAULT_CID;let de=!1;de=!0;const ue="https://"+getCommerceHostname("buy"),pe=`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa`;class StoreKit extends Notifications{updateUserTokenFromStorage(){const e=this._getStorageItem(j.USER_TOKEN);this.userToken=e||void 0}get authorizationStatus(){return this._authorizationStatus}set authorizationStatus(e){this._authorizationStatus!==e&&(this._getIsActiveSubscription.updateCache(void 0),this.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:this._authorizationStatus,newAuthorizationStatus:e}),this._authorizationStatus=e,this.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e}))}get cid(){if(!this._cids[this.cidNamespace]){const e=this._getStorageItem(this.cidNamespace);this._cids[this.cidNamespace]=e||void 0}return this._cids[this.cidNamespace]}set cid(e){e?this._setStorageItem(this.cidNamespace,e):this._removeStorageItem(this.cidNamespace),this._cids[this.cidNamespace]=e}eligibleForSubscribeView(){var e=this;return _async_to_generator$17((function*(){const t=yield e.hasMusicSubscription();return(!e.hasAuthorized||e.hasAuthorized&&!t)&&!e._dispatchedSubscribeView}))()}get hasAuthorized(){return this.authorizationStatus>ee.DENIED}get logoutURL(){if(!this._disableLogoutURL)return this.iTunesBuyBase+"/account/web/logout"}get parentalControls(){return this._parentalControls}set parentalControls(e){this._parentalControls=e,e&&(this.realm===F.MUSIC||this.realm===F.PODCAST?this.restrictedEnabled=e.musicParentalControlsEnabled:this.realm===F.TV&&e.videoContentRestrictions&&(this.authorizationStatus=ee.RESTRICTED))}get isU13(){return!!this._isU13}set isU13(e){this._isU13=e}get _pldfltcid(){return this._cids[j.DEFAULT_CID]}set _pldfltcid(e){this._cids[j.DEFAULT_CID]=e}get privacyAcknowledgements(){return this._privacyAcknowledgements}set privacyAcknowledgements(e){if(this._privacyAcknowledgements=e,!e)return this._gdprVersion=-1,void(this._needsGDPR=void 0);if(this.bundleId){var t;const r=null!==(t=this._needsGDPR)&&void 0!==t&&t;this._gdprVersion=e[this.bundleId]||0,this._needsGDPR=this._gdprVersion<(q[this.bundleId]||0),r!==this._needsGDPR&&this.dispatchEvent("needsGDPRDidChange",{GDPRVersion:this._gdprVersion,needsGDPR:this._needsGDPR})}}get restrictedEnabled(){if(this.userToken&&"boolean"!=typeof this._restrictedEnabled){const e=this._getStorageItem(j.RESTRICTIONS_ENABLED);if(e)this._restrictedEnabled="0"!==e;else if(this._storefrontCountryCode){const e=["br","ch","gt","hu","id","in","it","kr","la","lt","my","ru","sg","tr"];this._restrictedEnabled=-1!==e.indexOf(this._storefrontCountryCode)||void 0}}return this._restrictedEnabled}set restrictedEnabled(e){this._restrictedEnabledOverridden||(this.userToken&&void 0!==e&&this._setStorageItem(j.RESTRICTIONS_ENABLED,e?"1":"0"),this._restrictedEnabled=e,e&&(this.authorizationStatus=ee.RESTRICTED))}overrideRestrictEnabled(e){this._restrictedEnabledOverridden=!1,this.restrictedEnabled=e,this._restrictedEnabledOverridden=!0}get storefrontCountryCode(){if(!this._storefrontCountryCode){const e=this._getStorageItem(j.STOREFRONT_COUNTRY_CODE);this._storefrontCountryCode=(null==e?void 0:e.toLowerCase())||oe.ID}return this._storefrontCountryCode}set storefrontCountryCode(e){e&&this.userToken?this._setStorageItem(j.STOREFRONT_COUNTRY_CODE,e):this._removeStorageItem(j.STOREFRONT_COUNTRY_CODE),e!==this._storefrontCountryCode&&(this._storefrontCountryCode=e,this.dispatchEvent("storefrontCountryCodeDidChange",{storefrontCountryCode:e}))}get storefrontIdentifier(){return this._storefrontIdentifier}set storefrontIdentifier(e){this._storefrontIdentifier=e,this.dispatchEvent("storefrontIdentifierDidChange",{storefrontIdentifier:e})}runTokenValidations(e,t=!0){e&&validateToken(e)?(t&&this._setStorageItem(j.USER_TOKEN,e),this.authorizationStatus=this.restrictedEnabled?ee.RESTRICTED:ee.AUTHORIZED):(this._removeStorageItem(j.USER_TOKEN),this.authorizationStatus=ee.NOT_DETERMINED)}wrapDynamicUserTokenForChanges(e,t=invoke(e)){if("function"!=typeof e)return e;let r=t;return()=>{const t=invoke(e);return r!==t&&(r=t,this.runTokenValidations(t,!1),this.dispatchEvent("userTokenDidChange",{userToken:t})),t||""}}get dynamicUserToken(){return this._dynamicUserToken}set dynamicUserToken(e){const t=invoke(e);this._dynamicUserToken=this.wrapDynamicUserTokenForChanges(e,t),this.runTokenValidations(t,"function"!=typeof e),this.dispatchEvent("userTokenDidChange",{userToken:t})}get userToken(){return invoke(this.dynamicUserToken)}set userToken(e){this.dynamicUserToken=e}get userTokenIsValid(){return validateToken(this.userToken)}deeplinkURL(e={}){return"https://finance-app.itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$E({},this.deeplinkParameters||{},e))}itunesDeeplinkURL(e={p:"browse"}){return"https://itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$E({},this.deeplinkParameters||{},e))}pldfltcid(){var e=this;return _async_to_generator$17((function*(){if(!e._cids[j.DEFAULT_CID])try{yield e.infoRefresh()}catch(t){return}return e._cids[j.DEFAULT_CID]}))()}renewUserToken(){var e=this;return _async_to_generator$17((function*(){if(!e.userToken)return e.requestUserToken();const t=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+e.userToken}),r=yield e.fetch(e.playBase+"/renewMusicToken",{method:"POST",headers:t});if(401===r.status)return yield e.revokeUserToken(),Promise.reject(new Error("Renew token"));const n=yield r.json();return n["music-token"]&&(e.userToken=n["music-token"]),e.userToken}))()}requestStorefrontCountryCode(){var e=this;return _async_to_generator$17((function*(){if(e.authorizationStatus<=ee.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const t=new Headers({Authorization:"Bearer "+e.developerToken,"Media-User-Token":e.userToken||""}),r=yield e.fetch(e.apiBase+"/me/storefront",{headers:t});if(r&&!r.ok)return 401!==r.status&&403!==r.status||e._reset(),Promise.reject("Storefront Country Code error.");const n=yield r.json();if(n.errors)return Promise.reject(n.errors);const[i]=n.data;return i&&i.id?(e.storefrontCountryCode=i.id,e.storefrontCountryCode):Promise.reject("Storefront Country Code error.")}))()}requestStorefrontIdentifier(){var e=this;return _async_to_generator$17((function*(){if(!e.storefrontIdentifier){const t=yield Storefront.inferFromLanguages(e.developerToken);e.storefrontIdentifier=t.id}return e.storefrontIdentifier}))()}requestUserToken(){var e=this;return _async_to_generator$17((function*(){if(e._serviceSetupView.isServiceView)return e.userToken||"";try{const t=yield e._serviceSetupView.load({action:ie.AUTHORIZE});e.cid=t.cid,e.userToken=t.userToken,e.restrictedEnabled=t.restricted}catch(t){return e._reset(),e.authorizationStatus=t,Promise.reject(t)}return e.userToken}))()}revokeUserToken(){var e=this;return _async_to_generator$17((function*(){try{yield e._webPlayerLogout()}catch(t){}e.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:e.authorizationStatus,newAuthorizationStatus:ee.NOT_DETERMINED}),e._reset(),e.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e.authorizationStatus}),e.dispatchEvent("userTokenDidChange",{userToken:e.userToken})}))()}setCids(e){this._cids=_object_spread$E({},this._cids,e),Object.keys(this._cids).forEach(e=>{this._setStorageItem(e,this._cids[e])})}shouldDisplayPrivacyLink(e){var t=this;return _async_to_generator$17((function*(){return e||(e=t.bundleId),void 0!==t._needsGDPR||(yield t.me()),t._needsGDPR}))()}hasMusicSubscription(){var e=this;return _async_to_generator$17((function*(){return!!e.hasAuthorized&&e._getIsActiveSubscription()}))()}_getIsActiveSubscription(){var e=this;return _async_to_generator$17((function*(){var t;if(e.realm===F.PODCAST)return!0;return!!(null===(t=(yield e.me()).subscription)||void 0===t?void 0:t.active)}))()}resetSubscribeViewEligibility(){this._dispatchedSubscribeView=!1}presentSubscribeViewForEligibleUsers(e={},t=!0){var r=this;return _async_to_generator$17((function*(){const n=yield r.eligibleForSubscribeView();if(!r._serviceSetupView.isServiceView&&n){if(!t)return r.dispatchEvent("eligibleForSubscribeView",e),void(r._dispatchedSubscribeView=!0);try{const e=yield r._serviceSetupView.load({action:ie.SUBSCRIBE});return r._dispatchedSubscribeView=!0,e}catch(i){return r.revokeUserToken()}}}))()}infoRefresh(){var e=this;return _async_to_generator$17((function*(){if(e.authorizationStatus<=ee.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const t=new Headers({Authorization:"Bearer "+e.developerToken,"Media-User-Token":e.userToken||""});try{const r=yield e.fetch(e.iTunesBuyBase+"/account/web/infoRefresh",{credentials:"include",headers:t}),n=yield r.json();e.setCids(n)}catch(r){}}))()}me(){if(this.authorizationStatus<=ee.DENIED)return Promise.reject("Not authorized: "+this.authorizationStatus);if(!this._me){var e=this;this._me=new Promise(function(){var t=_async_to_generator$17((function*(t,r){const n=new Headers({Authorization:"Bearer "+e.developerToken,"Media-User-Token":e.userToken||""}),i=buildURL(e.apiBase,"/me/account",_object_spread$E({meta:"subscription"},e.meParameters));let o;try{o=yield e.fetch(i,{headers:n})}catch(d){return r(new MKError(MKError.Reason.NETWORK_ERROR,"Failed to fetch /me/account"))}if(o&&!o.ok)return e.realm===F.TV||401!==o.status&&403!==o.status||e._reset(),r("Account error.");let a=yield o.json();if(a.errors)return r(a.errors);const{data:s,meta:l}=a;if(!l||!l.subscription)return r("Account error.");e.storefrontCountryCode=l.subscription.storefront;const c={meta:l,subscription:l.subscription};s&&s.length&&(c.attributes=s[0].attributes);try{let r=yield e.fetch(e.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:n});if(a=yield r.json(),e.isU13=a.isU13,e.parentalControls=a.parentalControlsData,e.privacyAcknowledgements=a.privacyAcknowledgement,function(e){if("object"!=typeof e)throw new TypeError("Source is not an Object");for(const t in e)if(hasOwn(e,t))return!1;return!0}(e.privacyAcknowledgements||{})){try{yield e.infoRefresh()}catch(d){t(c)}r=yield e.fetch(e.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:n}),a=yield r.json(),e.isU13=a.isU13,e.parentalControls=a.parentalControlsData,e.privacyAcknowledgements=a.privacyAcknowledgement}c.info=a}catch(d){console.warn("Failed to fetch privacyAcknowledgements",d)}return t(c)}));return function(e,r){return t.apply(this,arguments)}}()).then(e=>{var t;return this._getIsActiveSubscription.updateCache((null===(t=e.subscription)||void 0===t?void 0:t.active)||!1),this._me=null,e}).catch(e=>(this._me=null,Promise.reject(e)))}return this._me}musicSubscriptionOffers(e,t=getLanguages()){var r=this;return _async_to_generator$17((function*(){let n;if(r.hasAuthorized){n=(yield r.me()).info.storeFrontISO3A}else{if(!e){const n=yield Storefront.inferFromLanguages(r.developerToken,t);e=null==n?void 0:n.id}n=e&&M[e.toUpperCase()]||"USA"}const i=function(e="en-US"){const t=D[e.toLowerCase()];if(t)return t;if(e.includes("-")){const t=e.split("-")[0],r=D[t.toLowerCase()];if(r)return r}return D["en-us"]}(t[0]),o=C[n];if(!i||!o)return[];const a=new Headers({"X-Apple-Store-Front":`${o}-${i},8`});r.userToken&&(a.set("Authorization","Bearer "+r.developerToken),a.set("Music-User-Token",r.userToken));const s=yield r.fetch(r.iTunesBuyBase+"/commerce/web/subscription/offers/music",{headers:a});if(!s.ok)return Promise.reject(s.status);return(yield s.json()).offers}))()}_getStorageItem(e){var t;if(e)return"cookie"===this.persist?getCookie(e):"localstorage"===this.persist?null===(t=this.storage)||void 0===t?void 0:t.getItem(`${this.storagePrefix}.${e}`):void 0}_processLocationHash(e){const t=/^\#([a-zA-Z0-9+\/]{200,}={0,2})$/;if(t.test(e)){const n=e.replace(t,"$1");try{const{itre:e,musicUserToken:t,cid:r}=JSON.parse(atob(n));this.restrictedEnabled=e&&"1"===e,this.userToken=t,this.cid=r}catch(r){}history.replaceState(null,document.title," ")}}_removeStorageItem(e){if("cookie"===this.persist)this._removeCookieFromDomains(e);else if("localstorage"===this.persist){var t;return null===(t=this.storage)||void 0===t?void 0:t.removeItem(`${this.storagePrefix}.${e}`)}}_removeCookieFromDomains(e,t=window){Z.debug("Calling removeCookie",e),removeCookie(e);const{hostname:r}=t.location,n=r.split(".");if(n.length&&(n.shift(),n.length>2))for(let i=n.length;i>2;i--){const r=n.join(".");n.shift(),Z.debug("Calling removeCookie",e,t,r),removeCookie(e,t,r)}}_reset(e=ee.NOT_DETERMINED){this._authorizationStatus=e,this._cids={},this._dispatchedSubscribeView=!1,this._restrictedEnabled=void 0,this._storefrontCountryCode=void 0,this._getIsActiveSubscription.updateCache(void 0),Object.keys(V).forEach(e=>{this._removeStorageItem(V[e])}),this._removeStorageItem(j.RESTRICTIONS_ENABLED),this._removeStorageItem(j.USER_TOKEN),this._removeStorageItem(j.STOREFRONT_COUNTRY_CODE),this._dynamicUserToken=void 0,this._me=null,this.privacyAcknowledgements=void 0}_setStorageItem(e,t){if("cookie"===this.persist){var r;if(null===(r=this.reflector)||void 0===r?void 0:r.skipJsCookieWrite(e))return;return Z.debug("Calling setCookie from _setStorageItem",e,t),setCookie(e,t,"/",180,void 0,determineBaseCookieDomain(window.location.hostname))}var n;if("localstorage"===this.persist)return null===(n=this.storage)||void 0===n?void 0:n.setItem(`${this.storagePrefix}.${e}`,t)}_webPlayerLogout(){var e=this;return _async_to_generator$17((function*(){const t=e.logoutURL;if(!t)return;const r=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Media-User-Token":""+e.userToken});r.delete("X-Apple-Media-User-Token"),r.append("Media-User-Token",e.userToken||"");const n=yield e.fetch(t,{method:"POST",headers:r,credentials:"include"});return n&&!n.ok?Promise.reject(n.status):n.json()}))()}constructor(e,t){var r;(super(["authorizationStatusDidChange","authorizationStatusWillChange","eligibleForSubscribeView","needsGDPRDidChange","storefrontCountryCodeDidChange","userTokenDidChange","storefrontIdentifierDidChange"]),_define_property$1A(this,"developerToken",void 0),_define_property$1A(this,"apiBase",void 0),_define_property$1A(this,"bundleId",void 0),_define_property$1A(this,"cidNamespace",void 0),_define_property$1A(this,"deeplinkParameters",void 0),_define_property$1A(this,"iconURL",void 0),_define_property$1A(this,"iTunesBuyBase",void 0),_define_property$1A(this,"meParameters",void 0),_define_property$1A(this,"persist",void 0),_define_property$1A(this,"playBase",void 0),_define_property$1A(this,"prefix",void 0),_define_property$1A(this,"realm",void 0),_define_property$1A(this,"storage",void 0),_define_property$1A(this,"storagePrefix",void 0),_define_property$1A(this,"whenAuthCompleted",void 0),_define_property$1A(this,"fetch",void 0),_define_property$1A(this,"_authorizationStatus",void 0),_define_property$1A(this,"_developerToken",void 0),_define_property$1A(this,"_disableLogoutURL",void 0),_define_property$1A(this,"_dispatchedSubscribeView",void 0),_define_property$1A(this,"_me",void 0),_define_property$1A(this,"_cids",void 0),_define_property$1A(this,"_gdprVersion",void 0),_define_property$1A(this,"_needsGDPR",void 0),_define_property$1A(this,"_isU13",void 0),_define_property$1A(this,"_parentalControls",void 0),_define_property$1A(this,"_privacyAcknowledgements",void 0),_define_property$1A(this,"_restrictedEnabled",void 0),_define_property$1A(this,"_restrictedEnabledOverridden",void 0),_define_property$1A(this,"_serviceSetupView",void 0),_define_property$1A(this,"reflector",void 0),_define_property$1A(this,"_storefrontCountryCode",void 0),_define_property$1A(this,"_storefrontIdentifier",void 0),_define_property$1A(this,"_dynamicUserToken",void 0),this.developerToken=e,this.apiBase="https://api.music.apple.com/v1",this.iTunesBuyBase=ue,this.meParameters={},this.persist="localstorage",this.playBase=pe,this.prefix="music",this.realm=F.MUSIC,this.storage=getLocalStorage(),this._authorizationStatus=ee.NOT_DETERMINED,this._disableLogoutURL=!1,this._dispatchedSubscribeView=!1,this._me=null,this._cids={},this._gdprVersion=-1,this._needsGDPR=void 0,this._restrictedEnabledOverridden=!1,this._dynamicUserToken=getCookie(j.USER_TOKEN),Z.info("StoreKit initialized"),t&&(t.apiBase&&(this.apiBase=t.apiBase),t.deeplink&&(this.deeplinkParameters=t.deeplink),t.meParameters&&(this.meParameters=t.meParameters),t.persist&&(this.persist=t.persist),t.prefix&&(this.prefix=t.prefix),void 0!==t.realm&&(this.realm=t.realm),void 0!==t.disableLogoutURL&&(this._disableLogoutURL=t.disableLogoutURL),this.bundleId=B[this.realm]),this.fetch=void 0!==t&&"function"==typeof t.fetch?t.fetch:globalThis.fetch.bind(globalThis),this.cidNamespace=V[this.realm],this._developerToken=new DeveloperToken(e),this._serviceSetupView=new ServiceSetupView(e,{authenticateMethod:t&&t.authenticateMethod,iconURL:t&&t.iconURL,deeplinkParameters:this.deeplinkParameters}),this.storagePrefix=`${this.prefix}.${this._developerToken.teamId}`.toLocaleLowerCase(),isNodeEnvironment$1()||"cookie"!==this.persist||(Z.debug("Creating Reflector"),this.reflector=new Reflector({hostname:window.location.hostname,developerToken:this.developerToken,getUserToken:()=>this.userToken,startingUserToken:getCookie(j.USER_TOKEN),onRequestsComplete:()=>{this.userToken!==getCookie(j.USER_TOKEN)&&(Z.debug("StoreKit.onRequestsComplete called, resetting"),this.updateUserTokenFromStorage(),this._cids={})},allowMultiReflection:!(null==t?void 0:t.disableAuthBridge)}),this.addEventListener("userTokenDidChange",this.reflector.onUserTokenChange)),this.updateUserTokenFromStorage(),this.developerToken&&this.userTokenIsValid&&(this._restrictedEnabled=this.restrictedEnabled,this.shouldDisplayPrivacyLink(this.bundleId).catch(()=>{})),this._storefrontCountryCode=this.storefrontCountryCode,this.whenAuthCompleted=Promise.resolve(),isNodeEnvironment$1())||(this._processLocationHash(window.location.hash),"cookie"===this.persist&&(null===(r=this.reflector)||void 0===r||r.refresh()))}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([((e=300)=>(t,r,n)=>{if(void 0===n||"function"!=typeof n.value)throw new TypeError(`Only methods can be decorated with @CachedResult, but ${r} is not a method.`);return{configurable:!0,get:function(){const t=n.value,i=1e3*e;let o,a=-1;function cachedResultMethod(){return _cachedResultMethod.apply(this,arguments)}function _cachedResultMethod(){return(_cachedResultMethod=_async_to_generator$1c((function*(...e){const r=Date.now();return(void 0===o||-1===a||a>0&&r>a+i)&&(a=r,o=yield t.apply(this,e)),o}))).apply(this,arguments)}return cachedResultMethod.updateCache=function(e){a=Date.now(),o=e},cachedResultMethod.getCachedValue=()=>o,Object.defineProperty(this,r,{value:cachedResultMethod,configurable:!0,writable:!0}),cachedResultMethod}}})(900),_ts_metadata$s("design:type",Function),_ts_metadata$s("design:paramtypes",[]),_ts_metadata$s("design:returntype",Promise)],StoreKit.prototype,"_getIsActiveSubscription",null);var he=function(e){return e[e.none=0]="none",e[e.loading=1]="loading",e[e.playing=2]="playing",e[e.paused=3]="paused",e[e.stopped=4]="stopped",e[e.ended=5]="ended",e[e.seeking=6]="seeking",e[e.waiting=8]="waiting",e[e.stalled=9]="stalled",e[e.completed=10]="completed",e}({}),ye=function(e){return e[e.pictureinpicture=0]="pictureinpicture",e[e.inline=1]="inline",e}({});const fe=new Logger$1("player"),K=()=>{},asAsync=e=>{e.then(K,K)},AsyncDebounce=(e=100,t)=>(r,n,i)=>{const o=i.value,a=asyncDebounce(o,e,t);i.value=a},asyncDebounce=(e,t=250,r={isImmediate:!1})=>{let n,i;function fulfill(e){return null==e?void 0:e.resolve(r.cancelledValue)}const clearLastPromise=()=>{n&&(n.resolved||(fulfill(n),n.timeoutId&&clearTimeout(n.timeoutId)),n=void 0)},invokeFn=(t,r,i,o)=>{e.apply(t,o).then(e=>{r(e),n&&(n.resolved=!0)}).catch(i)};return r.isImmediate?function(...e){const r=Date.now(),o=this;return i&&r>=i&&clearLastPromise(),i=Date.now()+t,n?fulfill(Promise):new Promise((t,r)=>{n={resolve:t,reject:r},invokeFn(o,t,r,e)})}:function(...e){const r=this;return n&&clearLastPromise(),new Promise((function(i,o){const a=setTimeout(invokeFn.bind(void 0,r,i,o,e),t);n={resolve:i,reject:o,timeoutId:a}}))}};function deprecationWarning(e,t={}){var r;const n=null!==(r=t.message)&&void 0!==r?r:e+" has been deprecated",i=[];t.since&&i.push("since: "+t.since),t.until&&i.push("until: "+t.until),console.warn("Deprecation Warning: "+n+(i.length>0?` (${i.join(", ")})`:""))}function asyncGeneratorStep$16(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$16(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$16(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$16(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const _e={},SerialAsync=e=>{let t=Promise.resolve();return(r,n,i)=>{const o=i.value;return i.value=_async_to_generator$16((function*(...r){return e&&(t=(e=>{let t=_e[e];return t||(t=Promise.resolve(),_e[e]=t),t})(e)),t=t.catch(()=>{}).then(()=>o.apply(this,r)),e&&(_e[e]=t),t})),i}};var ve=function(e){return e[e.STANDARD=64]="STANDARD",e[e.HIGH=256]="HIGH",e}({}),me=function(e){return e.apiStorefrontChanged="apiStorefrontChanged",e.hlsLevelUpdated="hlsLevelUpdated",e.mediaContentComplete="mediaContentComplete",e.playbackPause="playbackPause",e.playbackPlay="playbackPlay",e.playbackScrub="playbackScrub",e.playbackSeek="playbackSeek",e.playbackSkip="playbackSkip",e.playbackStop="playbackStop",e.lyricsPlay="lyricsPlay",e.lyricsStop="lyricsStop",e.playerActivate="playerActivate",e.playerExit="playerExit",e.queueModified="queueModified",e.userActivityIntent="userActivityIntent",e.applicationActivityIntent="applicationActivityIntent",e.timedMetadata="timedMetadata",e}({}),ge=function(e){return e.MUSICKIT="music_kit-integration",e.OTHER="other",e.MINI="mini",e.SONG="song",e.ALBUM="album",e.ALBUM_CLASSICAL="album-classical",e.ARTIST="artist",e.COMPILATION="compilation",e.COMPILATION_CLASSICAL="compilation-classical",e.PLAYLIST="playlist",e.PLAYLIST_CLASSICAL="playlist-classical",e.RADIO="radio",e.SEARCH="search",e.STATION="station",e}({}),be=function(e){return e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.OTHER=1]="OTHER",e[e.TRACK_SKIPPED_FORWARDS=2]="TRACK_SKIPPED_FORWARDS",e[e.PLAYBACK_MANUALLY_PAUSED=3]="PLAYBACK_MANUALLY_PAUSED",e[e.PLAYBACK_SUSPENDED=4]="PLAYBACK_SUSPENDED",e[e.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM=5]="MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM",e[e.PLAYBACK_PAUSED_DUE_TO_INACTIVITY=6]="PLAYBACK_PAUSED_DUE_TO_INACTIVITY",e[e.NATURAL_END_OF_TRACK=7]="NATURAL_END_OF_TRACK",e[e.PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT=8]="PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT",e[e.TRACK_BANNED=9]="TRACK_BANNED",e[e.FAILED_TO_LOAD=10]="FAILED_TO_LOAD",e[e.PAUSED_ON_TIMEOUT=11]="PAUSED_ON_TIMEOUT",e[e.SCRUB_BEGIN=12]="SCRUB_BEGIN",e[e.SCRUB_END=13]="SCRUB_END",e[e.TRACK_SKIPPED_BACKWARDS=14]="TRACK_SKIPPED_BACKWARDS",e[e.NOT_SUPPORTED_BY_CLIENT=15]="NOT_SUPPORTED_BY_CLIENT",e[e.QUICK_PLAY=16]="QUICK_PLAY",e[e.EXITED_APPLICATION=17]="EXITED_APPLICATION",e}({}),Se=function(e){return e[e.Manual=0]="Manual",e[e.Interval=1]="Interval",e[e.SkipIntro=2]="SkipIntro",e[e.Automatic=3]="Automatic",e[e.SkipToLiveManual=4]="SkipToLiveManual",e[e.SkipToLiveAutomatic=5]="SkipToLiveAutomatic",e}({});var Pe=function(e){return e[e.PLAY_END=0]="PLAY_END",e[e.PLAY_START=1]="PLAY_START",e[e.LYRIC_DISPLAY=2]="LYRIC_DISPLAY",e}({}),ke=function(e){return e[e.ORIGINATING_DEVICE=0]="ORIGINATING_DEVICE",e[e.PAIRED_WATCH=1]="PAIRED_WATCH",e[e.SONOS=2]="SONOS",e[e.CAR_PLAY=3]="CAR_PLAY",e[e.WEB_AUC=4]="WEB_AUC",e[e.TWITTER_AUC=5]="TWITTER_AUC",e[e.MUSIC_SDK=6]="MUSIC_SDK",e[e.ATV_REMOTE=7]="ATV_REMOTE",e[e.WEBPLAYER=8]="WEBPLAYER",e[e.WHOLE_HOUSE_AUDIO=9]="WHOLE_HOUSE_AUDIO",e[e.MUSICKIT=10]="MUSICKIT",e[e.VW=11]="VW",e[e.UNKNOWN_SOURCE_TYPE=12]="UNKNOWN_SOURCE_TYPE",e[e.AMAZON=13]="AMAZON",e[e.PORSCHE=14]="PORSCHE",e[e.CHROMECAST=15]="CHROMECAST",e[e.WEB_APP=16]="WEB_APP",e[e.MERCEDES_BENZ=17]="MERCEDES_BENZ",e[e.THIRD_PARTY_TV=18]="THIRD_PARTY_TV",e[e.SEAT=19]="SEAT",e[e.CUPRA=20]="CUPRA",e}({});function deferred(){let e,t;const r=new Promise((function(r,n){e=r,t=n}));return{promise:r,resolve:function(t){null==e||e(t)},reject:function(e){null==t||t(e)}}}new Logger$1("paf"),new Map([["play",Pe.PLAY_START],["playbackstarted",Pe.PLAY_START],["stop",Pe.PLAY_END],["playbackstopped",Pe.PLAY_END]]),new Map([["exit",be.EXITED_APPLICATION],["next",be.TRACK_SKIPPED_FORWARDS],["pause",be.PLAYBACK_MANUALLY_PAUSED],["playbackfinished",be.NATURAL_END_OF_TRACK],["playbackstopped",be.PLAYBACK_MANUALLY_PAUSED],["previous",be.TRACK_SKIPPED_BACKWARDS],["scrub_begin",be.SCRUB_BEGIN],["scrub_end",be.SCRUB_END],["stop",be.NATURAL_END_OF_TRACK]]);const Te=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];function itemType(e){var t,r;return void 0!==(null==e||null===(r=e.attributes)||void 0===r||null===(t=r.playParams)||void 0===t?void 0:t.kind)?e.attributes.playParams.kind:null==e?void 0:e.type}function isAudio(e){return null!=e&&!function(e){var t;return null!=e&&(!0===e.isUTS||Te.includes(e.type)||"video"===(null===(t=e.attributes)||void 0===t?void 0:t.mediaKind))}(e)}function isPodcastEpisode(e){var t;return!0===(null===(t=itemType(e))||void 0===t?void 0:t.startsWith("podcast-episode"))}function isPodcastPremiumEpisode(e){var t,r;const n=null!==(r=null==e||null===(t=e.attributes)||void 0===t?void 0:t.offers)&&void 0!==r?r:[];return isPodcastEpisode(e)&&n.some(({type:e})=>"PSUB"===e)}function isPodcastFreePremiumEpisode(e){var t,r;const n=null!==(r=null==e||null===(t=e.attributes)||void 0===t?void 0:t.offers)&&void 0!==r?r:[];return isPodcastEpisode(e)&&n.some(({type:e})=>"PLUS"===e)}function isLive(e){var t;return!!(null==e||null===(t=e.attributes)||void 0===t?void 0:t.isLive)}function isStream(e){var t,r;return"stream"===(null==e||null===(r=e.attributes)||void 0===r||null===(t=r.playParams)||void 0===t?void 0:t.format)}function isTracksRadioStation(e){var t,r;return"tracks"===(null==e||null===(r=e.attributes)||void 0===r||null===(t=r.playParams)||void 0===t?void 0:t.format)}function isAlgoStation(e){return function(...e){return isTracksRadioStation(...e)}(e)}function isRadioStation(e,t){var r,n,i;return"radioStation"===(null==e||null===(n=e.attributes)||void 0===n||null===(r=n.playParams)||void 0===r?void 0:r.kind)&&(void 0===t||(null===(i=e.attributes)||void 0===i?void 0:i.mediaKind)===t)}function isRadioEpisode(e,t){var r;return isRadioStation(e,t)&&isStream(e)&&!isLive(e)&&"Episode"===(null==e||null===(r=e.attributes)||void 0===r?void 0:r.streamingRadioSubType)}function isLiveRadioStation(e,t){return isRadioStation(e,t)&&isLive(e)&&isStream(e)}function normalizeContentType(e){return function(e){return pluralizeMediaType(e)}(e)}const Ee=["contributors","modalities","musicVideo","podcast-episodes","radioStation","song","uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo","workouts","workout-programs"],we={mediaItemStateDidChange:"mediaItemStateDidChange",mediaItemStateWillChange:"mediaItemStateWillChange"},Ie=new Logger$1("media-item");function mediaItemLogString(e){let t=e.id;var r;const n=null!==(r=e.attributes)&&void 0!==r?r:{};let i="";const o=n.name||n.title;return isEmptyString$3(o)||(i+=o),isEmptyString$3(n.albumName)||(i+=" - "+n.albumName),isEmptyString$3(n.artistName)||(i+=" - "+n.artistName),""!==i&&(t+=` (${i})`),t}const{none:Ae,loading:Oe,ready:Re,playing:$e,ended:Ce,unavailable:Me,restricted:De,error:xe,unsupported:Le}=y,Ne={[Ae]:{allowed:[Oe],unknown:[Ce,Me,De,xe,Le]},[Oe]:{allowed:[Re,De,xe,Le],unknown:[]},[Re]:{allowed:[$e],unknown:[xe]},[$e]:{allowed:[Ce,xe],unknown:[Me,De,Le]},[Ce]:{allowed:[],unknown:[]},[Me]:{allowed:[],unknown:[]},[De]:{allowed:[],unknown:[]},[xe]:{allowed:[],unknown:[]},[Le]:{allowed:[],unknown:[]}},toName=e=>y[e],createMediaItemStateGuard=(e=Ae)=>{const t={current:e,set:function(e){const{current:r}=t;if(!((e,t)=>Ne[e].allowed.includes(t))(r,e)){const t=((e,t)=>Ne[e].unknown.includes(t))(r,e);Ie.debug(`MediaItem.state was changed from ${toName(r)} to ${toName(e)}`,t?"but it is unknown whether it should be allowed or not.":"and it should not be happening")}t.current=e}};return t};function _define_property$1z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const{mediaItemStateDidChange:Ue,mediaItemStateWillChange:je}=we,Ke=BooleanDevFlag.register("mk-music-movie-playback");class MediaItem extends Notifications{get ageGatePolicy(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.ageGatePolicy}get albumInfo(){const{albumName:e,artistName:t}=this,r=[];return t&&r.push(t),e&&r.push(e),r.join(" - ")}get albumName(){return this.attributes.albumName}get artistName(){return this.attributes.genreNames&&this.attributes.genreNames.indexOf("Classical")>-1&&this.attributes.composerName?this.attributes.composerName:this.attributes.artistName}get artwork(){var e,t;return null!==(t=this.attributes.artwork)&&void 0!==t?t:null===(e=this.attributes.images)||void 0===e?void 0:e.coverArt16X9}get artworkURL(){if(this.artwork&&this.artwork.url)return this.artwork.url}get canPlay(){return this.isPlayable&&this.isReady}get container(){return this._container}set container(e){this._container=e}get contentRating(){return this.attributes.contentRating}get context(){return this._context}set context(e){this._context=e}get defaultPlayable(){var e;return null===(e=this.playables)||void 0===e?void 0:e[0]}get discNumber(){return this.attributes.discNumber}get hasContainerArtwork(){return this.container&&this.container.attributes&&this.container.attributes.artwork&&this.container.attributes.artwork.url}get hasPlaylistContainer(){return this.container&&"playlists"===this.container.type&&this.container.attributes}get supportsLinearScrubbing(){var e,t,r;return this.isLinearStream&&!0===(null===(r=this.defaultPlayable)||void 0===r||null===(t=r.assets)||void 0===t||null===(e=t.streamCapability)||void 0===e?void 0:e.supportsLinearScrubbing)}get isAssetScrubbingDisabled(){return!!this.isLinearStream&&!this.supportsLinearScrubbing}get isLinearStream(){return"LiveService"===(null==(e=this)?void 0:e.type)||"Event"===(null==e||null===(t=e.defaultPlayable)||void 0===t?void 0:t.type)||"EbsEvent"===(null==e||null===(r=e.defaultPlayable)||void 0===r?void 0:r.type);var e,t,r}get isAlgoStation(){return isAlgoStation(this)}get isRadioStation(){return isRadioStation(this)}get isRadioEpisode(){return isRadioEpisode(this)}get isLiveRadioStation(){return isLiveRadioStation(this)}get isLiveAudioStation(){return isLiveRadioStation(this,"audio")}get isLiveVideoStation(){return isLiveRadioStation(this,"video")}get isAOD(){return isRadioEpisode(e=this,t)||!!(null==e||null===(r=e.attributes)||void 0===r?void 0:r.isAOD);var e,t,r}get isSong(){return"song"===itemType(this)}get isPodcastEpisode(){return isPodcastEpisode(this)}get info(){return`${this.title} - ${this.albumInfo}`}get isCloudItem(){return this.isLibraryItem}get isLibrary(){var e,t;return!0===(null===(e=this.playParams)||void 0===e?void 0:e.isLibrary)||isLibraryType(null===(t=this.playParams)||void 0===t?void 0:t.id)||isLibraryType(this.id)}get isLibraryItem(){return this.isLibrary}get isCloudUpload(){return this.isLibraryItem&&!1===this.playParams.reporting&&void 0===this.playParams.catalogId}get isExplicitItem(){return"explicit"===this.contentRating}get isLoading(){return this.state===y.loading}get isPlayableMediaType(){return!("musicMovie"!==this.type||!Ke.enabled)||(this.isUTS||-1!==Ee.indexOf(this.type))}get isPlayable(){var e;return!!this.isUTS||!!this.isPlayableMediaType&&(!!(this.isLiveRadioStation||this.isRadioEpisode||this.hasOffersHlsUrl)||(this.needsPlayParams?!!this.playParams:!!this.rawAssetUrl||!!(null===(e=this.attributes.previews)||void 0===e?void 0:e.length)))}get isPlaying(){return this.state===y.playing}get isPreparedToPlay(){const e=isString$3(this.catalogId)&&!isEmptyString$3(this.catalogId),t=isString$3(this.assetURL)&&!isEmptyString$3(this.assetURL),r=!(!this.keyURLs||isEmptyString$3(this.keyURLs["hls-key-cert-url"])||isEmptyString$3(this.keyURLs["hls-key-server-url"])||isEmptyString$3(this.keyURLs["widevine-cert-url"]));return"song"===this.type?e&&t&&r:this.isUTS?t&&r||this.playRawAssetURL:t||this.playRawAssetURL}get isrc(){return this.attributes.isrc}get isReady(){return this.state===y.ready}get isRestricted(){return this.state===y.restricted}get isUTS(){return!!this.defaultPlayable}get isUnavailable(){return this.state===y.unavailable}get needsPlayParams(){return["musicMovie","musicVideo","song"].includes(this.type)}get normalizedType(){return normalizeContentType(this.type)}get offers(){return this.attributes.offers}get offersHlsUrl(){const{offers:e}=this,t=null==e?void 0:e.find(e=>{var t;return!!(null===(t=e.hlsUrl)||void 0===t?void 0:t.length)});return null==t?void 0:t.hlsUrl}get hasOffersHlsUrl(){return isString$3(this.offersHlsUrl)&&!isEmptyString$3(this.offersHlsUrl)}get rawAssetUrl(){return this.attributes.assetUrl}get playbackDuration(){return this.attributes.durationInMillis||this.attributes.durationInMilliseconds}get playEvent(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.playEvent}get playlistArtworkURL(){var e,t,r;return this.hasPlaylistContainer&&this.hasContainerArtwork?null===(r=this.container)||void 0===r||null===(t=r.attributes)||void 0===t||null===(e=t.artwork)||void 0===e?void 0:e.url:this.artworkURL}get playlistName(){var e,t;return this.hasPlaylistContainer?null===(t=this.container)||void 0===t||null===(e=t.attributes)||void 0===e?void 0:e.name:this.albumName}get playParams(){return this.attributes.playParams}get playRawAssetURL(){return this.isCloudUpload||!!this.rawAssetUrl}get previewURL(){var e,t,r,n,i,o,a,s,l,c,d,u,p,h,y;return(null===(r=this.attributes)||void 0===r||null===(t=r.previews)||void 0===t||null===(e=t[0])||void 0===e?void 0:e.url)||(null===(o=this.attributes)||void 0===o||null===(i=o.previews)||void 0===i||null===(n=i[0])||void 0===n?void 0:n.hlsUrl)||(null===(c=this.attributes)||void 0===c||null===(l=c.trailers)||void 0===l||null===(s=l[0])||void 0===s||null===(a=s.assets)||void 0===a?void 0:a.hlsUrl)||(null===(p=this.attributes)||void 0===p||null===(u=p.movieClips)||void 0===u||null===(d=u[0])||void 0===d?void 0:d.hlsUrl)||(null===(y=this.attributes)||void 0===y||null===(h=y.video)||void 0===h?void 0:h.hlsUrl)}get rating(){return this.attributes.rating}get releaseDate(){if(this._releaseDate)return this._releaseDate;if(this.attributes&&(this.attributes.releaseDate||this.attributes.releaseDateTime)){const e=this.attributes.releaseDate||this.attributes.releaseDateTime;return this._releaseDate=/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0,this._releaseDate}}set releaseDate(e){this._releaseDate="string"==typeof e?/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0:"number"==typeof e?new Date(e):e}get catalogId(){var e,t,r;return!0===(null===(e=this.playParams)||void 0===e?void 0:e.isLibrary)?null===(r=this.playParams)||void 0===r?void 0:r.catalogId:null===(t=this.playParams)||void 0===t?void 0:t.id}get state(){return this._state.current}set state(e){const t={oldState:this._state.current,state:e};this._stateWillChange&&this._stateWillChange(this),this.dispatchEvent(je,t),this._state.set(e),this._stateDidChange&&this._stateDidChange(this),this.dispatchEvent(Ue,t)}get title(){return this.attributes.name||this.attributes.title}get trackNumber(){return this.attributes.trackNumber}beginMonitoringStateDidChange(e){this._stateDidChange=e}beginMonitoringStateWillChange(e){this._stateWillChange=e}endMonitoringStateDidChange(){this._stateDidChange=void 0}endMonitoringStateWillChange(){this._stateWillChange=void 0}isEqual(e){return this.id===e.id&&this.type===e.type&&this.attributes===e.attributes}resetState(){this.endMonitoringStateWillChange(),this.endMonitoringStateDidChange(),this.state=y.none}restrict(){this.isExplicitItem&&(this.state=y.restricted,this._removePlayableData())}notSupported(){this.state=y.unsupported,this._removePlayableData()}updateFromLoadError(e){switch(e.reason){case MKError.Reason.CONTENT_RESTRICTED:this.state=y.restricted;break;case MKError.Reason.CONTENT_UNAVAILABLE:this.state=y.unavailable;break;default:this.state=y.error}}_removePlayableData(){var e,t,r;null===(e=this.attributes)||void 0===e||delete e.playParams,null===(t=this.attributes)||void 0===t||delete t.previews,null===(r=this.attributes)||void 0===r||delete r.trailers}toString(){var e;const{name:t,title:r,artistName:n}=null!==(e=this.attributes)&&void 0!==e?e:{};var i;return`<MediaItem id="${this.id}" title="${null!==(i=null!=t?t:r)&&void 0!==i?i:"-"}" artist="${null!=n?n:"-"}" />`}constructor(e={}){super([Ue,je]),_define_property$1z(this,"id",void 0),_define_property$1z(this,"type",void 0),_define_property$1z(this,"contentType",void 0),_define_property$1z(this,"playables",void 0),_define_property$1z(this,"channels",void 0),_define_property$1z(this,"assetURL",void 0),_define_property$1z(this,"hlsMetadata",{}),_define_property$1z(this,"flavor",void 0),_define_property$1z(this,"currentKeyPlay",void 0),_define_property$1z(this,"keyPlayShelf",void 0),_define_property$1z(this,"keyServerQueryParameters",void 0),_define_property$1z(this,"podpafMetrics",void 0),_define_property$1z(this,"attributes",{}),_define_property$1z(this,"playbackType",h.none),_define_property$1z(this,"href",void 0),_define_property$1z(this,"relationships",void 0),_define_property$1z(this,"_container",void 0),_define_property$1z(this,"_context",void 0),_define_property$1z(this,"_releaseDate",void 0),_define_property$1z(this,"_state",createMediaItemStateGuard()),_define_property$1z(this,"_stateDidChange",void 0),_define_property$1z(this,"_stateWillChange",void 0),_define_property$1z(this,"assets",[]),_define_property$1z(this,"keyURLs",void 0),Ie.debug("media-item: creating Media Item with options:",e);var t;e.id&&e.attributes?(Object.assign(this,e),this.type=(null===(t=this.playParams)||void 0===t?void 0:t.kind)?this.playParams.kind:this.type||"song"):(this.id=e.id||generateUUID(),this.type=e.type||"song",this.attributes={playParams:{id:this.id,kind:this.type}});this.contentType=e.contentType,this._context=e.context||{},e.container?this._container=e.container:e.containerId&&e.containerType&&(this._container={id:e.containerId,type:e.containerType})}}const Bind=()=>(e,t,r)=>{if(void 0===r||"function"!=typeof r.value)throw new TypeError(`Only methods can be decorated with @Bind, but ${t} is not a method.`);return{configurable:!0,get:function(){const e=r.value.bind(this);return Object.defineProperty(this,t,{value:e,configurable:!0,writable:!0}),e}}},Fe="mk-player-tsid",Be={audioTrackAdded:"audioTrackAdded",audioTrackChanged:"audioTrackChanged",audioTrackRemoved:"audioTrackRemoved",bufferedProgressDidChange:"bufferedProgressDidChange",drmUnsupported:"drmUnsupported",forcedTextTrackChanged:"forcedTextTrackChanged",mediaCanPlay:"mediaCanPlay",mediaElementCreated:"mediaElementCreated",mediaPlaybackError:"mediaPlaybackError",nowPlayingItemDidChange:"nowPlayingItemDidChange",nowPlayingItemWillChange:"nowPlayingItemWillChange",metadataDidChange:"metadataDidChange",hlsDaterangeUpdated:"player.hls.daterangeUpdated",playbackBitrateDidChange:"playbackBitrateDidChange",playbackDurationDidChange:"playbackDurationDidChange",playbackProgressDidChange:"playbackProgressDidChange",playbackRateDidChange:"playbackRateDidChange",playbackStateDidChange:"playbackStateDidChange",playbackStateWillChange:"playbackStateWillChange",playbackTargetAvailableDidChange:"playbackTargetAvailableDidChange",playbackTargetIsWirelessDidChange:"playbackTargetIsWirelessDidChange",playbackTimeDidChange:"playbackTimeDidChange",playbackVolumeDidChange:"playbackVolumeDidChange",playerTypeDidChange:"playerTypeDidChange",presentationModeDidChange:"presentationModeDidChange",primaryPlayerDidChange:"primaryPlayerDidChange",textTrackAdded:"textTrackAdded",textTrackChanged:"textTrackChanged",textTrackRemoved:"textTrackRemoved",timedMetadataDidChange:"timedMetadataDidChange"},Ve=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],qe=["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"],Ge=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],noop=()=>Promise.resolve(),He=(e=>{if(void 0===e)return noop;const t=Ve.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:(e=self.document)=>{var r;return null==e||null===(r=e[t])||void 0===r?void 0:r.call(e)}})(Document),We=(e=>{if(void 0===e)return()=>!1;const t=qe.find(t=>t in e.prototype);return"string"!=typeof t?()=>!1:(e=self.document)=>!!e[t]})(Document),ze=(e=>{if(void 0===e)return noop;const t=Ge.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:e=>null==e?void 0:e[t]()})(HTMLElement);function asyncGeneratorStep$15(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$15(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$15(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$15(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class Fullscreen{exit(){var e=this;return _async_to_generator$15((function*(){if(e.isInFullscreen())return e.stopDispatchingEvents(()=>e.exitFullscreen())}))()}request(e){var t=this;return _async_to_generator$15((function*(){if(void 0!==e)return t.stopDispatchingEvents(()=>t.requestFullscreenForElement(e))}))()}stopDispatchingEvents(e){var t=this;return _async_to_generator$15((function*(){return t.player.windowHandlers.stopListeningToVisibilityChanges(e)}))()}exitFullscreen(){return He()}isInFullscreen(){return We()}requestFullscreenForElement(e){return ze(e)}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"player",void 0),this.player=e}}function asyncGeneratorStep$14(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class UnsupportedSeeker{start(){fe.warn("seeker.start is not supported in this playback method")}end(){fe.warn("seeker.end is not supported in this playback method")}seekToTime(e){return fe.warn("seekToTime is not supported in this playback method"),Promise.resolve()}constructor(){_define_property$1x(this,"ended",!1)}}class PlayerSeeker{get ended(){return this._ended}get isEngagedInPlayback(){return this._player.isEngagedInPlayback}get stillPlayingSameItem(){return this._currentItem===this._player.nowPlayingItem}end(){fe.debug("seeker: end"),-1!==this._startTime?this._ended?fe.warn("seeker: Cannot end the same seeker twice."):(this.dispatchStartEvent(),this.dispatchEndEvent()):fe.warn("seeker: Cannot end a seeker before starting it.")}seekToTime(e){var t,r=this;return(t=function*(){if(fe.debug("seeker: seekToTime",e),!r.ended)return r.stillPlayingSameItem||(r._currentItem=r._player.nowPlayingItem,r._startTime=0),r._lastSeekedTime=e,r._player.seekToTime(e);fe.warn("seeker: Cannot seek once the seeker has ended")},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$14(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$14(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}start(){fe.debug("seeker: start"),-1===this._startTime?(this._currentItem=this._player.nowPlayingItem,this._startTime=this._player.currentPlaybackTime,this._lastSeekedTime=this._startTime):fe.warn("seeker: Cannot start same seeker twice")}dispatch(e,t){this.isEngagedInPlayback?(fe.debug("seeker: dispatch",e),this._player.dispatch(e,t)):fe.debug("seeker: do not dispatch because isEngagedInPlayback",this.isEngagedInPlayback)}dispatchStartEvent(){this.stillPlayingSameItem||(this._startTime=0,this._lastSeekedTime=0),this.dispatch(me.playbackScrub,{item:this._currentItem,position:this._startTime})}dispatchEndEvent(){this._ended=!0,this.dispatch(me.playbackScrub,{item:this._currentItem,position:this._lastSeekedTime,endReasonType:be.SCRUB_END})}constructor(e){_define_property$1x(this,"_ended",!1),_define_property$1x(this,"_lastSeekedTime",-1),_define_property$1x(this,"_player",void 0),_define_property$1x(this,"_startTime",-1),_define_property$1x(this,"_currentItem",void 0),fe.debug("seeker: new"),this._player=e}}function asyncGeneratorStep$13(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$r(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$r(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{visibilityChangeEvent:Ye,visibilityState:Qe,unloadEventName:Je}=(()=>{let e="visibilitychange",t="visibilityState";void 0!==document.mozHidden?(e="mozvisibilitychange",t="mozVisibilityState"):void 0!==document.msHidden?(e="msvisibilitychange",t="msVisibilityState"):document.webkitHidden&&(e="webkitvisibilitychange",t="webkitVisibilityState");return{visibilityChangeEvent:e,visibilityState:t,unloadEventName:"onpagehide"in window?"pagehide":"unload"}})();class WindowHandlers{activate(e=self,t=self.document){t.addEventListener(Ye,this.visibilityChanged),e.addEventListener("storage",this.storage,!1),e.addEventListener(Je,this.windowUnloaded)}deactivate(){document.removeEventListener(Ye,this.visibilityChanged),window.removeEventListener("storage",this.storage),window.addEventListener(Je,this.windowUnloaded)}stopListeningToVisibilityChanges(e){var t,r=this;return(t=function*(){r.dispatchVisibilityChanges=!1;const t=yield e();return r.dispatchVisibilityChanges=!0,t},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$13(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$13(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}dispatch(e,t={}){this.player.dispatch(e,t)}storage({key:e,newValue:t}){e===Fe&&this.player.tsidChanged(t)}visibilityChanged(e){const t=e.target[Qe];fe.info("dc visibilityState",t,e,We()),this.runtimeEnvironment.os.isIOS&&this.dispatchVisibilityChanges&&("hidden"===t?this.dispatch(me.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime}):"visible"===t&&this.dispatch(me.playerActivate))}windowUnloaded(){this.player.isPlaying&&this.dispatch(me.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime})}constructor(e,t){_define_property$1w(this,"player",void 0),_define_property$1w(this,"runtimeEnvironment",void 0),_define_property$1w(this,"dispatchVisibilityChanges",!0),this.player=e,this.runtimeEnvironment=t}}function asyncGeneratorStep$12(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$12(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$12(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$12(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$D(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1v(e,t,r[t])}))}return e}function _ts_metadata$q(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[void 0]),_ts_metadata$r("design:returntype",void 0)],WindowHandlers.prototype,"storage",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",["undefined"==typeof Event?Object:Event]),_ts_metadata$r("design:returntype",void 0)],WindowHandlers.prototype,"visibilityChanged",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],WindowHandlers.prototype,"windowUnloaded",null);const Xe=["canplay","durationchange","ended","error","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","timeupdate","volumechange","waiting"],Ze=["NotAllowedError","NotSupportedError"];class BasePlayer{get bitrate(){return this._bitrateCalculator.bitrate}get currentBufferedProgress(){return this._currentBufferedProgress}get _currentDuration(){return this._targetElement.duration}get _currentTime(){const e=this._targetElement.currentTime,t=this._buffer;var r;return e-(null!==(r=null==t?void 0:t.currentTimestampOffset)&&void 0!==r?r:0)}get currentPlaybackDuration(){const e=this.nowPlayingItem;if(!e)return 0;const t="podcast-episodes"===e.type,r=e.playbackType===h.encryptedFull||e.playbackType===h.unencryptedFull,n=e.playbackDuration;return r&&n&&!t?this.calculateTime(n/1e3):this.calculateTime(this._currentDuration)}get currentPlaybackTime(){return this.calculateTime(this._currentTime)}calculateTime(e){return this._timing.time(e)}get currentPlaybackTimeRemaining(){return this.currentPlaybackDuration-this.currentPlaybackTime}get currentPlaybackProgress(){return this._currentPlaybackProgress||0}get hasMediaElement(){return this._targetElement instanceof HTMLElement&&null!==this._targetElement.parentNode}get isEngagedInPlayback(){return!this._stopped&&!this.isPaused()}get isPlaying(){return this.playbackState===he.playing}get isPrimaryPlayer(){return this._isPrimaryPlayer}set isPrimaryPlayer(e){var t;e!==this._isPrimaryPlayer&&(this._isPrimaryPlayer=e,this._isPrimaryPlayer?null===(t=getLocalStorage())||void 0===t||t.setItem(Fe,this._serial):(this._dispatcher.publish(Be.primaryPlayerDidChange,{target:this}),this.pause({userInitiated:!1})))}get isReady(){return 0!==this._targetElement.readyState}get nowPlayingItem(){return this._nowPlayingItem}set nowPlayingItem(e){const t=this._dispatcher;if(void 0===e)return t.publish(Be.nowPlayingItemWillChange,{item:e}),this._nowPlayingItem=e,void t.publish(Be.nowPlayingItemDidChange,{item:e});const r=this._nowPlayingItem,n=this._buffer;(null==r?void 0:r.isEqual(e))||(t.publish(Be.nowPlayingItemWillChange,{item:e}),this.isPlaying&&(null==n?void 0:n.currentItem)!==e&&this._pauseMedia(),r&&(fe.debug("setting state to ended on ",r.title),r.state=y.ended,r.endMonitoringStateDidChange(),r.endMonitoringStateWillChange()),this._nowPlayingItem=e,fe.debug("setting state to playing on ",e.title),e.state=y.playing,e&&e.info&&this._setTargetElementTitle(e.info),t.publish(Be.nowPlayingItemDidChange,{item:e}),t.publish(Be.playbackDurationDidChange,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"}))}get playbackRate(){return this._targetElement.playbackRate}set playbackRate(e){this._targetElement.playbackRate=e}get defaultPlaybackRate(){return this._targetElement.defaultPlaybackRate}set defaultPlaybackRate(e){this._targetElement.defaultPlaybackRate=e}get playbackState(){return this._playbackState}setPlaybackState(e,t){const r=this._playbackState;if(e===r)return;const n={oldState:r,state:e,nowPlayingItem:t};fe.debug("BasePlayer.playbackState is changing",n),this._dispatcher.publish(Be.playbackStateWillChange,n),this._playbackState=e,this._dispatcher.publish(Be.playbackStateDidChange,n)}get playbackTargetAvailable(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetAvailable}set playbackTargetAvailable(e){e!==this._playbackTargetAvailable&&(this._playbackTargetAvailable=e,this._dispatcher.publish(Be.playbackTargetAvailableDidChange,{available:e}))}get playbackTargetIsWireless(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetIsWireless}set playbackTargetIsWireless(e){e!==this._playbackTargetIsWireless&&(this._playbackTargetIsWireless=e,this._dispatcher.publish(Be.playbackTargetIsWirelessDidChange,{playing:e}))}get volume(){return this._targetElement.volume}set volume(e){this._targetElement.volume=e}get isDestroyed(){return this._isDestroyed}get isInitialized(){return this._isInitialized}clearNextManifest(){var e;null===(e=this._buffer)||void 0===e||e.clearNextManifest()}initialize(){var e=this;return _async_to_generator$12((function*(){fe.trace("BasePlayer.initialize"),e._isInitialized?fe.warn("Player is already initialized"):(yield e.initializeMediaElement(),yield e.initializeExtension(),e.initializeEventHandlers(),e._dispatcher.publish(Be.mediaElementCreated,e._targetElement),e._isInitialized=!0)}))()}initializeEventHandlers(){if(this.windowHandlers.activate(),!this.hasMediaElement)return;const e=this._targetElement;window.WebKitPlaybackTargetAvailabilityEvent&&(e.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{this.playbackTargetAvailable="available"===e.availability}),e.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",e=>{this.playbackTargetIsWireless=e.target===this._targetElement&&!this.playbackTargetIsWireless})),fe.debug(`Adding event handlers to <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),Xe.forEach(t=>e.addEventListener(t,this)),this._dispatcher.publish(me.playerActivate)}removeEventHandlers(){fe.trace("BasePlayer.removeEventHandlers()"),setTimeout(()=>{fe.debug(`Removing event handlers from <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),Xe.forEach(e=>this._targetElement.removeEventListener(e,this)),this.windowHandlers.deactivate()},0)}isPaused(){return this._paused}exitFullscreen(){return this.fullscreen.exit()}requestFullscreen(e){return this.fullscreen.request(e)}newSeeker(){var e;return null===(e=this._seeker)||void 0===e||e.end(),this._seeker=new PlayerSeeker(this),this._seeker}stop(e){var t=this;return _async_to_generator$12((function*(){fe.debug("BasePlayer.stop",e),yield t._waitForPendingPlay(),t.isPlaying&&(fe.debug("BasePlayer.play dispatching playbackStop"),t.dispatch(me.playbackStop,_object_spread$D({item:t.nowPlayingItem,position:t.currentPlaybackTime,startPosition:t.initialPlaybackTime,playingDate:t.currentPlayingDate,startPlayingDate:t.initialPlayingDate},e))),yield t.stopMediaAndCleanup()}))()}stopMediaAndCleanup(e=he.stopped){var t=this;return _async_to_generator$12((function*(){fe.debug("BasePlayer.stopMediaAndCleanup",e),yield t.stopMediaElement(),t._stopped=!0,t._paused=!1;const r=t.nowPlayingItem;t.nowPlayingItem=void 0,t.initialPlayingDate=void 0,t.initialPlaybackTime=void 0,t.setPlaybackState(e,r)}))()}onPlaybackError(e,t){this.resetDeferredPlay(),this.stop({endReasonType:be.FAILED_TO_LOAD,userInitiated:!1})}calculatePlaybackProgress(){const e=Math.round(100*(this.currentPlaybackTime/this.currentPlaybackDuration||0))/100;this._currentPlaybackProgress!==e&&(this._currentPlaybackProgress=e,this._dispatcher.publish(Be.playbackProgressDidChange,{progress:this._currentPlaybackProgress}))}calculateBufferedProgress(e){const t=Math.round(e/this.currentPlaybackDuration*100);this._currentBufferedProgress!==t&&(this._currentBufferedProgress=t,this._dispatcher.publish(Be.bufferedProgressDidChange,{progress:t}))}destroy(){var e,t;if(fe.debug("BasePlayer.destroy()"),this._isDestroyed=!0,this._dispatcher.unsubscribe(Be.mediaPlaybackError,this.onPlaybackError),!this.hasMediaElement)return;const r=this._targetElement;null===(e=this.extension)||void 0===e||e.destroy(r),this.resetMediaElement(),this.removeEventHandlers(),null===(t=r.parentNode)||void 0===t||t.removeChild(r)}handleEvent(e){var t=this;return _async_to_generator$12((function*(){"timeupdate"!==e.type&&fe.debug("BasePlayer.handleEvent: ",e.type,e);const{nowPlayingItem:r}=t;switch(e.timestamp=Date.now(),e.type){case"canplay":t._dispatcher.publish(Be.mediaCanPlay,e),t._playbackState!==he.waiting||t._targetElement.paused||t.setPlaybackState(he.playing,r);break;case"durationchange":t._targetElement.duration!==1/0&&(e.duration=t.currentPlaybackDuration,t._dispatcher.publish(Be.playbackDurationDidChange,e),t.calculatePlaybackProgress());break;case"ended":{var n;if(fe.debug('media element "ended" event'),null===(n=t.nowPlayingItem)||void 0===n?void 0:n.isLinearStream)return void fe.warn("ignoring ended event for linear stream",e);if(t.isElementCleaned()){fe.debug('media element already cleaned, ignoring "ended" event');break}const r=t.nowPlayingItem,i=(null==r?void 0:r.playbackDuration)?r.playbackDuration/1e3:t.currentPlaybackTime,o=t.currentPlayingDate;yield t.stopMediaAndCleanup(he.ended),t.dispatch(me.playbackStop,{item:r,position:i,playingDate:o,endReasonType:be.NATURAL_END_OF_TRACK});break}case"error":var i,o;if(fe.error("Playback Error",e,t._targetElement.error),4===(null===(i=t._targetElement.error)||void 0===i?void 0:i.code)||3===(null===(o=t._targetElement.error)||void 0===o?void 0:o.code))break;t._dispatcher.publish(Be.mediaPlaybackError,new MKError(MKError.Reason.MEDIA_PLAYBACK,"Playback Error"));break;case"loadedmetadata":t._dispatcher.publish(Be.metadataDidChange,e);break;case"loadstart":t.setPlaybackState(he.loading,r);break;case"pause":t.setPlaybackState(t._stopped?he.stopped:he.paused,r);break;case"play":case"playing":t._paused=!1,t._stopped=!1,t.isPrimaryPlayer=!0,t.setPlaybackState(he.playing,r);break;case"progress":{const e=t._targetElement.buffered;t.handleBufferStart(),1===e.length&&0===e.start(0)&&t.calculateBufferedProgress(e.end(0));break}case"ratechange":t._dispatcher.publish(Be.playbackRateDidChange,e);break;case"seeked":t._stopped?t.setPlaybackState(he.stopped,r):t._paused?t.setPlaybackState(he.paused,r):t.playbackState!==he.ended&&t.setPlaybackState(he.playing,r);break;case"seeking":t.playbackState===he.paused?t._paused=!0:t.playbackState===he.stopped&&(t._stopped=!0),t.playbackState!==he.ended&&t.setPlaybackState(he.seeking,r);break;case"timeupdate":{t._dispatcher.publish(Be.playbackTimeDidChange,{currentPlaybackDuration:t.currentPlaybackDuration,currentPlaybackTime:t.currentPlaybackTime,currentPlaybackTimeRemaining:t.currentPlaybackTimeRemaining}),t.calculatePlaybackProgress();const e=t._buffer;e&&(e.currentTime=t.currentPlaybackTime);break}case"volumechange":t._dispatcher.publish(Be.playbackVolumeDidChange,e);break;case"waiting":t.setPlaybackState(he.waiting,r)}}))()}handleBufferStart(){const{_targetElement:e}=this;void 0!==this.initialPlaybackTime||e.paused||0===e.buffered.length||(this.initialPlaybackTime=this.currentPlaybackTime,this.initialPlayingDate=this.currentPlayingDate,fe.debug("BasePlayer.handleBufferStart: setting initialPlaybackTime",this.initialPlaybackTime))}pause(e={}){var t=this;return _async_to_generator$12((function*(){yield t._waitForPendingPlay(),t.isPlaying&&(yield t._pauseMedia(),t._paused=!0,t.dispatch(me.playbackPause,_object_spread$D({item:t.nowPlayingItem,position:t.currentPlaybackTime,playingDate:t.currentPlayingDate},e)))}))()}play(e=!0){var t=this;return _async_to_generator$12((function*(){if(fe.debug("BasePlayer.play()"),t.nowPlayingItem)try{yield t._playMedia(),fe.debug("BasePlayer.play dispatching playbackPlay"),t.dispatch(me.playbackPlay,{userInitiated:e,item:t.nowPlayingItem,position:t.currentPlaybackTime,playingDate:t.currentPlayingDate})}catch(r){if(r&&Ze.includes(r.name)&&fe.error("BasePlayer.play() rejected due to",r),"NotAllowedError"===(null==r?void 0:r.name))throw new MKError(MKError.Reason.USER_INTERACTION_REQUIRED,"Playback of media content requires user interaction first and cannot be automatically started on page load.")}}))()}preload(){return this._loadMedia()}showPlaybackTargetPicker(){this.playbackTargetAvailable&&this._targetElement.webkitShowPlaybackTargetPicker()}dispatch(e,t){void 0===t.item&&(t.item=this.nowPlayingItem),hasOwn(t,"isPlaying")||(t.isPlaying=this.isPlaying),this._dispatcher.publish(e,t)}tsidChanged(e){void 0!==e&&""!==e&&(this.isPrimaryPlayer=e===this._serial)}_waitForPendingPlay(){var e=this;return _async_to_generator$12((function*(){e._deferredPlay&&(yield e._deferredPlay.promise,e._deferredPlay=void 0)}))()}_loadMedia(){var e=this;return _async_to_generator$12((function*(){fe.debug("BasePlayer._loadMedia",e._targetElement),e._targetElement.load()}))()}_pauseMedia(){var e=this;return _async_to_generator$12((function*(){e._targetElement.pause()}))()}_playAssetURL(e,t){var r=this;return _async_to_generator$12((function*(){fe.debug("BasePlayer._playAssetURL",e),r._targetElement.src=e;const n=r._loadMedia();if(t)return fe.debug("BasePlayer.loadOnly"),void(yield n);yield r._playMedia()}))()}playItemFromUnencryptedSource(e,t,r){var n=this;return _async_to_generator$12((function*(){return(null==r?void 0:r.startTime)&&(e+="#t="+r.startTime),t||n.startPlaybackSequence(),yield n._playAssetURL(e,t),n.finishPlaybackSequence()}))()}_playMedia(){var e=this;return _async_to_generator$12((function*(){fe.debug("BasePlayer._playMedia",e._targetElement,e.extension);try{yield e._targetElement.play(),e._playbackDidStart=!0}catch(xe){throw fe.error("BasePlayer._playMedia: targetElement.play() rejected",xe),xe}}))()}_setTargetElementTitle(e){this.hasMediaElement&&(this._targetElement.title=e)}resetDeferredPlay(){this._deferredPlay=void 0}stopMediaElement(){var e=this;return _async_to_generator$12((function*(){fe.trace("BasePlayer.stopMediaElement()"),e.hasMediaElement&&(fe.debug("Stopping HTMLMediaElement id="+e._targetElement.id,e._targetElement),e._targetElement.pause(),e.resetMediaElement())}))()}resetMediaElement(){fe.trace("BasePlayer.cleanupElement()");const e=this._targetElement;e&&!this.isElementCleaned()?(fe.debug("Resetting HTMLMediaElement",e),e.currentTime=0,e.removeAttribute("src"),e.removeAttribute("title")):fe.debug("No HTMLMediaElement to reset")}isElementCleaned(){const e=this._targetElement;return!e||0===e.currentTime&&""===e.src&&""===e.title}finishPlaybackSequence(){var e;fe.debug("BasePlayer.finishPlaybackSequence",this._deferredPlay);const t=null===(e=this._deferredPlay)||void 0===e?void 0:e.resolve(void 0);return this._deferredPlay=void 0,t}startPlaybackSequence(){return fe.debug("BasePlayer.startPlaybackSequence",this._deferredPlay),this._deferredPlay&&(fe.warn("Previous playback sequence not cleared"),this.finishPlaybackSequence()),this._deferredPlay=deferred(),this._deferredPlay.promise}toString(){return`<${this.constructor.name} id="${this.id}" isInitialized=${this.isInitialized} isDestroyed=${this.isDestroyed} />`}constructor(e){var t;_define_property$1v(this,"id",generateUUID()),_define_property$1v(this,"privateEnabled",!1),_define_property$1v(this,"siriInitiated",!1),_define_property$1v(this,"windowHandlers",void 0),_define_property$1v(this,"_dispatcher",void 0),_define_property$1v(this,"_buffer",void 0),_define_property$1v(this,"services",void 0),_define_property$1v(this,"_context",void 0),_define_property$1v(this,"_currentBufferedProgress",0),_define_property$1v(this,"initialPlayingDate",void 0),_define_property$1v(this,"initialPlaybackTime",void 0),_define_property$1v(this,"_nowPlayingItem",void 0),_define_property$1v(this,"_paused",!1),_define_property$1v(this,"_playbackDidStart",!1),_define_property$1v(this,"_playbackState",he.none),_define_property$1v(this,"_stopped",!1),_define_property$1v(this,"_timing",void 0),_define_property$1v(this,"_bitrateCalculator",void 0),_define_property$1v(this,"_currentPlaybackProgress",0),_define_property$1v(this,"_isPrimaryPlayer",!0),_define_property$1v(this,"_playbackTargetAvailable",!1),_define_property$1v(this,"_playbackTargetIsWireless",!1),_define_property$1v(this,"_seeker",void 0),_define_property$1v(this,"_serial",Date.now().toString()),_define_property$1v(this,"fullscreen",void 0),_define_property$1v(this,"_isDestroyed",!1),_define_property$1v(this,"_isInitialized",!1),_define_property$1v(this,"_deferredPlay",void 0),this.services=e.services,this._dispatcher=e.services.dispatcher,this._timing=e.services.timing,this._context=e.context||{},this.privateEnabled=e.privateEnabled||!1,this.siriInitiated=e.siriInitiated||!1,this._bitrateCalculator=e.services.bitrateCalculator,this.windowHandlers=new WindowHandlers(this,e.services.runtime),this.fullscreen=new Fullscreen(this),null===(t=getLocalStorage())||void 0===t||t.setItem(Fe,this._serial),this._dispatcher.subscribe(Be.mediaPlaybackError,this.onPlaybackError)}}function generateAssetUrl(e,t){if("Preview"===e.type&&!isEmptyString$3(e.previewURL,{trim:!0}))return e.previewURL;if(!e.assetURL)throw new Error("Cannot generate asset URL");const r={};return(null==t?void 0:t.startOver)&&(r.startOver=!0),(null==t?void 0:t.bingeWatching)&&(r.bingeWatching=!0),e.supportsLinearScrubbing&&(r.linearScrubbingSupported=!0),e.assetURL.match(/xapsub=accepts-css/)||(r.xapsub="accepts-css"),buildURL(e.assetURL,r)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[String,void 0===MKError?Object:MKError]),_ts_metadata$q("design:returntype",void 0)],BasePlayer.prototype,"onPlaybackError",null);var et=function(e){return e.playbackLicenseError="playbackLicenseError",e.playbackSessionError="playbackSessionError",e.manifestParsed="manifestParsed",e.audioCodecIdentified="audioCodecIdentified",e.audioTracksSwitched="audioTracksSwitched",e.audioTracksUpdated="audioTracksUpdated",e.textTracksSwitched="textTracksSwitched",e.textTracksUpdated="textTracksUpdated",e.inlineStylesParsed="inlineStylesParsed",e.levelUpdated="levelUpdated",e}({}),tt=function(e){return e.MP4="audio/mp4",e.AVC1="video/mp4",e}({}),rt=function(e){return e.Home="com.apple.amp.appletv.home-team-radio",e.Away="com.apple.amp.appletv.away-team-radio",e}({});function isHomeRadioTrack(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.home-team-radio")}function isAwayRadioTrack(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.away-team-radio")}function toPersistedTrack(e){return{label:e.label,kind:e.kind,language:e.language}}function saveTrack(e,t){var r,n;r=e,n=toPersistedTrack(t),hasLocalStorage()&&(n?getLocalStorage().setItem(r,JSON.stringify(n)):getLocalStorage().setItem(r,""))}function loadTrack(e){return getJsonFromLocalStorage(e)}function trackEquals(e,t){const r=toPersistedTrack(e),n=toPersistedTrack(t);for(const i of Object.keys(r))if(r[i]!==n[i])return!1;return!0}function _define_property$1u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class AudioTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>e.enabled)}set currentTrack(e){this.setCurrentTrack(e,!0)}setCurrentTrack(e,t=!0){e&&(fe.debug("MEDIA_TRACK Setting audio track "+e.label,{shouldPersist:t}),this.extensionTracks?(fe.debug(`MEDIA_TRACK Setting track on extension ${e.id}-${e.label}`),this.extensionTracks.audioTrack=e):(fe.debug("MEDIA_TRACK disabling all audio tracks"),Array.from(this.mediaElement.audioTracks).forEach(t=>{t!==e&&(t.enabled=!1)}),fe.debug("MEDIA_TRACK enabling",e),e.enabled=!0),!t||isHomeRadioTrack(e)||isAwayRadioTrack(e)||(saveTrack("mk-audio-track",e),fe.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`)))}get tracks(){return this.extensionTracks?this._extensionTracks||this.extensionTracks.audioTracks||[]:Array.from(this.mediaElement.audioTracks)}destroy(){if(this._isDestroyed=!0,this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(et.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.removeEventListener(et.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!this.mediaElement.audioTracks)return;this.mediaElement.audioTracks.removeEventListener("addtrack",this.onAudioTrackAdded),this.mediaElement.audioTracks.removeEventListener("change",this.onAudioTrackChanged),this.mediaElement.audioTracks.removeEventListener("removetrack",this.onAudioTrackRemoved)}}onExtensionAudioTracksUpdated(e){var t;fe.debug("MEDIA_TRACK Extension audio tracks updated",e),this._extensionTracks=e;const r=loadTrack("mk-audio-track");let n;if((null===(t=this.tracks)||void 0===t?void 0:t.length)>=0&&void 0!==r&&(void 0===this.currentTrack||!trackEquals(this.currentTrack,r))&&(n=this.tracks.find(e=>trackEquals(e,r))),n)this.currentTrack=n;else{var i,o;const e=null===(i=this.tracks)||void 0===i?void 0:i.find(e=>e.isDefault),t=null!=e?e:null===(o=this.tracks)||void 0===o?void 0:o[0];fe.debug("Setting current track to:",t),this.setCurrentTrack(t,!1)}this.dispatcher.publish(Be.audioTrackAdded,e)}onExtensionAudioTrackSwitched(e){fe.debug("MEDIA_TRACK Extension audio track switched",e);const{selectedId:t}=e;if(this._extensionTracks){const updateTrackEnabledState=e=>{e.enabled=t===e.id};this._extensionTracks.forEach(updateTrackEnabledState)}this.dispatcher.publish(Be.audioTrackChanged,e)}onAudioTrackAdded(e){const t=loadTrack("mk-audio-track");void 0!==t&&trackEquals(e.track,t)&&(fe.debug("Found new track matching persisted track: "+e.track.label),this.currentTrack=e.track),this.dispatcher.publish(Be.audioTrackAdded,e)}onAudioTrackChanged(e){this.dispatcher.publish(Be.audioTrackChanged,e)}onAudioTrackRemoved(e){this.dispatcher.publish(Be.audioTrackRemoved,e)}constructor(e,t,r){if(_define_property$1u(this,"mediaElement",void 0),_define_property$1u(this,"dispatcher",void 0),_define_property$1u(this,"extensionTracks",void 0),_define_property$1u(this,"_extensionTracks",void 0),_define_property$1u(this,"_isDestroyed",void 0),this.mediaElement=e,this.dispatcher=t,this.extensionTracks=r,this._extensionTracks=[],this._isDestroyed=!1,this.extensionTracks){fe.debug("MEDIA_TRACK Initializing audio track manager for hls track events"),this.onExtensionAudioTracksUpdated=this.onExtensionAudioTracksUpdated.bind(this),this.onExtensionAudioTrackSwitched=this.onExtensionAudioTrackSwitched.bind(this);const e=this.extensionTracks;e.addEventListener(et.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.addEventListener(et.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!e.audioTracks)return;fe.debug("MEDIA_TRACK Initializing audio track manager for native track events"),this.onAudioTrackAdded=this.onAudioTrackAdded.bind(this),this.onAudioTrackChanged=this.onAudioTrackChanged.bind(this),this.onAudioTrackRemoved=this.onAudioTrackRemoved.bind(this),e.audioTracks.addEventListener("addtrack",this.onAudioTrackAdded),e.audioTracks.addEventListener("change",this.onAudioTrackChanged),e.audioTracks.addEventListener("removetrack",this.onAudioTrackRemoved)}}}const nt=[],it=[];function nextAvailableAudioElement(){let e=it.pop();return e?fe.debug(`dom-helpers: retrieving audio tag, ${it.length} remain`):(fe.debug("dom-helpers: no available audio tags, creating one"),e=document.createElement("audio")),e}function deferPlayback(){fillAvailableElements("audio",it),fillAvailableElements("video",nt),fe.debug(`dom-helpers: defer playback called.  There are ${nt.length} available video elements and ${it.length} available audio elements.`)}function fillAvailableElements(e,t){let r=100-t.length;for(;r>0;){const n=document.createElement(e);n.load(),t.push(n),r--}}var ot="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var at=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isValidScrollSetting=t.isValidPositionAlignSetting=t.isValidLineAlignSetting=t.isValidLineAndPositionSetting=t.isValidDirectionSetting=t.isValidAlignSetting=t.isValidPercentValue=void 0,t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}));unwrapExports(at),at.isValidScrollSetting,at.isValidPositionAlignSetting,at.isValidLineAlignSetting,at.isValidLineAndPositionSetting,at.isValidDirectionSetting,at.isValidAlignSetting,at.isValidPercentValue;var st=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const r={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"","&rlm;":"","&nbsp;":""},n={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},i={v:"title",lang:"lang"},o={rt:"ruby"},a={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class ParserUtility{static parseTimeStamp(e){function computeSeconds(e){const[t,r,n,i]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*r+n+i/1e3}const t=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return t?t[3]?computeSeconds([t[1],t[2],t[3].substring(1),t[4]]):parseInt(t[1])>59?computeSeconds([t[1],t[2],null,t[4]]):computeSeconds([null,t[1],t[2],t[4]]):null}static parseContent(e,t,s,l=!1){let c=t.text;function nextToken(){if(!c)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(c);return t=e[1]?e[1]:e[2],c=c.substr(t.length),t;var t}function unescape1(e){return r[e]}function shouldAdd(e,t){return!o[t.dataset.localName]||o[t.dataset.localName]===e.dataset.localName}function createElement(t,r,o){const c=n[t];if(!c)return null;const d=e.document.createElement(c);d.dataset.localName=c;const u=i[t];if(u&&o&&(d[u]=o.trim()),r)if(s[r]){const e=function(e){let t="";for(const r in e)t+=a[r]?a[r]:r+":"+e[r]+";";return t}(s[r]);d.setAttribute("style",e)}else l&&console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${r}'!`);return d}const d=e.document.createElement("div"),u=[];let p,h,y=d;for(;null!==(p=nextToken());)if("<"!==p[0])y.appendChild(e.document.createTextNode(p.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,unescape1)));else{if("/"===p[1]){u.length&&u[u.length-1]===p.substr(2).replace(">","")&&(u.pop(),y=y.parentNode);continue}const t=ParserUtility.parseTimeStamp(p.substr(1,p.length-2));let r;if(t){r=e.document.createProcessingInstruction("timestamp",t.toString()),y.appendChild(r);continue}if(h=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(p),!h)continue;if(r=createElement(h[1],h[2],h[3]),!r)continue;if(!shouldAdd(y,r))continue;h[2],u.push(h[1]),y.appendChild(r),y=r}return d}}t.default=ParserUtility}));unwrapExports(st);var lt=createCommonjsModule((function(e,t){var r=ot&&ot.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=void 0;let n=class{get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: "+e);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: "+e);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!at.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+e);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!at.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: "+e);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!at.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+e);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!at.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: "+e);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!at.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+e);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100: "+e);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!at.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: "+e);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return st.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(r=>{t.hasOwnProperty(r)&&(t[r]=e[r])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}constructor(e,t,r){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=r}};n=r([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTCue&&(t=window.VTTCue,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],n),t.VTTCue=n}));unwrapExports(lt),lt.VTTCue;var ct=createCommonjsModule((function(e,t){var r=ot&&ot.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTRegion=void 0;let n=class{get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!at.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!at.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(at.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!at.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!at.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!at.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(r=>{t.hasOwnProperty(r)&&(t[r]=e[r])}),t}static fromJSON(e){return this.create(JSON.parse(e))}constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}};n=r([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTRegion&&(t=window.VTTRegion,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],n),t.VTTRegion=n}));unwrapExports(ct),ct.VTTRegion;var dt=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}));unwrapExports(dt);var ut=createCommonjsModule((function(e,t){var r=ot&&ot.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=ot&&ot.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTRegion=t.VTTCue=t.WebVTTParser=t.ParsingError=void 0,Object.defineProperty(t,"VTTCue",{enumerable:!0,get:function(){return lt.VTTCue}}),Object.defineProperty(t,"VTTRegion",{enumerable:!0,get:function(){return ct.VTTRegion}});class ParsingError extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof ParsingError&&(this.message=e.message)}}t.ParsingError=ParsingError,ParsingError.Errors={BadSignature:new ParsingError(0,"Malformed WebVTT signature."),BadTimeStamp:new ParsingError(1,"Malformed time stamp.")};class Settings{set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,r){return"object"==typeof t&&"string"==typeof r?this.has(e)?this.values[e]:t[r]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,r){for(let n=0;n<r.length;++n)if(t===r[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const r=parseFloat(t);if(r>=0&&r<=100)return this.set(e,r),!0}catch(r){return!1}return!1}constructor(){this.values={}}}class WebVTTParser{static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof ParsingError&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,r,n){const i=n?e.split(n):[e];for(const o of i){if("string"!=typeof o)continue;const e=o.split(r);if(2!==e.length)continue;t(e[0],e[1])}}parseCue(e,t,r){const n=e,consumeTimeStamp=()=>{const t=st.default.parseTimeStamp(e);if(null===t)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+n);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},skipWhitespace=()=>{e=e.replace(/^\s+/,"")};if(skipWhitespace(),t.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==e.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+n);e=e.substr(3),skipWhitespace(),t.endTime=consumeTimeStamp(),skipWhitespace(),((e,t)=>{const n=new Settings;this.parseOptions(e,(e,t)=>{let i,o;switch(e){case"region":for(let i=r.length-1;i>=0;i--)if(r[i].id===t){n.set(e,r[i].region);break}break;case"vertical":n.alt(e,t,["rl","lr"]);break;case"line":i=t.split(","),o=i[0],n.integer(e,o),n.percent(e,o)&&n.set("snapToLines",!1),n.alt(e,o,["auto"]),2===i.length&&n.alt("lineAlign",i[1],["start","middle","center","end"]);break;case"position":if(i=t.split(","),n.percent(e,i[0]),2===i.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];n.alt("positionAlign",i[1],e)}break;case"size":n.percent(e,t);break;case"align":let a=["start","center","end","left","right","middle"];n.alt(e,t,a)}},/:/,/\s/),t.region=n.get("region",null),t.vertical=n.get("vertical",""),t.line=n.get("line",void 0===t.line?"auto":t.line);const i=n.get("lineAlign","start");t.lineAlign="center"===i||"middle"===i?this.middleOrCenter:i,t.snapToLines=n.get("snapToLines",!0),t.size=n.get("size",100);const o=n.get("align","center");t.align="center"===o||"middle"===o?this.middleOrCenter:o,t.position=n.get("position","auto");let a=n.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},t.align);t.positionAlign="center"===a||"middle"===a?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[a]})(e,t)}parseRegion(e){const t=new Settings;if(this.parseOptions(e,(e,r)=>{switch(e){case"id":t.set(e,r);break;case"width":t.percent(e,r);break;case"lines":t.integer(e,r);break;case"regionanchor":case"viewportanchor":{const n=r.split(",");if(2!==n.length)break;const i=new Settings;if(i.percent("x",n[0]),i.percent("y",n[1]),!i.has("x")||!i.has("y"))break;t.set(e+"X",i.get("x")),t.set(e+"Y",i.get("y"));break}case"scroll":t.alt(e,r,["up"])}},/=/,/\s/),t.has("id")){const e=new ct.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const parseStyles=e=>{const t={},r=e.split(";");for(let n=0;n<r.length;n++)if(r[n].includes(":")){const e=r[n].split(":",2),i=e[0].trim(),o=e[1].trim();""!==i&&""!==o&&(t[i]=o)}return t},t=e.split("}");t.pop();for(const r of t){let e=null,t=null;const n=r.split("{");n[0]&&(e=n[0].trim()),n[1]&&(t=parseStyles(n[1])),e&&t&&(this._styles[e]=t)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const collectNextLine=()=>{const e=this.buffer;let t=0;const calculateBreakPosition=(e,t)=>{const r={start:-1,length:-1};if("\r"===e[t])r.start=t,r.length=1;else if("\n"===e[t])r.start=t,r.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let n=t+2;for(;n<e.length&&">"!==e[n++];);r.start=t,r.length=n-t}return r};let r={start:e.length,length:0};for(;t<e.length;){const n=calculateBreakPosition(e,t);if(n.length>0){r=n;break}++t}const n=e.substr(0,r.start);return this.buffer=e.substr(r.start+r.length),n};try{let e;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="",e=collectNextLine();const t=/^()?WEBVTT([ \t].*)?$/.exec(e);if(!t||!t[0])throw new ParsingError(ParsingError.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(e=this.alreadyCollectedLine,this.alreadyCollectedLine=""):e=collectNextLine(),this.state){case"HEADER":e.includes(":")?this.parseHeader(e):e||(this.state="ID");continue;case"NOTE":e||(this.state="ID");continue;case"STYLE":e?this.styleCollector+=e:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(e)){this.state="STYLE";break}if(!e)continue;if(this.cue=new lt.VTTCue(0,0,""),this.state="CUE",!e.includes("--\x3e")){this.cue.id=e;continue}case"CUE":try{this.parseCue(e,this.cue,this.regionList)}catch(t){this.reportOrThrowError(t),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const t=e.includes("--\x3e");if(!e||t){this.alreadyCollectedLine=e,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=e;continue}case"BADCUE":e||(this.state="ID");continue}}}catch(t){this.reportOrThrowError(t),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}constructor(e,t,r){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=r,this._styles={},this.middleOrCenter="center";const n=new lt.VTTCue(0,0,"middleOrCenter");try{n.align="center","center"!==n.align&&(this.middleOrCenter="middle")}catch(i){this.middleOrCenter="middle"}}}t.default=WebVTTParser,t.WebVTTParser=WebVTTParser,n(dt,t)}));unwrapExports(ut),ut.VTTRegion,ut.VTTCue,ut.WebVTTParser,ut.ParsingError;var pt=createCommonjsModule((function(e,t){var r=ot&&ot.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=ot&&ot.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=t.WebVTTRenderer=t.BoxPosition=t.CueStyleBox=t.StyleBox=void 0,Object.defineProperty(t,"VTTCue",{enumerable:!0,get:function(){return lt.VTTCue}});const i=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],o=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class StyleBox{applyStyles(e,t){t=t||this.div;for(const r in e)e.hasOwnProperty(r)&&(t.style[r]=e[r])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=StyleBox;class CueStyleBox extends StyleBox{determineBidi(e){let t,r=[],n="";if(!e||!e.childNodes)return"ltr";function pushNodes(e,t){for(let r=t.childNodes.length-1;r>=0;r--)e.push(t.childNodes[r])}function nextTextNode(e){if(!e||!e.length)return null;let t=e.pop(),r=t.textContent||t.innerText;if(r){const t=/^.*(\n|\r)/.exec(r);return t?(e.length=0,t[0]):r}return"ruby"===t.tagName?nextTextNode(e):t.childNodes?(pushNodes(e,t),nextTextNode(e)):void 0}function isContainedInCharacterList(e,t){for(const r of t)if(e>=r[0]&&e<=r[1])return!0;return!1}for(pushNodes(r,e);n=nextTextNode(r);)for(let e=0;e<n.length;e++)if(t=n.charCodeAt(e),isContainedInCharacterList(t,o))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}constructor(e,t,r,n,i,o=!1){super(),this.loggingEnabled=o,this.cue=t;let a={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[t.positionAlign]||t.align;"middle"===a&&(a="center");let s={textAlign:a,whiteSpace:"pre-line",position:"absolute"};s.direction=this.determineBidi(this.cueDiv),s.writingMode=this.directionSettingToWritingMode(t.vertical),s.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(s),s={backgroundColor:n.backgroundColor,display:"inline-block"},this.parseOpacity(s.backgroundColor)&&(s.padding="5px",s.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(s,this.backgroundDiv),s={color:r.color,backgroundColor:r.backgroundColor,textShadow:r.textShadow,fontSize:r.fontSize,fontFamily:r.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},s.writingMode=this.directionSettingToWritingMode(t.vertical),s.unicodeBidi="plaintext",this.cueDiv=st.default.parseContent(e,t,i,this.loggingEnabled),this.applyStyles(s,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let l=0;if("number"==typeof t.position){let e=t.positionAlign||t.align;if(e)switch(e){case"start":case"left":l=t.position;break;case"center":case"middle":l=t.position-t.size/2;break;case"end":case"right":l=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(l,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(l,"%"),height:this.formatStyle(t.size,"%")})}}t.CueStyleBox=CueStyleBox;class BoxPosition{calculateNewLines(e){let t=1;for(let r=0;r<e.length;r++)"\n"===e[r]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof StyleBox&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let r=t.offsetHeight||0,n=t.offsetWidth||0,i=t.offsetTop||0,o=i+r,a=t.getBoundingClientRect();const{left:s,right:l}=a;return a.top&&(i=a.top),a.height&&(r=a.height),a.width&&(n=a.width),a.bottom&&(o=a.bottom),{left:s,right:l,top:i,height:r,bottom:o,width:n}}static getBoxPosition(e,t){if(e&&e.length>0){let r=0,n=e[0][t];for(let i=0;i<e.length;i++)t in["top","right"]?e[i][t]>n&&(r=i,n=e[i][t]):t in["bottom","left"]&&e[i][t]<n&&(r=i,n=e[i][t]);return e[r]}return null}static moveToMinimumDistancePlacement(e,t,r){"height"===e.property?"+y"===t?(e.top=r.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=r.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=r.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=r.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,r){const n=e.cue;let i,o=new BoxPosition(e),a=function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const r=e.track,n=r.textTrackList;for(let i=0;i<n.length&&n[i]!==r;i++)"showing"===n[i].mode&&t++;return-1*++t}(n),s=[];if(n.snapToLines){let e=0;switch(n.vertical){case"":s=["+y","-y"],i="height";break;case"rl":s=["+x","-x"],i="width";break;case"lr":s=["-x","+x"],i="width"}const r=o.lineHeight,l=t[i]+r,c=s[0];if(a<0){let i=0;switch(n.vertical){case"":i=t.height-r-.05*t.height;break;case"rl":case"lr":i=-t.width+r+.05*t.width}e=i,s=s.reverse()}else{switch(n.vertical){case"":e=r*Math.round(a);break;case"rl":e=t.width-r*Math.round(a);break;case"lr":e=r*Math.round(a)}Math.abs(e)>l&&(e=e<0?-1:1,e*=Math.ceil(l/r)*r)}o.move(c,e)}else{const r=""===n.vertical?t.height:t.width,i=o.lineHeight/r*100;switch(n.lineAlign){case"center":case"middle":a-=i/2;break;case"end":a-=i}switch(n.vertical){case"":e.applyStyles({top:e.formatStyle(a,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(a,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(a,"%")})}s=["+y","-y","+x","-x"],"+y"===n.axis?s=["+y","-y","+x","-x"]:"-y"===n.axis&&(s=["-y","+y","+x","-x"]),o=new BoxPosition(e)}const l=function(e,n){let i;for(let o=0;o<n.length;o++){e.moveIfOutOfBounds(t,n[o]);let a=0,s=!1;for(;e.overlapsAny(r)&&!(a>9);)s?e.move(n[o]):(r&&r.length>0&&(i||(i={topMostBoxPosition:BoxPosition.getBoxPosition(r,"top"),bottomMostBoxPosition:BoxPosition.getBoxPosition(r,"bottom"),leftMostBoxPosition:BoxPosition.getBoxPosition(r,"left"),rightMostBoxPosition:BoxPosition.getBoxPosition(r,"right")}),BoxPosition.moveToMinimumDistancePlacement(e,n[o],i)),s=!0),a++}return e}(o,s);e.move(l.toCSSCompatValues(t))}constructor(e){var t;let r,n,i,o,a,s;if(e instanceof CueStyleBox&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof BoxPosition&&(this.property=e.property||"height"),e instanceof CueStyleBox&&e.div){i=e.div.offsetHeight,o=e.div.offsetWidth,a=e.div.offsetTop;const t=e.div.firstChild;if(s=t?t.getBoundingClientRect():e.div.getBoundingClientRect(),r=s&&s[this.property]||null,t&&t.firstChild){const e=t.firstChild;if(e&&"string"==typeof e.textContent){n=r/this.calculateNewLines(e.textContent)}}}else e instanceof BoxPosition&&(s=e);this.left=s.left,this.right=s.right,this.top=s.top||a,this.height=s.height||i,this.bottom=s.bottom||a+(s.height||i),this.width=s.width||o,this.lineHeight=null!==r?r:s.lineHeight,this.singleLineHeight=null!==n?n:s.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}}t.BoxPosition=BoxPosition;class WebVTTRenderer{initSubtitleCSS(){const e=[new lt.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?st.default.parseContent(this.window,e,this.globalStyleCollection,this.loggingEnabled):null}setStyles(e){function applyStyles(e,t,r){for(const n in t)t.hasOwnProperty(n)&&(!0===r&&void 0!==e[n]||!1===r)&&(e[n]=t[n])}for(const t in e){let r=!1,n=null;"::cue"===t?(n=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===t&&(n=this.backgroundStyleOptions,r=!0);const o=e[t];if(!0===r)applyStyles(n,o,r);else for(let e=0;e<i.length;e++){const n=i[e].exec(t);if(n&&4===n.length){const e=n[2],t={};applyStyles(t,o,r),this.globalStyleCollection[e]=t}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1}(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],r=BoxPosition.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=function(e){const t=[];let r=0;for(let n=0;n<e.length;n++){let i=e[n];if("number"!=typeof i.line)return e;r+=i.line,t.push(i)}return r/=e.length,r>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t}(e));for(let n=0;n<e.length;n++){let i=e[n],o=new CueStyleBox(this.window,i,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection,this.loggingEnabled);this.paddedOverlay.appendChild(o.div),BoxPosition.moveBoxToLinePosition(o,r,t),i.displayState=o.div,t.push(BoxPosition.getSimpleBoxPosition(o))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}constructor(e,t,r=!1){if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=r,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const n=e.document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.right="0",n.style.top="0",n.style.bottom="0",n.style.margin="1.5%",this.paddedOverlay=n,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}}t.default=WebVTTRenderer,t.WebVTTRenderer=WebVTTRenderer,n(dt,t)}));unwrapExports(pt),pt.VTTCue,pt.WebVTTRenderer,pt.BoxPosition,pt.CueStyleBox,pt.StyleBox;var ht=createCommonjsModule((function(e,t){var r=ot&&ot.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=ot&&ot.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(ut,t),n(pt,t)}));unwrapExports(ht);var yt=ht.WebVTTRenderer;function isTextTrackID3FrameCue(e){return null!=e&&"string"==typeof e.id&&void 0!==e.value&&"string"==typeof e.value.key}const ft={[w.clearkey]:"",[w.widevine]:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",[w.playready]:"com.microsoft.playready",[w.fairplay]:"com.apple.streamingkeydelivery"};function _define_property$1t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const{textTracksSwitched:_t,textTracksUpdated:vt,inlineStylesParsed:mt}=et;class TextTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>"showing"===e.mode)}set currentTrack(e){if(!e)return;let t;saveTrack("mk-text-track",e),fe.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`),this.extensionTracks?(fe.debug("MEDIA_TRACK Setting track on extension "+e.label),"Off"===e.label?(this.clearCurrentlyPlayingTrack(),t=this.extensionTracks.forcedTextTrackForCurrentAudioTrack,this.extensionTracks.textTrack=t||void 0):this.extensionTracks.textTrack=e):(fe.debug("MEDIA_TRACK Setting track on element "+e.label),this._tracks.forEach(t=>{t!==e&&"showing"===t.mode&&(t.mode="disabled")}),e&&(fe.debug("MEDIA_TRACK setting track mode to showing for "+e.label),this.isTrackOff(e)?(this._tracks[0].mode="showing",t=this.selectNativeForcedTrack(this.mediaElement.audioTracks)):e.mode="showing")),this.dispatcher.publish(Be.forcedTextTrackChanged,t)}get tracks(){return this._tracks}destroy(){if(this._isDestroyed=!0,this.clearCurrentlyPlayingTrack(),this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(vt,this.onExtensionTextTracksUpdated),e.removeEventListener(_t,this.onExtensionTextTrackSwitched),e.removeEventListener(mt,this.onExtensionInlineStylesParsed)}else this.mediaElement.textTracks.removeEventListener("addtrack",this.onTextTrackAdded),this.mediaElement.textTracks.removeEventListener("change",this.onTextTrackChanged),this.mediaElement.textTracks.removeEventListener("removetrack",this.onTextTrackRemoved),this.mediaElement.removeEventListener("playing",this.onPlayStart);this.dispatcher.unsubscribe(Be.audioTrackChanged,this.onAudioTrackAddedOrChanged),this.dispatcher.unsubscribe(Be.audioTrackAdded,this.onAudioTrackAddedOrChanged)}restoreSelectedTrack(){const e=this.getValidSavedTrack();e&&(fe.debug("Found track matching persisted track: "+e.label),this.currentTrack=e)}getSavedTrack(){return loadTrack("mk-text-track")}getValidSavedTrack(){const e=this.getSavedTrack();if(e)return this.tracks.find(t=>trackEquals(t,e))}onExtensionInlineStylesParsed(e){var t;fe.debug("MEDIA_TRACK Extension inline styles parsed",e),null===(t=this.renderer)||void 0===t||t.setStyles(e.styles)}onExtensionTextTracksUpdated(e){fe.debug("MEDIA_TRACK Extension text tracks updated",e),this._tracks=[this.createOffOption(),...e],this.restoreSelectedTrack(),this.dispatcher.publish(Be.textTrackAdded,e)}onExtensionTextTrackSwitched(e){fe.debug("MEDIA_TRACKS Extension text track switched",e),this.handleVTT(e);const t=e.track;if(this._tracks){const updateTrackState=r=>{e.track?t.forced&&"Off"===r.label||"Off"===t.label&&"Off"===r.label?r.mode="showing":r.mode=t.persistentID===r.id?"showing":"disabled":r.mode="Off"===r.label?"showing":"disabled"};this._tracks.forEach(updateTrackState)}this.dispatcher.publish(Be.textTrackChanged,e)}handleVTT(e){var t;const r=null==e||null===(t=e.track)||void 0===t?void 0:t.id;if(void 0!==r&&r>=0){const e=this.filterSelectableTextTracks(this.mediaElement.textTracks)[r];this.onNativeTrackChange(e)}else this.clearCurrentlyPlayingTrack()}onAudioTrackAddedOrChanged(){if(fe.debug("MEDIA_TRACKS text track manager detects audio track change"),this.shouldForceSubtitle())if(this.extensionTracks){fe.debug("MEDIA_TRACKS selecting forced text track via extension");const e=this.extensionTracks.forcedTextTrackForCurrentAudioTrack;e?(fe.debug("MEDIA_TRACKS forced track found:",e),this.extensionTracks.textTrack=e,this.dispatcher.publish(Be.forcedTextTrackChanged,e)):this.clearCurrentlyPlayingTrack()}else fe.debug("MEDIA_TRACKS selecting forced text track natively"),this.currentTrack=this._tracks[0];else fe.debug("MEDIA_TRACKS valid persisted track found. Not displaying forced text track")}onTextTrackAdded(e){this._tracks.push(e.track),this.dispatcher.publish(Be.textTrackAdded,e)}onPlayStart(){this.restoreSelectedTrack()}onTextTrackRemoved(e){this.dispatcher.publish(Be.textTrackRemoved,e)}onTextTrackChanged(e){const t=this.findNativeSelectedTextTrack();let r=this.getSavedTrack();if(r||(r=this._tracks[0]),t&&!trackEquals(t,r))if(this.isTrackOff(r)&&"forced"!==t.kind){const e=this.tracks.find(e=>trackEquals(e,r));this.currentTrack=e}else{const e=this.findNativeTrack(r);e&&(this.currentTrack=e)}else this.dispatcher.publish(Be.textTrackChanged,e)}findNativeSelectedTextTrack(){for(let e=0;e<this.mediaElement.textTracks.length;e++){const t=this.mediaElement.textTracks[e];if("showing"===t.mode)return t}}findNativeTrack(e){for(let t=0;t<this.mediaElement.textTracks.length;t++){const r=this.mediaElement.textTracks[t];if(trackEquals(r,e))return r}}selectNativeForcedTrack(e){for(let t=0;t<e.length;t++){const r=e[t];if(r.enabled){const e=this.findNativeForcedTrack(r);return e&&"showing"!==e.mode&&(e.mode="showing"),e}}}findNativeForcedTrack(e){const t=this.mediaElement.textTracks;for(let r=0;r<t.length;r++){const n=t[r];if("forced"===n.kind&&n.language===e.language)return n}}onNativeTrackChange(e){this.clearCurrentlyPlayingTrack(),this._currentlyPlayingTrack=e,e.addEventListener("cuechange",this.onCueChange)}clearCurrentlyPlayingTrack(){var e;void 0!==this._currentlyPlayingTrack&&function(e){return null!=e&&"string"==typeof e.id&&"removeEventListener"in e}(this._currentlyPlayingTrack)&&(this._currentlyPlayingTrack.removeEventListener("cuechange",this.onCueChange),null===(e=this.renderer)||void 0===e||e.processCues({}),delete this._currentlyPlayingTrack)}onCueChange(e){const t=e&&e.target&&e.target.activeCues;var r;t&&(null===(r=this.renderer)||void 0===r||r.processCues(t))}filterSelectableTextTracks(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r];("captions"===n.kind||"subtitles"===n.kind||"metadata"===n.kind&&n.customTextTrackCueRenderer)&&t.push(n)}return t}shouldForceSubtitle(){fe.debug("MEDIA_TRACKS Determining whether to select forced text track");const e=this.getValidSavedTrack();return!e||this.isTrackOff(e)}createOffOption(){const e=this.getValidSavedTrack();return{id:-2,label:"Off",language:"",kind:"subtitles",mode:!e||this.isTrackOff(e)?"showing":"disabled"}}isTrackOff(e){return"Off"===e.label||"Auto"===e.label}constructor(e,t,r){if(_define_property$1t(this,"mediaElement",void 0),_define_property$1t(this,"dispatcher",void 0),_define_property$1t(this,"extensionTracks",void 0),_define_property$1t(this,"_tracks",void 0),_define_property$1t(this,"renderer",void 0),_define_property$1t(this,"_currentlyPlayingTrack",void 0),_define_property$1t(this,"_isDestroyed",void 0),this.mediaElement=e,this.dispatcher=t,this.extensionTracks=r,this._tracks=[],this._isDestroyed=!1,this._tracks.push(this.createOffOption()),this.extensionTracks){fe.debug("MEDIA_TRACK Initializing text track manager for HLS.js track events");const t=e.parentElement;this.renderer=new yt(window,t,!1),this.renderer.setStyles({"::cue":{fontSize:"calc(1vw + 1em)"}}),this.onExtensionTextTracksUpdated=this.onExtensionTextTracksUpdated.bind(this),this.onExtensionTextTrackSwitched=this.onExtensionTextTrackSwitched.bind(this),this.onExtensionInlineStylesParsed=this.onExtensionInlineStylesParsed.bind(this),this.onCueChange=this.onCueChange.bind(this);const r=this.extensionTracks;r.addEventListener(vt,this.onExtensionTextTracksUpdated),r.addEventListener(_t,this.onExtensionTextTrackSwitched),r.addEventListener(mt,this.onExtensionInlineStylesParsed)}else fe.debug("MEDIA_TRACK Initializing text track manager for native track events"),this.onTextTrackAdded=this.onTextTrackAdded.bind(this),this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.onTextTrackRemoved=this.onTextTrackRemoved.bind(this),this.onPlayStart=this.onPlayStart.bind(this),e.textTracks.addEventListener("addtrack",this.onTextTrackAdded),e.textTracks.addEventListener("change",this.onTextTrackChanged),e.textTracks.addEventListener("removetrack",this.onTextTrackRemoved),e.addEventListener("playing",this.onPlayStart);this.onAudioTrackAddedOrChanged=debounce(this.onAudioTrackAddedOrChanged.bind(this)),t.subscribe(Be.audioTrackChanged,this.onAudioTrackAddedOrChanged),t.subscribe(Be.audioTrackAdded,this.onAudioTrackAddedOrChanged)}}function asyncGeneratorStep$11(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$11(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$11(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$11(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$p(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const gt={"picture-in-picture":ye.pictureinpicture,inline:ye.inline},bt={};bt[ye.pictureinpicture]="picture-in-picture",bt[ye.inline]="inline";const{presentationModeDidChange:St}=Be,{playbackLicenseError:Pt}=et;class VideoPlayer extends BasePlayer{get audioTracks(){var e,t;return null!==(t=null===(e=this.audioTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==t?t:[]}get containerElement(){return this._context.videoContainerElement?this._context.videoContainerElement:document.getElementById("apple-music-video-container")}get currentAudioTrack(){var e;return null===(e=this.audioTrackManager)||void 0===e?void 0:e.currentTrack}set currentAudioTrack(e){void 0!==this.audioTrackManager&&(this.audioTrackManager.currentTrack=e)}get currentTextTrack(){var e;return null===(e=this.textTrackManager)||void 0===e?void 0:e.currentTrack}set currentTextTrack(e){void 0!==this.textTrackManager&&(this.textTrackManager.currentTrack=e)}get _targetElement(){return this.video||function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1s(e,t,r[t])}))}return e}({},document.createElement("video"))}get textTracks(){var e,t;return null!==(t=null===(e=this.textTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==t?t:[]}initializeExtension(){var e=this;return _async_to_generator$11((function*(){const{os:t}=e.services.runtime;e.restrictPlatforms&&t.isAndroid?fe.warn("videoPlayer.initializeExtension Not supported on the current platform"):e.video||fe.warn("videoPlayer.initializeExtension No video element, not initializing extension")}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(Pt,e)}setupTrackManagers(e){var t,r,n,i;null===(r=this.textTrackManager)||void 0===r||null===(t=r.destroy)||void 0===t||t.call(r),this.textTrackManager=new TextTrackManager(this._targetElement,this._dispatcher,e),null===(i=this.audioTrackManager)||void 0===i||null===(n=i.destroy)||void 0===n||n.call(i),this.audioTrackManager=new AudioTrackManager(this._targetElement,this._dispatcher,e)}destroy(){var e,t;this.finishPlaybackSequence(),null===(e=this.textTrackManager)||void 0===e||e.destroy(),null===(t=this.audioTrackManager)||void 0===t||t.destroy(),super.destroy()}initializeEventHandlers(){var e=this,_superprop_get_initializeEventHandlers=()=>super.initializeEventHandlers;return _async_to_generator$11((function*(){_superprop_get_initializeEventHandlers().call(e),e.hasMediaElement&&(e._targetElement.addEventListener("webkitpresentationmodechanged",e.pipEventHandler),e._targetElement.addEventListener("enterpictureinpicture",e.pipEventHandler),e._targetElement.addEventListener("leavepictureinpicture",e.pipEventHandler))}))()}removeEventHandlers(){if(super.removeEventHandlers(),!this.hasMediaElement)return;const{_targetElement:e}=this;e.removeEventListener("webkitpresentationmodechanged",this.pipEventHandler),e.removeEventListener("enterpictureinpicture",this.pipEventHandler),e.removeEventListener("leavepictureinpicture",this.pipEventHandler)}initializeMediaElement(){var e=this;return _async_to_generator$11((function*(){fe.debug("videoPlayer.initializeMediaElement Initializing media element");const t=e.containerElement;if(!t)throw new MKUniqueError("mk-117",MKUniqueError.Reason.CONFIGURATION_ERROR,"No container element found");e.video=function(){let e=nt.pop();return e?fe.debug(`dom-helpers: retrieving video tag, ${nt.length} remain`):(fe.debug("dom-helpers: no available video tags, creating one"),e=document.createElement("video")),e}(),e.video.autoplay=!1,e.video.controls=!1,e.video.playsInline=!0,e.video.id="apple-music-video-player",t.appendChild(e.video)}))()}ensureMediaElementInDocument(){this.containerElement?this.video?this.containerElement.appendChild(this.video):fe.warn("videoPlayer.addMediaElementToDocument - media element has not been initialized"):fe.warn("videoPlayer.addMediaElementToDocument No container defined")}pipEventHandler(e){switch(e.type){case"enterpictureinpicture":this._dispatcher.publish(St,{mode:ye.pictureinpicture});break;case"leavepictureinpicture":this._dispatcher.publish(St,{mode:ye.inline});break;case"webkitpresentationmodechanged":{const e=this._targetElement;this._dispatcher.publish(St,{mode:this._translateStringToPresentationMode(e.webkitPresentationMode)});break}}}playItemFromEncryptedSource(e,t=!1,r={}){var n=this;return _async_to_generator$11((function*(){fe.debug("videoPlayer.playItemFromEncryptedSource",e,t),e.playbackType=h.encryptedFull,n.nowPlayingItem=e,e.state=y.loading,n.userInitiated=t;const i=generateAssetUrl(e,r);yield n.playHlsStream(i,e,r)}))()}playItemFromUnencryptedSource(e,t,r){var n=this;return _async_to_generator$11((function*(){fe.debug("videoPlayer.playItemFromUnencryptedSource",e,t);const[r]=e.split("?");r.endsWith("m3u")||r.endsWith("m3u8")?yield n.playHlsStream(e):yield n._playAssetURL(e,t)}))()}setPresentationMode(e){var t=this;return _async_to_generator$11((function*(){const r=t._targetElement;if(r.webkitSupportsPresentationMode&&"function"==typeof r.webkitSetPresentationMode)return r.webkitSetPresentationMode(t._translatePresentationModeToString(e));if(r.requestPictureInPicture&&document.exitPictureInPicture){if(e===ye.pictureinpicture)return r.requestPictureInPicture();if(e===ye.inline)return document.exitPictureInPicture()}}))()}_translateStringToPresentationMode(e){let t=gt[e];return void 0===t&&(fe.warn(`videoPlayer._translateStringToPresentationMode ${e} is not a valid presentation mode, setting to inline`),t=ye.inline),t}_translatePresentationModeToString(e){let t=bt[e];return void 0===t&&(fe.warn(`videoPlayer._translatePresentationModeToString ${e} is not a valid presentation mode, setting to inline`),t="inline"),t}preloadItem(e,t){return _async_to_generator$11((function*(){}))()}constructor(e){var t,r;(super(e),_define_property$1s(this,"extension",void 0),_define_property$1s(this,"video",void 0),_define_property$1s(this,"mediaPlayerType","video"),_define_property$1s(this,"restrictPlatforms",void 0),_define_property$1s(this,"textTrackManager",void 0),_define_property$1s(this,"audioTrackManager",void 0),_define_property$1s(this,"userInitiated",!1),this.pipEventHandler=this.pipEventHandler.bind(this),this.restrictPlatforms=!0,void 0!==(null===(t=e.bag)||void 0===t?void 0:t.features))&&(this.restrictPlatforms=null===(r=e.bag.features.restrictPlatforms)||void 0===r||r)}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[void 0]),_ts_metadata$p("design:returntype",void 0)],VideoPlayer.prototype,"onPlaybackLicenseError",null);const decayingOperation=(e,t,r,n=0)=>e().catch(i=>{const o=n+1;function possiblyRetry(n){if(n&&o<3){const n=1e3*o;return new Promise((i,a)=>{setTimeout(()=>{decayingOperation(e,t,r,o).then(i,a)},n)})}throw i}const a=t(i);return"boolean"==typeof a?possiblyRetry(a):a.then(possiblyRetry)});let kt={developerToken:"developerTokenNotSet",musicUserToken:"musicUserTokenNotSet",cid:"cidNotSet"};function asyncGeneratorStep$10(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$10(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$10(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$10(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$B(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1r(e,t,r[t])}))}return e}function _object_spread_props$n(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function createHlsOffersLicenseChallengeBody(e){return{"adam-id":e.id,id:1}}function createStreamingKeysLicenseChallengeBody(e,t,r=0){var n;return _object_spread$B({id:r,"lease-action":t},null!==(n=e.keyServerQueryParameters)&&void 0!==n?n:{})}function createLicenseChallengeBody(e,t,r){let n,i={challenge:"challenge"in r?r.challenge:l(r.licenseChallenge),uri:r.keyuri,"key-system":r.keySystem,stkn:r.slotToken};return r.extendedLease&&(i["extended-lease"]=r.extendedLease),i=function(e,t){const r={};for(const n of t)n in e&&void 0!==e[n]&&(r[n]=e[n]);return r}(i,Object.keys(i)),n=t.isUTS?{"streaming-request":{version:1,"streaming-keys":[_object_spread$B({},i,createStreamingKeysLicenseChallengeBody(t,e))]}}:t.isLiveRadioStation?_object_spread$B({},i,function(e){return{event:e.isLiveAudioStation?"beats1":"amtv"}}(t)):t.hasOffersHlsUrl?{"license-requests":[_object_spread$B({},i,createHlsOffersLicenseChallengeBody(t))]}:_object_spread$B({},i,function(e,t=!1){var r;return{adamId:null!==(r=e.catalogId)&&void 0!==r?r:"-1",isLibrary:e.isLibrary,"user-initiated":t}}(t,r.userInitiated)),n}class License{fetch(e){const t={Authorization:"Bearer "+kt.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+kt.musicUserToken};this.keySystem===w.widevine&&(t["X-Apple-Renewal"]=!0);return decayingOperation(()=>(fe.debug("Fetching License challenge from "+this.licenseUrl,{headers:t,body:e}),fetch(this.licenseUrl,{method:"POST",body:JSON.stringify(e),headers:new Headers(t)})),e=>e instanceof TypeError,"license fetch")}reset(){fe.debug("Resetting License instance"),this.licenseUrl=void 0,this.playableItem=void 0,this.licenseData=void 0,this.initiated=void 0,this.keySystem=void 0,this.slotToken=void 0,this.startResponse=void 0}start(e,t,r,n,i=!1,o=!1){var a=this;return _async_to_generator$10((function*(){a.licenseUrl=e,a.playableItem=t,a.licenseData=r,a.keySystem=n,a.initiated=i,fe.debug(`Starting License request to ${a.licenseUrl} with URI ${a.licenseData.keyuri} for ${mediaItemLogString(a.playableItem)}`);const s=createLicenseChallengeBody("start",t,_object_spread_props$n(_object_spread$B({},r),{keySystem:n,extendedLease:o,userInitiated:i}));a.startResponse=a.fetch(s);try{var l,c,d;const e=yield a.startResponse;if(!e.ok){let t;try{t=yield e.json()}catch(u){}a.processJsonError(t)}fe.debug("Processing License Challenge reponse as JSON");const t=yield e.json();let r=t;return(null==t||null===(c=t["streaming-response"])||void 0===c||null===(l=c["streaming-keys"])||void 0===l?void 0:l.length)?r=t["streaming-response"]["streaming-keys"][0]:(null==t||null===(d=t["license-responses"])||void 0===d?void 0:d.length)&&(r=t["license-responses"][0]),0!==r.status&&a.processJsonError(r),a.slotToken=r.stkn,r}catch(xe){throw fe.error(`License Challenge Request failed to ${a.licenseUrl} with URI ${a.licenseData.keyuri} for ${mediaItemLogString(a.playableItem)}`),a.startResponse=void 0,xe}}))()}processJsonError(e){if((null==e?void 0:e.errorCode)&&(e.status=e.errorCode),-1021===(null==e?void 0:e.status)&&(e.status=190121),e&&0!==e.status){if(void 0===e.message)switch(e.status){case-1004:e.message=MKError.Reason.DEVICE_LIMIT;break;case-1017:e.message=MKError.Reason.GEO_BLOCK;break;default:e.message=MKError.Reason.MEDIA_LICENSE}throw new MKServerDialogError(e)}throw new MKError(MKError.Reason.MEDIA_LICENSE,"Error acquiring license")}stop(){var e=this;return _async_to_generator$10((function*(){if(e.startResponse)try{yield e.startResponse}catch(xe){}if(!e.playableItem||!e.licenseData||!e.licenseUrl)return;if(!e.playableItem.isUTS)return;const t=createLicenseChallengeBody("stop",e.playableItem,_object_spread_props$n(_object_spread$B({},e.licenseData),{keySystem:e.keySystem,slotToken:e.slotToken,userInitiated:e.initiated})),r=e.fetch(t);e.reset();try{yield r}catch(xe){fe.warn("license.stop request error",xe)}}))()}constructor(){_define_property$1r(this,"licenseUrl",void 0),_define_property$1r(this,"playableItem",void 0),_define_property$1r(this,"licenseData",void 0),_define_property$1r(this,"initiated",void 0),_define_property$1r(this,"keySystem",void 0),_define_property$1r(this,"slotToken",void 0),_define_property$1r(this,"startResponse",void 0)}}function asyncGeneratorStep$$(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$$(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$$(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$$(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class KeySession extends Notifications{get extID(){if(this.extURI)return this.extURI.replace("data:;base64,","")}get isFairplay(){return this.keySystem===w.fairplay}get isPlayReady(){return this.keySystem===w.playready}get isWidevine(){return this.keySystem===w.widevine}acquirePlaybackLicense(e,t,r){var n=this;return _async_to_generator$$((function*(){if(!n.keyServerURL||!n.developerToken||!n.userToken)return;const{initiated:i,isLegacyEme:o,keyServerURL:a,keySystem:s}=n,l=r.item;try{return yield n.license.start(a,l,{challenge:t,keyuri:e},s,i,o&&l.isUTS)}catch(c){n.dispatchEvent(et.playbackLicenseError,c)}}))()}startLicenseSession(e){var t=this;return _async_to_generator$$((function*(){let r;fe.debug("Starting License Session",e);const{message:n,target:i,messageType:o}=e;if(t.keySystem!==w.fairplay&&"license-request"!==o)return void fe.debug("not making license request for",o);if(t.isPlayReady){const e=String.fromCharCode.apply(null,new Uint16Array(n.buffer||n));r=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue}else r=l(new Uint8Array(n));const a=i.extURI||t.extURI,s=t.mediaKeySessions[a];if(!s)return void fe.debug("no key session info, aborting license request");const c=t.acquirePlaybackLicense(a,r,s);if(s.delayCdmUpdate)s["license-json"]=c;else{const e=yield c;yield t.handleLicenseJson(e,i,a)}}))()}setKeyURLs(e){this.keyCertURL=e[this.isFairplay?"hls-key-cert-url":"widevine-cert-url"],this.keyServerURL=e["hls-key-server-url"]}dispatchKeyError(e){var t,r;this.isFairplay&&4294955417===(null==e||null===(r=e.target)||void 0===r||null===(t=r.error)||void 0===t?void 0:t.systemCode)?fe.error("Ignoring error",e):(console.error(MKError.Reason.MEDIA_KEY+" error in dispatchKeyError:",e),this.dispatchEvent(et.playbackSessionError,new MKError(MKError.Reason.MEDIA_KEY,e)))}dispatchSessionError(e){this.dispatchEvent(et.playbackSessionError,new MKError(MKError.Reason.MEDIA_SESSION,e))}loadCertificateBuffer(){var e=this;return _async_to_generator$$((function*(){if(!e.keyCertURL)return Promise.reject(new MKError(MKError.Reason.MEDIA_SESSION,"No certificate URL"));let t;try{t=yield fetch(`${e.keyCertURL}?t=${Date.now()}`)}catch(xe){throw e.dispatchKeyError(xe),xe}const r=yield t.arrayBuffer(),n=String.fromCharCode.apply(String,new Uint8Array(r));return/^\<\?xml/.test(n)?Promise.reject(new MKError(MKError.Reason.MEDIA_CERTIFICATE,"Invalid certificate.")):r}))()}handleSessionCreation(e){var t=this;return _async_to_generator$$((function*(){return t.createSession(e).catch(e=>{t.dispatchSessionError(e)})}))()}handleLicenseJson(e,t,r){var n=this;return _async_to_generator$$((function*(){if(fe.debug(`updating session ${r} with license response`,e),null==e?void 0:e.license){const r=o(e.license);try{yield t.update(r)}catch(i){fe.error("Failed to updated media keys",i),n.dispatchKeyError(i)}}}))()}addMediaKeySessionInfo(e,t,r,n=!1){const i=this.mediaKeySessions[e];i?(fe.debug(`keySession info exists for ${r.title}, making existing session ${i.session.sessionId} the old session`),i.oldSession=i.session,i.session=t):(fe.debug("creating key session info for "+r.title),this.mediaKeySessions[e]={session:t,item:r,delayCdmUpdate:n})}stopLicenseSession(){fe.info("key session sending license stop"),this.license.stop()}constructor(){super([et.playbackLicenseError,et.playbackSessionError]),_define_property$1q(this,"developerToken",void 0),_define_property$1q(this,"adamId",void 0),_define_property$1q(this,"userToken",void 0),_define_property$1q(this,"extURI",void 0),_define_property$1q(this,"item",void 0),_define_property$1q(this,"initiated",!0),_define_property$1q(this,"isLibrary",!1),_define_property$1q(this,"keyCertURL",void 0),_define_property$1q(this,"keyServerURL",void 0),_define_property$1q(this,"keySystem",w.fairplay),_define_property$1q(this,"isLegacyEme",!1),_define_property$1q(this,"boundDispatchKeyError",void 0),_define_property$1q(this,"boundDispatchSessionError",void 0),_define_property$1q(this,"boundHandleSessionCreation",void 0),_define_property$1q(this,"boundStartLicenseSession",void 0),_define_property$1q(this,"mediaKeySessions",{}),_define_property$1q(this,"_pendingRenewal",void 0),_define_property$1q(this,"license",void 0),this.boundDispatchKeyError=this.dispatchKeyError.bind(this),this.boundDispatchSessionError=this.dispatchSessionError.bind(this),this.boundHandleSessionCreation=this.handleSessionCreation.bind(this),this.boundStartLicenseSession=this.startLicenseSession.bind(this),this.license=new License}}function asyncGeneratorStep$_(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$_(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$_(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$_(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$n(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0]),_ts_metadata$o("design:returntype",Promise)],KeySession.prototype,"startLicenseSession",null);class FairplayEncryptedSession extends KeySession{attachMedia(e,t){var r=this;return _async_to_generator$_((function*(){r.keySystem=t.keySystem,r._keySystemAccess=t,e.addEventListener("encrypted",r.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation);const t=this._mediaKeySessions,r=this._mediaKeySessionRenewals;Object.values(t).forEach(e=>{e.removeEventListener("message",this.boundStartLicenseSession),asAsync(e.close())}),this._mediaKeySessions={},Object.values(r).forEach(e=>clearTimeout(e)),this._mediaKeySessionRenewals={}}createSession(e){var t=this;return _async_to_generator$_((function*(){fe.debug("fairplay eme:  createSession",e);const r=t._keySystemAccess;if(!r)return;const{initData:n,target:i,initDataType:o}=e;t._mediaKeysPromise||(t._mediaKeysPromise=new Promise(function(){var e=_async_to_generator$_((function*(e,n){const o=yield r.createMediaKeys();try{yield i.setMediaKeys(o),t._mediaKeys=o;const e=yield t.loadCertificateBuffer();yield o.setServerCertificate(e)}catch(xe){t.dispatchKeyError(xe),n(xe)}e(o)}));return function(t,r){return e.apply(this,arguments)}}()));const a=yield t._mediaKeysPromise,s=new Uint8Array(n),l=String.fromCharCode.apply(void 0,Array.from(s));if(t.mediaKeySessions[l])return void fe.error("fairplay eme: not creating new session for extURI",l);const c=a.createSession();fe.debug("fairplay eme: creating new key session for",l),t.addMediaKeySessionInfo(l,c,t.item),c.addEventListener("message",t.startFairplayLicenseSession),c.extURI=l,yield c.generateRequest(o,n),t._mediaKeySessions[c.sessionId]=c,fe.debug("fairplay eme: created session",c)}))()}startFairplayLicenseSession(e){var t=this;return _async_to_generator$_((function*(){const{message:r,target:n}=e,i=l(new Uint8Array(r)),o=n.extURI||t.extURI,a=t.mediaKeySessions[o];if(!a)return void fe.debug("fairplay eme: no key session info, aborting license request",o);const s=yield t.acquirePlaybackLicense(o,i,a);return t.handleLicenseJson(s,n,o)}))()}handleLicenseJson(e,t,r){var n=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$_((function*(){if(!e)return;const i=n.mediaKeySessions[r];if(!i)return void fe.debug("fairplay eme: media key session does not exist, not updating");const o=e["renew-after"];if(e.license&&o){fe.debug("fairplay eme: got renew after value",o,r);const e=n._mediaKeySessionRenewals,a=e[t.sessionId];a&&clearTimeout(a),e[t.sessionId]=setTimeout(()=>n._renewMediaKeySession(i,r),1e3*o)}yield _superprop_get_handleLicenseJson().call(n,e,t,r)}))()}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],fe.debug("fairplay eme: renewing session",e),e.session.update(a("renew"))}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$_((function*(){}))()}clearSessions(){return _async_to_generator$_((function*(){}))()}constructor(...e){super(...e),_define_property$1p(this,"_keySystemAccess",void 0),_define_property$1p(this,"_mediaKeysPromise",void 0),_define_property$1p(this,"_mediaKeySessions",{}),_define_property$1p(this,"_mediaKeySessionRenewals",{}),_define_property$1p(this,"_mediaKeys",void 0)}}function asyncGeneratorStep$Z(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$Z(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Z(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Z(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0]),_ts_metadata$n("design:returntype",Promise)],FairplayEncryptedSession.prototype,"startFairplayLicenseSession",null);const Tt=/^(?:.*)(skd:\/\/.+)$/i;class WebKitSession extends KeySession{get isDestroyed(){return this._isDestroyed}attachMedia(e,t){return this.target=e,e.addEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("webkitkeyerror",this.boundDispatchKeyError),e}detachMedia(e){e&&(e.removeEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("webkitkeyerror",this.boundDispatchKeyError))}destroy(){fe.debug("FPS destroy"),this._isDestroyed=!0,this.detachMedia(this.target),this.session&&(this.session.removeEventListener("webkitkeyerror",this.boundDispatchKeyError),this.session.removeEventListener("webkitkeymessage",this.boundStartLicenseSession))}createSession(e){fe.debug("FPS createSession",e);const{initData:t,target:r}=e,{item:n}=this;if(!n)return fe.error("Cannot createSession without item"),Promise.resolve();const i=this._extractAssetId(t);if(fe.debug("extURI",i),!r.webkitKeys&&window.WebKitMediaKeys){const e=new window.WebKitMediaKeys(this.keySystem);r.webkitSetMediaKeys(e)}return this.loadCertificateBuffer().then(e=>{const o=this._concatInitDataIdAndCertificate(t,i,e),a="VIDEO"===r.tagName?tt.AVC1:tt.MP4,s=r.webkitKeys.createSession(a,o);this.addMediaKeySessionInfo(i,s,n),this.session=s,s.extURI=i,s.addEventListener("webkitkeyerror",this.boundDispatchKeyError),s.addEventListener("webkitkeymessage",this.boundStartLicenseSession)})}_extractAssetId(e){let t=String.fromCharCode.apply(null,new Uint16Array(e.buffer||e));const r=t.match(Tt);return r&&r.length>=2&&(t=r[1]),fe.debug("Extracted assetId from EXT-X-KEY URI",t),t}_concatInitDataIdAndCertificate(e,t,r){"string"==typeof t&&(t=s(t)),r=new Uint8Array(r);let n=0;const i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+r.byteLength),o=new DataView(i);new Uint8Array(i,n,e.byteLength).set(e),n+=e.byteLength,o.setUint32(n,t.byteLength,!0),n+=4;const a=new Uint8Array(i,n,t.byteLength);a.set(t),n+=a.byteLength,o.setUint32(n,r.byteLength,!0),n+=4;return new Uint8Array(i,n,r.byteLength).set(r),new Uint8Array(i,0,i.byteLength)}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$Z((function*(){}))()}clearSessions(){return _async_to_generator$Z((function*(){}))()}constructor(...e){super(...e),_define_property$1o(this,"target",void 0),_define_property$1o(this,"session",void 0),_define_property$1o(this,"_isDestroyed",!1),_define_property$1o(this,"isLegacyEme",!0)}}function asyncGeneratorStep$Y(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$Y(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Y(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Y(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class MSSession extends KeySession{attachMedia(e,t){return this.keySystem=t.keySystem,e.addEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("mskeyerror",this.boundDispatchKeyError),e}detachMedia(e){e.removeEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("mskeyerror",this.boundDispatchKeyError)}createSession(e){const{initData:t,target:r}=e;if(!r.msKeys){const e=new MSMediaKeys(this.keySystem);r.msSetMediaKeys(e)}const n=r.msKeys.createSession(tt.MP4,t);return n.addEventListener("mskeyerror",this.dispatchKeyError),n.addEventListener("mskeymessage",this.startLicenseSession.bind(this)),n}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$Y((function*(){}))()}clearSessions(){return _async_to_generator$Y((function*(){}))()}}const Et=[0,0,1,222,112,115,115,104,0,0,0,0,154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149,0,0,1,190],wt=[190,1,0,0,1,0,1,0,180,1];function concatenate(e,...t){let r=0;for(const o of t)r+=o.length;const n=new e(r);let i=0;for(const o of t)n.set(o,i),i+=o.length;return n}const It={[w.widevine]:e=>{fe.debug("generating Widevine pssh for keyId");const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(let r=0;r<e.length;r++)t[t.length-16+r]=e[r];return fe.debug("generatePSSH",t),t},[w.playready]:e=>{fe.debug("generating Playready pssh for keyId"),(e=>{const swap=(e,t,r)=>{const n=e[t];e[t]=e[r],e[r]=n};swap(e,0,3),swap(e,1,2),swap(e,4,5),swap(e,6,7)})(e);const t=l(e),r='<WRMHEADER xmlns="http://schemas.microsoft.com/DRM/2007/03/PlayReadyHeader" version="4.3.0.0"><DATA><PROTECTINFO><KIDS><KID ALGID="AESCTR" VALUE="[KEYID]"></KID></KIDS></PROTECTINFO></DATA></WRMHEADER>'.replace("[KEYID]",t),n=s(r),i=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return concatenate(Uint8Array,Et,wt,i)}};function asyncGeneratorStep$X(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$X(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$X(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$X(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PreloadingEncryptedSession extends KeySession{attachMedia(e,t){this.keySystem=t.keySystem,this._keySystemAccess=t,this._target=e}detachMedia(){asAsync(this.clearSessions())}createSession(e){return _async_to_generator$X((function*(){}))()}_mediaKeysSetup(){var e=this;return _async_to_generator$X((function*(){const t=e._keySystemAccess;t&&(e._mediaKeysPromise||(e._mediaKeysPromise=new Promise(function(){var r=_async_to_generator$X((function*(r,n){const i=yield t.createMediaKeys();try{var o;yield null===(o=e._target)||void 0===o?void 0:o.setMediaKeys(i),e._mediaKeys=i}catch(xe){e.dispatchKeyError(xe),n(xe)}if(e.isWidevine){const t=yield e.loadCertificateBuffer();yield i.setServerCertificate(t)}r(i)}));return function(e,t){return r.apply(this,arguments)}}())),yield e._mediaKeysPromise)}))()}createSessionAndGenerateRequest(e,t,r){var n=this;return _async_to_generator$X((function*(){var i;const o=!!(null==r?void 0:r.isRenewal),s=!!(null==r?void 0:r.delayCdmUpdate);if(!o&&n.mediaKeySessions[e])return;fe.debug(`createSessionAndGenerateRequest for item ${t.title}, isRenewal ${o}`);const c=null===(i=n._mediaKeys)||void 0===i?void 0:i.createSession(),{keySystem:d}=n;if(!c)return;n.addMediaKeySessionInfo(e,c,t,s);const u=e.includes("base64"),p=u?e.split(",")[1]:e,h=a(u?atob(p):p),y=n.isWidevine&&t.isSong||16===h.length;let f;var _;return fe.debug("extracted uri",e),n.isPlayReady&&!y?(fe.debug("handling Playready object"),c.extURI=e,_=h,f=concatenate(Uint8Array,new Uint8Array(Et),_)):y?(fe.debug("handling keyId only initData"),c.extURI="data:;base64,"+l(h),f=((e,t)=>{const r=It[t];if(!r)return fe.warn("No pssh generator for ",t),e;return r(Uint8Array.from(e))})(h,d)):(fe.debug("handling pssh initData"),c.extURI=e,f=h),c.addEventListener("message",n.startLicenseSession),c.generateRequest("cenc",f).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return c.generateRequest("cenc",f);throw e})}))()}handleLicenseJson(e,t,r){var n=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$X((function*(){var i;if(!e)return;const o=n.mediaKeySessions[r];if(!o)return void fe.debug("media key session does not exist, not updating");const a=e["renew-after"];if(e.license&&a){fe.debug("Got renew after value",a,r);const e=n._mediaKeySessionRenewals,i=e[t.sessionId];i&&clearTimeout(i),e[t.sessionId]=setTimeout(()=>n._renewMediaKeySession(o,r),1e3*a)}yield _superprop_get_handleLicenseJson().call(n,e,t,r);const s=null===(i=n.mediaKeySessions[r])||void 0===i?void 0:i.oldSession;s&&(fe.debug("removing old key session after updating",r),yield n._removeAndCloseSession(s),delete n.mediaKeySessions[r].oldSession,delete n._mediaKeySessionRenewals[s.sessionId])}))()}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],asAsync(this.createSessionAndGenerateRequest(t,e.item,{isRenewal:!0}))}applyDelayedCdmUpdates(){var e=this;return _async_to_generator$X((function*(){fe.debug("applying delayed CDM updates");const t=Object.entries(e.mediaKeySessions);for(const r of t){const[t,n]=r;if(n.delayCdmUpdate){const r=yield n["license-json"];fe.debug("delayed update of license",r),n.delayCdmUpdate=!1,yield e.handleLicenseJson(r,n.session,t)}}}))()}loadKeys(e,t,r){var n=this;return _async_to_generator$X((function*(){yield n._mediaKeysSetup();const i=n.filterKeyValues(e);for(const e of i){const{dataUri:i}=e;yield n.createSessionAndGenerateRequest(i,t,r)}if(null==t?void 0:t.isLiveAudioStation){const e=Object.keys(n.mediaKeySessions),t=i.reduce((e,t)=>(e[t.dataUri]=!0,e),{});for(const r of e)t[r]||(yield n._scheduleRemoveSession(r))}}))()}filterKeyValues(e){let t;if(1===e.length)t=e;else{const r=ft[this.keySystem];t=e.filter(e=>e.keyFormat===r)}return t}clearSessions(e){var t=this;return _async_to_generator$X((function*(){const r=t.mediaKeySessions;if(null==e?void 0:e.length){const r=t.filterKeyValues(e);for(const e of r){const r=e.dataUri;clearTimeout(t._sessionRemovalTimeouts[r]),yield t._removeSessionImmediately(r)}}else{Object.values(t._sessionRemovalTimeouts).forEach(e=>clearTimeout(e)),fe.debug("clearing key sessions",r);for(const e of Object.keys(r))yield t._removeSessionImmediately(e)}}))()}_scheduleRemoveSession(e){var t=this;return _async_to_generator$X((function*(){if(!t.mediaKeySessions[e])return void fe.warn("no session for dataUri, not scheduling remove",e);if(t._sessionRemovalTimeouts[e])return;const r=setTimeout(()=>{asAsync(t._removeSessionImmediately(e))},6e4);fe.debug("deferring removal of keysession for dataUri",e),t._sessionRemovalTimeouts[e]=r}))()}_removeSessionImmediately(e){var t=this;return _async_to_generator$X((function*(){const r=t.mediaKeySessions[e];if(!r)return void fe.warn("no session for dataUri, not removing",e);fe.debug("removing keysession for",e);const{session:n,oldSession:i}=r;t._clearSessionRenewal(n),delete t.mediaKeySessions[e],yield t._removeAndCloseSession(n),i&&(yield t._removeAndCloseSession(i))}))()}_removeAndCloseSession(e){var t=this;return _async_to_generator$X((function*(){e.removeEventListener("message",t.startLicenseSession),fe.debug("tearing down session",e.sessionId);try{yield e.remove()}catch(r){fe.warn("Error invoking session.remove()",r)}finally{try{yield e.close()}catch(r){fe.warn("Error invoking session.close()",r)}}}))()}_clearSessionRenewal(e){const t=this._mediaKeySessionRenewals[e.sessionId];t&&(fe.debug("clearing scheduled license renewal for session",e.sessionId),clearTimeout(t),delete this._mediaKeySessionRenewals[e.sessionId])}constructor(...e){super(...e),_define_property$1n(this,"_keySystemAccess",void 0),_define_property$1n(this,"_mediaKeysPromise",void 0),_define_property$1n(this,"_mediaKeys",void 0),_define_property$1n(this,"_target",void 0),_define_property$1n(this,"_sessionRemovalTimeouts",{}),_define_property$1n(this,"_mediaKeySessionRenewals",{})}}function asyncGeneratorStep$W(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$W(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$W(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$W(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const At=BooleanDevFlag.register("mk-safari-modern-eme");class MediaExtension extends Notifications{get runtime(){return this.services.runtime}get hasMediaSession(){return void 0!==this._session}get isFairplay(){return this._session.isFairplay}set extURI(e){this._session.extURI=e}set initiated(e){this._session.initiated=e}get session(){return this._session}clearSessions(e){var t=this;return _async_to_generator$W((function*(){var r;return null===(r=t.session)||void 0===r?void 0:r.clearSessions(e)}))()}initializeKeySystem(){var e=this;return _async_to_generator$W((function*(){var t,r;const{mediaElement:n,contentType:i}=e;if(null===(t=window.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported(w.fairplay+".1_0",tt.MP4)){let t;At.enabled&&e.runtime.isEMESupported&&(t=yield function(e){return _requestModernFairplayAccess.apply(this,arguments)}(e.contentType)),void 0!==t?(fe.warn("media-extension: Using Fairplay modern EME"),e._session=new FairplayEncryptedSession,e._session.attachMedia(n,t)):(fe.warn("media-extension: Using Fairplay legacy EME"),e._session=new WebKitSession,e._session.attachMedia(n,{keySystem:w.fairplay}))}else if(null===(r=window.MSMediaKeys)||void 0===r?void 0:r.isTypeSupported(w.playready,tt.MP4))e._session=new MSSession,e._session.attachMedia(n,{keySystem:w.playready});else if(void 0!==e.runtime.preferredKeySystem&&n.canPlayType(i)){const t=w[e.runtime.preferredKeySystem];if(void 0!==t){e._session=new PreloadingEncryptedSession;const r=yield getKeySystemAccess(t,{initDataTypes:["cenc","keyids"],audioCapabilities:[{contentType:i}],distinctiveIdentifier:"optional",persistentState:"required"});var o;if(r)null===(o=e._session)||void 0===o||o.attachMedia(n,r)}}else fe.warn("No KeySystem available for playback!");void 0!==e._session&&[et.playbackLicenseError,et.playbackSessionError].forEach(t=>{e._session.addEventListener(t,r=>{e.dispatchEvent(t,r)})})}))()}setMediaItem(e){!function(e,t){var r;t.keyURLs&&(e.developerToken=kt.developerToken,e.userToken=kt.musicUserToken,e.item=t,e.adamId=null!==(r=t.catalogId)&&void 0!==r?r:"-1",e.isLibrary=t.isLibrary,e.setKeyURLs(t.keyURLs))}(this._session,e)}destroy(e){var t;null===(t=this._session)||void 0===t||t.detachMedia(e)}constructor(e){super([et.playbackLicenseError,et.playbackSessionError]),_define_property$1m(this,"_session",void 0),_define_property$1m(this,"mediaElement",void 0),_define_property$1m(this,"contentType",void 0),_define_property$1m(this,"services",void 0),this.mediaElement=e.mediaElement,this.contentType=e.contentType,this.services=e.services}}function getKeySystemAccess(e,t){return _getKeySystemAccess.apply(this,arguments)}function _getKeySystemAccess(){return(_getKeySystemAccess=_async_to_generator$W((function*(e,t){try{return navigator.requestMediaKeySystemAccess(e,[t])}catch(xe){fe.warn("Unable to get KeySystem access to "+e)}}))).apply(this,arguments)}function _requestModernFairplayAccess(){return(_requestModernFairplayAccess=_async_to_generator$W((function*(e){return getKeySystemAccess(w.fairplay,{initDataTypes:["skd"],audioCapabilities:[{contentType:e,robustness:""}],videoCapabilities:[{contentType:e,robustness:""}],distinctiveIdentifier:"not-allowed",persistentState:"not-allowed",sessionTypes:["temporary"]})}))).apply(this,arguments)}const Ot=BooleanDevFlag.register("mk-force-audio-mse"),shouldForceAudioMse=()=>Ot.enabled;function asyncGeneratorStep$V(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ByteRangeSegment{load(){var e,t=this;return(e=function*(){const{url:e,range:r}=t;if(!e)return new Uint8Array;const n=new Headers;n.append("Range",r);const i=yield fetch(e,{headers:n}),o=yield i.arrayBuffer();return new Uint8Array(o)},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$V(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$V(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor({url:e,startByte:t,length:r,isInitSegment:n=!1}){_define_property$1l(this,"url",void 0),_define_property$1l(this,"range",void 0),_define_property$1l(this,"startByte",void 0),_define_property$1l(this,"endByte",void 0),_define_property$1l(this,"length",void 0),_define_property$1l(this,"startTime",void 0),_define_property$1l(this,"endTime",void 0),_define_property$1l(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=n,this.startByte=parseInt(t,10),this.length=parseInt(r,10),this.endByte=this.startByte+this.length-1,this.range=`bytes=${this.startByte}-${this.endByte}`}}function asyncGeneratorStep$U(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$1k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ContinuousSegment{load(){var e,t=this;return(e=function*(){const{url:e}=t;if(!e)return new Uint8Array;const r=yield fetch(e),n=yield r.arrayBuffer();return new Uint8Array(n)},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$U(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$U(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,t=!1){_define_property$1k(this,"url",void 0),_define_property$1k(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=t}}function _define_property$1j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Rt=/^#EXT-X-BYTERANGE:([^\n]+)\n/gim,$t=/^#EXT-X-MAP:([^\n]+)\n/im,Ct=/#EXTINF:\d*\.\d*\,[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,Mt=/#EXTINF:\d*\.\d*,\s*#EXT-X-BITRATE:\d{1,3}[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,Dt=fe.createChild("hls");class SegmentList{get segments(){return this._segments}addSegment(e,t){this._addedSegments[t]||(Dt.debug("Adding segment",t),this._segments.push(e),this._addedSegments[t]=!0)}extractLiveRadioSegments(e,t){this._extractContinuousSegments(Ct,e,t)}extractHlsOffersSegments(e,t){this._extractContinuousSegments(Mt,e,t)}_extractContinuousSegments(e,t,r){if(!t||!e.test(t))return;let n;for(e.lastIndex=0;n=e.exec(t);){const e=n[0].startsWith("#EXT-X-MAP")?n[2]:n[1];let t=e;/^http(s)?:\/\//.test(t)||(t=joinURLPath$1([...splitURLPath(r).slice(0,-1),e]));const i=n[0].startsWith("#EXT-X-MAP");this.addSegment(new ContinuousSegment(t,i),e)}}extractByteRangeSegments(e,t){if(!e||!Rt.test(e))return;const r=function(e){if(!e||!$t.test(e))return;const[,t]=e.match($t);return t.split(",").reduce((e,t)=>{const[r,n]=t.split("=");return e[r.toLowerCase()]=n.replace(/\"/gi,""),e},{})}(e);var n;const i=null!==(n=t.split("/").pop())&&void 0!==n?n:"",o=t.replace(i,r.uri),[a,s]=r.byterange.split("@"),l=new ByteRangeSegment({url:o,startByte:s,length:a});var c;this.addSegment(l,l.range),(null!==(c=e.match(Rt))&&void 0!==c?c:[]).forEach(e=>{const[,t,r]=e.match(/^#EXT-X-BYTERANGE:(\d+)@(\d+)\n/),n=new ByteRangeSegment({url:o,startByte:r,length:t});this.addSegment(n,n.range)})}constructor(){_define_property$1j(this,"_segments",[]),_define_property$1j(this,"_addedSegments",{})}}var xt=function(e){return e.keysParsed="keysParsed",e}({});function asyncGeneratorStep$T(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$T(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$T(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$T(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$m(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Lt=/^#EXT-X-TARGETDURATION:(\d+)/im,Nt=/^#EXT-X-KEY:[^\n]+URI="([^"]+)"/im,Ut=/^#EXT-X-KEY:.*(.*$)/gim;class Manifest extends Notifications{parse(){const e=this._item,t=this._data;if("fairplay"!==this.services.runtime.preferredKeySystem||shouldForceAudioMse())if(this._detectKeyTags(),e.hasOffersHlsUrl)this._segmentList.extractHlsOffersSegments(t,e.assetURL);else if(e.isLiveRadioStation){this._segmentList.extractLiveRadioSegments(t,e.assetURL);const[,r]=this._data.match(Lt);fe.debug(`manifest: setting up manifest refresh interval at ${r} seconds`);const n=1e3*parseInt(r,10);this._manifestRefreshInterval=setInterval(this.liveRadioRefresh,n)}else this._segmentList.extractByteRangeSegments(t,e.assetURL)}static load(e,t){var r=this;return _async_to_generator$T((function*(){fe.debug("loading manifest for item",e.title);const n=e.assetURL,i=getSessionStorage();var o;const a=!!i&&(null===(o=t.cache)||void 0===o||o),s=t.services;if(a){const t=null==i?void 0:i.getItem(n);if(t)return new r(t,e,{services:s})}const l=(new Date).getTime(),c=yield s.request.fetchText(n),d=(new Date).getTime(),u=new r(c,e,{services:s});return u.downlink=8*c.length/((d-l)/1e3)/1024,a&&(null==i||i.setItem(n,c)),u}))()}get downlink(){return this._downlink}set downlink(e){this._downlink=e}get mediaItem(){return this._item}liveRadioRefresh(){var e=this;return _async_to_generator$T((function*(){const t=yield e.services.request.fetchText(e._url);e._data=t,e._detectKeyTags(),e._segmentList.extractLiveRadioSegments(t,e._url),e.dispatchEvent(et.manifestParsed)}))()}segmentsForTimeRange(e){const t=Math.floor(e.start/10)+1,r=Math.floor(e.end/10)+1,{segments:n}=this;return[n[0],...n.slice(t,r+1)]}get segments(){return this._segmentList.segments}get extURI(){if(!this._extURI){const e=this._data.match(Nt);fe.debug("manifest: EXT_X_KEY_URI matches",e),this._extURI=e&&e[1]||void 0}return this._extURI}get keyValues(){let e=this._modernKeys;return e.length||(e=this._legacyKeys),e}_detectKeyTags(){const e=this.keyValues;e.length&&this.dispatchEvent(xt.keysParsed,{item:this.mediaItem,keys:e})}get _legacyKeys(){const e=this._data.match(Nt);fe.debug("manifest: EXT_X_KEY_URI matches",e);const t=e&&e[1]||void 0;this._extURI=t;const r=[];return t&&r.push({keyFormat:ft[w.widevine],dataUri:t}),r}get _modernKeys(){let e;const t=[];for(;e=Ut.exec(this._data);){var r,n;const a=e[0];var i;const s=null!==(i=null===(r=/KEYFORMAT="(.*?)"/.exec(a))||void 0===r?void 0:r[1])&&void 0!==i?i:"";var o;const l=null!==(o=null===(n=/URI="(.*?)"/.exec(a))||void 0===n?void 0:n[1])&&void 0!==o?o:"";s&&l&&t.push({keyFormat:s,dataUri:l})}return t}stop(){this._manifestRefreshInterval&&clearInterval(this._manifestRefreshInterval)}constructor(e,t,r){super([et.manifestParsed,xt.keysParsed]),_define_property$1i(this,"_data",void 0),_define_property$1i(this,"_downlink",0),_define_property$1i(this,"_extURI",void 0),_define_property$1i(this,"_url",void 0),_define_property$1i(this,"_item",void 0),_define_property$1i(this,"_segmentList",new SegmentList),_define_property$1i(this,"_manifestRefreshInterval",void 0),_define_property$1i(this,"services",void 0),this._data=e,this._item=t,this._url=t.assetURL,this.services=r.services}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$m("design:type",Function),_ts_metadata$m("design:paramtypes",[]),_ts_metadata$m("design:returntype",Promise)],Manifest.prototype,"liveRadioRefresh",null);const jt="seamlessAudioTransition",Kt="bufferTimedMetadataDidChange",Ft="loadSegmentError";function encodedArrayToString(e,t="utf-8"){return"iso-8859-1"===t?String.fromCharCode(...e):new TextDecoder(t).decode(e)}function readNullTerminatedString(e,t=0,r){const n=[];r=null!=r?r:e.length;for(let i=t;i<r;i++){const t=e[i];if("\0"===String.fromCharCode(t))break;n.push(String.fromCharCode(t))}return[n.join(""),n.length]}function _define_property$1h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class BaseMp4Box{get size(){return this.end-this.start}get rawBytes(){return this.data.slice(this.start,this.end)}constructor(e,t,r,n){_define_property$1h(this,"id",void 0),_define_property$1h(this,"data",void 0),_define_property$1h(this,"start",void 0),_define_property$1h(this,"end",void 0),this.id=e,this.data=t,this.start=r,this.end=n}}const Bt=[237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237];class PsshBox extends BaseMp4Box{get systemId(){const{data:e,start:t}=this,r=t+12;return e.slice(r,r+16)}get dataSize(){return this.view.getUint32(28)}get psshData(){const{data:e,start:t,dataSize:r}=this,n=t+32;return e.slice(n,n+r)}get keyBytes(){const{psshData:e}=this;return e.slice(2,18)}get isWidevine(){return arrayEquals(this.systemId,Bt)}constructor(e,t,r){super("pssh",e,t,r),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"view",void 0),this.view=new DataView(e.buffer,t)}}function _define_property$1f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TencBox extends BaseMp4Box{get isProtected(){const{data:e,start:t}=this;return e[t+14]}get defaultKeyId(){const{data:e,start:t}=this;return e.slice(t+16,t+32)}set defaultKeyId(e){const{data:t,start:r}=this;for(let n=0;n<e.length;n++)t[n+r+16]=e[n]}constructor(e,t,r){super("tenc",e,t,r),_define_property$1f(this,"data",void 0),_define_property$1f(this,"start",void 0),_define_property$1f(this,"end",void 0),this.data=e,this.start=t,this.end=r}}function findBox(e,t,r=[]){for(let n=t;n<e.length;){if(0===r.length)return;const t=new DataView(e.buffer,n).getUint32(0),i=encodedArrayToString(e.subarray(n+4,n+8)),o=n+t;if(1===r.length&&i===r[0])return new BaseMp4Box(i,e,n,o);if(i===r[0])return findBox(e,n+8,r.slice(1));n+=t}}const rewriteDefaultKid=e=>{const[t]=function(e){const t=findBox(e,0,["moov","trak","mdia","minf","stbl","stsd"]),r=[];if(!t)return r;for(let n=t.start+16;n<t.end;){let i=findBox(e,n,["enca"]),o=36;if(i||(i=findBox(e,n,["encv"]),o=86),!i)return r;const a=findBox(e,i.start+o,["sinf","schi","tenc"]);a?(r.push(new TencBox(a.data,a.start,a.end)),n=a.end):n=t.end}return r}(e);if(!t)return;const r=function(e){const t=findBox(e,0,["moov"]),r=[];if(!t)return r;const n=new DataView(e.buffer,0);for(let i=t.start+8;i<t.size;){const t=n.getUint32(i);"pssh"===encodedArrayToString(e.subarray(i+4,i+8))&&r.push(new PsshBox(e,i,i+t)),i+=t}return r}(e).find(e=>e.isWidevine);r&&(t.defaultKeyId=r.keyBytes)};function _define_property$1e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ID3Tag{get major(){return this.version[0]}get minor(){return this.version[1]}get revision(){var e;return null!==(e=this.version[2])&&void 0!==e?e:0}static parse(e){return function(e){if(0===e.length||"ID3"!==function(e,t=0){return decodeString(e.subarray(t,3))}(e))return;const t={};let r=3;t.version=[3,e[r++],e[r++]],t.flags=function(e,t=5){const r=e[t];return{unsynchronized:decodeBitFlag(r,7),extendedHeader:decodeBitFlag(r,6),experimental:decodeBitFlag(r,5),footer:decodeBitFlag(r,4)}}(e),r+=1;const n=r+4+decodeSynchSafeUint32(e.subarray(r,r+4));r+=4,t.flags.extendedHeader&&(r+=decodeSynchSafeUint32(e.subarray(r,r+4)));t.version[1]>2&&(t.frames=decodeID3Frames(e,t.version,[r,n]));return new ID3Tag(t)}(e)}constructor(e){var t;_define_property$1e(this,"version",[3,2,0]),_define_property$1e(this,"frames",[]),_define_property$1e(this,"flags",{unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1}),this.version=e.version,this.flags=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1e(e,t,r[t])}))}return e}({unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1},e.flags),this.frames=null!==(t=e.frames)&&void 0!==t?t:[]}}const Vt={WXXX:function(e,t,r){const n=decodeCharset(t[0]),[i,o]=decodeNullTerminatedString(t.subarray(1),n),a=o>0?o+2:0;return{key:"WXXX",data:decodeString(t.subarray(a),n),description:i}},TXXX:function(e,t,r){const n=decodeCharset(t[0]),[i,o]=decodeNullTerminatedString(t.subarray(1),n),a=o>0?o+2:0;return{key:"TXXX",data:decodeString(t.subarray(a),n),description:i}},TPE1:function(e,t,r){return{key:"TPE1",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TIT2:function(e,t,r){return{key:"TIT2",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TALB:function(e,t,r){return{key:"TALB",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TEXT:function(e,t,r){return{key:"TEXT",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},PRIV:function(e,t,r){const[n,i]=decodeNullTerminatedString(t);if(0===i)return;return{key:"PRIV",owner:n,data:t.slice(i+1)}},CHAP:function(e,t,r){const n=new DataView(t.buffer),i={key:"CHAP",elementId:"",startTime:0,endTime:0,frames:[]},[o,a]=decodeNullTerminatedString(t);i.elementId=o;let s=a+1;return i.startTime=n.getUint32(s),s+=4,i.endTime=n.getUint32(s),s+=4,i.startOffset=n.getUint32(s),s+=4,i.endOffset=n.getUint32(s),s+=4,i.frames=decodeID3Frames(t,r,[s,t.length]),i}};function decodeID3Frames(e,t,r){var n;const i=null!==(n=(r=null!=r?r:[0,e.byteLength])[1])&&void 0!==n?n:e.byteLength;var o;let a=null!==(o=r[0])&&void 0!==o?o:0;const s=new DataView(e.buffer,0,i),l=[];for(;a+8<=i;){var c;const r=decodeString(e.subarray(a,a+4));a+=4;const n=4===t[1]?decodeSynchSafeUint32(e.subarray(a,a+4)):s.getUint32(a);if(a+=4,e[a++],e[a++],a+n>i)break;const o=e.slice(a,a+n),d=null===(c=Vt[r])||void 0===c?void 0:c.call(Vt,r,o,t);d&&l.push(d),a+=n}return l}function decodeString(e,t="utf-8"){return new TextDecoder(t).decode(e)}function decodeBitFlag(e,t){return 0!=(e&1<<t)}const qt={0:"iso-8859-1",1:"utf-16",2:"utf-16be",3:"utf-8"};function decodeCharset(e){var t;return null!==(t=qt[e])&&void 0!==t?t:"iso-8859-1"}function trimNull(e){return e.replace(/^\0*|\0*/g,"")}function decodeNullTerminatedString(e,t="utf-8",r=0){const n=[];for(let i=r;i<e.byteLength;i++){const t=e[i];if(0===t)break;n.push(t)}return[decodeString(new Uint8Array(n),t),n.length]}function decodeSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}function checkBoxName(e,t,r){return!(t+4>e.length)&&(e[t]===r[0]&&e[t+1]===r[1]&&e[t+2]===r[2]&&e[t+3]===r[3])}function findEmsgs(e){const t=e.length,r=[];if(function(e){return(null==e?void 0:e.length)>=8&&checkBoxName(e,4,[102,116,121,112])}(e))return r;for(let n=0;n<t;n++){if(checkBoxName(e,n,[109,111,111,102]))return r;if(checkBoxName(e,n,[101,109,115,103])){const t=n-4,i=new DataView(e.buffer,t).getUint32(0),o=e.subarray(t,t+i);n=n+i-1,r.push(o)}}return r}function _define_property$1d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TimedMetadata{storefrontAdamId(e){var t;return null===(t=this.storefrontAdamIds)||void 0===t?void 0:t[e]}equals(e){return function(e,t){var r,n,i,o;if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;if(t=t,(e=e).album!==t.album||e.title!==t.title||e.performer!==t.performer)return!1;if((null===(r=e.links)||void 0===r?void 0:r.length)!==(null===(n=t.links)||void 0===n?void 0:n.length))return!1;for(let l=0;l<(null!==(o=null===(i=e.links)||void 0===i?void 0:i.length)&&void 0!==o?o:0);l++){var a,s;if(!objectKeyValueEquals(null===(a=e.links)||void 0===a?void 0:a[l],null===(s=t.links)||void 0===s?void 0:s[l]))return!1}if(!objectKeyValueEquals(e.storefrontAdamIds,t.storefrontAdamIds))return!1;if(!function(e,t){if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;if(t=t,(e=e).byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}(e.blob,t.blob))return!1;return!0}(this,e)}constructor(e){var t;_define_property$1d(this,"performer",void 0),_define_property$1d(this,"title",void 0),_define_property$1d(this,"album",void 0),_define_property$1d(this,"links",void 0),_define_property$1d(this,"storefrontAdamIds",void 0),_define_property$1d(this,"blob",void 0),this.performer=null==e?void 0:e.performer,this.title=null==e?void 0:e.title,this.album=null==e?void 0:e.album,this.links=null==e?void 0:e.links,this.storefrontAdamIds=null!==(t=null==e?void 0:e.storefrontAdamIds)&&void 0!==t?t:{},this.blob=null==e?void 0:e.blob}}function objectKeyValueEquals(e,t){if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;e=e,t=t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const i of r)if(e[i]!==t[i])return!1;return!0}function parseStorefrontAdamIds(e){let t;t="Uint8Array"===e.constructor.name?new TextDecoder("utf-8").decode(e):e;const r=t.trim().split(",");if(0===r.length)return;const isEmptyString=e=>void 0===e||""===e,n={};for(const i of r){const[e,t]=i.split(":",2).map(e=>e.trim());isEmptyString(e)||isEmptyString(t)||"0"===t||void 0!==n[e]||(n[e]=t)}return n}function parsePingBlob(e){return"string"==typeof e?Uint8Array.from(atob(e),e=>e.charCodeAt(0)):e}function _define_property$1c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Emsg{get length(){return this.data.length}get elementPresentationTime(){const{presentationTime:e,timeScale:t}=this;return e&&t?Math.round(e/t):NaN}get timedMetadata(){var e;if(this._timedMetadata)return this._timedMetadata;const t=null===(e=this.id3)||void 0===e?void 0:e.frames;return t?(this._timedMetadata=function(e){const t={};for(const n of e)if(void 0!==n.key)switch(n.key){case"TALB":t.album=n.data;break;case"TIT2":t.title=n.data;break;case"TPE1":t.performer=n.data;break;case"WXXX":var r;if(void 0!==n.description)if(void 0===t.links&&(t.links=[]),!t.links.some(e=>e.url===n.data))t.links.push({description:null!==(r=n.description)&&void 0!==r?r:"",url:n.data});break;case"PRIV":"com.apple.radio.adamid"===n.owner&&(t.storefrontAdamIds=parseStorefrontAdamIds(n.data)),"com.apple.radio.ping.jingle"===n.owner&&(t.blob=parsePingBlob(n.data))}return new TimedMetadata(t)}(t),this._timedMetadata):void 0}constructor(e){_define_property$1c(this,"data",void 0),_define_property$1c(this,"schemeIdUri",void 0),_define_property$1c(this,"eventDuration",void 0),_define_property$1c(this,"presentationTime",void 0),_define_property$1c(this,"payload",void 0),_define_property$1c(this,"timeScale",void 0),_define_property$1c(this,"id3",void 0),_define_property$1c(this,"id",void 0),_define_property$1c(this,"_timedMetadata",void 0),this.data=e;const t=new DataView(e.buffer);let r=8;if(1!==e[r])return;r+=4,this.timeScale=t.getUint32(r),r+=4;const n=t.getUint32(r);r+=4;const i=t.getUint32(r);if(r+=4,this.presentationTime=Math.pow(2,32)*n+i,!Number.isSafeInteger(this.presentationTime))throw this.presentationTime=Number.MAX_SAFE_INTEGER,new Error("Failed to create 64 bit integer");this.eventDuration=t.getUint32(r),r+=4,this.id=t.getUint32(r),r+=4;const[o,a]=readNullTerminatedString(e,r);r+=a+1,this.schemeIdUri=o;const[s,l]=readNullTerminatedString(e,r);r+=l+1,this.payload=e.subarray(r,e.byteLength),this.id3=ID3Tag.parse(this.payload)}}function _define_property$1b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TimedMetadataManager{processEmsgs(e){const t=findEmsgs(e);t.length&&(this._currentEmsgInterval||(this._currentEmsgInterval=setInterval(this._getCurrentEmsg,1e3)),t.forEach(e=>{const t=new Emsg(e);this._emsgLookup[t.elementPresentationTime]=t}))}stop(){const{_currentEmsgInterval:e}=this;e&&clearInterval(e)}_getCurrentEmsg(){const{_currentTime:e,_emsgLookup:t}=this,r=Math.round(e()),n=[],i=Object.keys(t);for(let a=0;a<i.length;a++){const e=parseInt(i[a],10);if(!(e<r))break;n.push(e)}const o=n.pop();if(o){const e=t[o];if(!e)return;const{_currentEmsg:r,_onDidChange:n}=this,i=null==r?void 0:r.payload,a=e.payload;i&&arrayEquals(i,a)||(this._currentEmsg=e,n(e)),this._cleanupEmsgs(o)}}_cleanupEmsgs(e){const{_emsgLookup:t}=this;Object.keys(t).forEach(r=>{parseInt(r,10)<e&&delete t[r]})}constructor(e,t){_define_property$1b(this,"_currentTime",void 0),_define_property$1b(this,"_onDidChange",void 0),_define_property$1b(this,"_currentEmsgInterval",void 0),_define_property$1b(this,"_emsgLookup",void 0),_define_property$1b(this,"_currentEmsg",void 0),this._currentTime=e,this._onDidChange=t,this._emsgLookup={},this._getCurrentEmsg=this._getCurrentEmsg.bind(this)}}function _define_property$1a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class SegmentProcessor{process(e,t){const{_item:r}=this;try{r.isLiveRadioStation?this._processLiveRadioSegment(e,t):r.hasOffersHlsUrl&&this._processHlsOffersSegment(e,t)}catch(n){fe.error("Error processing segment",n)}}stop(){this._timedMetadataManager.stop()}_processHlsOffersSegment(e,t){e.isInitSegment&&rewriteDefaultKid(t)}_processLiveRadioSegment(e,t){e.isInitSegment&&rewriteDefaultKid(t),this._timedMetadataManager.processEmsgs(t)}constructor(e,t,r){_define_property$1a(this,"_item",void 0),_define_property$1a(this,"_timedMetadataManager",void 0),this._item=e,this._timedMetadataManager=new TimedMetadataManager(()=>t.currentTime,e=>{r.publish(Kt,{item:this._item,metadata:e.timedMetadata,position:t.currentTime,playingDate:void 0})})}}function asyncGeneratorStep$S(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$S(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$S(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$S(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$19(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$l(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$l(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Gt=fe.createChild("mse"),Ht=BooleanDevFlag.get("mk-mse-buffer"),{manifestParsed:Wt}=et;class MseBuffer{onSourceOpen(){Gt.debug("mediaSource open handler");const{mediaSource:e}=this;if(e.activeSourceBuffers.length>0)return void Gt.debug("not adding new source buffer");Gt.debug("adding new source buffer");const t=e.addSourceBuffer('audio/mp4;codecs="mp4a.40.2"');this.sourceBuffer=t,t.addEventListener("updateend",this.updateEndHandler);const{clip:r,hasAppendWindowSupport:n}=this;r&&(n?(Gt.debug("appendWindowStart/End",r.start,r.end),t.appendWindowStart=r.start,t.appendWindowEnd=r.end):(Gt.debug("seeking for clip",r.start),asAsync(this.seek(r.start)))),this.updateSegmentToFetch(0,!0)}setNextManifest(e){Gt.debug("setting next manifest for ",e.mediaItem.title),this.nextSeamlessTransition?(Gt.debug("abandoning transition scheduled for "+this.nextSeamlessTransition),this.revertSeamlessTransition(!0),this.playbackTimeline.next={manifest:e}):(this.playbackTimeline.next={manifest:e},this.isFullyBuffered&&(Gt.debug("current song is fully buffered, beginning transition to next"),this.transitionToNextManifest()))}isItemPlaying(e){var t,r;const{playbackTimeline:n}=this,i=this.nextSeamlessTransition?null===(t=n.previous)||void 0===t?void 0:t.manifest.mediaItem:null===(r=n.current)||void 0===r?void 0:r.manifest.mediaItem;return!!i&&(Gt.debug(`isItemPlaying ${e.title}, ${i.title}, ${e.id===i.id}`),e.id===i.id)}get currentItem(){return this.manifest.mediaItem}get playableUrl(){let e=this._playableUrl;return e||(e=window.URL.createObjectURL(this.mediaSource),Gt.debug("created url",e),this._playableUrl=e,e)}get segments(){const{manifest:e,clip:t}=this;return t?e.segmentsForTimeRange(t):e.segments||[]}get currentTime(){return this._currentTime}set currentTime(e){if(e+=this.currentTimestampOffset,this._currentTime===e)return;const{nextSeamlessTransition:t}=this;if(t&&e>=t){var r,n;Gt.debug("setting offset to",t),this.currentTimestampOffset=t||0,this.nextSeamlessTransition=void 0,this.duration=this.manifest.mediaItem.playbackDuration/1e3,Gt.debug("buffer setting duration to",this.duration);const e={previous:null===(n=this.playbackTimeline.previous)||void 0===n||null===(r=n.manifest)||void 0===r?void 0:r.mediaItem,current:this.manifest.mediaItem};Gt.debug("dispatching seamless audio transition",e),this.dispatcher.publish(jt,e)}this._currentTime=e;const{isOverBufferLimit:i,timeToTrim:o}=this,a=e>this.timeToTrim;i&&a&&(Gt.debug("buffer over limit, trimming to ",o),this.removeToTime(o),this.timeToTrim+=10)}get hasAppendWindowSupport(){var e;return void 0!==(null===(e=this.sourceBuffer)||void 0===e?void 0:e.appendWindowStart)}seek(e){var t=this;return _async_to_generator$S((function*(){const{duration:r,seekWhenUpdated:n,sourceBuffer:i}=t;if(t.resolveSeekPromise(!1),Gt.debug("seek to ",e),(e=+e)>r&&(Gt.debug("rounding seek time to duration",e,r),e=r),!i)return!1;if(t.revertSeamlessTransition(),i.updating)return Gt.debug("sourcebuffer updating, deferring seek"),new Promise(r=>{n&&n.resolve(!1),t.seekWhenUpdated={seek:t.seek.bind(t,e),resolve:r}});t.currentlyLoadingSegmentIndex=void 0,t.updateSegmentToFetch(0,!0),t.removeToTime(e),t.timeToTrim=10*Math.floor(e/10);const o=t.getSegmentForTime(e);0!==o&&(yield t.firstSegmentLoadPromise),Gt.debug("seeking to",e,"segment",o),t.updateSegmentToFetch(o,!0);const a=new Promise(r=>{t.seekResolver={time:e,resolve:r}});return t.checkSeekBuffered(),a}))()}clearNextManifest(){this.revertSeamlessTransition(!0),this.playbackTimeline.next=void 0}revertSeamlessTransition(e=!1){const{playbackTimeline:t,nextSeamlessTransition:r}=this;if(!r||!t.previous)return void Gt.debug("no need to revert, no transition");this.isAtEndOfStream=e,Gt.debug("reverting seamless transition with discardNextManifest",e),e?this.clearBufferToEnd(r):this.clearBuffer(),Gt.debug("abandoning transition to "+this.manifest.mediaItem.title),t.next=e?void 0:t.current,t.current=t.previous,t.previous=void 0;const n=this.manifest.mediaItem;Gt.debug("current item reverted to "+n.title),this.nextSeamlessTransition=void 0,this.duration=n.playbackDuration/1e3,Gt.debug("reverted duration to "+this.duration),e||(this.currentTimestampOffset=0,this.timestampOffsetAdjustment=0,Gt.debug("reverted currentTimestampOffset and timestampOffsetAdjustment to 0")),this.printInfo(),this.segmentIndexToFetch=-1}get streamHasEnding(){return!this.manifest.mediaItem.isLiveRadioStation}stop(){this.segmentProcessor.stop(),this.setEndOfStream(),this.remove()}remove(){var e;Gt.debug("removing sourceBuffer and mediaSource");const{sourceBuffer:t,mediaSource:r}=this;null===(e=this.seekResolver)||void 0===e||e.resolve(!1),this.manifest.removeEventListener(Wt,this.onManifestParsed);const n=this._playableUrl;n&&(Gt.debug("revoking url",n),window.URL.revokeObjectURL(n)),r.removeEventListener("sourceopen",this.onSourceOpen),t&&(t.removeEventListener("updateend",this.updateEndHandler),this.sourceBuffer=void 0)}onManifestParsed(){const e=this.segmentIndexToFetch+1;Gt.debug("manifestParsed, loading segment",e),this.updateSegmentToFetch(e,!0)}updateEndHandler(){if(this.kickstartBuffer(),this.clearDeferredRemove())return;if(Gt.debug("update end",this.seekWhenUpdated),this.seekWhenUpdated){Gt.debug("updateEndHandler resolving seekWhenUpdated");const{seekWhenUpdated:e}=this;return asAsync(e.seek().then(e.resolve)),void(this.seekWhenUpdated=void 0)}this.checkSeekBuffered();const{clip:e,sourceBuffer:t,hasAppendWindowSupport:r}=this;if(e&&t&&!r){const{buffered:r}=t;if(this.isTimeBuffered(e.end+1)){const n=r.end(r.length-1);return Gt.debug("clipping sourcebuffer to",e.end,n),void t.remove(e.end,n)}}if(this.isAtEndOfStream)return Gt.debug("buffer is at end of stream"),this.streamHasEnding&&(Gt.debug("isAtEndOfStream, not fetching any more segments"),this.playbackTimeline.next||this.setEndOfStream(),this.transitionToNextManifest()),void(this.isAtEndOfStream=!1);Gt.debug("updateEndHandler invoking loadSegment"),asAsync(this.loadSegment())}clearDeferredRemove(){if(0===this.deferredRemoves.length)return!1;const e=this.deferredRemoves.shift();var t;(Gt.trace("clearDeferredRemove",e),e.end>e.start)?null===(t=this.sourceBuffer)||void 0===t||t.remove(e.start,e.end):e.end<=e.start&&Gt.warn(`Trying to remove an invalid time range from SourceBuffer: |${e.start} <=> ${e.end}| (${e.end-e.start})`);return!0}transitionToNextManifest(){var e;Gt.debug("beginning transition to next manifest");const{playbackTimeline:t,sourceBuffer:r}=this;if(!t.next||!r)return void Gt.debug("no next manifest");const n=this.endOfBufferTime||this.currentTimestampOffset;Gt.debug("setting seamless transition at",n),this.nextSeamlessTransition=n,this.timestampOffsetAdjustment=n,this.playbackTimeline.current.endTime=n,t.previous=t.current,Gt.debug("previous manifest set to",null===(e=t.previous)||void 0===e?void 0:e.manifest.mediaItem.title),t.current=t.next,Gt.debug("current manifest set to",t.current.manifest.mediaItem.title),t.next=void 0,this.updateSegmentToFetch(0,!0),this.printInfo()}updateSegmentToFetch(e,t=!1){this.segments.length&&e<this.segments.length&&e!==this.segmentIndexToFetch&&(this.segmentIndexToFetch=e,t&&(Gt.debug("updateSegmentToFetch invoking loadSegment"),asAsync(this.loadSegment())))}loadSegment(){var e=this;return _async_to_generator$S((function*(){const t=e.segmentIndexToFetch,r=e.segments[t];if(t!==e.currentlyLoadingSegmentIndex){if(r)try{Gt.debug("begin loadSegment "+t),e.currentlyLoadingSegmentIndex=t;const i=r.load();0===t&&(e.firstSegmentLoadPromise=i);const o=yield i;if(0!==t&&t!==e.segmentIndexToFetch)return void Gt.debug("load segment index to fetch changed, not processing bytes for segment",t);e.segmentProcessor.process(r,o),Gt.debug("loadSegment processed: "+t);const{sourceBuffer:a,timestampOffsetAdjustment:s}=e;if(!a)return;try{"number"==typeof s&&(Gt.debug("adjusting timestampOffset of sourcebuffer to",s),a.timestampOffset=s,e.timestampOffsetAdjustment=void 0),a.appendBuffer(o),e.isFullyBuffered=!1,e.isOverBufferLimit=!1,Gt.debug("appended to buffer",o.length),e.printBufferTimes(),t===e.segments.length-1?e.isAtEndOfStream=!0:t===e.segmentIndexToFetch&&(Gt.debug("loadSegment bumping segment index to fetch to ",t+1),e.updateSegmentToFetch(t+1))}catch(n){"QuotaExceededError"===n.name?(e.isOverBufferLimit=!0,Gt.debug("reached buffer limit")):Gt.warn("Error appending to source buffer",n)}}catch(i){Gt.error("Error loading segment",i),e.dispatcher.publish(Ft,i)}finally{e.currentlyLoadingSegmentIndex=void 0}}else Gt.debug(`segment ${t} is currently loading, not loading it again`)}))()}setEndOfStream(){const{sourceBuffer:e,mediaSource:t}=this;e&&"ended"!==t.readyState&&(e.updating||"open"!==t.readyState?Gt.error("Could not end of stream (updating, readyState)",e.updating,t.readyState):(Gt.debug("mediaSource.endOfStream"),t.endOfStream(),this.isFullyBuffered=!0))}removeToTime(e){Gt.debug("removing to time",e),e>0&&(this.isTimeBuffered(e)||this.isOverBufferLimit)&&this.safeSourceBufferRemove(0,e)}safeSourceBufferRemove(e,t){Gt.trace("safeSourceBufferRemove",e,t);const{sourceBuffer:r}=this;r&&(r.updating?this.deferredRemoves.push({start:e,end:t}):t<=e?Gt.warn(`Trying to remove an invalid time range from SourceBuffer: |${e} <=> ${t}| (${t-e})`):r.remove(e,t))}get previousOffset(){var e,t;return(null===(t=this.playbackTimeline)||void 0===t||null===(e=t.previous)||void 0===e?void 0:e.endTime)||0}get manifest(){var e;return null===(e=this.playbackTimeline.current)||void 0===e?void 0:e.manifest}checkSeekBuffered(){const{seekResolver:e,currentTimestampOffset:t}=this;if(!e)return;const{time:r}=e,n=r+t,i=this.isTimeBuffered(n);Gt.debug("resolving seek for time, adjustedTime, isBuffered",r,n,i),this.printBufferTimes(),i&&(Gt.debug("resolving seek to true for time:",n),this.element.currentTime=n,this.resolveSeekPromise(!0))}resolveSeekPromise(e){this.seekResolver&&(this.seekResolver.resolve(e),this.seekResolver=void 0)}get endOfBufferTime(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;return!(!t||!t.length)&&t.end(t.length-1)}isTimeBuffered(e){var t;const r=null===(t=this.sourceBuffer)||void 0===t?void 0:t.buffered;if(!r)return!1;for(let n=0;n<r.length;n++)if(Gt.debug("isTimeBuffered",r.start(n),e,r.end(n)),e>=r.start(n)&&e<=r.end(n))return!0;return!1}clearBufferToEnd(e){const{sourceBuffer:t}=this;if(!t||!t.buffered)return;const r=t.buffered.end(t.buffered.length-1);this.safeSourceBufferRemove(e,r)}clearBuffer(){const{sourceBuffer:e}=this;if(!e||!e.buffered)return;const t=e.buffered;for(let r=0;r<t.length;r++)this.safeSourceBufferRemove(t.start(r),t.end(r))}get bufferTimesString(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;if(!t)return"";const r=[];for(let n=0;n<t.length;n++)r.push(`start ${t.start(n)} end: ${t.end(n)}`);return r.join(",")}printBufferTimes(){Ht&&Gt.debug("buffer times",this.bufferTimesString)}getSegmentForTime(e){return Math.floor(e/10)+1}kickstartBuffer(){const{hasKickstarted:e,element:t,clip:r}=this,{buffered:n}=t;e||(this.manifest.mediaItem.isSong?r&&this.isTimeBuffered(r.start)&&(t.currentTime=r.start,this.hasKickstarted=!0):n.length&&(t.currentTime=n.start(0),this.hasKickstarted=!0))}printInfo(){var e,t;const{playbackTimeline:r}=this;Gt.info("---- Buffer Info ----"),Gt.info("currently buffering item",r.current.manifest.mediaItem.title),Gt.info("next item to buffer",null===(e=r.next)||void 0===e?void 0:e.manifest.mediaItem.title),Gt.info("previously buffered item",null===(t=r.previous)||void 0===t?void 0:t.manifest.mediaItem.title),Gt.info("currentTimestampOffset",this.currentTimestampOffset),Gt.info("currentTime",this.currentTime),Gt.info("duration",this.duration),Gt.info("nextSeamlessTransition",this.nextSeamlessTransition),Gt.info("timestampOffsetAdjustment",this.timestampOffsetAdjustment),Gt.info("buffered times",this.bufferTimesString),Gt.info("isAtEndOfStream",this.isAtEndOfStream),Gt.info("isFullyBuffered",this.isFullyBuffered),Gt.info("segmentIndexToFetch",this.segmentIndexToFetch),Gt.info("segments.length",this.segments.length),Gt.info("---- End Buffer Info ----")}constructor({dispatcher:e,element:t,manifest:r,currentTime:n,duration:i,clip:o}){_define_property$19(this,"dispatcher",void 0),_define_property$19(this,"mediaSource",void 0),_define_property$19(this,"sourceBuffer",void 0),_define_property$19(this,"element",void 0),_define_property$19(this,"_currentTime",void 0),_define_property$19(this,"currentlyLoadingSegmentIndex",void 0),_define_property$19(this,"duration",void 0),_define_property$19(this,"firstSegmentLoadPromise",Promise.resolve()),_define_property$19(this,"hasKickstarted",!1),_define_property$19(this,"isOverBufferLimit",void 0),_define_property$19(this,"seekResolver",void 0),_define_property$19(this,"seekWhenUpdated",void 0),_define_property$19(this,"segmentIndexToFetch",-1),_define_property$19(this,"segmentProcessor",void 0),_define_property$19(this,"timeToTrim",10),_define_property$19(this,"isAtEndOfStream",!1),_define_property$19(this,"isFullyBuffered",!1),_define_property$19(this,"_playableUrl",void 0),_define_property$19(this,"clip",void 0),_define_property$19(this,"deferredRemoves",[]),_define_property$19(this,"timestampOffsetAdjustment",void 0),_define_property$19(this,"playbackTimeline",void 0),_define_property$19(this,"currentTimestampOffset",0),_define_property$19(this,"nextSeamlessTransition",void 0),this.dispatcher=e,this.clip=o,this.element=t,this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.segmentProcessor=new SegmentProcessor(r.mediaItem,t,e),this.playbackTimeline={current:{manifest:r}},r.addEventListener(Wt,this.onManifestParsed),this._currentTime=n||0,this.duration=i,window.mseBuffer=this}}function asyncGeneratorStep$R(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$R(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$R(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$R(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$18(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$k(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$k(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[]),_ts_metadata$l("design:returntype",void 0)],MseBuffer.prototype,"onSourceOpen",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[]),_ts_metadata$l("design:returntype",void 0)],MseBuffer.prototype,"onManifestParsed",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[]),_ts_metadata$l("design:returntype",void 0)],MseBuffer.prototype,"updateEndHandler",null);const{mediaPlaybackError:zt}=Be;class AudioPlayer extends BasePlayer{destroy(){var e=this,_superprop_get_destroy=()=>super.destroy;return _async_to_generator$R((function*(){_superprop_get_destroy().call(e),e._dispatcher.unsubscribe(Ft,e.onLoadSegmentError)}))()}onLoadSegmentError(e){this._dispatcher.publish(zt,new MKError(MKError.Reason.MEDIA_SESSION,e)),this.destroy()}get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}get _targetElement(){return this.audio}initializeExtension(){var e=this;return _async_to_generator$R((function*(){e.extension=new MediaExtension({mediaElement:e.audio,contentType:'audio/mp4;codecs="mp4a.40.2"',services:{runtime:e.services.runtime}}),yield e.extension.initializeKeySystem(),e.extension.addEventListener(et.playbackLicenseError,t=>{e.resetDeferredPlay(),e._dispatcher.publish(zt,t)}),e.extension.addEventListener(et.playbackSessionError,t=>{e._dispatcher.publish(zt,new MKError(MKError.Reason.MEDIA_SESSION,t)),e.destroy()})}))()}initializeMediaElement(){var e=this;return _async_to_generator$R((function*(){const t=nextAvailableAudioElement();t.autoplay=!1,t.id="apple-music-player",t.controls=!1,t.muted=!1,t.playbackRate=1,t.preload="metadata",t.volume=1,e.audio=t,document.body.appendChild(t),fe.debug("initializedMediaElement",t)}))()}removeEventHandlers(){this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck),super.removeEventHandlers()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$R((function*(){var t;yield _superprop_get_stopMediaElement().call(e),yield e.tearDownManifests(),null===(t=e._buffer)||void 0===t||t.stop(),e._buffer=void 0}))()}preloadItem(e){var t=this;return _async_to_generator$R((function*(){const{extension:r,nextManifest:n}=t,i=t._buffer;if("song"!==e.type||!i||!r||!t.isSeamlessAudioTransitionsEnabled)return;if((null==n?void 0:n.mediaItem.id)===e.id)return void fe.debug("already have next manifest for ",e.title);if(n&&n.mediaItem.id!==e.id)return void fe.debug(`preventing race condition: not overwriting nextManifest for ${n.mediaItem.title} with ${e.title}`);t._targetElement.removeEventListener("timeupdate",t.onTimeUpdate),t._targetElement.addEventListener("timeupdate",t.onTimeUpdate),fe.debug("player preparing next manifest for",e.title);const o=yield t.loadAndParseManifest(e,!1);i.setNextManifest(o),r.setMediaItem(e),r.extURI=o.extURI,t.nextManifest=o}))()}playItemFromEncryptedSource(e,t=!1,r){var n=this;return _async_to_generator$R((function*(){const i=n._paused&&!t;fe.debug("playItemFromEncryptedSource",e.title);const o=i?void 0:n.startPlaybackSequence();if(e.playRawAssetURL)return e.playbackType=h.unencryptedFull,n.nowPlayingItem=e,yield n._playAssetURL(e.assetURL,i),n.finishPlaybackSequence();const{extension:a}=n;var s,l;n.delaySeamlessCdmUpdates&&(null===(l=n.extension)||void 0===l||null===(s=l.session)||void 0===s||s.applyDelayedCdmUpdates());if(!a)return o;a.initiated=t,a.setMediaItem(e),e.playbackType=h.encryptedFull,n.nowPlayingItem=e,e.state=y.loading;const c=yield n.getManifestForItem(e);n.manifest=c;const d=shouldForceAudioMse();if((e.isSong||a.isFairplay&&d)&&(a.extURI=c.extURI),e.state=y.ready,a.isFairplay&&!d){let t=e.assetURL;(null==r?void 0:r.startTime)&&(t+="#t="+r.startTime),yield n._playAssetURL(t,i)}else{const e=n._buffer;e&&n.isSeamlessAudioTransitionsEnabled&&e.isItemPlaying(c.mediaItem)?fe.debug("already have buffer, continuing playback"):yield n.beginNewBufferForItem(i,c,r)}return n.finishPlaybackSequence()}))()}getManifestForItem(e){var t=this;return _async_to_generator$R((function*(){var r,n;fe.debug("reconciling item to play against playing item");const{nextManifest:i,manifest:o,isSeamlessAudioTransitionsEnabled:a}=t,s=t._buffer;if(!s||!o)return fe.debug("no buffer or manifest, creating manifest [title, buffer, manifest]",e.title,!!s,!!o),t.loadAndParseManifest(e);if(!a)return fe.debug("seamless transitions disabled, stopping and creating manifest for",e.title),yield t.tearDownManifests(),t.loadAndParseManifest(e);const l=!s.isItemPlaying(e);let c;fe.debug("itemMismatch",l);const d=(null==i?void 0:i.mediaItem.id)===e.id;return i&&!l&&d?(fe.debug(`replacing manifest for ${o.mediaItem.title} with next manifest ${i.mediaItem.title}`),c=i,t.nextManifest=void 0,fe.debug("cease listening for keys on manifest for",o.mediaItem.title),yield t.tearDownManifest(o)):l?(null==i?void 0:i.mediaItem.id)!==e.id?(fe.debug(`item to play ${e.title} does not match playing or next items, tearing down all manifests`),yield t.tearDownManifests(),c=yield t.loadAndParseManifest(e)):(fe.debug(`item to play ${e.title} matches next item, tearing down current manifest`),yield t.tearDownManifest(o),c=i):(fe.debug("item is already playing, returning existing manifest"),c=o),fe.debug("getManifestForItem loading keys for",c.mediaItem.title),null===(n=t.extension)||void 0===n||null===(r=n.session)||void 0===r||r.loadKeys(c.keyValues,c.mediaItem),c}))()}seekToTime(e){var t=this;return _async_to_generator$R((function*(){const r=t._buffer;if(r){fe.debug("audio-player: buffer seek to",e);if(!(yield r.seek(e)))return;t.isSeamlessAudioTransitionsEnabled&&t.onTimeUpdate()}else fe.debug("audio-player: media element seek to",e),t._targetElement.currentTime=e}))()}tearDownManifests(){var e=this;return _async_to_generator$R((function*(){e.manifest=yield e.tearDownManifest(e.manifest),e.nextManifest=yield e.tearDownManifest(e.nextManifest)}))()}tearDownManifest(e){var t=this;return _async_to_generator$R((function*(){const{extension:r}=t;e&&(fe.debug("tearing down manifest for",e.mediaItem.title),e.stop(),r&&(yield r.clearSessions(e.keyValues)),e.removeEventListener(xt.keysParsed,t.loadKeysHandler))}))()}loadAndParseManifest(e,t=!0){var r=this;return _async_to_generator$R((function*(){let n;fe.debug(`will load and parse manifest for ${e.title}, loadKeys ${t}`);try{return n=yield Manifest.load(e,{cache:!1,services:{runtime:r.services.runtime,request:r.services.request}}),t&&n.addEventListener(xt.keysParsed,r.loadKeysHandler),n.parse(),n}catch(xe){r.resetDeferredPlay();const t=new MKError(MKError.Reason.NETWORK_ERROR,"Could not fetch manifest");throw t.data=xe,r._dispatcher.publish(zt,t),t}}))()}onTimeUpdate(){if(!this._buffer)return;const{currentPlaybackTimeRemaining:e,nextManifest:t,delaySeamlessCdmUpdates:r}=this;if(t&&e<15){var n,i,o,a;if(fe.debug("player loading keys for",t.mediaItem.title,r),r)null===(i=this.extension)||void 0===i||null===(n=i.session)||void 0===n||n.loadKeys(t.keyValues,t.mediaItem,{delayCdmUpdate:!0}),this._targetElement.addEventListener("timeupdate",this.delayedCdmUpdateCheck);else null===(a=this.extension)||void 0===a||null===(o=a.session)||void 0===o||o.loadKeys(t.keyValues,t.mediaItem);this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate)}}delayedCdmUpdateCheck(){var e;const t=null===(e=this.nowPlayingItem)||void 0===e?void 0:e.playbackDuration,r=t?t/1e3:this.currentPlaybackDuration,n=this._currentTime,i=Number((r-n).toFixed(3));if(i<1){const e=1e3*i;fe.debug("delayed CDM update in ",e),setTimeout(()=>{var e,t;fe.debug("applying delayed CDM update"),null===(t=this.extension)||void 0===t||null===(e=t.session)||void 0===e||e.applyDelayedCdmUpdates()},e),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck)}}loadKeysHandler(e){var t,r;null===(r=this.extension)||void 0===r||null===(t=r.session)||void 0===t||t.loadKeys(e.keys,e.item)}beginNewBufferForItem(e,t,r){var n=this;return _async_to_generator$R((function*(){if(fe.debug("creating new MseBuffer for item",t.mediaItem.title,e),n._buffer&&(fe.debug("stopping old buffer"),n._buffer.stop()),n._buffer=new MseBuffer({dispatcher:n._dispatcher,element:n._targetElement,duration:t.mediaItem.playbackDuration/1e3,manifest:t}),yield n._playAssetURL(n._buffer.playableUrl,!0),!e){let e=Promise.resolve();return(null==r?void 0:r.startTime)&&(e=n.seekToTime(r.startTime)),e.then(()=>n._playMedia())}}))()}setPresentationMode(e){return _async_to_generator$R((function*(){return Promise.resolve()}))()}loadPreviewImage(e){return _async_to_generator$R((function*(){}))()}constructor(e){var t,r;super(e),_define_property$18(this,"currentAudioTrack",void 0),_define_property$18(this,"currentTextTrack",void 0),_define_property$18(this,"textTracks",[]),_define_property$18(this,"audioTracks",[]),_define_property$18(this,"audio",void 0),_define_property$18(this,"isSeamlessAudioTransitionsEnabled",!1),_define_property$18(this,"delaySeamlessCdmUpdates",!1),_define_property$18(this,"extension",void 0),_define_property$18(this,"mediaPlayerType","audio"),_define_property$18(this,"manifest",void 0),_define_property$18(this,"nextManifest",void 0);const n=null!==(r=null===(t=e.bag)||void 0===t?void 0:t.features)&&void 0!==r?r:{};this.isSeamlessAudioTransitionsEnabled=!!n["seamless-audio-transitions"],this.delaySeamlessCdmUpdates=!!n["delay-seamless-cdm-updates"],window.audioPlayer=this,this._dispatcher.subscribe(Ft,this.onLoadSegmentError)}}function asyncGeneratorStep$Q(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$Q(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Q(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Q(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$17(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$k([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[void 0]),_ts_metadata$k("design:returntype",void 0)],AudioPlayer.prototype,"onLoadSegmentError",null),_ts_decorate$k([AsyncDebounce(250),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[Number]),_ts_metadata$k("design:returntype",Promise)],AudioPlayer.prototype,"seekToTime",null),_ts_decorate$k([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[]),_ts_metadata$k("design:returntype",void 0)],AudioPlayer.prototype,"onTimeUpdate",null),_ts_decorate$k([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[]),_ts_metadata$k("design:returntype",void 0)],AudioPlayer.prototype,"delayedCdmUpdateCheck",null),_ts_decorate$k([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[void 0]),_ts_metadata$k("design:returntype",void 0)],AudioPlayer.prototype,"loadKeysHandler",null);class EncryptedSession extends KeySession{attachMedia(e,t){var r=this;return _async_to_generator$Q((function*(){r.keySystem=t.keySystem,r._keySystemAccess=t,e.addEventListener("encrypted",r.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation)}createSession(e){var t=this;return _async_to_generator$Q((function*(){fe.debug("Encrypted createSession",e);const r=t._keySystemAccess;if(!r)return;const{initData:n,initDataType:i,target:o}=e;return t._mediaKeysPromise||(t._mediaKeysPromise=new Promise(function(){var e=_async_to_generator$Q((function*(e,n){const i=yield r.createMediaKeys();try{yield o.setMediaKeys(i)}catch(xe){t.dispatchKeyError(xe),n(xe)}const a=yield t.loadCertificateBuffer();yield i.setServerCertificate(a),t._mediaKeysServerCertificate=a,e(i)}));return function(t,r){return e.apply(this,arguments)}}())),yield t._mediaKeysPromise,t._mediaKeysServerCertificate?t._createSession(o,n,i):void 0}))()}generatePSSH(e){const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r=o(e);for(let n=0;n<r.length;n++)t[t.length-16+n]=r[n];return fe.debug("generatePSSH",t),t}_createSession(e,t,r){const n=e.mediaKeys.createSession(),{item:i}=this;if(!i)return;this._teardownCurrentSession(),fe.debug("creating media key session",n);let o;if(this.isWidevine&&i.isSong)o=this.generatePSSH(this.extID);else{const e=function(e){const t=[],r=new DataView(e.buffer);for(let n=0;n<e.length;){const i=r.getUint32(n);t.push(new PsshBox(e,n,n+i)),n+=i}return t}(new Uint8Array(t)).find(e=>e.isWidevine),r=null==e?void 0:e.rawBytes,i=r?l(r):void 0;fe.debug("extracted uri",i),n.extURI=i,o=t}return n.addEventListener("message",this.startLicenseSession),this._currentSession=n,n.generateRequest(r,o).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return n.generateRequest(r,o);throw e})}_teardownCurrentSession(){this._currentSession&&(fe.debug("tearing down media key session",this._currentSession),this._currentSession.removeEventListener("message",this.startLicenseSession),this._currentSession=void 0)}applyDelayedCdmUpdates(){}loadKeys(e,t,r){return _async_to_generator$Q((function*(){}))()}clearSessions(){return _async_to_generator$Q((function*(){}))()}constructor(...e){super(...e),_define_property$17(this,"_currentSession",void 0),_define_property$17(this,"_keySystemAccess",void 0),_define_property$17(this,"_mediaKeysPromise",void 0),_define_property$17(this,"_mediaKeysServerCertificate",void 0)}}function asyncGeneratorStep$P(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$P(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$P(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$P(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$16(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MediaExtensionStub extends Notifications{destroy(e){}setMediaItem(e){}initializeKeySystem(){var e=this;return _async_to_generator$P((function*(){e.session=new EncryptedSession}))()}clearSessions(){return _async_to_generator$P((function*(){}))()}constructor(e){super(e),_define_property$16(this,"audioTracks",[]),_define_property$16(this,"textTracks",[]),_define_property$16(this,"session",void 0),_define_property$16(this,"extURI",void 0),_define_property$16(this,"hasMediaSession",void 0),_define_property$16(this,"initiated",void 0),_define_property$16(this,"isFairplay",void 0),this.extURI="",this.initiated=!0,this.isFairplay=!0,this.hasMediaSession=!0}}function asyncGeneratorStep$O(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$O(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$O(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$O(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$15(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PlayerStub{get hasMediaElement(){return!0}get isEngagedInPlayback(){return!this.paused}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._dispatcher.publish(Be.playbackRateDidChange,new Event("ratechange"))}get defaultPlaybackRate(){return this._defaultPlaybackRate}set defaultPlaybackRate(e){this._defaultPlaybackRate=e,this._dispatcher.publish(Be.playbackRateDidChange,new Event("ratechange"))}get volume(){return this._volume}set volume(e){this._volume=e,this._dispatcher.publish(Be.playbackVolumeDidChange,new Event("volumeChange"))}destroy(){}dispatch(){}exitFullscreen(){return _async_to_generator$O((function*(){}))()}loadPreviewImage(e){return _async_to_generator$O((function*(){}))()}initialize(){return _async_to_generator$O((function*(){}))()}isPaused(){return this.paused}calculateTime(e){return e}clearNextManifest(){}mute(){}newSeeker(){return new PlayerSeeker(this)}pause(e){return _async_to_generator$O((function*(){}))()}play(){return _async_to_generator$O((function*(){}))()}playItemFromEncryptedSource(e,t,r){return _async_to_generator$O((function*(){}))()}playItemFromUnencryptedSource(e,t,r){return _async_to_generator$O((function*(){}))()}preload(){return _async_to_generator$O((function*(){}))()}seekToTime(e){return _async_to_generator$O((function*(){}))()}requestFullscreen(){return _async_to_generator$O((function*(){}))()}setPlaybackState(e,t){this.playbackState=e}setPresentationMode(e){return _async_to_generator$O((function*(){}))()}showPlaybackTargetPicker(){}stop(e){return _async_to_generator$O((function*(){}))()}stopMediaAndCleanup(){return _async_to_generator$O((function*(){}))()}supportsPictureInPicture(){return!1}tsidChanged(){}preloadItem(e,t){return _async_to_generator$O((function*(){}))()}toString(){return`<PlayerStub id="${this.id}" isInitialized=true isDestroyed=false />`}constructor(e){_define_property$15(this,"id",generateUUID()),_define_property$15(this,"bitrate",ve.STANDARD),_define_property$15(this,"audioTracks",[]),_define_property$15(this,"currentBufferedProgress",0),_define_property$15(this,"currentPlaybackDuration",0),_define_property$15(this,"currentPlaybackProgress",0),_define_property$15(this,"currentPlaybackTime",0),_define_property$15(this,"currentPlaybackTimeRemaining",0),_define_property$15(this,"currentPlayingDate",void 0),_define_property$15(this,"isPlayingAtLiveEdge",!1),_define_property$15(this,"isPlaying",!1),_define_property$15(this,"isPrimaryPlayer",!0),_define_property$15(this,"isReady",!1),_define_property$15(this,"nowPlayingItem",void 0),_define_property$15(this,"paused",!1),_define_property$15(this,"playbackState",he.none),_define_property$15(this,"playbackTargetAvailable",!1),_define_property$15(this,"playbackTargetIsWireless",!1),_define_property$15(this,"previewOnly",!1),_define_property$15(this,"supportsPreviewImages",!1),_define_property$15(this,"textTracks",[]),_define_property$15(this,"extension",new MediaExtensionStub([])),_define_property$15(this,"hasAuthorization",!0),_define_property$15(this,"windowHandlers",void 0),_define_property$15(this,"isDestroyed",!1),_define_property$15(this,"services",void 0),_define_property$15(this,"_dispatcher",void 0),_define_property$15(this,"_volume",1),_define_property$15(this,"_playbackRate",1),_define_property$15(this,"_defaultPlaybackRate",1),_define_property$15(this,"currentAudioTrack",void 0),_define_property$15(this,"currentTextTrack",void 0),_define_property$15(this,"seekableTimeRanges",void 0),this.services=e.services,this._dispatcher=e.services.dispatcher,this.windowHandlers=new WindowHandlers(this,e.services.runtime)}}class VideoMediaExtension extends MediaExtension{destroy(e){var t;null===(t=this._session)||void 0===t||t.stopLicenseSession(),super.destroy(e)}}function asyncGeneratorStep$N(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$N(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$N(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$N(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _ts_decorate$j(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$j(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{mediaPlaybackError:Yt}=Be,{playbackLicenseError:Qt,playbackSessionError:Jt}=et;class NativeSafariVideoPlayer extends VideoPlayer{get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}initializeExtension(){var e=this;return _async_to_generator$N((function*(){if(!e.video)return void fe.warn("NativeSafariVideoPlayer.initializeExtension No video element, not initializing extension");const t=new VideoMediaExtension({mediaElement:e.video,contentType:'video/mp4;codecs="avc1.42E01E"',services:{runtime:e.services.runtime}});e.extension=t,yield t.initializeKeySystem(),t.addEventListener(Qt,e.onPlaybackLicenseError),t.addEventListener(Jt,e.onPlaybackSessionError)}))()}destroy(){fe.debug("native-safari-video-player.destroy");const{extension:e,video:t}=this;this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl=void 0),e&&t&&(e.removeEventListener(Qt,this.onPlaybackLicenseError),e.removeEventListener(Jt,this.onPlaybackSessionError),t.removeEventListener("loadedmetadata",this.onMetadataLoaded),super.destroy())}loadPreviewImage(e){return _async_to_generator$N((function*(){}))()}preloadItem(e,t){return _async_to_generator$N((function*(){}))()}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$N((function*(){fe.debug("native-safari-video-player.playHlsStream",e);const{video:i}=n;if(!i){const e="NativeSafariVideoPlayer.playHlsStream(): No video element";throw fe.error(e),new Error(e)}n.setupTrackManagers();const o=n.startPlaybackSequence(),a=(n.services.manifest.personalizedManifests?n.playByBlob(e,i,r):n.playBySource(e,i,r)).then(()=>o);var s;t&&(null===(s=n.extension)||void 0===s||s.setMediaItem(t));return i.addEventListener("loadedmetadata",n.onMetadataLoaded),a}))()}onPlaybackSessionError(e){this._dispatcher.publish(Yt,new MKError(MKError.Reason.MEDIA_SESSION,e))}onMetadataLoaded(){var e=this;return _async_to_generator$N((function*(){fe.debug("native-safari-video-player.onMetadataLoaded");const{nowPlayingItem:t}=e;t&&(t.state=y.ready),yield e._playMedia(),e.finishPlaybackSequence()}))()}seekToTime(e){var t=this;return _async_to_generator$N((function*(){fe.debug("native-safari-video-player: media element seek to",e),t._targetElement.currentTime=e}))()}playByBlob(e,t,r={}){var n=this;return _async_to_generator$N((function*(){fe.debug("native-safari-video-player: playing video by blob");const i=n.services.manifest;let o=yield i.getManifest(e);if(!o&&(fe.debug("native-safari-video-player: fetching manifest"),o=yield i.fetchManifest(e),!o))throw fe.error("No manifest for "+e),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Failed to load manifest");fe.debug("native-safari-video-player: loaded manifest",!!o),yield i.clearManifest(e);const a=o.contentType,s=o.content.replace(/^#EXT-X-SESSION-DATA-ITUNES:.*$/gm,""),l=new Blob([s],{type:a});e=URL.createObjectURL(l),n._blobUrl=e;const c=document.createElement("source");c.setAttribute("src",e),a&&c.setAttribute("type",a),fe.debug("native-safari-video-player: blob url",e),void 0!==r.startTime&&(t.currentTime=r.startTime),t.appendChild(c)}))()}playBySource(e,t,r={}){return _async_to_generator$N((function*(){fe.debug("native-safari-video-player: playing video by source"),void 0!==r.startTime&&(e+="#t="+r.startTime),t.src=e}))()}stopMediaElement(){var e=this;return _async_to_generator$N((function*(){fe.trace("native-safari-video-player.stopMediaElement()"),e.hasMediaElement&&(fe.debug("Stopping HTMLMediaElement id="+e._targetElement.id,e._targetElement),e._targetElement.pause(),e.resetMediaElement()),e.destroy()}))()}constructor(...e){super(...e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"_blobUrl",void 0)}}_ts_decorate$j([Bind(),_ts_metadata$j("design:type",Function),_ts_metadata$j("design:paramtypes",[void 0]),_ts_metadata$j("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onPlaybackSessionError",null),_ts_decorate$j([Bind(),_ts_metadata$j("design:type",Function),_ts_metadata$j("design:paramtypes",[]),_ts_metadata$j("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"onMetadataLoaded",null),_ts_decorate$j([AsyncDebounce(250),_ts_metadata$j("design:type",Function),_ts_metadata$j("design:paramtypes",[Number]),_ts_metadata$j("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"seekToTime",null);const Xt=new RegExp("^https://([a-z0-9]+-)?"+("js-cdn.music.apple.com"+"/musickit/v3/".replace(/v3/,"(v2|v3)")).replace(/[\.\/]/g,"\\$&"),"i"),Zt=/^https:\/\/(.*\/includes\/js-cdn)\//i,er=/^([a-z]+:)?\/\//;function findScript(e){return isNodeEnvironment$1()||!e?null:document.querySelector(`script[src*="${e}"]`)}function getScriptSrcElements(){if("undefined"==typeof document||!document.querySelectorAll)return[];return Array.from(document.querySelectorAll("script[src]"))}function determineCdnBaseHost(){if(isNodeEnvironment$1())return"";return`//${function(){for(const e of getScriptSrcElements()){const t=Xt.exec(e.src);if(t)return t[1]||""}return""}()}js-cdn.music.apple.com`}function determineCdnPathHost(){const e=function(){for(const e of getScriptSrcElements()){const t=Zt.exec(e.src);if(t)return t[1]||""}return""}();return e?"//"+e:e}const tr=StringDevFlag.register("mk-hlsjs-log-level"),rr=StringDevFlag.register("mk-hlsjs-version");function getHlsJsCdnConfig(){const e={hls:"",rtc:""};if(isNodeEnvironment$1())return e;const t=determineCdnPathHost()||determineCdnBaseHost(),r=rr.get()||"current",n=function(){const e=tr.value;switch(e){case"info":case"error":case"warn":return"hls.production.verbose.min.js";case"trace":case"debug":return console.warn(`HLS log level ${e} is not supported, loading production build.`),"hls.js";default:return"hls.js"}}();return e.hls=`https:${t}/hls.js/${r}/hls.js/${n}`,e.rtc=`https:${t}/hls.js/${r}/rtc.js/rtc.min.js`,e}function cdnBaseURL(e,t=window){var r;if(isNodeEnvironment$1())return"";const n=null===(r=getLocalStorage())||void 0===r?void 0:r.getItem("mkCDNBaseURLOverride");if(n)return n;const i=findScript(e);return i?i.getAttribute("src").replace(new RegExp(e+"$"),""):(determineCdnPathHost()||determineCdnBaseHost())+"/musickit/v3/"}const nr=new Map;function loadScript(e,t){const r=nr.get(e);if(r)return r;const n=new Promise((r,n)=>{isNodeEnvironment$1()&&n("Dynamic script loading is unsupported in Node environments.");if(findScript(e))return r();const i=document.createElement("script");let o;if(t&&Object.keys(t).forEach(e=>{i.setAttribute(e,t[e])}),i.onload=()=>{r()},i.onerror=e=>{n(e)},er.test(e))o=e;else{o=`${cdnBaseURL(e)}${e}`}i.src=o,document.head.appendChild(i)});return nr.set(e,n),n}const ir=fe.createChild("tracks");function _define_property$13(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$z(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$13(e,t,r[t])}))}return e}function _object_spread_props$m(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$i(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$i(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{audioTracksSwitched:or,audioTracksUpdated:ar,inlineStylesParsed:sr,textTracksSwitched:lr,textTracksUpdated:cr}=et,dr=BooleanDevFlag.register("mk-hlsjs-interstitial-playback");class HlsJsTracks extends Notifications{get isDestroyed(){return this._isDestroyed}get audioTracks(){return this._audioTracks}get textTracks(){return this._textTracks}get currentInterstitialId(){var e,t;return null===(t=this.session.getCurrentIntegratedTimelineSegmentAndCurrentTime())||void 0===t||null===(e=t.segment)||void 0===e?void 0:e.interstitialEventIdentifier}set audioTrack(e){const{currentInterstitialId:t,session:r}=this;r&&e&&void 0!==e.id&&(t?r.setInterstitialAudioSelectedPersistentId(t,e.id):r.audioSelectedPersistentID=e.id)}set textTrack(e){const{currentInterstitialId:t,session:r}=this;var n;const i=null!==(n=null==e?void 0:e.id)&&void 0!==n?n:-1;t?r.setInterstitialSubtitleSelectedPersistentId(t,i):r.subtitleSelectedPersistentID=i}get audioMediaOptions(){const{currentInterstitialId:e,session:t}=this;return t?e?t.getAudioMediaOptionsForItem({itemId:e}):t.audioMediaOptions:[]}get currentAudioMediaOption(){var e;const{currentInterstitialId:t,session:r}=this;if(r)return t?r.getEnabledAudioMediaOptionForItem({itemId:t}):null===(e=this.audioMediaOptions)||void 0===e?void 0:e.find(e=>e.MediaSelectionOptionsPersistentID===r.audioSelectedPersistentID)}get subtitleMediaOptions(){const{currentInterstitialId:e,session:t}=this;return t?e?t.getSubtitleMediaOptionsForItem({itemId:e}):t.subtitleMediaOptions:[]}get forcedTextTrackForCurrentAudioTrack(){const{currentAudioMediaOption:e}=this;if(!e)return;const t=this.subtitleMediaOptions.find(t=>0===t.MediaSelectionOptionsDisplaysNonForcedSubtitles&&t.MediaSelectionOptionsExtendedLanguageTag===e.MediaSelectionOptionsExtendedLanguageTag);return t?this.normalizeTextTrack(t):void 0}audioTracksUpdated(e=[]){const t=e.map(this.normalizeAudioTrack,this);this._audioTracks=t,this.dispatchEvent(ar,t)}handleItemPlaying(e,t){ir.debug("handleItemPlaying",t);const{itemId:r,interstitialId:n}=t;n||this.updateAudioAndTextTracks({itemId:r})}handleInterstitialAssetStarted(e,t){ir.debug("handleInterstitialAssetStarted",t);const{asset:r}=t;this.updateAudioAndTextTracks({itemId:null==r?void 0:r.identifier})}updateAudioAndTextTracks(e){const t=this.session.getAudioMediaOptionsForItem(e),r=this.session.getSubtitleMediaOptionsForItem(e);ir.debug("updateAudioAndTextTracks - updating audio and text tracks with options:",t,r),this.audioTracksUpdated(t),this.subtitleTracksUpdated(r)}handleAudioTrackSwitched(e,t){if(!this.isEventForCurrentItem(t))return;let r=this.session.audioSelectedPersistentID;this.currentInterstitialId&&(r=this.session.getInterstitialAudioSelectedPersistentId(this.currentInterstitialId)),this.dispatchEvent(or,{selectedId:r})}handleInlineStylesParsed(e,t){this.dispatchEvent(sr,t)}handleManifestLoaded(e,t){if(ir.debug("handleManifestLoaded",t),dr.enabled)return;const{audioMediaSelectionGroup:r,subtitleMediaSelectionGroup:n}=t;this.audioTracksUpdated(null==r?void 0:r.MediaSelectionGroupOptions),this.subtitleTracksUpdated(null==n?void 0:n.MediaSelectionGroupOptions)}handleSessionDataComplete(e,t){var r;null==t||null===(r=t.itemList)||void 0===r||r.forEach(e=>{if("_hls.localized-rendition-names"===e["DATA-ID"]&&e.VALUE)try{this._localizedRenditionNames=JSON.parse(e.VALUE),this._audioTracks.forEach(e=>{var t;const r=null===(t=this._localizedRenditionNames)||void 0===t?void 0:t[e.label];r&&(e.localizedRenditionNames=r)}),this.dispatchEvent(ar,this._audioTracks)}catch(t){return void ir.error("Failed to parse _hls.localized-rendition-names",t)}})}handleSubtitleTrackSwitch(e,t){this.isEventForCurrentItem(t)&&this.dispatchEvent(lr,t)}subtitleTracksUpdated(e=[]){const t=[];e.forEach(e=>{0!==e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&t.push(this.normalizeTextTrack(e))}),this._textTracks=t,this.dispatchEvent(cr,t)}normalizeAudioTrack(e){const t=e.MediaSelectionOptionsTaggedMediaCharacteristics,r=(null!=t?t:[]).includes("public.accessibility.describes-video")?"description":"main";return _object_spread_props$m(_object_spread$z({},this.normalizeSelectionOption(e)),{enabled:!1,kind:r,characteristics:t})}normalizeTextTrack(e){var t;let r;return r=(null===(t=e.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===t?void 0:t.includes("public.accessibility.describes-music-and-sound"))||"clcp"===e.MediaSelectionOptionsMediaType?"captions":"subtitles",_object_spread_props$m(_object_spread$z({},this.normalizeSelectionOption(e)),{mode:"disabled",kind:r})}normalizeSelectionOption(e){return{id:e.MediaSelectionOptionsPersistentID,label:e.MediaSelectionOptionsName,language:e.MediaSelectionOptionsExtendedLanguageTag,interstitialId:e.MediaSelectionOptionsInterstitialId,isDefault:e.MediaSelectionOptionsIsDefault}}isEventForCurrentItem(e){return this.currentInterstitialId?e.interstitialId===this.currentInterstitialId:!e.interstitialId}destroy(){this._isDestroyed=!0;const{AUDIO_TRACK_SWITCHED:e,INLINE_STYLES_PARSED:t,INTERSTITIAL_ASSET_STARTED:r,ITEM_PLAYING:n,MANIFEST_LOADED:i,SESSION_DATA_COMPLETE:o,SUBTITLE_TRACK_SWITCH:a}=window.Hls.Events;this.session.off(e,this.handleAudioTrackSwitched),this.session.off(t,this.handleInlineStylesParsed),this.session.off(r,this.handleInterstitialAssetStarted),this.session.off(n,this.handleItemPlaying),this.session.off(i,this.handleManifestLoaded),this.session.off(o,this.handleSessionDataComplete),this.session.off(a,this.handleSubtitleTrackSwitch)}constructor(e){super([or,ar,sr,lr,cr]),_define_property$13(this,"session",void 0),_define_property$13(this,"_audioTracks",void 0),_define_property$13(this,"_textTracks",void 0),_define_property$13(this,"_localizedRenditionNames",void 0),_define_property$13(this,"_isDestroyed",void 0),this.session=e,this._audioTracks=[],this._textTracks=[],this._isDestroyed=!1;const{AUDIO_TRACK_SWITCHED:t,INLINE_STYLES_PARSED:r,INTERSTITIAL_ASSET_STARTED:n,ITEM_PLAYING:i,MANIFEST_LOADED:o,SESSION_DATA_COMPLETE:a,SUBTITLE_TRACK_SWITCH:s}=window.Hls.Events;this.session.on(t,this.handleAudioTrackSwitched),this.session.on(r,this.handleInlineStylesParsed),this.session.on(n,this.handleInterstitialAssetStarted),this.session.on(i,this.handleItemPlaying),this.session.on(o,this.handleManifestLoaded),this.session.on(a,this.handleSessionDataComplete),this.session.on(s,this.handleSubtitleTrackSwitch)}}function _define_property$12(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,"undefined"==typeof ItemPlayingData?Object:ItemPlayingData]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleItemPlaying",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,Object]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleInterstitialAssetStarted",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,Object]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleAudioTrackSwitched",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[void 0,void 0]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleInlineStylesParsed",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,"undefined"==typeof ManifestLoadedData?Object:ManifestLoadedData]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleManifestLoaded",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[void 0,void 0]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleSessionDataComplete",null),_ts_decorate$i([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,"undefined"==typeof SubtitleTrackSwitchData?Object:SubtitleTrackSwitchData]),_ts_metadata$i("design:returntype",void 0)],HlsJsTracks.prototype,"handleSubtitleTrackSwitch",null);class HlsJsPreviewImageLoader{loadPreviewImage(e){return this.lastPosition===e||(this.lastPosition=e,this.lastPromise=new Promise((t,r)=>{this.hls.loadImageIframeData$(e).subscribe(e=>{const{data:r}=e,n=new Blob([r],{type:"image/jpeg"});t(n)})})),this.lastPromise}constructor(e){_define_property$12(this,"hls",void 0),_define_property$12(this,"lastPosition",void 0),_define_property$12(this,"lastPromise",void 0),this.hls=e}}function asyncGeneratorStep$M(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$M(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$M(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$M(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$11(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$h(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$h(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const ur={bufferStalledError:"bufferStalledError",keySystemGenericError:"keySystemGenericError"},pr=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK,MKError.Reason.WIDEVINE_CDM_EXPIRED]),hr=BooleanDevFlag.register("mk-hlsjs-interstitial-playback"),yr=BooleanDevFlag.register("mk-hlsjs-item-preloading"),fr=BooleanDevFlag.register("mk-hlsjs-disable-reuse-video-player"),_r=JsonDevFlag.register("mk-hlsjs-config-overrides"),vr=BooleanDevFlag.get("mk-block-report-cdn-server");class HlsJsVideoPlayer extends VideoPlayer{get keySystem(){return this.services.runtime.preferredKeySystem}get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get supportsPreviewImages(){var e,t;return!this.services.runtime.isMobile&&!!(null===(t=this._hlsSession)||void 0===t||null===(e=t.iframeVariants)||void 0===e?void 0:e.some(e=>"mjpg"===e.imageCodec))}get currentPlayingDate(){var e;return null===(e=this._hlsSession)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const t=this._hlsSession;return!(!t||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!t.isPlayingAtLive}get seekableTimeRanges(){const e=this._hlsSession;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get currentPlaybackDuration(){return this._integratedTimelineDuration?this._timing.time(this._integratedTimelineDuration):super.currentPlaybackDuration}get currentPlaybackTime(){let e={};var t,r;hr.enabled&&(e=null===(t=this._hlsSession)||void 0===t?void 0:t.getCurrentIntegratedTimelineSegmentAndCurrentTime());return null!==(r=null==e?void 0:e.targetTime)&&void 0!==r?r:super.currentPlaybackTime}initializeExtension(){var e=this;return _async_to_generator$M((function*(){e.services.runtime;try{var t;if(!e.hlsScriptURL)throw new Error("HLS.js script URL is not configured");yield Promise.all([loadScript(e.hlsScriptURL),null===(t=e._rtcTracker)||void 0===t?void 0:t.loadScript()])}catch(r){throw fe.error("hlsjs-video-player failed to load script "+e.hlsScriptURL,r),r}}))()}destroy(){var e;if(fe.debug("hlsjs-video-player.destroy"),null===(e=this._hlsJsTracks)||void 0===e||e.destroy(),this._hlsSession){const{DATERANGE_UPDATED:e,ERROR:t,INTERNAL_ERROR:r,INTERSTITIALS_UPDATED:n,MANIFEST_PARSED:i,KEY_REQUEST_STARTED:o,LICENSE_CHALLENGE_CREATED:a,LEVEL_SWITCHED:s,UNRESOLVED_URI_LOADING:l}=window.Hls.Events,c=this._hlsSession;c.detachMedia(),c.off(t,this.handleHlsError),c.off(r,this.handleHlsError),c.off(i,this.handleManifestParsed),c.off(o,this.handleKeyRequestStarted),c.off(a,this.handleLicenseChallengeCreated),c.off(s,this.handleLevelSwitched),c.off(e,this.handleDaterangeUpdated),hr.enabled&&c.off(n,this.handleInterstitialUpdated),this.services.manifest.personalizedManifests&&c.off(l,this.handleUnresolvedUriLoading),c.destroy(),window.hlsSession=void 0}this.unloadPlaybackItem("current"),this.unloadPlaybackItem("next"),super.destroy()}stopMediaAndCleanup(e=he.stopped){var t=this,_superprop_get_stopMediaAndCleanup=()=>super.stopMediaAndCleanup;return _async_to_generator$M((function*(){var r;(fe.debug("hlsjs-video-player.stopMediaAndCleanup",e),yield _superprop_get_stopMediaAndCleanup().call(t,e),!1!==fr.value)?t.destroy():(null===(r=t._hlsSession)||void 0===r||r.detachMedia(),t.unloadPlaybackItem("current"))}))()}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$M((function*(){var i;fe.debug("hlsjs-video-player.playHlsStream",e,t),n._unrecoverableError=void 0,n._hlsSession||n.createHlsPlayer(),n.ensureMediaElementInDocument();const o={requiresCDMAttachOnStart:void 0!==n.keySystem},hasKey=(e,t)=>{var r;return void 0!==(null==t||null===(r=t.keyURLs)||void 0===r?void 0:r[e])};"widevine"===n.keySystem&&hasKey("widevine-cert-url",t)&&(o.maxSecurityLevel="WIDEVINE_SOFTWARE",o.keySystemConfig={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const a={itemId:null==t?void 0:t.id,subs:"accepts-css",platformInfo:o,appData:{serviceName:null===(i=n.appInfo)||void 0===i?void 0:i.name}},{_rtcTracker:s,_hlsSession:l}=n;if(s){const e=s.prepareReportingAgent(t);void 0!==e&&(a.appData.reportingAgent=e)}fe.debug("RTC: loadSource with load options",a);const c=n.startPlaybackSequence();return n.services.manifest.personalizedManifests&&(e=e.replace("https://","manifest://"),fe.info("Manifest already loaded, passing url to HLSJS",e)),void 0!==t&&n.setCurrentPlaybackItem(t),null==l||l.loadSource(e,a,r.startTime),null==l||l.attachMedia(n.video),void 0!==t&&("fairplay"===n.keySystem&&hasKey("hls-key-cert-url",t)?null==l||l.setProtectionData({fairplaystreaming:{serverCertUrl:t.keyURLs["hls-key-cert-url"]}}):hasKey("widevine-cert-url",t)&&(null==l||l.setProtectionData({widevine:{serverCertUrl:t.keyURLs["widevine-cert-url"]}}))),c}))()}preloadItem(e,t){var r=this;return _async_to_generator$M((function*(){return r.preloadNextItem(e,t)}))()}preloadNextItem(e,t){var r=this;return _async_to_generator$M((function*(){if(fe.trace("preloadNextItem",e,t),yr.enabled){var n;const i=r.playbackDataStore.next;if(void 0!==i&&i.id===e.id)return void fe.info(`Source already preloaded for item "${e}"`);fe.info(`Prefetching HLS source for item "${e}"`),r.unloadPlaybackItem("next"),r.playbackDataStore.next={id:e.id,item:e,asset:void 0},null===(n=r._hlsSession)||void 0===n||n.prefetchSource(generateAssetUrl(e,t),{itemId:e.id})}}))()}unloadNextItem(e){var t=this;return _async_to_generator$M((function*(){var r;void 0!==e&&e.id!==(null===(r=t.playbackDataStore.next)||void 0===r?void 0:r.id)||t.unloadPlaybackItem("next")}))()}unloadPlaybackItem(e){var t=this;return _async_to_generator$M((function*(){fe.trace("unloadPlaybackItem(...)",e);const r=t.playbackDataStore[e];var n,i;(t.playbackDataStore[e]=void 0,fe.debug(`Reset ${void 0!==r?"occupied":"unoccupied"} playback slot: ${e}`),void 0!==r&&void 0!==r.licenseChallenge)&&(fe.debug("Revoking license for playback slot: "+e),t._license.revokeLicense(r.item,r.licenseChallenge,{userInitiated:null!==(i=null===(n=r.config)||void 0===n?void 0:n.userInitiated)&&void 0!==i&&i}))}))()}createHlsPlayer(){const{Hls:e}=window,t=tr.get(),{os:r,browser:n}=this.services.runtime,i={clearMediaKeysOnPromise:!1,customTextTrackCueRenderer:!0,debug:!!t,debugLevel:t,enableItemPreloading:yr.enabled,enableIFramePreloading:!1,enablePerformanceLogging:!!t,enablePlayReadyKeySystem:!0,enableQueryParamsForITunes:!this.services.manifest.personalizedManifests,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:"fairplay"===this.keySystem?"fairplaystreaming":this.keySystem,useMediaKeySystemAccessFilter:!0,maintainMediaKeysBetweenSessions:!1,nativeControlsEnabled:r.isAndroid||n.isSafari,enableContentSteering:!0,allowFastSwitchUp:!0,liveAllowLowLatencyPlayback:!0,rtcErrStackNumLines:100,rtcLogHistoryNumLines:100};hr.enabled&&Object.assign(i,{gapless:!0,enableInterstitialPlayback:!0}),(e=>{const{Hls:t}=window;if(t&&vr){const r=deepClone(t.DefaultConfig.fragLoadPolicy);r.default.reportCDNServer=!1,r.customURL.reportCDNServer=!1,e.fragLoadPolicy=r}})(i),(e=>{const t=_r.value;t&&"object"==typeof t&&Object.assign(e,t)})(i);const o=new e(i),{DATERANGE_UPDATED:a,ERROR:s,INTERNAL_ERROR:l,INTERSTITIALS_UPDATED:c,KEY_REQUEST_STARTED:d,LEVEL_SWITCHED:u,LICENSE_CHALLENGE_CREATED:p,MANIFEST_PARSED:h,UNRESOLVED_URI_LOADING:y}=e.Events;o.on(s,this.handleHlsError),o.on(l,this.handleHlsError),o.on(h,this.handleManifestParsed),o.on(d,this.handleKeyRequestStarted),o.on(p,this.handleLicenseChallengeCreated),o.on(u,this.handleLevelSwitched),o.on(a,this.handleDaterangeUpdated),hr.enabled&&o.on(c,this.handleInterstitialUpdated),this.services.manifest.personalizedManifests&&o.on(y,this.handleUnresolvedUriLoading),this._hlsSession=o,window.hlsSession=o,this._hlsJsTracks=new HlsJsTracks(this._hlsSession),this.setupTrackManagers(this._hlsJsTracks),this._hlsPreviewImageLoader=new HlsJsPreviewImageLoader(this._hlsSession)}setCurrentPlaybackItem(e){var t;this.unloadPlaybackItem("current");let r={id:e.id,item:e,asset:void 0,config:{userInitiated:this.userInitiated}};return e.id===(null===(t=this.playbackDataStore.next)||void 0===t?void 0:t.id)&&(r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$11(e,t,r[t])}))}return e}({},this.playbackDataStore.next,r),this.playbackDataStore.next=void 0),this.playbackDataStore.current=r,r}handleUnresolvedUriLoading(e,t){var r=this;return _async_to_generator$M((function*(){const e=r._hlsSession,n=t.uri,i=n.replace("manifest://","https://");fe.debug("handleUnresolvedUriLoading for uri ",n);const o=r.services.manifest;var a;const s=null!==(a=yield o.getManifest(i))&&void 0!==a?a:yield o.fetchManifest(i);s?(yield o.clearManifest(i),null==e||e.handleResolvedUri(n,{url:i,status:200,data:s.content})):fe.error("No cached manifest for "+i)}))()}handleInterstitialUpdated(e,t){fe.debug("handleInterstitialUpdated - ",e,t),t.integratedTimeline.duration&&(this._integratedTimelineDuration=t.integratedTimeline.duration)}handleLevelSwitched(e,t){var r,n;const{level:i}=t;if(!i)return;const o=null===(r=this._levels)||void 0===r?void 0:r.find(e=>e.persistentId===i);if(!o||(null===(n=this._currentLevel)||void 0===n?void 0:n.persistentId)===(null==o?void 0:o.persistentId))return;this._currentLevel=o;const a=void 0!==o.audioGroupId?this._channelsByGroup[o.audioGroupId]:void 0;this._dispatcher.publish(me.hlsLevelUpdated,{level:o,channels:a})}handleDaterangeUpdated(e,t){fe.info("handleDaterangeUpdated",JSON.stringify(t)),this._dispatcher.publish(Be.hlsDaterangeUpdated,t)}handleHlsError(e,t){var r;if(fe.warn("HLS.js error",JSON.stringify(t)),this._unrecoverableError)return;let n=new MKError(MKError.Reason.UNSUPPORTED_ERROR,t.reason);n.data=t;const{bufferStalledError:i,keySystemGenericError:o}=ur;if(t.details===o)return void this._dispatcher.publish(o,n);let a=!1;var s;t.details===i&&"Seek"===t.stallType&&-12909===(null===(r=t.response)||void 0===r?void 0:r.code)&&(n=new MKError(MKError.Reason.BUFFER_STALLED_ERROR,t.stallType),n.data={stallType:t.stallType,code:null===(s=t.response)||void 0===s?void 0:s.code},a=!0);if("output-restricted"===t.reason&&(n=new MKError(MKError.Reason.OUTPUT_RESTRICTED,t.reason)),t.fatal){var l;if(null===(l=this._hlsSession)||void 0===l||l.destroy(),!this.shouldDispatchErrors&&!a)throw n;this._dispatcher.publish(Be.mediaPlaybackError,n)}}handleManifestParsed(e,t){var r=this;return _async_to_generator$M((function*(){var e,n;fe.debug("handleManifestParsed",t),r._levels=null!==(e=t.levels)&&void 0!==e?e:[],r.nowPlayingItem.state=y.ready,r._channelsByGroup=(null!==(n=t.audioTracks)&&void 0!==n?n:[]).reduce((e,t)=>(e[t.groupId]=t.channels,e),{});try{yield r._playMedia()}catch(i){throw fe.warn("error from media element, possibly non-fatal",i),i}finally{r.finishPlaybackSequence()}}))()}handleKeyRequestStarted(e,t){var r;fe.debug("hlsjs-video.handleKeyRequestStarted"),null===(r=this._hlsSession)||void 0===r||r.generateKeyRequest(t.keyuri,{})}handleLicenseChallengeCreated(e,t){var r=this;return _async_to_generator$M((function*(){var e,n;fe.trace("handleLicenseChallengeCreated",t);const{userInitiated:i}=r,a=null===(e=t.appItemIds)||void 0===e?void 0:e[0];if(void 0===a)throw new MKUniqueError("mk-185",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to locate item id for license challenge request"});const s=(null===(n=r.playbackDataStore.next)||void 0===n?void 0:n.id)===a?r.playbackDataStore.next:r.playbackDataStore.current;if(void 0===s)throw new MKUniqueError("mk-186",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to locate playback data for license challenge request"});try{const e=yield r._license.requestLicense(s.item,t,{userInitiated:i}),n={statusCode:e.status};(null==e?void 0:e.license)&&("fairplay"===r.keySystem?n.ckc=o(e.license):n.license=o(e.license));const a=e["renew-after"];a&&(n.renewalDate=new Date(Date.now()+1e3*a)),s.licenseChallenge=t,s.licenseKey=n,s.config={stkn:e.stkn,userInitiated:i},t.resolve(n)}catch(xe){if(r._unrecoverableError)return;const n=xe.data,o={};void 0!==(null==n?void 0:n.status)&&(o.statusCode=parseInt(n.status,10)),fe.warn("Passing license response error to Hls.js",o),t.resolve(o),MKError.isMKError(xe)&&pr.has(xe.reason)&&(r._unrecoverableError=xe,r.resetDeferredPlay(),yield r.stop({endReasonType:be.FAILED_TO_LOAD,userInitiated:i})),r.onPlaybackLicenseError(xe)}}))()}seekToTime(e){var t=this;return _async_to_generator$M((function*(){t._hlsSession?(fe.debug("hlsjs-video: hls seekTo",e),t._hlsSession.seekTo=e):(fe.debug("hlsjs-video: media element seek to",e),t._targetElement.currentTime=e)}))()}loadPreviewImage(e){var t=this;return _async_to_generator$M((function*(){var r;return null===(r=t._hlsPreviewImageLoader)||void 0===r?void 0:r.loadPreviewImage(e)}))()}constructor(e){var t,r,n;super(e),_define_property$11(this,"_hlsSession",void 0),_define_property$11(this,"_hlsPreviewImageLoader",void 0),_define_property$11(this,"_hlsJsTracks",void 0),_define_property$11(this,"_license",void 0),_define_property$11(this,"_rtcTracker",void 0),_define_property$11(this,"_levels",void 0),_define_property$11(this,"_channelsByGroup",{}),_define_property$11(this,"_currentLevel",void 0),_define_property$11(this,"_unrecoverableError",void 0),_define_property$11(this,"_integratedTimelineDuration",void 0),_define_property$11(this,"hlsScriptURL",void 0),_define_property$11(this,"appInfo",void 0),_define_property$11(this,"playbackDataStore",{}),this._rtcTracker=null==e||null===(t=e.playbackServices)||void 0===t?void 0:t.getRTCStreamingTracker(),this._license=e.services.license,this.hlsScriptURL=null===(r=e.bag)||void 0===r?void 0:r.urls.hls,this.appInfo=null===(n=e.bag)||void 0===n?void 0:n.app}}var mr;function _define_property$10(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$g(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$g(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[String,"undefined"==typeof HlsUnresolvedUriData?Object:HlsUnresolvedUriData]),_ts_metadata$h("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleUnresolvedUriLoading",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[String,Object]),_ts_metadata$h("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleInterstitialUpdated",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[void 0,void 0]),_ts_metadata$h("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[String,"undefined"==typeof HlsDaterangeUpdatedData?Object:HlsDaterangeUpdatedData]),_ts_metadata$h("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleDaterangeUpdated",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[void 0,void 0]),_ts_metadata$h("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleHlsError",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[void 0,void 0]),_ts_metadata$h("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleManifestParsed",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[void 0,void 0]),_ts_metadata$h("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[String,"undefined"==typeof HlsLicenseChallengeCreatedData?Object:HlsLicenseChallengeCreatedData]),_ts_metadata$h("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$h([AsyncDebounce(250),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[Number]),_ts_metadata$h("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"seekToTime",null),_ts_decorate$h([(mr=250,(e,t,r)=>{const n=function(e,t){let r,n,i=0;const resetState=()=>{clearTimeout(n),n=0,r=void 0};return function(...o){const a=this;return new Promise((function(s,l){const c=Date.now();c-i<t?(r&&(r.resolve(void 0),resetState()),r={resolve:s,reject:l,args:o},n=setTimeout(()=>{e.apply(a,r.args).then(r.resolve).catch(r.reject),resetState()},t-(c-i+1))):(resetState(),i=c,e.apply(a,o).then(s).catch(l))}))}}(r.value,mr);r.value=n}),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[Number]),_ts_metadata$h("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"loadPreviewImage",null);class ID3MetadataTrackManager{get activeMetadata(){return this._activeMetadata}get activeCues(){var e;const t=null===(e=this.metadataTrack)||void 0===e?void 0:e.activeCues;return null!=t?Array.from(t):[]}get isDestroyed(){return this._isDestroyed}get tracks(){return void 0!==this.metadataTrack?[this.metadataTrack]:[]}get currentTrack(){return this.metadataTrack}attach(e){if(void 0!==this.mediaElement&&this.mediaElement!==e)throw new Error("MetadaTrackManager is already attached to a different HTMLMediaElement.");this.mediaElement!==e&&(this.mediaElement=e,this.mediaElement.addEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.addEventListener("loadeddata",this.registerMetadataTrack))}detach(){void 0!==this.mediaElement&&(this.mediaElement.removeEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.removeEventListener("loadeddata",this.registerMetadataTrack),this.mediaElement=void 0),void 0!==this.metadataTrack&&(this.metadataTrack.removeEventListener("cuechange",this.onCueChange),this.metadataTrack=void 0)}registerMetadataTrack(e){if(void 0!==this.mediaElement)for(let r=0;r<this.mediaElement.textTracks.length;r++){const e=this.mediaElement.textTracks[r];if("metadata"===e.kind){var t;if(void 0===this.metadataTrack)this.metadataTrack=e,this.metadataTrack.addEventListener("cuechange",this.onCueChange);else ir.warning(`Skipping registering metadata TextTrack with id "${null!==(t=e.id)&&void 0!==t?t:"unknown"}"`);break}}}onCueChange(e){if(ir.debug("Processing metadata cues"),void 0===this.activeCues||this.activeCues.length<=0){var t;if(void 0!==this.activeMetadata)null===(t=this.onchange)||void 0===t||t.call(this);this._activeMetadata=void 0}else{const e=function(e){const t={};for(const i of e){if(!isTextTrackID3FrameCue(i)||void 0===(null==i?void 0:i.value))continue;const e=i.value;switch(e.key){case"TALB":t.album=e.data;break;case"TIT2":t.title=e.data;break;case"TPE1":t.performer=e.data;break;case"WXXX":var r,n;if(t.links=null!==(r=t.links)&&void 0!==r?r:[],!t.links.some(({url:t})=>t===e.data))t.links.push({description:null!==(n=e.description)&&void 0!==n?n:"",url:e.data});break;case"PRIV":{const r=e.owner||e.info;"com.apple.radio.ping.jingle"===r&&(t.blob=parsePingBlob(e.data)),"com.apple.radio.adamid"===r&&(t.storefrontAdamIds=parseStorefrontAdamIds(e.data));break}}}return new TimedMetadata(t)}(this.activeCues);var r;if(void 0===this.activeMetadata||!e.equals(this.activeMetadata))ir.debug("Track TimedMetadata changed",e),this._activeMetadata=e,null===(r=this.onchange)||void 0===r||r.call(this,e)}}saveTrack(){}restoreSelectedTrack(){}destroy(){this._isDestroyed=!0,this.onchange=void 0,this.detach()}constructor(e){_define_property$10(this,"_isDestroyed",!1),_define_property$10(this,"mediaElement",void 0),_define_property$10(this,"metadataTrack",void 0),_define_property$10(this,"_activeMetadata",void 0),_define_property$10(this,"onchange",void 0),this.onchange=null==e?void 0:e.onchange,void 0!==(null==e?void 0:e.element)&&this.attach(e.element)}}function asyncGeneratorStep$L(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$L(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$L(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$L(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$$(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$f(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$f(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$g([Bind(),_ts_metadata$g("design:type",Function),_ts_metadata$g("design:paramtypes",[Object]),_ts_metadata$g("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"registerMetadataTrack",null),_ts_decorate$g([Bind(),_ts_metadata$g("design:type",Function),_ts_metadata$g("design:paramtypes",[Object]),_ts_metadata$g("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"onCueChange",null);const gr=BooleanDevFlag.register("mk-hlsjs-item-preloading"),br={keySystemGenericError:"keySystemGenericError"},Sr=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK]),Pr=fe.createChild("hlsjs-audio"),kr=JsonDevFlag.register("mk-hlsjs-config-overrides");class HlsJsAudioPlayer extends BasePlayer{loadPreviewImage(){return _async_to_generator$L((function*(){}))()}get _targetElement(){return this.mediaElement}setPresentationMode(e){return _async_to_generator$L((function*(){return Promise.resolve()}))()}get keySystem(){return this.services.runtime.preferredKeySystem}get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get currentPlayingDate(){var e;return null===(e=this.hls)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const t=this.hls;return!(!t||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!t.isPlayingAtLive}playItemFromEncryptedSource(e,t=!1,r={}){var n=this;return _async_to_generator$L((function*(){Pr.trace("HlsJsAudioPlayer.playItemFromEncryptedSource",e,r),n.playbackState!==he.stopped?(Pr.debug("Playing Encrypted Item: "+mediaItemLogString(e)),e.playbackType=h.encryptedFull,n.nowPlayingItem=e,e.state=y.loading,n.userInitiated=t,yield n.playHlsStream(e.assetURL,e,r)):Pr.debug("hlsjsAudioPlayer.playItemFromEncryptedSource aborting playback because player is stopped")}))()}initializeMediaElement(){var e=this;return _async_to_generator$L((function*(){const t=nextAvailableAudioElement();t.autoplay=!1,t.id="apple-music-player",t.controls=!1,t.muted=!1,t.playbackRate=1,t.preload="metadata",t.volume=1,e.mediaElement=t,document.body.appendChild(t),e.id3MetadataManager.attach(t),Pr.debug("initializedMediaElement",t)}))()}get seekableTimeRanges(){const e=this.hls;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}initializeExtension(){var e=this;return _async_to_generator$L((function*(){try{var t;if(!e.hlsScriptURL)throw new Error("HLS.js script URL is not configured");yield Promise.all([loadScript(e.hlsScriptURL),null===(t=e._rtcTracker)||void 0===t?void 0:t.loadScript()])}catch(r){throw Pr.error("hlsjs-audio-player failed to load script "+e.hlsScriptURL,r),r}}))()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$L((function*(){Pr.trace("HlsJsAudioPlayer.stopMediaElement()"),yield _superprop_get_stopMediaElement().call(e),e.destroy()}))()}stopMediaAndCleanup(e=he.stopped){var t=this,_superprop_get_stopMediaAndCleanup=()=>super.stopMediaAndCleanup;return _async_to_generator$L((function*(){t.nowPlayingItem,Pr.debug("hlsjs-video-player.stopMediaAndCleanup",e),yield _superprop_get_stopMediaAndCleanup().call(t,e),t.unloadPlaybackItem("current"),t.destroy()}))()}destroy(){if(Pr.debug("HlsJsAudioPlayer.destroy()"),this.hls){const e=this.hls;e.stopLoad();const t=e.Events;e.off(t.ERROR,this.handleHlsError),e.off(t.INTERNAL_ERROR,this.handleHlsError),e.off(t.MANIFEST_PARSED,this.handleManifestParsed),e.off(t.KEY_REQUEST_STARTED,this.handleKeyRequestStarted),e.off(t.LICENSE_CHALLENGE_CREATED,this.handleLicenseChallengeCreated),e.off(t.LEVEL_SWITCHED,this.handleLevelSwitched),e.destroy()}this.id3MetadataManager.destroy(),this.unloadPlaybackItem("current"),this.unloadPlaybackItem("next"),super.destroy()}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$L((function*(){var i;let o,a;Pr.trace("HlsJsAudioPlayer.playHlsStream()",e,t,r),n._unrecoverableError=void 0,Pr.debug("Initiating HLS.js player"),n.createHlsPlayer(),"widevine"===n.keySystem&&(Pr.debug("Setting Widevine specific HLS options"),o="WIDEVINE_SOFTWARE",a={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const s={subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:void 0!==n.keySystem,maxSecurityLevel:o,keySystemConfig:a},appData:{serviceName:null===(i=n.appInfo)||void 0===i?void 0:i.name},itemId:null==t?void 0:t.id};if(void 0!==n._rtcTracker){const e=n._rtcTracker.prepareReportingAgent(t);void 0!==e&&(Pr.debug("Adding RTC agent to loadSource options",e),s.appData.reportingAgent=e)}void 0!==t&&n.setCurrentPlaybackItem(t),Pr.info("Loading source into HLS.js: "+e),Pr.debug("Calling loadSource with options",s),n.hls.loadSource(e,s,r.startTime),Pr.debug("Attaching HTMLMediaElement to HLS instance",n.mediaElement),n.hls.attachMedia(n.mediaElement),t&&("fairplay"===n.keySystem?(Pr.info("Setting Protection Data URL for FairPlay: "+t.keyURLs["hls-key-cert-url"]),n.hls.setProtectionData({fairplaystreaming:{serverCertUrl:t.keyURLs["hls-key-cert-url"]}})):(Pr.info("Setting Protection Data URL for Widevine: "+t.keyURLs["widevine-cert-url"]),n.hls.setProtectionData({widevine:{serverCertUrl:t.keyURLs["widevine-cert-url"]}})),t.state=y.ready),n.hls.setRate(1)}))()}setCurrentPlaybackItem(e){var t;this.unloadPlaybackItem("current");let r={id:e.id,item:e,asset:void 0,config:{userInitiated:this.userInitiated}};return e.id===(null===(t=this.playbackDataStore.next)||void 0===t?void 0:t.id)&&(r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$$(e,t,r[t])}))}return e}({},this.playbackDataStore.next,r),this.playbackDataStore.next=void 0),this.playbackDataStore.current=r,r}preloadItem(e,t){var r=this;return _async_to_generator$L((function*(){return r.preloadNextItem(e,t)}))()}preloadNextItem(e,t){var r=this;return _async_to_generator$L((function*(){if(Pr.trace("preloadNextItem",e,t),gr.enabled){var n;const i=r.playbackDataStore.next;if(void 0!==i&&i.id===e.id)return void Pr.info(`Source already preloaded for item "${e}"`);Pr.info(`Prefetching HLS source for item "${e}"`),r.unloadPlaybackItem("next"),r.playbackDataStore.next={id:e.id,item:e,asset:void 0},null===(n=r.hls)||void 0===n||n.prefetchSource(generateAssetUrl(e,t),{itemId:e.id})}}))()}unloadNextItem(e){var t=this;return _async_to_generator$L((function*(){var r;void 0!==e&&e.id!==(null===(r=t.playbackDataStore.next)||void 0===r?void 0:r.id)||t.unloadPlaybackItem("next")}))()}unloadPlaybackItem(e){var t=this;return _async_to_generator$L((function*(){const r=t.playbackDataStore[e];var n,i;(t.playbackDataStore[e]=void 0,void 0!==r&&void 0!==r.licenseChallenge)&&t._license.revokeLicense(r.item,r.licenseChallenge,{userInitiated:null!==(i=null===(n=r.config)||void 0===n?void 0:n.userInitiated)&&void 0!==i&&i})}))()}createHlsPlayer(){Pr.trace("HlsJsAudioPlayer.createHlsPlayer()");const{os:e}=this.services.runtime,{Hls:t}=window,r=tr.get(),n={clearMediaKeysOnPromise:!1,debug:!!r,debugLevel:r,enableItemPreloading:gr.enabled,enablePerformanceLogging:!!r,enablePlayReadyKeySystem:!0,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:"fairplay"===this.keySystem?"fairplaystreaming":this.keySystem,useMediaKeySystemAccessFilter:!0,nativeControlsEnabled:e.isAndroid,enableID3Cues:!0,rtcErrStackNumLines:100,rtcLogHistoryNumLines:100};Pr.debug("Reading HLS.js option overrides from DevFlag"),(e=>{const t=kr.value;t&&"object"==typeof t&&Object.assign(e,t)})(n),Pr.debug("Constructing HLS instance",n);const i=new t(n);Pr.debug("Using HLS instance with ID "+i.sessionID,n),Pr.debug("Adding Event handlers for HLS instance"),i.on(t.Events.ERROR,this.handleHlsError),i.on(t.Events.INTERNAL_ERROR,this.handleHlsError),i.on(t.Events.MANIFEST_PARSED,this.handleManifestParsed),i.on(t.Events.KEY_REQUEST_STARTED,this.handleKeyRequestStarted),i.on(t.Events.LICENSE_CHALLENGE_CREATED,this.handleLicenseChallengeCreated),i.on(t.Events.LEVEL_SWITCHED,this.handleLevelSwitched),this.hls=i}handleLevelSwitched(e,t){var r,n;const{level:i}=t;if(!i)return;const o=null===(r=this._levels)||void 0===r?void 0:r.find(e=>e.persistentId===i);if(!o||(null===(n=this._currentLevel)||void 0===n?void 0:n.persistentId)===(null==o?void 0:o.persistentId))return;this._currentLevel=o;const a=void 0!==o.audioGroupId?this._channelsByGroup[o.audioGroupId]:void 0;this._dispatcher.publish(me.hlsLevelUpdated,{level:o,channels:a})}handleHlsError(e,t){if(Pr.warn("HLS.js error",JSON.stringify(t)),this._unrecoverableError)return;let r=new MKError(MKError.Reason.UNSUPPORTED_ERROR,t.reason);r.data=t;const{keySystemGenericError:n}=br;if(t.details!==n){if("output-restricted"===t.reason&&(r=new MKError(MKError.Reason.OUTPUT_RESTRICTED,t.reason)),t.fatal){if(this.hls.destroy(),!this.shouldDispatchErrors)throw r;this._dispatcher.publish(Be.mediaPlaybackError,r)}}else this._dispatcher.publish(n,r)}handleManifestParsed(e,t){var r=this;return _async_to_generator$L((function*(){var e,n;Pr.debug("handleManifestParsed",t),r._levels=null!==(e=t.levels)&&void 0!==e?e:[],r.nowPlayingItem.state=y.ready,r._channelsByGroup=(null!==(n=t.audioTracks)&&void 0!==n?n:[]).reduce((e,t)=>(e[t.groupId]=t.channels,e),{})}))()}handleKeyRequestStarted(e,t){var r,n;Pr.trace("HlsJsAudioPlayer.handleKeyRequestStarted()",t);const i=null!==(n=null===(r=t.appItemIds)||void 0===r?void 0:r[0])&&void 0!==n?n:"unknown";Pr.debug(`Generating key request for item ${i} with URI ${t.keyuri}`),this.hls.generateKeyRequest(t.keyuri,{})}handleLicenseChallengeCreated(e,t){var r=this;return _async_to_generator$L((function*(){var e,n;Pr.trace("HlsJsAudioPlayer.handleLicenseChallengeCreated()",t);const i=null===(e=t.appItemIds)||void 0===e?void 0:e[0];if(void 0===i)throw new MKUniqueError("mk-191",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to locate item id for license challenge request"});const a=(null===(n=r.playbackDataStore.next)||void 0===n?void 0:n.id)===i?r.playbackDataStore.next:r.playbackDataStore.current;if(void 0===a)throw new MKUniqueError("mk-192",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to locate playback data for license challenge request"});Pr.debug(`Handling License Challenge for item ${i} with URI ${t.keyuri}`);const{userInitiated:s}=r;try{const e=yield r._license.requestLicense(a.item,t,{userInitiated:s}),n={statusCode:e.status};(null==e?void 0:e.license)&&("fairplay"===r.keySystem?n.ckc=o(e.license):n.license=o(e.license));const i=e["renew-after"];i&&(n.renewalDate=new Date(Date.now()+1e3*i)),a.licenseChallenge=t,a.licenseKey=n,a.config={userInitiated:s},Pr.debug(`Passing License Challenge Response for ${t.keyuri} to HLS`,n),t.resolve(n)}catch(l){if(r._unrecoverableError)return;const e=l.data,n={};void 0!==(null==e?void 0:e.status)&&(n.statusCode=+e.status),Pr.warn("Passing license response error to Hls.js",n),t.resolve(n),Sr.has(l.reason)&&(r._unrecoverableError=l,r.resetDeferredPlay(),yield r.stop({endReasonType:be.FAILED_TO_LOAD,userInitiated:r.userInitiated})),r.onPlaybackLicenseError(l)}}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(et.playbackLicenseError,e)}seekToTime(e){var t=this;return _async_to_generator$L((function*(){t.hls?(Pr.debug("hlsjs-video: hls seekTo",e),t.hls.seekTo=e):(Pr.debug("hlsjs-video: media element seek to",e),t._targetElement.currentTime=e)}))()}constructor(e){var t,r,n;super(e),_define_property$$(this,"currentAudioTrack",void 0),_define_property$$(this,"currentTextTrack",void 0),_define_property$$(this,"textTracks",[]),_define_property$$(this,"audioTracks",[]),_define_property$$(this,"userInitiated",!1),_define_property$$(this,"mediaElement",void 0),_define_property$$(this,"mediaPlayerType","hlsjs-audio"),_define_property$$(this,"hls",void 0),_define_property$$(this,"supportsPreviewImages",!1),_define_property$$(this,"extension",void 0),_define_property$$(this,"_license",void 0),_define_property$$(this,"_rtcTracker",void 0),_define_property$$(this,"_levels",void 0),_define_property$$(this,"_channelsByGroup",{}),_define_property$$(this,"_currentLevel",void 0),_define_property$$(this,"_unrecoverableError",void 0),_define_property$$(this,"hlsScriptURL",void 0),_define_property$$(this,"appInfo",void 0),_define_property$$(this,"id3MetadataManager",void 0),_define_property$$(this,"playbackDataStore",{}),this._rtcTracker=null==e||null===(t=e.playbackServices)||void 0===t?void 0:t.getRTCStreamingTracker(),this._license=e.services.license,this.appInfo=null===(r=e.bag)||void 0===r?void 0:r.app,this.hlsScriptURL=null===(n=e.bag)||void 0===n?void 0:n.urls.hls,this.id3MetadataManager=new ID3MetadataTrackManager({onchange:e=>{var t;const r={item:this.nowPlayingItem,metadata:e,position:this.currentPlaybackTime,playingDate:this.currentPlayingDate};Pr.debug("Dispatching bufferTimedMetadataDidChange",r),null===(t=this._dispatcher)||void 0===t||t.publish(Kt,r)}})}}_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleHlsError",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleManifestParsed",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[Object,Object]),_ts_metadata$f("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[String,"undefined"==typeof HlsLicenseChallengeCreatedData?Object:HlsLicenseChallengeCreatedData]),_ts_metadata$f("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",["undefined"==typeof Error?Object:Error]),_ts_metadata$f("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"onPlaybackLicenseError",null),_ts_decorate$f([AsyncDebounce(250),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[Number]),_ts_metadata$f("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"seekToTime",null),e.version="3.2542.1";const Tr=e.version.split("."),Er=Tr[0],wr=Tr[Tr.length-1];Tr[0]="3",Tr[Tr.length-1]=wr+"-prerelease",Tr[0]=Er,Tr[Tr.length-1]=wr,e.version=Tr.join(".");var Ir=function(e){return e[e.PREVIEW_ONLY=0]="PREVIEW_ONLY",e[e.MIXED_CONTENT=1]="MIXED_CONTENT",e[e.FULL_PLAYBACK_ONLY=2]="FULL_PLAYBACK_ONLY",e[e.SHAREPLAY_PARTICIPANT=3]="SHAREPLAY_PARTICIPANT",e}({});const Ar={configured:"musickitconfigured",loaded:"musickitloaded",audioTrackAdded:Be.audioTrackAdded,audioTrackChanged:Be.audioTrackChanged,audioTrackRemoved:Be.audioTrackRemoved,authorizationStatusDidChange:ce.authorizationStatusDidChange,authorizationStatusWillChange:ce.authorizationStatusWillChange,bufferedProgressDidChange:Be.bufferedProgressDidChange,capabilitiesChanged:"capabilitiesChanged",autoplayEnabledDidChange:"autoplayEnabledDidChange",drmUnsupported:Be.drmUnsupported,eligibleForSubscribeView:ce.eligibleForSubscribeView,forcedTextTrackChanged:Be.forcedTextTrackChanged,hlsDaterangeUpdated:Be.hlsDaterangeUpdated,mediaCanPlay:Be.mediaCanPlay,mediaElementCreated:Be.mediaElementCreated,mediaItemStateDidChange:we.mediaItemStateDidChange,mediaItemStateWillChange:we.mediaItemStateWillChange,mediaPlaybackError:Be.mediaPlaybackError,mediaSkipAvailable:"mediaSkipAvailable",mediaRollEntered:"mediaRollEntered",mediaUpNext:"mediaUpNext",metadataDidChange:Be.metadataDidChange,needsGDPRDidChange:"needsGDPRDidChange",nowPlayingItemDidChange:Be.nowPlayingItemDidChange,nowPlayingItemWillChange:Be.nowPlayingItemWillChange,playInitiated:"playInitiated",playbackBitrateDidChange:Be.playbackBitrateDidChange,playbackDurationDidChange:Be.playbackDurationDidChange,playbackProgressDidChange:Be.playbackProgressDidChange,playbackRateDidChange:Be.playbackRateDidChange,playbackStateDidChange:Be.playbackStateDidChange,playbackStateWillChange:Be.playbackStateWillChange,playbackTargetAvailableDidChange:Be.playbackTargetAvailableDidChange,playbackTargetIsWirelessDidChange:Be.playbackTargetIsWirelessDidChange,playbackTimeDidChange:Be.playbackTimeDidChange,playbackVolumeDidChange:Be.playbackVolumeDidChange,playerTypeDidChange:Be.playerTypeDidChange,presentationModeDidChange:Be.presentationModeDidChange,primaryPlayerDidChange:Be.primaryPlayerDidChange,queueIsReady:"queueIsReady",queueItemsDidChange:"queueItemsDidChange",queueItemForStartPosition:"queueItemForStartPosition",queuePositionDidChange:"queuePositionDidChange",shuffleModeDidChange:"shuffleModeDidChange",repeatModeDidChange:"repeatModeDidChange",storefrontCountryCodeDidChange:ce.storefrontCountryCodeDidChange,storefrontIdentifierDidChange:ce.storefrontIdentifierDidChange,textTrackAdded:Be.textTrackAdded,textTrackChanged:Be.textTrackChanged,textTrackRemoved:Be.textTrackRemoved,timedMetadataDidChange:Be.timedMetadataDidChange,userTokenDidChange:ce.userTokenDidChange,webComponentsLoaded:"musickitwebcomponentsloaded"};function parseSkipItems(e){const t=parseInt(e.hlsMetadata["skip.count"],10),r=[];if(isNaN(t)||0===t)return r;for(let n=0;n<t;n++){const t={start:parseFloat(e.hlsMetadata[`skip.${n}.start`]),duration:parseFloat(e.hlsMetadata[`skip.${n}.duration`]),target:parseFloat(e.hlsMetadata[`skip.${n}.target`]),label:e.hlsMetadata[`skip.${n}.label`]};void 0!==e.hlsMetadata[`skip.${n}.promo.enabled`]&&(t.promo={enabled:"true"===e.hlsMetadata[`skip.${n}.promo.enabled`],image:e.hlsMetadata[`skip.${n}.promo.image`],"image-height":parseInt(e.hlsMetadata[`skip.${n}.promo.image-height`],10),"image-width":parseInt(e.hlsMetadata[`skip.${n}.promo.image-width`],10),genre:e.hlsMetadata[`skip.${n}.promo.genre`],"release-year":parseInt(e.hlsMetadata[`skip.${n}.promo.release-year`],10),"rating-display-name":e.hlsMetadata[`skip.${n}.promo.rating-display-name`],"rating-system":e.hlsMetadata[`skip.${n}.promo.rating-system`],"canonical-id":e.hlsMetadata[`skip.${n}.promo.canonical-id`],title:e.hlsMetadata[`skip.${n}.promo.title`],"rating-tag":e.hlsMetadata[`skip.${n}.promo.rating-tag`],"rating-rank":e.hlsMetadata[`skip.${n}.promo.rating-rank`],"up-next":{"is-added":"true"===e.hlsMetadata[`skip.${n}.promo.up-next.is-added`],"add-label":e.hlsMetadata[`skip.${n}.promo.up-next.add-label`],"added-label":e.hlsMetadata[`skip.${n}.promo.up-next.added-label`]},runtime:parseInt(e.hlsMetadata[`skip.${n}.promo.runtime`],10)}),r.push(t)}return r}function parseRollItems(e,t=["pre-roll","mid-roll","post-roll"]){if(void 0===e.hlsMetadata)return[];const r=[];return t.forEach(t=>{const n=parseInt(e.hlsMetadata[t+".count"],10);if(!isNaN(n))for(let i=0;i<n;i++){const n=`${t}.${i}`,o={index:i,type:t,skippable:"true"===e.hlsMetadata[n+".skippable"],"adam-id":e.hlsMetadata[n+".adam-id"],start:Math.round(parseFloat(e.hlsMetadata[n+".start"])),duration:Math.round(parseFloat(e.hlsMetadata[n+".duration"]))},a=n+".dynamic-slot.data-set-id";void 0!==e.hlsMetadata[a]&&(o["dynamic-id"]=e.hlsMetadata[a]),r.push(o)}}),r}const addRollItemDuration=(e,t)=>e+t.duration;function asyncGeneratorStep$K(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$_(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$e(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class SpanWatcher{startMonitor(){this.dispatcher.unsubscribe(Ar.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Ar.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Ar.playbackTimeDidChange,this.handleTimeChange)}handleTimeChange(e,{currentPlaybackTime:t}){var r,n=this;return(r=function*(){!Number.isFinite(t)||t<n.start||t>n.stop?n.inWatchSpan=!1:n.inWatchSpan||(n.allowMultiple||n.stopMonitor(),n.inWatchSpan=!0,yield n.callback(t,n))},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$K(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$K(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,t,r,n,i=!1){_define_property$_(this,"dispatcher",void 0),_define_property$_(this,"callback",void 0),_define_property$_(this,"start",void 0),_define_property$_(this,"stop",void 0),_define_property$_(this,"allowMultiple",void 0),_define_property$_(this,"inWatchSpan",void 0),this.dispatcher=e,this.callback=t,this.start=r,this.stop=n,this.allowMultiple=i,this.inWatchSpan=!1}}function _define_property$Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[void 0,void 0]),_ts_metadata$e("design:returntype",Promise)],SpanWatcher.prototype,"handleTimeChange",null);class PlaybackMonitor{activate(){this.isActive=!0,this.startMonitor()}deactivate(){this.isActive=!1,this.clearMonitor()}clearMonitor(){this.isMonitoring&&(this.watchers.forEach(e=>e.stopMonitor()),this.isMonitoring=!1)}shouldMonitor(){return this.isActive}startMonitor(){this.shouldMonitor()&&(this.watchers.forEach(e=>e.startMonitor()),this.isMonitoring=!0)}handleMediaItemChange(){this.isActive&&(this.clearMonitor(),this.shouldMonitor()&&this.startMonitor())}constructor(e){_define_property$Z(this,"isActive",!1),_define_property$Z(this,"isMonitoring",!1),_define_property$Z(this,"dispatcher",void 0),_define_property$Z(this,"playbackController",void 0),_define_property$Z(this,"watchers",[]),this.handlePlaybackThreshold=this.handlePlaybackThreshold.bind(this),this.playbackController=e.controller,this.dispatcher=e.services.dispatcher,this.dispatcher.subscribe(Ar.nowPlayingItemDidChange,this.handleMediaItemChange)}}function asyncGeneratorStep$J(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$d("design:type",Function),_ts_metadata$d("design:paramtypes",[]),_ts_metadata$d("design:returntype",void 0)],PlaybackMonitor.prototype,"handleMediaItemChange",null);class RollMonitor extends PlaybackMonitor{handlePlaybackThreshold(e,t){var r,n=this;return(r=function*(){if(!n.rollMap.has(t))return;const e=n.rollMap.get(t);n.dispatcher.publish(Ar.mediaRollEntered,e),n.rollMap.delete(t)},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$J(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$J(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getRollMetadata().length>0}startMonitor(){this.setupWatchers(this.getRollMetadata()),super.startMonitor()}getRollMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseRollItems(e,["pre-roll","post-roll"])}setupWatchers(e){const t=[];e.forEach(e=>{const{start:r,duration:n}=e,i=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,r,r+n);t.push(i),this.rollMap.set(i,e)}),this.watchers=t}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"rollMap",new Map)}}function asyncGeneratorStep$I(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}class SkipAvailable extends PlaybackMonitor{handlePlaybackThreshold(e,t){var r,n=this;return(r=function*(){if(!n.skipMap.has(t))return;const e=n.skipMap.get(t);n.dispatcher.publish(Ar.mediaSkipAvailable,e)},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$I(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$I(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getNowPlayingMetadata().length>0}startMonitor(){this.setupWatchers(this.getNowPlayingMetadata()),super.startMonitor()}getNowPlayingMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseSkipItems(e)}setupWatchers(e){const t=[];e.forEach(e=>{const{start:r,target:n,duration:i,promo:o}=e,a=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,r,o?n:r+i,!0);t.push(a),this.skipMap.set(a,e)}),this.watchers=t}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"skipMap",new Map)}}const Or=new Logger$1("services");function asyncGeneratorStep$H(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const hasContentCompletionThresholdData=e=>!isNaN(getUpNextStart(e))&&!isNaN(getWatchedTime(e)),getUpNextStart=e=>parseFloat(e.hlsMetadata["up-next.start"]),getWatchedTime=e=>parseFloat(e.hlsMetadata["watched.time"]),Rr=function(){var e,t=(e=function*(e,t){if(e.isUTS&&e.assetURL)try{const r=generateAssetUrl(e,t.playOptions),n=yield t.manifestManager.fetchManifest(r);e.hlsMetadata=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$W(e,t,r[t])}))}return e}({},e.hlsMetadata,function(e,t={}){const r=/^(?:#EXT-X-SESSION-DATA:?)DATA-ID="([^"]+)".+VALUE="([^"]+)".*$/,n={};for(const i of e.split("\n")){const e=i.match(r);if(e){let r=e[1];e[1].startsWith("com.apple.hls.")&&!1!==t.stripPrefix&&(r=e[1].slice("com.apple.hls.".length));const i=e[2];n[r]=i}}return n}(n.content))}catch(xe){Or.error(xe.message,xe)}},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$H(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$H(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))});return function(e,r){return t.apply(this,arguments)}}();function asyncGeneratorStep$G(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _ts_metadata$c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class UpNextMonitor extends PlaybackMonitor{handlePlaybackThreshold(){var e,t=this;return(e=function*(){t.dispatcher.publish(Ar.mediaUpNext)},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$G(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$G(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;const e=this.playbackController.nowPlayingItem;return void 0!==e&&hasContentCompletionThresholdData(e)}startMonitor(){this.setupWatchers(),super.startMonitor()}setupWatchers(){const e=this.playbackController.nowPlayingItem;e&&hasContentCompletionThresholdData(e)&&(this.watchers=[new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,Math.round(this.getStartTime(e)),Number.POSITIVE_INFINITY)])}getStartTime(e){const t=getUpNextStart(e);return isNaN(t)?getWatchedTime(e):t}constructor(e){super(e)}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[]),_ts_metadata$c("design:returntype",Promise)],UpNextMonitor.prototype,"handlePlaybackThreshold",null);const $r=BooleanDevFlag.register("mk-console-logging"),Cr=StringDevFlag.register("mk-logging-levels"),Mr=G.ERROR;let Dr=Mr;const xr=new Logger$1("mk",{level:Dr,handlers:{console:new class{get hasConsole(){return"undefined"!=typeof console}process(e){if(!this.enabled||!this.hasConsole)return;let t="log";if(this.mapLevels){const r=this.levelMapping.get(e.level);(function(e){return void 0!==e&&e in console})(r)&&(t=r)}var r;const n=null!==(r=e.args)&&void 0!==r?r:[],i=this.format(e);console[t](i,...n)}constructor(e={}){var t,r,n,i;_define_property$1F(this,"enabled",void 0),_define_property$1F(this,"mapLevels",void 0),_define_property$1F(this,"levelMapping",void 0),_define_property$1F(this,"format",void 0),this.enabled=null===(t=e.enabled)||void 0===t||t,this.mapLevels=null===(r=e.mapLevels)||void 0===r||r,this.levelMapping=null!==(n=e.levelMapping)&&void 0!==n?n:Q,this.format=null!==(i=e.formatter)&&void 0!==i?i:J}}({enabled:!1}),external:new CallbackHandler(()=>{})}});function applyLoggingLevels(e){!function(e,t){walk(e,(function(e){let r;const n=e.namespace;e.clearLevel(),void 0===e.parent&&void 0!==t["*"]?r=getLoggingLevel(t["*"]):void 0!==t[n]&&(r=getLoggingLevel(t[n])),void 0!==r&&e.setLevel(r)}))}(xr,function(e){const t=getLoggingLevel(e.trim(),{allowShorthands:!0});if(void 0!==t)return{"*":t};const r={},n=e.split(",").filter(e=>""!==e.trim());for(const l of n){var i,o;const e=l.split("=",2);if(2!==e.length)continue;var a;const t=null!==(a=null===(i=e[0])||void 0===i?void 0:i.trim())&&void 0!==a?a:"";var s;const n=getLoggingLevel(null!==(s=null===(o=e[1])||void 0===o?void 0:o.trim())&&void 0!==s?s:"",{allowShorthands:!0});""!==t&&void 0!==n&&(r[t]=n)}return r}(e))}function clearLoggingLevels(){xr.setLevel(Dr),function(e,t={includeRoot:!0}){walk(e,(function(e){(void 0!==e.parent||t.includeRoot)&&e.clearLevel()}))}(xr,{includeRoot:!1})}function setConsoleOutput(e){xr.handlers.console.enabled=null!=e&&e}function setRootLoggingLevel(e){var t;Dr=null!==(t=getLoggingLevel(e))&&void 0!==t?t:Dr}const Lr={getLogger:(e="*")=>xr.getByNamespace(null!=e?e:"*"),setConsoleOutput(e){!0===e?($r.enable(),setConsoleOutput(!0),xr.info("Console output is enabled with level "+xr.levelName)):($r.disable(),setConsoleOutput(!1))},setLoggingLevels(e,t){""!==e.trim()?(Cr.set(e),applyLoggingLevels(e),Lr.setConsoleOutput(null==t||t)):Lr.clearLoggingLevels(null!=t&&t)},clearLoggingLevels(e=!1){Lr.setConsoleOutput(e),Cr.clear(),clearLoggingLevels()},listLoggers:e=>function(e){const t={};void 0!==e&&(e=e.startsWith("mk/")?e:"mk/"+e);const r=xr.children;for(;r.length>0;){const n=r.shift();if(void 0===n)break;(void 0===e||n.namespace.startsWith(e))&&(t[n.namespace]=n.levelName,r.unshift(...n.children))}return t}(e)};function _define_property$V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}$r.enabled&&Lr.setConsoleOutput($r.enabled),void 0!==Cr.value&&Lr.setLoggingLevels(Cr.value,$r.enabled);var Nr=function(e){return e[e.none=0]="none",e[e.one=1]="one",e[e.all=2]="all",e}({});class BaseRepeatable{get repeatMode(){return 0}set repeatMode(e){e!==this.repeatMode&&Or.warn("setting repeatMode is not supported in this playback method")}constructor(){_define_property$V(this,"canSetRepeatMode",!1)}}class Repeatable{get repeatMode(){return this._repeatMode}set repeatMode(e){e in Nr&&e!==this._repeatMode&&(this._repeatMode=e,this.dispatcher.publish(Ar.repeatModeDidChange,this._repeatMode))}constructor(e,t=0){_define_property$V(this,"canSetRepeatMode",!0),_define_property$V(this,"dispatcher",void 0),_define_property$V(this,"_repeatMode",void 0),this.dispatcher=e,this._repeatMode=t}}const Ur=getHlsJsCdnConfig(),jr={app:{},autoplay:{maxQueueSizeForAutoplay:50,maxQueueSizeInRequest:10,maxUpcomingTracksToMaintain:10},features:{xtrick:!0,isWeb:!0,bookmarking:!1,"seamless-audio-transitions":!0,"enhanced-hls":!1,"fetch-container-pages":!1},urls:{hls:Ur.hls,rtc:Ur.rtc,mediaApi:"https://amp-api.music.apple.com/v1",webPlayback:`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa/webPlayback`}},Kr=JsonDevFlag.register("mk-offers-key-urls").get();function asyncGeneratorStep$F(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$F(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$F(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$F(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$U(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}let Fr;jr.urls.hlsOffersKeyUrls=Kr||{"hls-key-cert-url":"https://s.mzstatic.com/skdtool_2021_certbundle.bin","hls-key-server-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/podcast/hls/license/streaming/start","widevine-cert-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/widevineCert"};class Store{get authorizationStatus(){return this.storekit.authorizationStatus}get cid(){return this.storekit.cid}get developerToken(){return this.storekit.developerToken}get hasAuthorized(){return this._hasAuthorized}get isAuthorized(){return this.storekit.hasAuthorized}get isRestricted(){return this.storekit.authorizationStatus===ee.RESTRICTED}get isU13(){return this.storekit.isU13}get metricsClientId(){return this._metricsClientId}set metricsClientId(e){this._metricsClientId=e}get musicUserToken(){return this.storekit.userToken}set musicUserToken(e){this.storekit.userToken=e}updateUserTokenFromStorage(){return this.storekit.updateUserTokenFromStorage()}set dynamicMusicUserToken(e){this.storekit.dynamicUserToken=e}get needsGDPR(){Or.error("needsGDPR has been deprecated. Plesae migrate to shouldDisplayPrivacyLink()")}get realm(){return this.storekit.realm}set requestUserToken(e){this._providedRequestUserToken=!0,this.storekit.requestUserToken=e}get restrictedEnabled(){return this.storekit.restrictedEnabled}set restrictedEnabled(e){this.storekit.overrideRestrictEnabled(e)}get storefrontCountryCode(){var e;return this.isAuthorized?this.storekit.storefrontCountryCode:null!==(e=this._defaultStorefrontCountryCode)&&void 0!==e?e:this.storekit.storefrontCountryCode}get storefrontId(){return this._apiStorefrontId||this.storekit.storefrontCountryCode}set storefrontId(e){e&&(e=e.toLowerCase()),e!==this._apiStorefrontId&&(this._apiStorefrontId=e,this.dispatcher.publish(me.apiStorefrontChanged,{storefrontId:e}))}get subscribeURL(){return this.storekit.deeplinkURL({p:"subscribe"})}get subscribeFamilyURL(){return this.storekit.deeplinkURL({p:"subscribe-family"})}get subscribeIndividualURL(){return this.storekit.deeplinkURL({p:"subscribe-individual"})}get subscribeStudentURL(){return this.storekit.deeplinkURL({p:"subscribe-student"})}get userToken(){return this.musicUserToken}authorize(){var e=this;return _async_to_generator$F((function*(){if(e.storekit.userTokenIsValid)return e.storekit.userToken;let t;try{t=yield e.storekit.requestUserToken()}catch(xe){try{yield e.unauthorize()}catch(r){}throw new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized")}return e._providedRequestUserToken&&(e.storekit.userToken=t),e.storekit.userTokenIsValid?(yield e.storekit.requestStorefrontCountryCode().catch(function(){var t=_async_to_generator$F((function*(t){return yield e.unauthorize(),Promise.reject(t)}));return function(e){return t.apply(this,arguments)}}()),t):void 0}))()}shouldDisplayPrivacyLink(e){var t=this;return _async_to_generator$F((function*(){return t.storekit.shouldDisplayPrivacyLink(e)}))()}unauthorize(){var e=this;return _async_to_generator$F((function*(){return e.storekit.revokeUserToken()}))()}constructor(e,t={}){var r,n;_define_property$U(this,"precache",void 0),_define_property$U(this,"storekit",void 0),_define_property$U(this,"dispatcher",void 0),_define_property$U(this,"_apiStorefrontId",void 0),_define_property$U(this,"_defaultStorefrontCountryCode",void 0),_define_property$U(this,"_hasAuthorized",!1),_define_property$U(this,"_metricsClientId",void 0),_define_property$U(this,"_providedRequestUserToken",!1),this.dispatcher=t.services.dispatcher,"precache"in t&&(this.precache=t.precache),t.storefrontId&&(this.storefrontId=t.storefrontId),this._defaultStorefrontCountryCode=t.storefrontCountryCode,("affiliateToken"in t||"campaignToken"in t)&&(t.linkParameters=_object_spread_props$l(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$U(e,t,r[t])}))}return e}({},t.linkParameters||{}),{at:t.affiliateToken,ct:t.campaignToken})),this.storekit=new StoreKit(e,{apiBase:jr.urls.mediaApi,authenticateMethod:jr.features["legacy-authenticate-method"]?"POST":"GET",deeplink:t.linkParameters,disableAuthBridge:t.disableAuthBridge,iconURL:jr.app.icon,meParameters:t.meParameters,persist:t.persist,realm:t.realm||F.MUSIC,fetch:null==t||null===(n=t.services)||void 0===n||null===(r=n.request)||void 0===r?void 0:r.fetch,disableLogoutURL:t.disableLogoutURL}),this.storekit.addEventListener(Ar.authorizationStatusDidChange,e=>{const{authorizationStatus:t}=e;this._hasAuthorized=[ee.AUTHORIZED,ee.RESTRICTED].includes(t)})}}function formattedSeconds(e){return{hours:Math.floor(e/3600),minutes:Math.floor(e%3600/60)}}function asyncGeneratorStep$E(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$E(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$E(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$E(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _hasMusicSubscription(){return(_hasMusicSubscription=_async_to_generator$E((function*(e){return void 0===e&&(e=Fr&&Fr.storekit),e.hasMusicSubscription()}))).apply(this,arguments)}function _define_property$T(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function transform$9(e){return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$T(e,t,r[t])}))}return e}({attributes:{}},transform$a({id:"metadata.itemId",type:"metadata.itemType","attributes.contentRating":function(){var t;if(1===(null==e||null===(t=e.metadata)||void 0===t?void 0:t.isExplicit))return"explicit"},"attributes.playParams":function(){var t,r,n;return 0!==(null==e||null===(t=e.metadata)||void 0===t?void 0:t.isPlayable)&&{id:null==e||null===(r=e.metadata)||void 0===r?void 0:r.itemId,kind:null==e||null===(n=e.metadata)||void 0===n?void 0:n.itemType}},"container.id":"metadata.containerId","container.name":"metadata.containerName","container.type":"metadata.containerType"},e))}function _define_property$S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$t(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$S(e,t,r[t])}))}return e}function _object_spread_props$k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Br={condition:()=>!0,toOptions:(e,t,r)=>[_object_spread_props$k(_object_spread$t({},e),{context:r})]};function _define_property$R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$R(e,t,r[t])}))}return e}function _object_spread_props$j(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Vr={condition:e=>{var t;return"stations"===e.type&&(null===(t=e.attributes)||void 0===t?void 0:t.isLive)},toOptions:(e,t,r)=>[_object_spread_props$j(_object_spread$s({},e),{context:r,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==r?void 0:r.featureName}})]};function _define_property$Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$r(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$Q(e,t,r[t])}))}return e}function _object_spread_props$i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const qr={condition:function(e){var t,r,n,i;return"stations"===e.type&&"streaming"===(null===(t=e.attributes)||void 0===t?void 0:t.kind)&&"episode"===(null===(n=e.attributes)||void 0===n||null===(r=n.streamingRadioSubType)||void 0===r?void 0:r.toLowerCase())&&!1===(null===(i=e.attributes)||void 0===i?void 0:i.isLive)},toOptions:function(e,t,r){var n,i;return[_object_spread_props$i(_object_spread$r({},e),{context:r,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==r?void 0:r.featureName,stationHash:null===(i=e.attributes)||void 0===i||null===(n=i.playParams)||void 0===n?void 0:n.stationHash}})]}},hasRelationship=e=>t=>{var r,n;return!!(null===(n=t.relationships)||void 0===n||null===(r=n[e])||void 0===r?void 0:r.data)},typeIs=(...e)=>({type:t})=>e.includes(t),withBagPrefix=e=>{if(void 0===e||""===e)return;const{prefix:t}=jr;return t?`${t}:${e}`:e};function _define_property$P(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$h(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const getContainerName=(e,t)=>{var r,n;return null!==(n=null!=t?t:null==e||null===(r=e.container)||void 0===r?void 0:r.name)&&void 0!==n?n:ge.SONG},Gr={toOptions:(e,t,r)=>{const n=_object_spread_props$h(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$P(e,t,r[t])}))}return e}({id:e.id},t),{name:withBagPrefix(getContainerName(e,null==r?void 0:r.featureName))});return[{relationships:e.relationships,attributes:e.attributes,id:e.id,type:e.type,container:n,context:r}]},condition:typeIs("songs","library-songs","music-videos","library-music-videos")};function _define_property$O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$p(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$O(e,t,r[t])}))}return e}function _object_spread_props$g(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const parseAssets=({type:e,attributes:{assetTokens:t}})=>e.includes("udio")?(e=>{if(void 0===e)return;const[t]=Object.keys(e);return e[t]})(t):(e=>{if(void 0===e)return;const t=Object.keys(e);return e[t[t.length-1]]})(t),Hr={condition:typeIs("uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo"),toOptions:(e,t,r)=>{var n,i;const o=_object_spread_props$g(_object_spread$p({},e),{context:r,attributes:_object_spread_props$g(_object_spread$p({},e.attributes),{assetUrl:parseAssets(e),playParams:null!==(i=null==e||null===(n=e.attributes)||void 0===n?void 0:n.playParams)&&void 0!==i?i:{id:e.id,kind:e.type}})});return void 0!==t&&(o.container=t),void 0!==(null==r?void 0:r.featureName)&&(o.container=_object_spread_props$g(_object_spread$p({},o.container),{name:null==r?void 0:r.featureName})),[o]}};function _define_property$N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$f(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Wr={toOptions:function(e,t,r){return e.relationships.episodes.data.map(e=>_object_spread_props$f(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$N(e,t,r[t])}))}return e}({},e),{context:r}))},condition:hasRelationship("episodes"),requiredRelationships:["episodes"]};const getFeatureName=(e,t)=>{if(t)return t;const r=function(e=[]){return 0!==e.length&&e.filter(({attributes:e})=>!!e&&(e.workName||e.movementName||e.movementCount||e.movementNumber)).length>0}(e.relationships.tracks.data);return"albums"===e.type||"library-albums"===e.type?r?ge.ALBUM_CLASSICAL:ge.ALBUM:"playlists"===e.type||"library-playlists"===e.type?r?ge.PLAYLIST_CLASSICAL:ge.PLAYLIST:void 0};function _define_property$M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$M(e,t,r[t])}))}return e}function _object_spread_props$e(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const zr=[{toOptions:(e,t,r)=>{const n={attributes:e.attributes,id:e.id,type:e.type,name:withBagPrefix(getFeatureName(e,null==r?void 0:r.featureName))};return e.relationships.tracks.data.map(e=>({attributes:e.attributes,id:e.id,type:e.type,container:n,context:r}))},condition:hasRelationship("tracks"),requiredRelationships:["tracks"]},Wr,Gr,Vr,qr,Hr,{condition:typeIs("music-movies"),toOptions:(e,t,r)=>{var n,i;const o=_object_spread_props$e(_object_spread$n({},e),{context:r,attributes:_object_spread_props$e(_object_spread$n({},e.attributes),{playParams:null!==(i=null==e||null===(n=e.attributes)||void 0===n?void 0:n.playParams)&&void 0!==i?i:{id:e.id,kind:"musicMovie"},offers:void 0})});return void 0!==t&&(o.container=t),void 0!==(null==r?void 0:r.featureName)&&(o.container=_object_spread_props$e(_object_spread$n({},o.container),{name:null==r?void 0:r.featureName})),[o]}}],transform=(e,t,r={})=>{var n,i,o;t=null!==(i=null==t||null===(n=t.serialize)||void 0===n?void 0:n.call(t).data)&&void 0!==i?i:t;return(null!==(o=zr.find(n=>n.condition(e,t,r)))&&void 0!==o?o:Br).toOptions(e,t,r).map(e=>new MediaItem(e))},Yr=zr.reduce((e,t)=>{const r=t.requiredRelationships;return r&&e.push(...r),e},[]),Qr=new Set(Yr),isArrayOf=(e,t)=>Array.isArray(e)&&(0===e.length||t(e[0])),isMediaAPIResource$1=e=>e&&void 0!==e.id&&void 0!==e.type,isMediaItem=e=>e&&void 0!==e.id,isMPMediaItem=e=>e&&void 0!==e.contentId&&void 0!==e.metadata&&void 0!==e.metadata.itemId&&void 0!==e.metadata.itemType,isQueueLoaded=e=>e&&e.loaded;function _define_property$L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Jr=xr.linkChild(new Logger$1("queue")),descriptorToMediaItems=e=>{if(!(e=>e&&e.items&&Array.isArray(e.items))(e)&&!isQueueLoaded(e))return[];const t=isQueueLoaded(e)?loadedDescriptorToMediaItem(e):unloadedDescriptorToMediaItem(e);return t.forEach(t=>t.context=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$L(e,t,r[t])}))}return e}({},e.context,t.context)),t},unloadedDescriptorToMediaItem=({items:e})=>isArrayOf(e,isMPMediaItem)?e.map(e=>new MediaItem(transform$9(e))):isArrayOf(e,isMediaItem)?e.map(e=>new MediaItem(e)):[],loadedDescriptorToMediaItem=e=>{const t=[],{loaded:r,container:n,context:i}=e;return void 0===r?[]:isArrayOf(r,isDataRecord)?(r.forEach(e=>{t.push(...dataRecordToMediaItems(e,n,i))}),t):isArrayOf(r,isMediaAPIResource$1)?(r.forEach(e=>{t.push(...resourceToMediaItem(e,n,i))}),t):isDataRecord(r)?dataRecordToMediaItems(r,n,i):isMediaAPIResource$1(r)?resourceToMediaItem(r,n,i):[]},dataRecordToMediaItems=(e,t,r={})=>{const{data:n}=e.serialize(!0,void 0,{includeRelationships:Qr,allowFullDuplicateSerializations:!0});return resourceToMediaItem(n,t,r)},resourceToMediaItem=(e,t,r={})=>(Jr.trace("resourceToMediaItem()",e),transform(e,t,r));function _define_property$K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}xr.createChild("queue");class QueueItem{restrict(){return this.item.restrict()}constructor(e,t){var r;_define_property$K(this,"isAutoplay",!1),_define_property$K(this,"item",void 0),this.item=e,this.isAutoplay=null!==(r=null==t?void 0:t.isAutoplay)&&void 0!==r&&r}}function toQueueItems(e,t){return e.map(e=>new QueueItem(e,t))}function toMediaItems(e){return e.map(e=>e.item)}const{queueItemsDidChange:Xr,queuePositionDidChange:Zr}=Ar;class Queue{get isEmpty(){return 0===this.length}set isRestricted(e){var t;this._isRestricted=e;const r=null===(t=this.currentItem)||void 0===t?void 0:t.id;this._isRestricted&&!this.isEmpty&&(this.removeQueueItems(e=>e.item.isExplicitItem),this.isEmpty&&this._dispatcher.publish(Ar.mediaPlaybackError,new MKError(MKError.Reason.CONTENT_RESTRICTED,"Content restricted")),r&&(this.position=this._getStartItemPosition(r)))}get isRestricted(){return this._isRestricted}get appendTargetIndex(){let e=this.length;const t=this._queueItems.findIndex(e=>e.isAutoplay);return-1!==t&&this.position<t&&(e=t),e}get items(){return toMediaItems(this._queueItems)}get autoplayItems(){return toMediaItems(this._queueItems.filter(e=>e.isAutoplay))}get unplayedAutoplayItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>e.isAutoplay))}get userAddedItems(){return toMediaItems(this._queueItems.filter(e=>!e.isAutoplay))}get unplayedUserItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>!e.isAutoplay))}get playableItems(){return toMediaItems(this._queueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get unplayedPlayableItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get length(){return this._queueItems.length}get nextPlayableItem(){if(-1!==this.nextPlayableItemIndex)return this.item(this.nextPlayableItemIndex)}get nextPlayableItemIndex(){return this._nextPlayableItemIndex=this.findPlayableIndexForward(),this._nextPlayableItemIndex}get position(){return this._position}set position(e){this._updatePosition(e)}get isInitiated(){return this.position>=0}get previousPlayableItem(){if(-1!==this.previousPlayableItemIndex)return this.item(this.previousPlayableItemIndex)}get previousPlayableItemIndex(){return this.findPlayableIndexBackward()}removeQueueItems(e){for(let t=this.length-1;t>=0;t--)e(this.queueItem(t),t)&&this.spliceQueueItems(t,1)}indexForItem(e){return("string"==typeof e?this._itemIDs:this.items).indexOf(e)}item(e){var t;return null===(t=this.queueItem(e))||void 0===t?void 0:t.item}get currentItem(){return this.item(this.position)}queueItem(e){var t;return null===(t=this._queueItems)||void 0===t?void 0:t[e]}updateItems(e){this._queueItems=toQueueItems(e),this._reindex(),this._dispatcher.publish(Ar.queueItemsDidChange,this.items)}get currentQueueItem(){return this.queueItem(this.position)}remove(e){if(deprecationWarning("remove",{message:"The queue remove function has been deprecated"}),e===this.position)throw new MKError(MKError.Reason.INVALID_ARGUMENTS);this.splice(e,1)}append(e=[]){return this.appendQueueItems(toQueueItems(e))}appendQueueItems(e=[]){this.spliceQueueItems(this.appendTargetIndex,0,e)}splice(e,t,r=[]){return toMediaItems(this.spliceQueueItems(e,t,toQueueItems(r)))}spliceQueueItems(e,t,r=[],n=!0){r=r.filter(e=>isPlayable(null==e?void 0:e.item,this.playbackMode));const i=this._queueItems.splice(e,t,...r);return this._itemIDs.splice(e,t,...r.map(e=>e.item.id)),n&&(this._dispatcher.publish(me.queueModified,{start:e,added:toMediaItems(r),removed:toMediaItems(i)}),this._dispatcher.publish(Xr,this.items)),i}clearAfterCurrent(){if(-1===this.position)this.clear();else if(this.length>0&&this.position+1<this.length){const e=this.position+1;this.splice(e,this.length)}}clear(){this.length>0&&(this.splice(0,this.length),this.reset())}reset(){const e=this.position;this._position=-1,e>=0&&this._dispatcher.publish(Zr,{oldPosition:e,position:this.position})}_isSameItems(e){if(e.length!==this.length)return!1;const t=e.map(e=>e.id).sort(),r=[...this._itemIDs].sort();let n,i;try{n=JSON.stringify(t),i=JSON.stringify(r)}catch(o){return!1}return n===i}_reindex(){this._queueItems&&(this._itemIDs=this._queueItems.map(e=>e.item.id))}_updatePosition(e){if(e===this._position)return;const t=this._position;this._position=e;const r=this.item(e);r&&canPlay(r,this.playbackMode)||(this._position=this.findPlayableIndexForward(e)),this._position!==t&&this._dispatcher.publish(Zr,{oldPosition:t,position:this._position})}findPlayableIndexForward(e=this.position){var t;if(this.isEmpty)return-1;if(this.isInitiated&&!indexInBounds([0,this.position],e))return-1;const r=null===(t=this.repeatable)||void 0===t?void 0:t.repeatMode;if(e<this.length)for(let n=e+1;n<this.length;n++){if(canPlay(this.item(n),this.playbackMode))return n}if(r===Nr.all)for(let n=0;n<=e;n++){if(canPlay(this.item(n),this.playbackMode))return n}return-1}findPlayableIndexBackward(e=this.position){var t;if(this.isEmpty)return-1;if(!indexInBounds([0,this.position],e))return-1;const r=null===(t=this.repeatable)||void 0===t?void 0:t.repeatMode;if(e>0)for(let n=e-1;n>=0;n--){if(canPlay(this.item(n),this.playbackMode))return n}if(r===Nr.all)for(let n=this.length-1;n>=e;n--){if(canPlay(this.item(n),this.playbackMode))return n}return-1}get _unplayedQueueItems(){const e=this.position<0?0:this.position;return this._queueItems.slice(e)}_getStartItemPosition(e){if(void 0===e)return-1;if("object"==typeof e&&"id"in e&&(e=e.id),"string"==typeof e)return this.indexForItem(e);const t=parseInt(""+e,10);return t>=0&&t<this.length?t:-1}constructor(e){if(_define_property$K(this,"repeatable",void 0),_define_property$K(this,"hasAutoplayStation",!1),_define_property$K(this,"playbackMode",Ir.MIXED_CONTENT),_define_property$K(this,"_itemIDs",[]),_define_property$K(this,"_queueItems",[]),_define_property$K(this,"_isRestricted",!1),_define_property$K(this,"_nextPlayableItemIndex",-1),_define_property$K(this,"_position",-1),_define_property$K(this,"_dispatcher",void 0),this._dispatcher=e.services.dispatcher,this.playbackMode=e.playbackMode,!e.descriptor)return;const t=descriptorToMediaItems(e.descriptor).filter(e=>isPlayable(e,this.playbackMode));this._queueItems=toQueueItems(t),this._reindex(),void 0!==e.descriptor.startWith&&(this.position=this._getStartItemPosition(e.descriptor.startWith))}}function isPlayable(e,t){return e.isPlayable||t!==Ir.FULL_PLAYBACK_ONLY&&void 0!==e.previewURL}function canPlay(e,t){return isPlayable(e,t)&&!function(e){return e.isRestricted}(e)&&!function(e){return e.isUnavailable}(e)}function indexInBounds(e,t){return e[0]<=t&&t<=e[1]}function _define_property$J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const en=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$J(e,t,r[t])}))}return e}({},{NEXT_ITEM:"NEXT"},be);function asyncGeneratorStep$D(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$D(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$D(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$D(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const tn=["EditorialVideoClip","uploaded-videos","uploadedVideo","musicVideo"],rn=function(){var e=_async_to_generator$D((function*(){}));return function(){return e.apply(this,arguments)}}();class BaseSeekable{getSeekSeconds(e){return{BACK:0,FORWARD:0}}seekBackward(e=rn){Or.warn("seekBackward is not supported in this playback method")}seekForward(e=rn){Or.warn("seekForward is not supported in this playback method")}seekToTime(e,t){return _async_to_generator$D((function*(){Or.warn("seekToTime is not supported in this playback method")}))()}constructor(e){_define_property$I(this,"mediaItemPlayback",void 0),_define_property$I(this,"canSeek",void 0),this.mediaItemPlayback=e,this.canSeek=!1}}class Seekable{getSeekSeconds(e){return(e=>(null==e?void 0:e.isUTS)||tn.includes(null==e?void 0:e.type)?{FORWARD:10,BACK:10}:(null==e?void 0:e.isAOD)?{FORWARD:30,BACK:30}:{FORWARD:30,BACK:15})(e)}seekBackward(e=this._seekToBeginning){var t=this;return _async_to_generator$D((function*(){if(void 0===t.mediaItemPlayback.nowPlayingItem)return void Or.warn("Cannot seekBackward when nowPlayingItem is not yet set.");const r=t.mediaItemPlayback.currentPlaybackTime-t.getSeekSeconds(t.mediaItemPlayback.nowPlayingItem).BACK;r<0?yield e.call(t):yield t.seekToTime(r,Se.Interval)}))()}seekForward(e=this._seekToEnd){var t=this;return _async_to_generator$D((function*(){if(void 0===t.mediaItemPlayback.nowPlayingItem)return void Or.warn("Cannot seekForward when nowPlayingItem is not yet set.");const r=t.mediaItemPlayback.currentPlaybackTime+t.getSeekSeconds(t.mediaItemPlayback.nowPlayingItem).FORWARD;r>t.mediaItemPlayback.currentPlaybackDuration?yield e.call(t):yield t.seekToTime(r,Se.Interval)}))()}seekToTime(e,t=Se.Manual){var r=this;return _async_to_generator$D((function*(){if(void 0===r.mediaItemPlayback.nowPlayingItem)return void Or.warn("Cannot seekToTime when nowPlayingItem is not yet set.");const n=r.mediaItemPlayback.nowPlayingItem,i=r.mediaItemPlayback.currentPlaybackTime,o=r.mediaItemPlayback.currentPlayingDate,a=Math.min(Math.max(0,e),r.mediaItemPlayback.currentPlaybackDuration);let s;if(n.isLinearStream&&void 0!==o){const e=1e3*(a-i);s=new Date(o.getTime()+e)}yield r.mediaItemPlayback.seekToTime(a,t),r._dispatcher.publish(me.playbackSeek,{item:n,startPosition:i,position:a,playingDate:s,startPlayingDate:o,seekReasonType:t})}))()}_seekToBeginning(){var e=this;return _async_to_generator$D((function*(){yield e.seekToTime(0,Se.Interval)}))()}_seekToEnd(){var e=this;return _async_to_generator$D((function*(){yield e.seekToTime(e.mediaItemPlayback.currentPlaybackDuration,Se.Interval)}))()}constructor(e,t){_define_property$I(this,"_dispatcher",void 0),_define_property$I(this,"mediaItemPlayback",void 0),_define_property$I(this,"canSeek",void 0),this._dispatcher=e,this.mediaItemPlayback=t,this.canSeek=!0}}const shuffleCollection=e=>{const t=[...e],{length:r}=t;for(let n=0;n<r;++n){const e=n+Math.floor(Math.random()*(r-n)),i=t[e];t[e]=t[n],t[n]=i}return t};function _define_property$H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$b(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var nn=function(e){return e[e.off=0]="off",e[e.songs=1]="songs",e}({});const on="Shuffling is not supported in this playback method.";class BaseShuffler{set shuffle(e){Or.warn(on)}get shuffleMode(){return 0}set shuffleMode(e){Or.warn(on)}checkAndReshuffle(e){Or.warn(on)}constructor(){_define_property$H(this,"canSetShuffleMode",!1),_define_property$H(this,"queue",void 0)}}class Shuffler{get queue(){return this._queue}set queue(e){this._queue=e,this._unshuffledIDs=e.userAddedItems.map(e=>e.id),this.checkAndReshuffle(!1)}queueModifiedHandler(e,t){if(this._isSpliceFromShuffle)return void(this._isSpliceFromShuffle=!1);const{start:r,added:n,removed:i}=t;if(i.length>0){const e=i.map(e=>e.id);this._unshuffledIDs=this._unshuffledIDs.filter(t=>!e.includes(t))}n.length>0&&this._unshuffledIDs.splice(r,0,...n.map(e=>e.id))}set shuffle(e){this.shuffleMode=e?1:0}get shuffleMode(){return this.mode}set shuffleMode(e){e!==this.shuffleMode&&e in nn&&(Or.debug(`mk: set shuffleMode from ${this.shuffleMode} to ${e}`),this.mode=e,1===this.mode?this.shuffleQueue():this.unshuffleQueue(),this.controller.nowPlayingItem&&(this._queue.position=this._queue.indexForItem(this.controller.nowPlayingItem.id)),this.dispatcher.publish(Ar.shuffleModeDidChange,this.shuffleMode))}checkAndReshuffle(e=!1){1===this.shuffleMode&&this.shuffleQueue(e)}shuffleQueue(e=!0){const{userAddedItems:t}=this._queue;if(t.length<=1)return t;const r=t.slice(0),n=this._queue.position>-1?r.splice(this._queue.position,1):[];let i=[];do{i=shuffleCollection(r)}while(r.length>1&&arrayEquals(i,r));const o=[...n,...i];this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,o.length,toQueueItems(o),e)}unshuffleQueue(e=!0){let t=[];const r=this._unshuffledIDs.reduce((e,t,r)=>(e[t]=r,e),{}),n=[];let i=0;const o=this._queue.item(this._queue.position);this._queue.userAddedItems.forEach(e=>{const a=r[e.id];void 0===a&&n.push(e),t[a]=e,e.id===(null==o?void 0:o.id)&&(i=a)}),t=t.filter(Boolean);const a=t.concat(n);this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,a.length,toQueueItems(a),e),this._queue.position=i}constructor(e,{dispatcher:t}){_define_property$H(this,"controller",void 0),_define_property$H(this,"canSetShuffleMode",void 0),_define_property$H(this,"dispatcher",void 0),_define_property$H(this,"mode",void 0),_define_property$H(this,"_queue",void 0),_define_property$H(this,"_unshuffledIDs",void 0),_define_property$H(this,"_isSpliceFromShuffle",void 0),this.controller=e,this.canSetShuffleMode=!0,this.mode=0,this._unshuffledIDs=[],this._isSpliceFromShuffle=!1,this.dispatcher=t,this.dispatcher.subscribe(me.queueModified,this.queueModifiedHandler),this._queue=e.queue}}function asyncGeneratorStep$C(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$C(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$C(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$C(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$G(e,t,r[t])}))}return e}function _ts_metadata$a(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$b("design:type",Function),_ts_metadata$b("design:paramtypes",[String,Object]),_ts_metadata$b("design:returntype",void 0)],Shuffler.prototype,"queueModifiedHandler",null);var an=function(e){return e.continuous="continuous",e.serial="serial",e}({});const{queueItemsDidChange:sn}=Ar;class PlaybackController{get isActive(){return this._isActive}get isDestroyed(){return this._isDestroyed}updateAutoplay(e,t){this.autoplayEnabled=t}constructContext(e,t){let r=null==e?void 0:e.context;var n;return void 0!==(null==e?void 0:e.featureName)&&void 0===(null==r?void 0:r.featureName)&&(Or.warn("featureName is deprecated, pass it inside context"),r||(r={}),r.featureName=e.featureName),null!==(n=null!=r?r:t)&&void 0!==n?n:{}}get context(){return this._context}get shuffler(){return this._shuffler}get continuous(){return this._continuous||this.hasAuthorization}set continuous(e){this._continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e}get previewOnly(){return this._mediaItemPlayback.previewOnly}get _dispatcher(){return this.services.dispatcher}get hasAuthorization(){return void 0===(e=this.storekit)&&(e=Fr&&Fr.storekit),void 0!==e&&e.hasAuthorized&&e.userTokenIsValid;var e}get isPlaying(){return this._mediaItemPlayback.isPlaying}get isPrimaryPlayer(){return this._mediaItemPlayback.isPrimaryPlayer}set isPrimaryPlayer(e){this._mediaItemPlayback.isPrimaryPlayer=e}get isReady(){return this._mediaItemPlayback.isReady}get _mediaItemPlayback(){return this.services.mediaItemPlayback}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){return this.queue?this.queue.position:-1}get playbackMode(){return this._playbackMode}set playbackMode(e){this._playbackMode=e,this.queue&&(this.queue.playbackMode=e)}get queue(){return this._queue}set queue(e){this.setQueue(e)}get repeatMode(){return this._repeatable.repeatMode}set repeatMode(e){this._repeatable.repeatMode=e}get seekSeconds(){const{nowPlayingItem:e}=this;if(void 0!==e)return this._seekable.getSeekSeconds(e)}set shuffle(e){this._shuffler.shuffle=e}get shuffleMode(){return this._shuffler.shuffleMode}set shuffleMode(e){this._shuffler.shuffleMode=e}get storekit(){return this._storekit}set storekit(e){if(e){var t=this;e.addEventListener(ce.authorizationStatusWillChange,function(){var e=_async_to_generator$C((function*({authorizationStatus:e,newAuthorizationStatus:r}){e>ee.DENIED&&r<ee.RESTRICTED?yield t.stop({endReasonType:be.PLAYBACK_SUSPENDED,userInitiated:!1}):yield t.stop({userInitiated:!1})}));return function(t){return e.apply(this,arguments)}}()),this._storekit=e}}changeToMediaAtIndex(e=0){var t=this;return _async_to_generator$C((function*(){var r,n,i,o;yield t.stop();const a=null===(r=t.queue.item(e))||void 0===r?void 0:r.id,s=null===(i=t._mediaItemPlayback)||void 0===i||null===(n=i.playOptions)||void 0===n?void 0:n.get(a);let l=(null==s?void 0:s.startTime)||0;var c;t._dispatcher.publish(Ar.playInitiated,{item:t.queue.item(e),timestamp:null!==(c=null==s||null===(o=s.meta)||void 0===o?void 0:o.initiatedTimestamp)&&void 0!==c?c:Date.now()});const d=yield t._changeToMediaAtIndex(e,{userInitiated:!0});d&&(d.id!==a&&(l=0),t._dispatcher.publish(me.playbackPlay,{item:d,position:l,playingDate:t._mediaItemPlayback.currentPlayingDate,userInitiated:!0}))}))()}changeToMediaItem(e){var t=this;return _async_to_generator$C((function*(){const r=t.queue.indexForItem(e);return-1===r?Promise.reject(new MKError(MKError.Reason.MEDIA_DESCRIPTOR)):t.changeToMediaAtIndex(r)}))()}activate(){var e=this;return _async_to_generator$C((function*(){Or.debug("PlaybackController.activate()"),e._isActive=!0,e._dispatcher.unsubscribe(Ar.playbackStateDidChange,e.onPlaybackStateDidChange),e._dispatcher.subscribe(Ar.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.activate(),e._upNext.activate(),e._rollMonitor.activate()}))()}deactivate(){var e=this;return _async_to_generator$C((function*(){Or.debug("PlaybackController.deactivate()"),e._isActive=!1,yield e.stop(),e._dispatcher.unsubscribe(Ar.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.deactivate(),e._upNext.deactivate(),e._rollMonitor.deactivate()}))()}destroy(){var e=this;return _async_to_generator$C((function*(){e._isDestroyed=!0,yield e.deactivate(),e._dispatcher.unsubscribe(Ar.autoplayEnabledDidChange,e.updateAutoplay)}))()}pause(e){var t=this;return _async_to_generator$C((function*(){return t._mediaItemPlayback.pause(e)}))()}play(){var e=this;return _async_to_generator$C((function*(){if(e.nowPlayingItem)return e._mediaItemPlayback.play();if(!e._queue||e._queue.isEmpty)return;if(e.nowPlayingItemIndex>=0)return e.changeToMediaAtIndex(e.nowPlayingItemIndex);const{queue:t}=e;return-1!==t.nextPlayableItemIndex?e.changeToMediaAtIndex(t.nextPlayableItemIndex):void 0}))()}playSingleMediaItem(e,t){var r=this;return _async_to_generator$C((function*(){e.isUTS&&(yield Rr(e,{manifestManager:r.services.manifest,playOptions:t})),r._dispatcher.publish(Ar.queueItemsDidChange,[e]);const n=yield r._mediaItemPlayback.startMediaItemPlayback(e,!0);if(n){var i;const e={item:n,position:null!==(i=r._mediaItemPlayback.currentPlaybackTime)&&void 0!==i?i:0,playingDate:r._mediaItemPlayback.currentPlayingDate,userInitiated:!0};Or.debug("playSingleMediaItem: Dispatching DispatchTypes.playbackPlay event",e),r._dispatcher.publish(me.playbackPlay,e)}}))()}onPlaybackStateDidChange(e,t){var r=this;return _async_to_generator$C((function*(){t.state===he.ended&&(r.continuous||r.repeatMode===Nr.one)&&(Or.debug("controller detected track ended event, moving to next item."),r._dispatcher.publish(me.applicationActivityIntent,{endReasonType:be.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),yield r._next())}))()}preload(){var e=this;return _async_to_generator$C((function*(){return e._mediaItemPlayback.preload()}))()}showPlaybackTargetPicker(){this._mediaItemPlayback.showPlaybackTargetPicker()}seekBackward(){var e=this;return _async_to_generator$C((function*(){return e._seekable.seekBackward()}))()}seekForward(){var e=this;return _async_to_generator$C((function*(){return e._seekable.seekForward(e.skipToNextItem.bind(e))}))()}skipToNextItem(){var e=this;return _async_to_generator$C((function*(){return e._next({userInitiated:!0})}))()}skipToPreviousItem(){var e=this;return _async_to_generator$C((function*(){return e._previous({userInitiated:!0})}))()}getNewSeeker(){return this._mediaItemPlayback.getNewSeeker()}seekToTime(e,t){var r=this;return _async_to_generator$C((function*(){yield r._seekable.seekToTime(e,t)}))()}replaceQueue(e,t){var r=this;return _async_to_generator$C((function*(){var n;if(yield r.extractGlobalValues(t),yield r._mediaItemPlayback.stop(),void 0!==(null==t?void 0:t.context)&&(r._context=t.context),r.setQueue(new Queue({services:{dispatcher:r.services.dispatcher},descriptor:{loaded:e,context:r.context,startWith:null!==(n=null==t?void 0:t.startWith)&&void 0!==n?n:null==t?void 0:t.startPosition},playbackMode:r.playbackMode})),0===e.length)throw Or.warn("No items (0) are playable for new queue"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No playable items for queue");if(void 0!==(null==t?void 0:t.shuffleMode)&&(r.shuffleMode=t.shuffleMode),void 0!==(null==t?void 0:t.repeatMode)&&(r.repeatMode=t.repeatMode),function(e){return"number"==typeof e&&!Number.isNaN(e)}(null==t?void 0:t.startTime)){const e=r.queue.nextPlayableItem;e&&r._mediaItemPlayback.playOptions.set(e.id,{startTime:null==t?void 0:t.startTime})}return r._dispatcher.publish("queue.created",r.queue),r._dispatcher.publish("queue.ready",r.queue),r._dispatcher.publish(Ar.queueIsReady,r.queue.items),r.queue}))()}extractGlobalValues(e){var t=this;return _async_to_generator$C((function*(){t._context=t.constructContext(e),void 0!==(null==e?void 0:e.featureName)&&e.context&&(Or.warn("featureName is deprecated, pass it inside context"),e.context.featureName=e.featureName)}))()}stop(e){var t=this;return _async_to_generator$C((function*(){yield t._mediaItemPlayback.stop(e)}))()}_changeToMediaAtIndex(e=0,t={}){var r=this;return _async_to_generator$C((function*(){if(r.queue.isEmpty)return;r.queue.position=e;const n=r.queue.item(r.queue.position);if(!n)return;var i;const o=yield r._mediaItemPlayback.startMediaItemPlayback(n,null!==(i=t.userInitiated)&&void 0!==i&&i);if(o||n.state!==y.unsupported)return o;yield r.skipToNextItem()}))()}_next(e={}){var t=this;return _async_to_generator$C((function*(){if(t.queue.isEmpty)return;const{userInitiated:r=!1}=e;return t.repeatMode===Nr.one&&void 0!==t.queue.currentItem?(yield t.stop(_object_spread$k({userInitiated:r},e)),void(yield t.play())):(!r&&e.seamlessAudioTransition&&(t._dispatcher.publish(me.playbackStop,_object_spread$k({userInitiated:r,endReasonType:be.NATURAL_END_OF_TRACK},e)),e={userInitiated:e.userInitiated,seamlessAudioTransition:!0}),t._nextAtIndex(t.queue.nextPlayableItemIndex,e))}))()}_nextAtIndex(e,t={}){var r=this;return _async_to_generator$C((function*(){if(r.queue.isEmpty)return;const{_mediaItemPlayback:n}=r;var i;const o=null!==(i=t.userInitiated)&&void 0!==i&&i;if(e<0)return Or.debug("controller/index._next no next item available, stopping playback"),yield r.stop({userInitiated:o,seamlessAudioTransition:t.seamlessAudioTransition}),void(n.playbackState=he.completed);const a=r.isPlaying,s=n.currentPlaybackTime,l=yield r._changeToMediaAtIndex(e,{userInitiated:o});var c;return r._notifySkip(a,l,{userInitiated:o,seamlessAudioTransition:null!==(c=t.seamlessAudioTransition)&&void 0!==c&&c,position:s,direction:be.TRACK_SKIPPED_FORWARDS}),l}))()}_previous(e={}){var t=this;return _async_to_generator$C((function*(){if(t.queue.isEmpty)return;const{userInitiated:r=!1}=e;if(t.repeatMode===Nr.one&&void 0!==t.queue.currentItem)return yield t.stop({endReasonType:be.TRACK_SKIPPED_BACKWARDS,userInitiated:r}),void(yield t.play());const n=t.queue.previousPlayableItemIndex;if(r&&t.repeatMode===Nr.none&&void 0!==t.nowPlayingItem&&-1===n)return yield t.stop({endReasonType:be.TRACK_SKIPPED_BACKWARDS,userInitiated:!0}),void(yield t.play());if(-1===n)return;const i=t.isPlaying,o=t._mediaItemPlayback.currentPlaybackTime,a=yield t._changeToMediaAtIndex(n,{userInitiated:r});return t._notifySkip(i,a,{userInitiated:r,seamlessAudioTransition:!1,direction:be.TRACK_SKIPPED_BACKWARDS,position:o}),a}))()}_notifySkip(e,t,r){const{userInitiated:n,direction:i,position:o,seamlessAudioTransition:a=!1}=r,s=this._dispatcher;a?(Or.debug("seamlessAudioTransition transition, PAF play"),s.publish(me.playbackPlay,{item:t,position:0,endReasonType:be.NATURAL_END_OF_TRACK})):e?t?s.publish(me.playbackSkip,{item:t,userInitiated:n,direction:i,position:o}):s.publish(me.playbackStop,{item:t,userInitiated:n,position:o}):t&&s.publish(me.playbackPlay,_object_spread$k({item:t,playingDate:this._mediaItemPlayback.currentPlayingDate,position:0},n?{endReasonType:be.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM}:{}))}setQueue(e){return Or.trace("PlaybackController.prepareQueue()"),this.hasAuthorization&&(e.isRestricted=this.storekit.restrictedEnabled||!1),e.repeatable=this._repeatable,this._queue=e,this._shuffler.queue=this._queue,this._dispatcher.publish(sn,e.items),e}constructor(e){var t;_define_property$G(this,"_continuous",void 0),_define_property$G(this,"_context",{}),_define_property$G(this,"_autoplayEnabled",void 0),_define_property$G(this,"_queue",void 0),_define_property$G(this,"_storekit",void 0),_define_property$G(this,"_repeatable",void 0),_define_property$G(this,"_shuffler",void 0),_define_property$G(this,"_seekable",void 0),_define_property$G(this,"services",void 0),_define_property$G(this,"_rollMonitor",void 0),_define_property$G(this,"_skipIntro",void 0),_define_property$G(this,"_upNext",void 0),_define_property$G(this,"_playbackMode",void 0),_define_property$G(this,"_isActive",!1),_define_property$G(this,"_isDestroyed",!1),this.onPlaybackStateDidChange=this.onPlaybackStateDidChange.bind(this),this._autoplayEnabled=null!==(t=null==e?void 0:e.autoplayEnabled)&&void 0!==t&&t,this._continuous=!1,this.services=e.services,this.storekit=this.services.store.storekit,this._skipIntro=new SkipAvailable({controller:this,services:e.services}),this._upNext=new UpNextMonitor({controller:this,services:e.services}),this._rollMonitor=new RollMonitor({controller:this,services:e.services}),this._shuffler=new BaseShuffler,this._seekable=new BaseSeekable(this._mediaItemPlayback),this._repeatable=new BaseRepeatable,this._dispatcher.subscribe(Ar.autoplayEnabledDidChange,this.updateAutoplay),this._playbackMode=e.playbackMode}}function _define_property$F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$9(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$9(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$a("design:type",Function),_ts_metadata$a("design:paramtypes",[String,Boolean]),_ts_metadata$a("design:returntype",void 0)],PlaybackController.prototype,"updateAutoplay",null);class MediaSessionManager{onCapabilitiesChanged(){this._resetHandlers(),this._setMediaSessionHandlers()}onNowPlayingItemDidChange(e,{item:t}){this._setMediaSessionMetadata(t)}_setMediaSessionMetadata(e){var t,r;this.session&&"MediaMetadata"in window&&e&&(this.session.metadata=new window.MediaMetadata({title:e.title,artist:null!==(r=e.artistName)&&void 0!==r?r:null===(t=e.attributes)||void 0===t?void 0:t.showTitle,album:e.albumName,artwork:e.artwork?[96,128,192,256,384,512].map(t=>({src:formatArtworkURL(e.artwork,t,t),sizes:`${t}x${t}`,type:"image/jpeg"})):[]}))}_setMediaSessionHandlers(){this.session&&(this._resetHandlers(),this.session.setActionHandler("play",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.play()}),this.capabilities.canPause?this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.pause()}):this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.stop()}),this.capabilities.canSeek&&(this.session.setActionHandler("seekforward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekForward()}),this.session.setActionHandler("seekbackward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekBackward()})),this.capabilities.canSkipToNextItem&&this.session.setActionHandler("nexttrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToNextItem()}),this.capabilities.canSkipToPreviousItem&&this.session.setActionHandler("previoustrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToPreviousItem()}))}_resetHandlers(){this.session&&(this.session.setActionHandler("play",void 0),this.session.setActionHandler("pause",void 0),this.session.setActionHandler("seekforward",void 0),this.session.setActionHandler("seekbackward",void 0),this.session.setActionHandler("nexttrack",void 0),this.session.setActionHandler("previoustrack",void 0))}constructor(e,t){_define_property$F(this,"capabilities",void 0),_define_property$F(this,"dispatcher",void 0),_define_property$F(this,"controller",void 0),_define_property$F(this,"session",void 0),this.capabilities=e,this.dispatcher=t,this.session=navigator.mediaSession,this.session&&(this.dispatcher.subscribe(Ar.nowPlayingItemDidChange,this.onNowPlayingItemDidChange),this.dispatcher.subscribe(Ar.capabilitiesChanged,this.onCapabilitiesChanged),this._setMediaSessionHandlers())}}function _define_property$E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$9([Bind(),_ts_metadata$9("design:type",Function),_ts_metadata$9("design:paramtypes",[]),_ts_metadata$9("design:returntype",void 0)],MediaSessionManager.prototype,"onCapabilitiesChanged",null),_ts_decorate$9([Bind(),_ts_metadata$9("design:type",Function),_ts_metadata$9("design:paramtypes",[void 0,void 0]),_ts_metadata$9("design:returntype",void 0)],MediaSessionManager.prototype,"onNowPlayingItemDidChange",null);var ln=function(e){return e[e.PAUSE=0]="PAUSE",e[e.EDIT_QUEUE=1]="EDIT_QUEUE",e[e.SEEK=2]="SEEK",e[e.REPEAT=3]="REPEAT",e[e.SHUFFLE=4]="SHUFFLE",e[e.SKIP_NEXT=5]="SKIP_NEXT",e[e.SKIP_PREVIOUS=6]="SKIP_PREVIOUS",e[e.SKIP_TO_ITEM=7]="SKIP_TO_ITEM",e[e.AUTOPLAY=8]="AUTOPLAY",e[e.VOLUME=9]="VOLUME",e}({});class Capabilities{set controller(e){this._mediaSession.controller=e}updateChecker(e){this._checkCapability!==e&&(this._checkCapability=e,this._dispatcher.publish(Ar.capabilitiesChanged))}get canEditPlaybackQueue(){return this._checkCapability(1)}get canPause(){return this._checkCapability(0)}get canSeek(){return this._checkCapability(2)}get canSetRepeatMode(){return this._checkCapability(3)}get canSetShuffleMode(){return this._checkCapability(4)}get canSkipToNextItem(){return this._checkCapability(5)}get canSkipToMediaItem(){return this._checkCapability(7)}get canSkipToPreviousItem(){return this._checkCapability(6)}get canAutoplay(){return this._checkCapability(8)}get canSetVolume(){return this._checkCapability(9)}constructor(e){_define_property$E(this,"_dispatcher",void 0),_define_property$E(this,"_checkCapability",void 0),_define_property$E(this,"_mediaSession",void 0),this._dispatcher=e,this._checkCapability=e=>9===e,this._mediaSession=new MediaSessionManager(this,e)}}function asyncGeneratorStep$B(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$B(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$B(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$B(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$8(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$8(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class ContinuousPlaybackController extends PlaybackController{get continuous(){return!0}set continuous(e){if(!0!==e)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Continuous playback cannot be disabled for station queues.")}get isLive(){return this._isLiveStation}set isLive(e){e!==this._isLiveStation&&(this._isLiveStation=e,this._dispatcher.publish(Ar.capabilitiesChanged))}get isTracksStation(){return this._isTracksStation}set isTracksStation(e){e!==this._isTracksStation&&(this._isTracksStation=e,this._dispatcher.publish(Ar.capabilitiesChanged))}changeToMediaItem(e){return _async_to_generator$B((function*(){Or.warn("changeToMediaItem is not supported for this type of playback")}))()}hasCapabilities(e){switch(e){case ln.VOLUME:return!0;case ln.PAUSE:case ln.SKIP_NEXT:case ln.SKIP_PREVIOUS:case ln.SEEK:return!this.isLive;case ln.SKIP_TO_ITEM:case ln.AUTOPLAY:case ln.EDIT_QUEUE:case ln.SHUFFLE:case ln.REPEAT:default:return!1}}pause(e){var t=this,_superprop_get_pause=()=>super.pause;return _async_to_generator$B((function*(){if(!t.isLive)return _superprop_get_pause().call(t,e);Or.warn("pause is not supported for this type of playback")}))()}skipToPreviousItem(){var e=this,_superprop_get_skipToPreviousItem=()=>super.skipToPreviousItem;return _async_to_generator$B((function*(){if(!e.isLive)return _superprop_get_skipToPreviousItem().call(e);Or.warn("skipToPreviousItem is not supported for this type of playback")}))()}replaceQueue(e,t){var r=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$B((function*(){var n;const i=e[0];if(void 0===i)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No Queue item");if(!isRadioStation(i))throw new MKError(MKError.Reason.MEDIA_DESCRIPTOR,"Item is not a Radio Station");return r.station=i,r.isLive=!!(null==i?void 0:i.isLiveRadioStation)||!!(null==i||null===(n=i.attributes)||void 0===n?void 0:n.isLive),r.isTracksStation=isTracksRadioStation(i),r._context=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$D(e,t,r[t])}))}return e}({featureName:ge.STATION},null==t?void 0:t.context),r._seekable=r.isLive?new BaseSeekable(r._mediaItemPlayback):new Seekable(r._dispatcher,r._mediaItemPlayback),r.isTracksStation?e=yield r.loadNextTracks(r.station,{context:r.context}):(e.length>1&&Or.warn(`Attempting to play multiple Live Radio Station items (${e.length})`),e=[i]),_superprop_get_replaceQueue().call(r,e,{context:r.context})}))()}appendToQueue(e){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Appending to the Queue is not supported for this type of playback")}))()}insertInQueue(e,t){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Inserting into the Queue is not supported for this type of playback")}))()}prependToQueue(e,t){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Prepending to the Queue is not supported for this type of playback")}))()}clearQueue(){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Clearing the Queue is not supported for this type of playback")}))()}getNewSeeker(){return this.hasCapabilities(ln.SEEK)?super.getNewSeeker():new UnsupportedSeeker}skipToNextItem(){var e=this,_superprop_get_skipToNextItem=()=>super.skipToNextItem;return _async_to_generator$B((function*(){if(!e.isLive)return _superprop_get_skipToNextItem().call(e);Or.warn("Method skipToNextItem is not supported for this type of playback")}))()}loadNextTracks(e,t){var r=this;return _async_to_generator$B((function*(){if(0===(null==t?void 0:t.limit))return Or.warn("Not loading next tracks, limit is set to zero (0)"),[];var n;Or.debug("Loading tracks for station "+e.id);let i=yield r.services.itemLoader.loadStationNextTracks(e.id,{container:null!==(n=null==t?void 0:t.container)&&void 0!==n?n:e,context:null==t?void 0:t.context,limit:null==t?void 0:t.limit});var o;if(Or.debug(`Loaded ${i.length} tracks for station ${e.id}`),0===i.length)throw Or.warn("No track data is available for the current station",{stationId:null===(o=r.station)||void 0===o?void 0:o.id}),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No track data is available for the current station.");return"number"==typeof(null==t?void 0:t.limit)&&t.limit>0&&(i=i.slice(0,t.limit)),i}))()}queueNextTracks(){var e=this;return _async_to_generator$B((function*(){if(!e.isActive)return void Or.debug("Not loading next tracks, controller is not active");if(void 0===e.station||!e.isTracksStation)return void Or.debug("Not loading next tracks, not a tracks radio station");if(e.queue.isEmpty)return void Or.debug("Not loading next tracks, queue is empty");if(-1!==e.queue.nextPlayableItemIndex)return void Or.debug("Not loading next tracks, enough playable items in queue");const t=yield e.loadNextTracks(e.station,{context:e.context,limit:1});t.length>0&&(Or.debug(`Queueing ${t.length} ${1===t.length?"track":"tracks"}`),e.queue.append(t))}))()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$B((function*(){yield _superprop_get_activate().call(e),e._dispatcher.subscribe(Ar.queuePositionDidChange,e.queueNextTracks),e.queueNextTracks()}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$B((function*(){yield _superprop_get_deactivate().call(e),e._dispatcher.unsubscribe(Ar.queuePositionDidChange,e.queueNextTracks)}))()}constructor(e){super(e),_define_property$D(this,"type",an.continuous),_define_property$D(this,"_isLiveStation",!1),_define_property$D(this,"_isTracksStation",!1),_define_property$D(this,"station",void 0),this._continuous=!0}}function asyncGeneratorStep$A(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$C(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$7(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$7(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$8([Bind(),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[void 0===ln?Object:ln]),_ts_metadata$8("design:returntype",Boolean)],ContinuousPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$8([Bind(),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[]),_ts_metadata$8("design:returntype",Promise)],ContinuousPlaybackController.prototype,"queueNextTracks",null);class PercentageWatcher{startMonitor(){this.dispatcher.unsubscribe(Ar.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Ar.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Ar.playbackDurationDidChange,this.updateThreshold),this.dispatcher.subscribe(Ar.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Ar.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Ar.playbackTimeDidChange,this.handleTimeChange),this.threshold=-1}handleTimeChange(e,{currentPlaybackDuration:t,currentPlaybackTime:r}){var n,i=this;return(n=function*(){i.threshold<0&&i.updateThreshold(e,{duration:t}),r<i.threshold||(i.stopMonitor(),yield i.callback(r,i))},function(){var e=this,t=arguments;return new Promise((function(r,i){var o=n.apply(e,t);function _next(e){asyncGeneratorStep$A(o,r,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$A(o,r,i,_next,_throw,"throw",e)}_next(void 0)}))})()}updateThreshold(e,{duration:t}){this.threshold=t*this.percentage}constructor(e,t,r){_define_property$C(this,"dispatcher",void 0),_define_property$C(this,"callback",void 0),_define_property$C(this,"percentage",void 0),_define_property$C(this,"threshold",void 0),this.dispatcher=e,this.callback=t,this.percentage=r,this.threshold=-1}}function asyncGeneratorStep$z(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}_ts_decorate$7([Bind(),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[void 0,void 0]),_ts_metadata$7("design:returntype",Promise)],PercentageWatcher.prototype,"handleTimeChange",null),_ts_decorate$7([Bind(),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[void 0,void 0]),_ts_metadata$7("design:returntype",void 0)],PercentageWatcher.prototype,"updateThreshold",null);class Preloader extends PlaybackMonitor{handlePlaybackThreshold(){var e,t=this;return(e=function*(){yield t.playbackController.prepareToPlayNextItem()},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$z(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$z(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;if(!this.playbackController.hasAuthorization||this.playbackController.previewOnly)return!1;const e=this.getNextPlayableItem(),t=void 0!==e;return this.isSeamlessAudioTransitionsEnabled?t:t&&!(null==e?void 0:e.isPreparedToPlay)}getNextPlayableItem(){return this.playbackController.queue.nextPlayableItem}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"isSeamlessAudioTransitionsEnabled",!1),this.watchers=[new PercentageWatcher(this.dispatcher,this.handlePlaybackThreshold,.3)],this.isSeamlessAudioTransitionsEnabled=jr.features["seamless-audio-transitions"]}}function asyncGeneratorStep$y(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$y(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$y(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$y(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$A(e,t,r[t])}))}return e}function _object_spread_props$d(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$6(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$6(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class SerialPlaybackController extends PlaybackController{get autoplayStation(){return this._autoplayStation}get autoplayStarted(){return void 0!==this._autoplayStation}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e,!0===e?this.startAutoplay():this.stopAutoplay()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$y((function*(){yield _superprop_get_activate().call(e),e._preloader.activate(),e._dispatcher.subscribe(Ar.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.subscribe(Ar.queueItemsDidChange,e.onQueueChange),e._dispatcher.subscribe(Ar.queuePositionDidChange,e.onQueueChange),e._dispatcher.subscribe(Ar.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.subscribe(jt,e.onSeamlessAudioTransition)}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$y((function*(){yield _superprop_get_deactivate().call(e),e._preloader.deactivate(),e._dispatcher.unsubscribe(Ar.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.unsubscribe(Ar.queueItemsDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Ar.queuePositionDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Ar.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.unsubscribe(jt,e.onSeamlessAudioTransition),yield e.stopAutoplay()}))()}hasCapabilities(e){switch(e){case ln.EDIT_QUEUE:case ln.SKIP_NEXT:case ln.SKIP_TO_ITEM:case ln.AUTOPLAY:case ln.VOLUME:case ln.SKIP_PREVIOUS:return!0;case ln.REPEAT:case ln.SHUFFLE:var t,r;return!(null===(r=this.queue)||void 0===r||null===(t=r.currentQueueItem)||void 0===t?void 0:t.isAutoplay);case ln.PAUSE:case ln.SEEK:var n;return!(null===(n=this.nowPlayingItem)||void 0===n?void 0:n.isAssetScrubbingDisabled);default:return!1}}onSeamlessAudioTransition(e,t){var r=this;return _async_to_generator$y((function*(){Or.trace("onSeamlessAudioTransition",t),r._next({userInitiated:!1,seamlessAudioTransition:!0,endReasonType:be.NATURAL_END_OF_TRACK,position:t.previous.playbackDuration/1e3,isPlaying:!1})}))()}onRepeatModeChange(){var e=this;return _async_to_generator$y((function*(){e.repeatMode===Nr.none?(Or.debug("Queueing Autoplay tracks after RepeatMode change"),yield e.queueAutoplayTracks()):(Or.debug("Removing Autoplay tracks after RepeatMode change"),e.queue.removeQueueItems((t,r)=>r>e.queue.position&&t.isAutoplay)),e.repeatMode!==Nr.one&&e.prepareToPlayNextItem()}))()}onQueueChange(){var e=this;return _async_to_generator$y((function*(){e.queue.isInitiated?e.queue.isEmpty||(yield e.queueAutoplayTracks(),e.prepareToPlayNextItem()):(e.stopAutoplay(),e.startAutoplay())}))()}prepareToPlayNextItem(){var e=this;return _async_to_generator$y((function*(){if(!e.nowPlayingItem)return;const t=e.queue.nextPlayableItem;if(t&&e.queue.currentItem!==t)if(e.queue.currentItem.isPreparedToPlay)try{return Or.debug("Preparing next MediaItem: "+mediaItemLogString(t),t),e._mediaItemPlayback.preloadMediaItem(t)}catch(r){Or.debug("next item failed to prepare for playbck -",r)}else Or.debug("Not preparing next item: current item not prepared to play");else Or.debug("Not preparing next item: no next item or current item is same as next item")}))()}appendToQueue(e){var t=this;return _async_to_generator$y((function*(){return t.queue.splice(t.queue.appendTargetIndex,0,e),t.queue}))()}insertInQueue(e,t){var r=this;return _async_to_generator$y((function*(){return r.queue.splice(t,0,e),r.queue}))()}prependToQueue(e,t){var r=this;return _async_to_generator$y((function*(){return!0===(null==t?void 0:t.clear)&&r.queue.clearAfterCurrent(),r.queue.splice(r.queue.position+1,0,e),r.queue}))()}clearQueue(){var e=this;return _async_to_generator$y((function*(){return e.queue.clear(),e.queue}))()}replaceQueue(e,t){var r=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$y((function*(){const n=yield _superprop_get_replaceQueue().call(r,e,t);return yield r.stopAutoplay(),yield r.startAutoplay(),n}))()}stopAutoplay(){var e=this;return _async_to_generator$y((function*(){Or.trace("SerialController.stopAutoplay()"),e._autoplayStation=void 0,e.queue.hasAutoplayStation=!1,Or.debug("Removing unplayed Autoplay tracks from Queue"),e.queue.isInitiated&&e.queue.removeQueueItems((t,r)=>r>e.queue.position&&!0===t.isAutoplay)}))()}startAutoplay(){var e=this;return _async_to_generator$y((function*(){var t;if(Or.trace("SerialController.startAutoplay()"),!e.isActive)return void Or.debug("Not starting autoplay, not active");if(!e.autoplayEnabled)return void Or.debug("Not starting autoplay, not enabled");if(e.repeatMode!==Nr.none)return void Or.debug("Not starting autoplay, repeat mode is on");if(void 0!==e.autoplayStation)return void Or.debug("Autoplay station already created");if(e.loadingAutoplayStation)return void Or.debug("Autoplay station already loading");const r=e.queue.items.slice(-e.maxTracksForAutoplayStation);if(0===r.length)return void Or.debug("No items in queue to start Autoplay station");e.loadingAutoplayStation=!0;const n=null===(t=e.queue.userAddedItems.slice(-1))||void 0===t?void 0:t.pop();let i,o;void 0!==(null==n?void 0:n.container)&&(i={id:n.container.id,type:n.container.type});try{Or.info(`Creating Autoplay station with ${r.length} ${1===r.length?"item":"items"}`);o=(yield e.services.itemLoader.createAutoplayStation(e.queue.items.slice(-e.maxTracksForAutoplayStation),{container:i})).station}catch(xe){Or.warning("Unable to create Autoplay station: "+xe.message)}void 0===o?Or.info("Unable to create Autoplay station: no server data"):Or.info("Created Autoplay Station "+(null==o?void 0:o.id)),e._autoplayStation=o,e.queue.hasAutoplayStation=void 0!==o,e.loadingAutoplayStation=!1,yield e.queueAutoplayTracks()}))()}queueAutoplayTracks(e){var t=this;return _async_to_generator$y((function*(){var r,n;if(void 0===t._autoplayStation)return void Or.debug("Skipping loading Autoplay tracks, no autoplay station");if(0===(null==e?void 0:e.limit))return void Or.warn("Skipping loading Autoplay tracks, track limit set to 0");if(t.queue.unplayedUserItems.length>t.autoplayQueueSizeThreshold)return void Or.debug(`Skipping loading Autoplay tracks, more than ${t.autoplayQueueSizeThreshold} user added tracks in the queue `);if(t.loadingAutoplayTracks)return void Or.debug("Skipping loading Autoplay tracks, already loading");const i=t.autoplayUpcomingTracksLimit-t.queue.unplayedAutoplayItems.length+((null===(r=t.queue.currentQueueItem)||void 0===r?void 0:r.isAutoplay)?1:0);if(i<=0)return void Or.debug(`Skipping loading Autoplay tracks, ${t.autoplayUpcomingTracksLimit} autoplay items already in the queue`);t.loadingAutoplayTracks=!0,Or.debug(`Loading next tracks from Autoplay station ${t._autoplayStation.id} (amount: ${i})`);let o=yield t.services.itemLoader.loadStationNextTracks(t._autoplayStation.id,{limit:i,container:t._autoplayStation,context:_object_spread_props$d(_object_spread$i({},t.context),{featureName:"now_playing",reco_id:(null===(n=t.context.featureName)||void 0===n?void 0:n.startsWith("listen-now"))?void 0:t.context.reco_id})});"number"==typeof(null==e?void 0:e.limit)&&e.limit>0&&(o=o.slice(0,e.limit)),Or.debug(`Queueing ${o.length} tracks from Autoplay station ${t._autoplayStation.id}`),t.queue.appendQueueItems(o.map(e=>new QueueItem(e,{isAutoplay:!0}))),t.loadingAutoplayTracks=!1}))()}_changeToMediaAtIndex(e=0,t={userInitiated:!1}){var r=this,_superprop_get__changeToMediaAtIndex=()=>super._changeToMediaAtIndex;return _async_to_generator$y((function*(){return yield _superprop_get__changeToMediaAtIndex().call(r,e,t)}))()}get shouldTransitionSeamlessly(){return this._isSeamlessAudioTransitionsEnabled&&this.hasAuthorization&&!this.previewOnly}constructor(e){var t,r,n,i,o,a,s,l,c,d;super(e),_define_property$A(this,"type",an.serial),_define_property$A(this,"_preloader",void 0),_define_property$A(this,"_isSeamlessAudioTransitionsEnabled",void 0),_define_property$A(this,"autoplayQueueSizeThreshold",void 0),_define_property$A(this,"autoplayUpcomingTracksLimit",void 0),_define_property$A(this,"maxTracksForAutoplayStation",void 0),_define_property$A(this,"_autoplayStation",void 0),_define_property$A(this,"loadingAutoplayStation",!1),_define_property$A(this,"loadingAutoplayTracks",!1),this._queue=new Queue(e),this._repeatable=new Repeatable(this._dispatcher),this._seekable=new Seekable(this._dispatcher,this._mediaItemPlayback),this._shuffler=new Shuffler(this,{dispatcher:this._dispatcher}),this._isSeamlessAudioTransitionsEnabled=!!(null==e||null===(t=e.bag)||void 0===t?void 0:t.features["seamless-audio-transitions"]),this.autoplayQueueSizeThreshold=null!==(l=null==e||null===(n=e.bag)||void 0===n||null===(r=n.autoplay)||void 0===r?void 0:r.maxQueueSizeForAutoplay)&&void 0!==l?l:50,this.autoplayUpcomingTracksLimit=null!==(c=null==e||null===(o=e.bag)||void 0===o||null===(i=o.autoplay)||void 0===i?void 0:i.maxUpcomingTracksToMaintain)&&void 0!==c?c:10,this.maxTracksForAutoplayStation=null!==(d=null==e||null===(s=e.bag)||void 0===s||null===(a=s.autoplay)||void 0===a?void 0:a.maxQueueSizeInRequest)&&void 0!==d?d:10;const u={controller:this,services:e.services};this._preloader=new Preloader(u)}}_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[void 0===ln?Object:ln]),_ts_metadata$6("design:returntype",Boolean)],SerialPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[String,Object]),_ts_metadata$6("design:returntype",Promise)],SerialPlaybackController.prototype,"onSeamlessAudioTransition",null),_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[]),_ts_metadata$6("design:returntype",Promise)],SerialPlaybackController.prototype,"onRepeatModeChange",null),_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[]),_ts_metadata$6("design:returntype",Promise)],SerialPlaybackController.prototype,"onQueueChange",null),_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[]),_ts_metadata$6("design:returntype",Promise)],SerialPlaybackController.prototype,"prepareToPlayNextItem",null);const cn={};function adaptAddEventListener(e,t,r,n={}){const{once:i}=n,o=function(e,t){const r=getCallbacksForName(e),wrappedCallback=(e,r)=>{t(r)};return r.push([t,wrappedCallback]),wrappedCallback}(t,r);!0===i?e.subscribeOnce(t,o):e.subscribe(t,o)}function getCallbacksForName(e){let t=cn[e];return t||(t=[],cn[e]=t),t}function _define_property$z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class BitrateCalculator{get bitrate(){return this._bitrate}set bitrate(e){this._bitrate!==e&&(this._bitrate=e,this._dispatcher.publish(Be.playbackBitrateDidChange,{bitrate:e}))}_calculateAverageDownlink(){return 0===this._downlinkSamples.length?0:this._downlinkSamples.reduce((e,t)=>e+t,0)/this._downlinkSamples.length||0}_recalculateBitrate(e){fe.debug("_recalculateBitrate",e),this._downlinkSamples.push(e);this._calculateAverageDownlink()>ve.STANDARD?(fe.debug("setting bitrate to",ve.HIGH),this.bitrate=ve.HIGH):(fe.debug("setting bitrate to",ve.STANDARD),this.bitrate=ve.STANDARD)}constructor(e,t=ve.STANDARD){var r,n,i;_define_property$z(this,"_bitrate",void 0),_define_property$z(this,"_dispatcher",void 0),_define_property$z(this,"_downlinkSamples",[]),this._bitrate=null!=t?t:ve.STANDARD,this._dispatcher=e,void 0!==(null===(i=window)||void 0===i||null===(n=i.navigator)||void 0===n||null===(r=n.connection)||void 0===r?void 0:r.downlink)&&this._recalculateBitrate(100*(window.navigator.connection.downlink||0))}}class TimingAccuracy{time(e=0){return 1===this.mode?Math.round(e):e}constructor(e=!1){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"mode",void 0),this.mode=e?0:1}}function asyncGeneratorStep$x(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$x(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$x(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$x(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const dn=Or.createChild("player"),un=BooleanDevFlag.register("mk-hlsjs-song-playback"),pn=BooleanDevFlag.register("mk-hlsjs-disable-reuse-video-player"),hn=BooleanDevFlag.register("mk-force-native-safari-video-player");class MKPlayerManager{get isDestroyed(){return this._isDestroyed}createPlayer(e,t){var r=this;return _async_to_generator$x((function*(){if(dn.trace("PlayerManager.createPlayer()",e,t),"audio"===e.contentType)return r.createAudioPlayer(e,t);if("video"===e.contentType)return r.createVideoPlayer(e,t);throw new MKUniqueError("mk-171",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{description:"Unable to create player for asset: "+e.id,data:e})}))()}createAudioPlayer(e,t){var r=this;return _async_to_generator$x((function*(){const{playerOptions:n}=t;if(yield function(e){return _assetRequiresHlsJs.apply(this,arguments)}(e)){dn.info("Creating HlsJsAudioPlayer required for asset");const e=new HlsJsAudioPlayer(n);return yield e.initialize(),e}{const e=r.cachedPlayers.get(AudioPlayer);if(void 0!==e&&!e.isDestroyed)return dn.debug("Using cached AudioPlayer instance"),e;dn.info("Creating AudioPlayer as a fall through");const t=new AudioPlayer(n);return yield t.initialize(),dn.debug("Caching AudioPlayer instance"),r.cachedPlayers.set(AudioPlayer,t),t}}))()}createVideoPlayer(e,t){var r=this;return _async_to_generator$x((function*(){dn.debug("Creating VideoPlayer");const{playerOptions:e}=t;if(hn.enabled){dn.info("Creating NativeSafariVideoPlayer with mkForceSafariNativeVideoPlayer enabled");const t=new NativeSafariVideoPlayer(e);return yield t.initialize(),t}const n=r.cachedPlayers.get(HlsJsVideoPlayer);if(void 0!==n&&!n.isDestroyed)return dn.debug("Using cached HlsJsVideoPlayer instance"),n;dn.info("Creating HLSjsVideoPlayer as the default");const i=new HlsJsVideoPlayer(e);return yield i.initialize(),!1!==pn.value||r.cachedPlayers.set(HlsJsVideoPlayer,i),i}))()}destroy(){this._isDestroyed=!0;for(const e of this.cachedPlayers.values())e.destroy();this.cachedPlayers.clear()}constructor(e){_define_property$x(this,"services",void 0),_define_property$x(this,"cachedPlayers",new Map),_define_property$x(this,"_isDestroyed",!1),this.services=e.services}}function _assetRequiresHlsJs(){return(_assetRequiresHlsJs=_async_to_generator$x((function*(e){return"video"===e.contentType||(!!(void 0===e.item||isRadioStation(null!==(t=e.item)&&void 0!==t?t:{})||isRadioEpisode(null!==(r=e.item)&&void 0!==r?r:{})||isPodcastPremiumEpisode(null!==(n=e.item)&&void 0!==n?n:{})||isPodcastFreePremiumEpisode(null!==(i=e.item)&&void 0!==i?i:{}))||!!un.enabled);var t,r,n,i}))).apply(this,arguments)}const yn=["artist","album","audioBook","episode","librarySong","movie","musicMovie","musicVideo","playlist","podcast","podcastEpisode","radioStation","song","station","trailer","tvEpisode","uploadedAudio","uploadedVideo"],fn=["artists","albums","audioBooks","episodes","librarySongs","movies","musicVideos","musicMovies","playlists","podcasts","podcastEpisodes","radioStations","songs","stations","trailers","tvEpisodes","uploadedVideos","uploadedAudios"],_n=Or.createChild("item-loader");function isMediaAPIResource(e){return void 0!==e&&"string"==typeof e.id&&"string"==typeof e.type&&void 0!==e.attributes}function convertToItemDescriptors(e){if(Object.keys(e).reduce((function(e,t){return"item"===t||"items"===t||"url"===t||"urls"===t||yn.includes(t)||fn.includes(t)?e+1:e}),0)>1)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Using multiple media kinds is not supported");return function(e){return null!=e&&void 0!==e.item}(e)?convertItemList([e.item]):function(e){return null!=e&&Array.isArray(e.items)}(e)?convertItemList(e.items):function(e){return null!=e&&"string"==typeof e.url}(e)?[convertURL(e.url)]:function(e){return null!=e&&Array.isArray(e.urls)}(e)?e.urls.map(e=>convertURL(e)):function(e){let t;const r=[];for(const a of Object.keys(e)){const n=translateMediaAPIResource(a);isNamedOptionKey(a)&&(void 0===t?t=[n,e[a]]:r.push(a))}const[n,i]=null!=t?t:[];if(void 0===n||void 0===i)return[];r.length>0&&_n.warn(`Found redundant named options besides ${n}: ${r.join(", ")}`);const o=singularizeMediaType(n);return Array.isArray(i)?i.map(e=>({id:e,kind:o})):[{id:i,kind:o}]}(e)}function convertItemList(e){const t=[];for(const r of e)"string"==typeof r?t.push(convertURL(r)):r instanceof MediaItem?t.push({id:r.id,kind:singularizeMediaType(r.type),item:r}):isMediaAPIResource(r)?t.push({id:r.id,kind:singularizeMediaType(r.type),data:r}):t.push(r);return t}function convertURL(e){if(!function(e){return c.test(String(e))}(e))throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"Invalid media URL: "+e);const{contentId:t,kind:r}=parseMediaURL(e);if(void 0===t)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to resolve URL: "+e);const n=translateMediaAPIResource(r);if(void 0===n||!yn.includes(n)&&!fn.includes(n))throw new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unsupported Media Kind: "+n);return{id:t,kind:singularizeMediaType(n)}}function translateMediaAPIResource(e){const t=singularizeMediaType(e);return"episode"===t?"podcastEpisode":"radio-station"===t?"station":e}function isNamedOptionKey(e){return yn.includes(e)||fn.includes(e)}function asyncGeneratorStep$w(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$w(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$w(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$w(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$w(e,t,r[t])}))}return e}function _object_spread_props$c(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class MusicItemLoader{static create(e){const t=new this(e);return t.configure(e),t}configure(e){void 0!==e.fetchContainerPages&&(this.fetchContainerPages=e.fetchContainerPages)}convertOptionsToItemDescriptors(e){return convertToItemDescriptors(e)}buildRequest(e,t){return this.services.mediaAPI.createRequest(e,t)}loadItems(e){var t=this;return _async_to_generator$w((function*(){_n.trace("MusicItemLoader.loadItems()",e),_n.debug("Loading resources for options",e);const r=yield t.loadResources(_object_spread$h({fetchContainerPages:t.fetchContainerPages},e)),n=t.createItems(r,{container:null==e?void 0:e.container,context:null==e?void 0:e.context});return _n.debug(`Transformed ${r.length} resources into ${n.length} MediaItems`),n}))()}loadStation(e){var t=this;return _async_to_generator$w((function*(){_n.debug("Loading Radio Station",e);const r=t.convertOptionsToItemDescriptors(e).find(e=>"station"===e.kind);if(void 0===r)return void _n.debug("No station descriptor found in options, returning undefined");return(yield t.loadItems({restricted:e.restricted,items:[r],container:null==e?void 0:e.container,context:null==e?void 0:e.context,fetchContainerPages:!1}))[0]}))()}loadStationNextTracks(e,t){var r=this;return _async_to_generator$w((function*(){var n,i,o;const a="string"==typeof e?e:e.id,s=r.buildRequest("/v1/me/stations/next-tracks/"+a,{params:void 0!==(null==t?void 0:t.limit)?{limit:t.limit}:void 0,method:"POST"}),l=yield r.fetchResources(s);var c,d,u;const p={id:null!==(c=null==t||null===(n=t.container)||void 0===n?void 0:n.id)&&void 0!==c?c:a,type:"stations",href:null!==(d=null==t||null===(i=t.container)||void 0===i?void 0:i.href)&&void 0!==d?d:`/v1/catalog/${r.services.mediaAPI.storefrontId}/stations/${a}`,attributes:null!==(u=null==t||null===(o=t.container)||void 0===o?void 0:o.attributes)&&void 0!==u?u:{}};var h;const y=null!==(h=null==t?void 0:t.context)&&void 0!==h?h:{};return flattenAll$1(l.map(e=>transform(e,p,y)))}))()}createAutoplayStation(e,t){var r=this;return _async_to_generator$w((function*(){const n=[];for(let r=0;r<e.length;r++){const i=e[r],o=pluralizeMediaType(i instanceof MediaItem?i.type:i.kind);/(-?songs|artists?)$/.test(o)&&n.push({id:i.id,type:isLibraryType(i.id)?"library-songs":"songs",meta:void 0!==(null==t?void 0:t.container)?{container:t.container}:void 0})}if(0===n.length)throw _n.error("Unable to create AutoplayStation: No items to seed"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No items to seed");const i=r.buildRequest("/v1/me/stations/continuous",{params:{"limit[results:tracks]":void 0!==(null==t?void 0:t.limit)&&t.limit>1?t.limit:void 0,with:!0===(null==t?void 0:t.withTracks)?["tracks"]:void 0},method:"POST",body:{data:n}}),{errors:o,results:a}=yield i.send().then(e=>e.json());if(void 0!==o&&o.length>0){_n.error("Unable to create AutoplayStation: Server Error");const e=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unable to create AutoplayStation: Server Error");throw e.data={errors:o},e}if(void 0===(null==a?void 0:a.station))throw _n.error("Unable to create AutoplayStation: No station returned from server"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No station returned from server");const s=r.createItems(a.station,{container:null==t?void 0:t.container,context:null==t?void 0:t.context})[0];let l=[];return Array.isArray(a.tracks)&&(l=r.createItems(a.tracks,{container:s,context:null==t?void 0:t.context})),_n.info(`Created AutoPlay station ${s.id} with ${l.length} tracks`),{station:s,tracks:l}}))()}loadResources(e){var t=this;return _async_to_generator$w((function*(){const r=convertToItemDescriptors(e),n=function(e){const t=_object_spread$h({},e);if(void 0===e)return t;for(const r of["extend","include","relate","fields"])if(void 0!==t[r]){const n=e[r];"string"==typeof n&&(t[r]=n.split(/(?:,{1}?\s*|\s+)/))}return t}(e.parameters),i=new Map(r.map((e,t)=>[e.id,{position:t,descriptor:e}])),o=function(e,t){const r={};for(const n of e){const e=t(n);void 0===r[e]&&(r[e]=[]),r[e].push(n)}return r}(r,e=>e.kind),a=Object.entries(o),s=[],l=[];for(const[p,h]of a){const r=[],i=[],o=[];for(const e of h)void 0!==e.item||void 0!==e.data?r.push(e):(isLibraryType(e.id)?o:i).push(e);const a=[];/^(?:playlists?|albums?)$/i.test(p)&&a.push("tracks"),/^podcasts?$/i.test(p)&&a.push("episodes");const c=/^(?:playlists?|library-playlists?)$/i.test(p),d=e.restricted?"explicit":void 0;r.length>0&&s.push(...r.map(e=>{var t;return null!==(t=e.item)&&void 0!==t?t:e.data}));const u=deepmerge(deepClone(n),{include:a,extend:c?["hasCollaboration"]:[],restrict:d}),y=16;if(i.length>0){const e=batchIds(i,y);for(const r of e)l.push(t.buildRequest(`/v1/catalog/${t.services.mediaAPI.storefrontId}/${dasherize(p)}s`,{params:_object_spread_props$c(_object_spread$h({},u),{ids:r})}))}if(o.length>0)if("song"===p){const e=batchIds(o,y);for(const r of e)l.push(t.buildRequest(`/v1/me/library/${dasherize(p)}s/`,{params:_object_spread_props$c(_object_spread$h({},u),{ids:r})}))}else for(const e of o)l.push(t.buildRequest(`/v1/me/library/${dasherize(p)}s/${e.id}`,{params:u}))}const c=yield Promise.all(l.map(r=>t.fetchResources(r,{fetchContainerPages:e.fetchContainerPages,containerItemLimit:e.containerItemLimit,restricted:e.restricted}))),d=Array(i.size);for(const e of[...s,...flattenAll$1(c)]){const t=i.get(e.id);void 0!==(null==t?void 0:t.position)&&(d[t.position]=e)}const u=[];for(const{position:e,descriptor:t}of i.values())void 0===d[e]&&u.push(t);if(u.length>0){const e=new MKError(MKError.Reason.NOT_FOUND,"One or more items could not be resolved: "+u.map(({id:e})=>e).join(", "));throw e.data=u,e}return d}))()}fetchResources(e,t){var r=this;return _async_to_generator$w((function*(){const n=(null==t?void 0:t.restricted)?"explicit":void 0;var i;const o=null!==(i=null==t?void 0:t.fetchContainerPages)&&void 0!==i&&i;var a;const s=Math.max(0,null!==(a=null==t?void 0:t.containerItemLimit)&&void 0!==a?a:1/0),l=yield e.send(),c=yield l.json();if(void 0===(null==c?void 0:c.data))return _n.error("Unable to fetch resources: empty data from server"),[];const d=Array.isArray(c.data)?c.data:[c.data];return Promise.all(d.map(function(){var e=_async_to_generator$w((function*(e){var t,i,a;const l=null!==(a=null===(t=e.relationships)||void 0===t?void 0:t.tracks)&&void 0!==a?a:null===(i=e.relationships)||void 0===i?void 0:i.episodes;if(void 0===l)return e;const c=[...l.data];let d;for(o&&c.length<s&&(d=l.next);void 0!==d;){const e=Math.min(100,s-c.length),t=r.buildRequest(d,{params:{restrict:n,limit:e}}),i=yield t.send(),o=yield i.json();c.push(...o.data),d=c.length<s?o.next:void 0}return null==l||delete l.next,null==l||delete l.href,l.data=c.slice(0,s),e}));return function(t){return e.apply(this,arguments)}}()))}))()}createItems(e,t){return flattenAll$1((e=Array.isArray(e)?e:[e]).map(e=>transform(e,null==t?void 0:t.container,null==t?void 0:t.context)))}constructor(e){var t;_define_property$w(this,"services",void 0),_define_property$w(this,"fetchContainerPages",void 0),_define_property$w(this,"isConfigured",!0),this.services=e.services,this.fetchContainerPages=null!==(t=e.fetchContainerPages)&&void 0!==t&&t}}function batchIds(e,t){return e.reduce((function(e,r,n){const i=Math.floor(n/t);return void 0===e[i]&&(e[i]=[]),e[i].push(r.id),e}),[])}function asyncGeneratorStep$v(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$v(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$v(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$v(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$5(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$5(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class PlayActivityService{get isEnabled(){return this.enabled}get isConfigured(){return void 0!==this.config}get dispatcher(){return this.services.dispatcher}get trackers(){return this._trackers}configure(e){var t=this;return _async_to_generator$v((function*(){t.config=e,t.isEnabled&&(yield t.configureTrackers())}))()}enable(){var e=this;return _async_to_generator$v((function*(){e.isEnabled||(e.enabled=!0,yield e.configureTrackers())}))()}disable(){var e=this;return _async_to_generator$v((function*(){e.isEnabled&&(e.enabled=!1,e.teardownListeners(),yield Promise.all(e.trackers.map(function(){var e=_async_to_generator$v((function*(e){try{var t;yield null===(t=e.cleanup)||void 0===t?void 0:t.call(e)}catch(r){Or.warn("Tracker failed to clean up: "+e.constructor.name)}}));return function(t){return e.apply(this,arguments)}}())))}))()}registerTracker(e){var t=this;return _async_to_generator$v((function*(){yield t.registerTrackers([e])}))()}registerTrackers(e){var t=this;return _async_to_generator$v((function*(){t.trackers.push(...e),t.isConfigured&&t.isEnabled&&(yield t.configureTrackers())}))()}getTrackerByType(e){return this._trackers.find(t=>t instanceof e)}configureTrackers(){var e=this;return _async_to_generator$v((function*(){const t=e.config;if(void 0===t)throw new MKUniqueError("mk-142",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"PlayActivityService is not configured yet"});if(e.isEnabled){yield Promise.all(e.trackers.map(function(){var e=_async_to_generator$v((function*(e){try{var t;yield null===(t=e.cleanup)||void 0===t?void 0:t.call(e)}catch(r){Or.warn("Tracker failed to clean up: "+e.constructor.name)}}));return function(t){return e.apply(this,arguments)}}())),e.teardownListeners(),e.registeredEvents=new Set;for(const t of e._trackers)for(const r of t.requestedEvents)e.registeredEvents.add(r);e.setupListeners(),yield Promise.all(e.trackers.map(function(){var e=_async_to_generator$v((function*(e){try{yield e.configure(t)}catch(r){Or.warn("Tracker failed to configure: "+e.constructor.name)}}));return function(t){return e.apply(this,arguments)}}()))}}))()}handleEvent(e,t={}){const r=this.addIntention(e,t);e===me.playerActivate&&(r.flush="boolean"==typeof t.isPlaying?!t.isPlaying:void 0);for(const n of this._trackers)n.handleEvent(e,r,t.item)}addIntention(e,t){if(![me.playbackPause,me.playbackStop].includes(e))return t;const r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$v(e,t,r[t])}))}return e}({},this.lastUserIntent,this.lastApplicationIntent,t);return this.clearIntention(),r}clearIntention(){this.lastUserIntent=void 0,this.lastApplicationIntent=void 0}recordApplicationIntent(e,t){this.lastApplicationIntent=t}recordUserIntent(e,t){this.lastUserIntent=t}setupListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.subscribe(e,this.handleEvent)}),this.dispatcher.subscribe(me.userActivityIntent,this.recordUserIntent),this.dispatcher.subscribe(me.applicationActivityIntent,this.recordApplicationIntent)}teardownListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.unsubscribe(e,this.handleEvent)}),this.dispatcher.unsubscribe(me.userActivityIntent,this.recordUserIntent),this.dispatcher.unsubscribe(me.applicationActivityIntent,this.recordApplicationIntent)}constructor(e){var t;_define_property$v(this,"services",void 0),_define_property$v(this,"config",void 0),_define_property$v(this,"_trackers",[]),_define_property$v(this,"enabled",!0),_define_property$v(this,"registeredEvents",new Set),_define_property$v(this,"lastUserIntent",void 0),_define_property$v(this,"lastApplicationIntent",void 0),this.services=e.services,this.enabled=null===(t=e.enabled)||void 0===t||t,void 0!==e.trackers&&this.registerTrackers(e.trackers)}}function asyncGeneratorStep$u(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$u(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$u(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$u(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$4(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$4(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,Object]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"handleEvent",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"recordApplicationIntent",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"recordUserIntent",null);const vn=xr.createChild("playback"),assertLinearOnUnsupportedDevice=(e,t)=>{const{os:r}=t;if(e.isLinearStream&&("ios"===r.name||"ipados"===r.name)){vn.warn("Cannot play linear stream on iOS or iPad");const t=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"IOS LINEAR");throw t.data={item:e},t}},mn=function(){var e=_async_to_generator$u((function*(e,t){var r,n;if(null===(n=e.container)||void 0===n||null===(r=n.attributes)||void 0===r?void 0:r.requiresSubscription){if(!(yield t())){const t=new MKError(MKError.Reason.SUBSCRIPTION_ERROR);throw t.data=e,t}}}));return function(t,r){return e.apply(this,arguments)}}(),assertHLSOnUnsupportedDevice=(e,t)=>{const{isMSESupported:r,isMMSSupported:n}=t;if(e.hasOffersHlsUrl&&!r&&!n){vn.warn("HLSjs is not supported");const t=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"HLSjs Unsupported on Device");throw t.data={item:e},t}};let gn=!1;class MediaItemPlayback{get isDestroyed(){return this._isDestroyed}get bitrateCalculator(){return this.services.bitrateCalculator}get dispatcher(){return this.services.dispatcher}get playerManager(){return this.services.player}get manifestManager(){return this.services.manifest}get currentPlaybackTime(){return this._currentPlayer.currentPlaybackTime}get currentPlaybackTimeRemaining(){return this._currentPlayer.currentPlaybackTimeRemaining}get currentPlayingDate(){return this._currentPlayer.currentPlayingDate}get isPlayingAtLiveEdge(){return this._currentPlayer.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._currentPlayer.seekableTimeRanges}get audioTracks(){return this._currentPlayer.audioTracks}get currentAudioTrack(){return this._currentPlayer.currentAudioTrack}set currentAudioTrack(e){this._currentPlayer.currentAudioTrack=e}get currentPlaybackDuration(){return this._currentPlayer.currentPlaybackDuration}get currentBufferedProgress(){return this._currentPlayer.currentBufferedProgress}get currentPlaybackProgress(){return this._currentPlayer.currentPlaybackProgress}get currentTextTrack(){return this._currentPlayer.currentTextTrack}set currentTextTrack(e){this._currentPlayer.currentTextTrack=e}get isPlaying(){return this._currentPlayer.isPlaying}get isPrimaryPlayer(){return this._currentPlayer.isPrimaryPlayer}set isPrimaryPlayer(e){this._currentPlayer.isPrimaryPlayer=e}get isReady(){return this._currentPlayer.isReady}get nowPlayingItem(){return this._currentPlayer.nowPlayingItem}get currentTimedMetadata(){return this._currentTimedMetadata}get playbackRate(){return this._currentPlayer.playbackRate}set playbackRate(e){this._updatePlayerState("playbackRate",e)}get defaultPlaybackRate(){return this._currentPlayer.defaultPlaybackRate}set defaultPlaybackRate(e){this._updatePlayerState("defaultPlaybackRate",e)}get playbackState(){return this._currentPlayer.playbackState}set playbackState(e){this._currentPlayer.setPlaybackState(e,this.nowPlayingItem)}get playbackTargetAvailable(){return this._currentPlayer.playbackTargetAvailable}get playbackTargetIsWireless(){return this._currentPlayer.playbackTargetIsWireless}get supportsPreviewImages(){return this._currentPlayer.supportsPreviewImages}get textTracks(){return this._currentPlayer.textTracks}get volume(){return this._currentPlayer.volume}set volume(e){this._currentPlayer.isDestroyed&&this.dispatcher.publish(Be.playbackVolumeDidChange,{}),this._updatePlayerState("volume",e)}clearNextManifest(){this._currentPlayer.clearNextManifest()}destroy(){var e;this._currentTimedMetadata=void 0,this._isDestroyed=!0,this.dispatcher.unsubscribe(et.playbackLicenseError,this.onPlaybackLicenseError),this.dispatcher.unsubscribe(ur.keySystemGenericError,this.onKeySystemGenericError),null===(e=this.dispatcher)||void 0===e||e.unsubscribe(ur.keySystemGenericError,this.onBufferTimedMetadataDidChange)}exitFullscreen(){return this._currentPlayer.exitFullscreen()}loadPreviewImage(e){var t=this;return _async_to_generator$u((function*(){return t._currentPlayer.loadPreviewImage(e)}))()}getNewSeeker(){return this._currentPlayer.newSeeker()}mute(){this._volumeAtMute=this.volume,this.volume=0}pause(e){var t=this;return _async_to_generator$u((function*(){return t._currentPlayer.pause(e)}))()}play(){var e=this;return _async_to_generator$u((function*(){return e._currentPlayer.play()}))()}preload(){var e=this;return _async_to_generator$u((function*(){return e._currentPlayer.preload()}))()}prepareToPlay(e){var t=this;return _async_to_generator$u((function*(){return vn.trace("MediaItemPlayback.prepareToPlay()",e),t.preloadMediaItem(e)}))()}preloadMediaItem(e){var t=this;return _async_to_generator$u((function*(){if(vn.trace("MediaItemPlayback.preloadItem()",e),function(e){var t,r;const n=null!==(r=null==e||null===(t=e.attributes)||void 0===t?void 0:t.offers)&&void 0!==r?r:[];return isPodcastEpisode(e)&&n.some(({type:e})=>"STDQ"===e)}(e))return vn.info("Free podcast episode, not preparing item: "+e,e),e;const r=t.playOptions.get(e.id);vn.info("Preparing MediaItem: "+e,e);const n=yield t.services.assetResolver.resolveAsset(e,{previewOnly:t.previewOnly,subscription:yield t.hasMusicSubscription(),bitrate:t.services.bitrateCalculator.bitrate===ve.HIGH?256:64,startOver:null==r?void 0:r.startOver,bingeWatching:null==r?void 0:r.bingeWatching});return updateMediaItemFromAsset(e,n,t.previewOnly),vn.info(`Calling ${t._currentPlayer.constructor.name}.preloadItem for ${e}`),yield t._currentPlayer.preloadItem(e,r),e}))()}requestFullscreen(e){return this._currentPlayer.requestFullscreen(e)}showPlaybackTargetPicker(){this._currentPlayer.showPlaybackTargetPicker()}seekToTime(e,t=Se.Manual){var r=this;return _async_to_generator$u((function*(){yield r._currentPlayer.seekToTime(e,t)}))()}setPresentationMode(e){var t=this;return _async_to_generator$u((function*(){return t._currentPlayer.setPresentationMode(e)}))()}startMediaItemPlayback(e,t){var r=this;return _async_to_generator$u((function*(){return vn.trace("MediaItemPlayback.startMediaItemPlayback()",e),r.playMediaItem(e,t)}))()}playMediaItem(e,t=!1,r){var n=this;return _async_to_generator$u((function*(){vn.trace("MediaItemPlayback.playMediaItem()",e),assertLinearOnUnsupportedDevice(e,n.services.runtime),assertHLSOnUnsupportedDevice(e,n.services.runtime),yield mn(e,n.hasMusicSubscription),n.playOptions.has(e.id)&&(r=null!=r?r:n.playOptions.get(e.id),n.playOptions.delete(e.id));const i=yield n.services.assetResolver.resolveAsset(e,{previewOnly:n.previewOnly,subscription:yield n.hasMusicSubscription(),bitrate:n.services.bitrateCalculator.bitrate===ve.HIGH?256:64,startOver:null==r?void 0:r.startOver,bingeWatching:null==r?void 0:r.bingeWatching});return yield n.playAsset(i,t,r),e}))()}playAsset(e,t=!1,r){var n=this;return _async_to_generator$u((function*(){vn.trace("MediaItemPlayback.playAsset",e);const i=e.item;null==i||i.resetState(),assertLinearOnUnsupportedDevice(i,n.services.runtime),assertHLSOnUnsupportedDevice(i,n.services.runtime),yield mn(i,n.hasMusicSubscription),n._currentTimedMetadata=void 0,n.playOptions.has(i.id)&&(r=null!=r?r:n.playOptions.get(i.id),n.playOptions.delete(i.id));const o=yield n.playerManager.createPlayer(e,{playerOptions:n.playerOptions,playOptions:r});if(yield n.setCurrentPlayer(o),updateMediaItemFromAsset(i,e,n.previewOnly),e.encrypted){if(!e.encrypted)throw new MKUniqueError("mk-170",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{description:"Unable to play asset for MediaItem",data:{asset:e,item:i}});vn.debug("Initializing encrypted playback for "+i,e),i.playbackType=h.encryptedFull,o.nowPlayingItem=i,yield o.playItemFromEncryptedSource(i,t,r)}else{vn.debug("Initializing unencrypted playback for "+i,e);const a=o.isPaused()&&!t;i.playbackType=n.previewOnly||e.preview?h.preview:h.unencryptedFull,o.nowPlayingItem=i,yield o.playItemFromUnencryptedSource(e.assetURL,a,n.previewOnly?void 0:r)}return n.currentPlayback={asset:e,item:i,userInitiated:t},e}))()}stop(e){var t=this;return _async_to_generator$u((function*(){yield t._currentPlayer.stop(e)}))()}unmute(){this.volume>0||(this.volume=this._volumeAtMute||1,this._volumeAtMute=void 0)}setCurrentPlayer(e){var t=this;return _async_to_generator$u((function*(){return t._currentPlayer===e||(vn.debug("MediaItemPlayback: setting currentPlayer",e),yield t._currentPlayer.stop(),t._currentPlayer=e,vn.trace("Applying default player state",e,t.playerState),Object.assign(e,t.playerState),t.dispatcher.publish(Be.playerTypeDidChange,{player:e})),e}))()}getCurrentPlayer(){return this._currentPlayer}onKeySystemGenericError(e,t){var r=this;return _async_to_generator$u((function*(){if(gn)r.dispatcher.publish(Be.mediaPlaybackError,t);else if(gn=!0,vn.warn("Retrying playback after keysystemGenericError"),yield r.stop(),void 0!==r.currentPlayback){const{asset:e,item:t,userInitiated:n}=r.currentPlayback;void 0!==e?yield r.playAsset(e,n):yield r.playMediaItem(t,n)}}))()}onBufferTimedMetadataDidChange(e,t){this._currentTimedMetadata=t.metadata}onPlaybackLicenseError(e,t){var r=this;return _async_to_generator$u((function*(){r.dispatcher.publish(Be.mediaPlaybackError,t)}))()}_updatePlayerState(e,t){this.playerState[e]=t,this._currentPlayer[e]=t}constructor(e){_define_property$u(this,"playerState",{defaultPlaybackRate:1,playbackRate:1,volume:1}),_define_property$u(this,"playOptions",new Map),_define_property$u(this,"hasMusicSubscription",void 0),_define_property$u(this,"_currentPlayer",void 0),_define_property$u(this,"services",void 0),_define_property$u(this,"previewOnly",!1),_define_property$u(this,"_volumeAtMute",void 0),_define_property$u(this,"currentPlayback",void 0),_define_property$u(this,"_isDestroyed",!1),_define_property$u(this,"_currentTimedMetadata",void 0),_define_property$u(this,"playerOptions",void 0),this.services=e.services,this.playerOptions=e.playerOptions;const{playbackServices:t}=e.playerOptions;this.hasMusicSubscription=t.hasMusicSubscription,function(e){kt=e}(this.playerOptions.tokens),this._currentPlayer=new PlayerStub(this.playerOptions),this.dispatcher.subscribe(et.playbackLicenseError,this.onPlaybackLicenseError),this.dispatcher.subscribe(ur.keySystemGenericError,this.onKeySystemGenericError),this.dispatcher.subscribe(Kt,this.onBufferTimedMetadataDidChange)}}function updateMediaItemFromAsset(e,t,r){e.assetURL=t.assetURL,t.encrypted&&(e.keyURLs={"hls-key-server-url":t.keyServerURL,"hls-key-cert-url":t.keyCertURL,"widevine-cert-url":t.keyCertURL}),void 0!==t.meta&&(e.hlsMetadata=t.meta),r?e.playbackType=h.preview:t.encrypted?t.encrypted?e.playbackType=h.encryptedFull:e.playbackType=h.none:e.playbackType=h.unencryptedFull,e.state=y.ready}function asyncGeneratorStep$t(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$t(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$t(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$t(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onKeySystemGenericError",null),_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",void 0)],MediaItemPlayback.prototype,"onBufferTimedMetadataDidChange",null),_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onPlaybackLicenseError",null);const bn=Or.createChild("rtc");class RTCStreamingTracker{get isConfigured(){return void 0!==this.instance}configure(e){var t=this;return _async_to_generator$t((function*(){t.instance=e.instance}))()}handleEvent(e,t,r){}loadScript(){return _async_to_generator$t((function*(){if(!jr.urls.rtc)throw new Error("bag.urls.rtc is not configured");yield loadScript(jr.urls.rtc)}))()}prepareReportingAgent(e){this.clearReportingAgent();const{Sender:t,ClientName:r,ServiceName:n,ApplicationName:i,ReportingStoreBag:o,DeviceName:a}=window.rtc.RTCReportingAgentConfigKeys;e=null!=e?e:this.instance.nowPlayingItem;const s=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$t(e,t,r[t])}))}return e}({firmwareVersion:this.generateBrowserVersion(),model:this.options.browserName},this.getMediaIdentifiers(e));void 0===this._storeBag&&(this._storeBag=this.generateStoreBag());const l={[t]:"HLSJS",[r]:this.options.clientName,[n]:this.options.serviceName,[i]:this.options.applicationName,[o]:this._storeBag,[a]:this.options.osVersion,userInfoDict:s};return bn.debug("RTC: creating reporting agent with config",l),this.reportingAgent=new window.rtc.RTCReportingAgent(l),bn.debug("RTC: created reporting agent",this.reportingAgent),this.reportingAgent}cleanup(){var e=this;return _async_to_generator$t((function*(){e.clearReportingAgent()}))()}getMediaIdentifiers(e){const t=null==e?void 0:e.defaultPlayable;if(t){var r;const e={};return void 0!==(null===(r=t.mediaMetrics)||void 0===r?void 0:r.MediaIdentifier)&&(e.MediaIdentifier=t.mediaMetrics.MediaIdentifier),void 0!==t.channelId&&(e.ContentProvider=t.channelId),e}return"musicVideo"===(null==e?void 0:e.type)?{MediaIdentifier:"adamid="+e.id}:(null==e?void 0:e.isLiveVideoStation)?{MediaIdentifier:"raid="+e.id}:void 0}clearReportingAgent(){void 0!==this.reportingAgent&&(this.reportingAgent.destroy(),bn.debug("RTC: called destroy on reporting agent",this.reportingAgent),this.reportingAgent=void 0)}generateBrowserVersion(){return this.options.browserMajorVersion?`${this.options.browserMajorVersion}.${this.options.browserMinorVersion||0}`:"unknown"}generateStoreBag(){var e;const{storeBagURL:t,clientName:r,applicationName:n,serviceName:i,browserName:o}=this.options,a={iTunesAppVersion:`${`${jr.app.name}-${jr.app.build}`}/${null===(e=this.instance)||void 0===e?void 0:e.version}`},s=new window.rtc.RTCStorebag.RTCReportingStoreBag(t,r,i,n,o,a);return bn.debug("RTC: created store bag",s),s}constructor(e){_define_property$t(this,"options",void 0),_define_property$t(this,"reportingAgent",void 0),_define_property$t(this,"instance",void 0),_define_property$t(this,"currentMediaItem",void 0),_define_property$t(this,"_storeBag",void 0),_define_property$t(this,"requestedEvents",[]),this.options=e}}function flattenAll(e){return function(e,t=1){if("function"==typeof Array.prototype.flat)return Array.prototype.flat.call(e,t);if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Array.isArray(e)||(e=Array.from(e)),function flat(e,t){return t<=0?e.slice():Array.prototype.reduce.call(e,(function(e,r){return Array.isArray(r)?e.concat(flat(r,t-1)):[...e,r]}),[])}(e,t)}(e,1/0)}function _define_property$s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$e(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$s(e,t,r[t])}))}return e}function _object_spread_props$b(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function isString$2(e){return"string"==typeof e}function isEmptyString$2(e,t){if(!isString$2(e))return!1;return 0===(!0===(null==t?void 0:t.trim)?e.trim():e).length}function isFunction$2(e){return"function"==typeof e}function formatQueryString(e,t){if(!e)return"";let r=!0===(null==t?void 0:t.prefix)?"?":"";if(isString$2(null==t?void 0:t.prefix)&&(r=t.prefix),isString$2(e))return r+function(e,t){if((t=isString$2(t)&&!isEmptyString$2(t,{trim:!0})?t:"").length>1)throw new Error("QueryString prefix can only be a single character");return e.replace(new RegExp(`^[?&${t}]+`,"i"),"")}(e,r);var n,i;const o=isFunction$2(null==t?void 0:t.arrayFormat)?t.arrayFormat:null!==(i=Tn[null!==(n=null==t?void 0:t.arrayFormat)&&void 0!==n?n:Sn])&&void 0!==i?i:Tn[Sn];var a,s;const l=isFunction$2(null==t?void 0:t.objectFormat)?t.objectFormat:null!==(s=kn[null!==(a=null==t?void 0:t.objectFormat)&&void 0!==a?a:Pn])&&void 0!==s?s:kn[Pn];var c;const d=null!==(c=null==t?void 0:t.sort)&&void 0!==c?c:DEFAULT_SORTER;let u=DEFAULT_ENCODER;var p,h,y,f,_;isFunction$2(null==t?void 0:t.encode)&&(u=t.encode);const v=l(e,{path:[],format:function(e,r){return function(e,t){if(void 0===e&&!1!==(null==t?void 0:t.skipUndefined))return!0;if(null===e&&!1!==(null==t?void 0:t.skipNull))return!0;if(isEmptyString$2(e)&&!1!==(null==t?void 0:t.skipEmptyString))return!0;if(Array.isArray(e)&&0===e.length&&!1!==(null==t?void 0:t.skipEmptyArray))return!0;return!1}(e,t)?"":function(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}(e)?l(e,r):Array.isArray(e)?o(e,r):formatPrimitive(e,r)},encode:u,sort:d,formatting:{skipNull:null!==(p=null==t?void 0:t.skipNull)&&void 0!==p&&p,skipUndefined:null===(h=null==t?void 0:t.skipUndefined)||void 0===h||h,skipEmptyString:null===(y=null==t?void 0:t.skipEmptyString)||void 0===y||y,skipEmptyArray:null===(f=null==t?void 0:t.skipEmptyArray)||void 0===f||f,includeNullValue:null!==(_=null==t?void 0:t.includeNullValue)&&void 0!==_&&_}});return isEmptyString$2(v)?"":r+v}const Sn="bracket",Pn="bracket",DEFAULT_ENCODER=e=>encodeURIComponent(String(e)),DEFAULT_SORTER=(...e)=>0,kn={bracket:function(e,t){return Object.keys(e).sort(t.sort).map((function(r){return t.format(e[r],_object_spread_props$b(_object_spread$e({},t),{path:t.path.concat(r)}))})).filter(e=>!isEmptyString$2(e)).join("&")},dot:function(e,t){throw new Error("Not Implemented")}},Tn={comma:function(e,t){return formatPrimitive(e.join(","),t)},repeat:function(e,t){return 0===e.length&&!1===t.formatting.skipEmptyArray?formatPrimitive("",t):e.map(e=>formatPrimitive(String(e),t)).filter(e=>e.length>0).join("&")},bracket:function(e,t){return 0===e.length&&!1===t.formatting.skipEmptyArray?formatPrimitive("",t):e.map((function(e){return t.format(e,_object_spread_props$b(_object_spread$e({},t),{path:[...t.path,""]}))})).filter(e=>!isEmptyString$2(e)&&!1!==t.formatting.skipEmptyArray).join("&")},index:function(e,t){return 0===e.length&&!1===t.formatting.skipEmptyArray?formatPrimitive("",t):e.map((function(e,r){return t.format(e,_object_spread_props$b(_object_spread$e({},t),{path:[...t.path,String(r)]}))})).filter(e=>!isEmptyString$2(e)&&!1!==t.formatting.skipEmptyArray).join("&")}};function formatPrimitive(e,t){const r=t.path.map((e,r)=>0===r?t.encode(e):`[${t.encode(e)}]`).join("");return null===e&&!0!==t.formatting.includeNullValue?r:`${r}=${t.encode(e)}`}function buildURLQueryString(e,t){return formatQueryString(e,{prefix:null==t?void 0:t.prefix,objectFormat:"bracket",arrayFormat:"comma"})}function buildURLString(e,t,r){let n=null!=t?t:"";(function(e){return!!e&&"object"==typeof e&&!Array.isArray(e)})(n)&&(r=t,n="");const i=function(...e){const t=flattenAll(e).filter(e=>"string"==typeof e&&0!==e.trim().length);if(0===t.length)return"/";let r=t[0];for(let n=1;n<t.length;n++)r=r.replace(/[/]+$/,"")+"/"+t[n].replace(/^[/]+/,"");/^([a-z][a-z0-9\-_+]+)?:\/\//i.test(r)||(r="/"+r.replace(/^[/]+/,""));return r=r.replace(/(:)?[/]+/g,(e,t)=>t?e:"/"),r}(e,n);let o="?";i.endsWith("&")||i.endsWith("?")?o="":i.includes("?")&&(o="&");return i+(void 0===r?"":buildURLQueryString(r,{prefix:o}))}function isString$1(e){return"string"==typeof e}const isNotEmptyString=e=>!function(e,t){return!!isString$1(e)&&0===(!0===(null==t?void 0:t.trim)?e.trim():e).length}(e);function asyncGeneratorStep$s(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$s(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$s(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$s(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class MediaAPIRequestBuilder{static create(e){return new MediaAPIRequestBuilder(e)}withMethod(e){return this._config.method=e,this}withScheme(e){return this._config.scheme=e,this}withHost(e){const t=/^(https?)?(:?:\/\/)?([^/]+)/i.exec(e);return t&&(isNotEmptyString(t[1])&&this.withScheme(t[1]),this._config.host=t[2]),this}withPath(e){return this._config.path="/"+e.replace(/^\/+/,""),this}withHeader(e,t){return this._config.headers[e.toLowerCase()]=t,this}withHeaders(e){if(e instanceof Headers||e instanceof Map)for(const[t,r]of e.entries())this.withHeader(t,r);else for(const[t,r]of Object.entries(e))this.withHeader(t,r);return this}withDeveloperToken(e){return this.withHeader("Authorization","Bearer "+e)}withMediaUserToken(e){return this.withHeader("Media-User-Token",e)}withUserAgent(e){return this.withHeader("User-Agent",e)}withUserCountry(e){return this.withHeader("User-Country",e)}withQueryParams(e){return void 0===this._config.params&&(this._config.params={}),Object.assign(this._config.params,e),this}withQueryParam(e,t){return this.withQueryParams({[e]:t})}withParams(e){return this.withQueryParams(e)}withParam(e,t){return this.withQueryParams({[e]:t})}withBody(e){var t;return void 0===(null===(t=this._config.headers)||void 0===t?void 0:t["Content-Type"])&&this.withHeader("Content-Type","application/json"),this._config.body=isString$1(e)?e:JSON.stringify(e),this}withConfig(e){const t={scheme:this.withScheme,method:this.withMethod,host:this.withHost,path:this.withPath,headers:this.withHeaders,params:this.withQueryParams,body:this.withBody};for(const[r,n]of Object.entries(t)){const t=e[r];void 0!==t&&n.call(this,t)}return this}withURL(e){return this.withConfig(function(e){const t={method:"GET",host:e.hostname,path:e.pathname};if(e.searchParams.size>0){const r={};for(const[t,n]of e.searchParams.entries())r[t]=n;t.params=r}return t}(e))}config(){var e=this;return _async_to_generator$s((function*(){return e._config}))()}build(){var e=this;return _async_to_generator$s((function*(){const{MediaAPIRequest:t}=yield Promise.resolve().then((function(){return En}));return new t(yield e.config())}))()}send(e){var t=this;return _async_to_generator$s((function*(){const{sendRequest:r}=yield Promise.resolve().then((function(){return En}));return r(yield t.build(),{fetch:null==e?void 0:e.fetch})}))()}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"_config",{method:"GET",scheme:"https",host:"",path:"",headers:{},params:{},body:void 0}),this.withConfig(null!=e?e:{})}}class MACError extends Error{constructor(e,t,r){super(t)}}function asyncGeneratorStep$r(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$r(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$r(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$r(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MediaAPIResponse{get url(){return this.response.url}get status(){return this.response.status}get statusText(){return this.response.statusText}get ok(){return this.response.ok}get headers(){return this.response.headers}text(){var e=this;return _async_to_generator$r((function*(){return void 0===e.textPayload&&(e.textPayload=yield e.response.text()),e.textPayload}))()}json(){var e=this;return _async_to_generator$r((function*(){if(void 0===e.jsonPayload){const t=yield e.text();e.jsonPayload=JSON.parse(t)}return e.jsonPayload}))()}hasData(){var e=this;return _async_to_generator$r((function*(){return void 0!==(yield e.json()).data}))()}hasNext(){var e=this;return _async_to_generator$r((function*(){return void 0!==(yield e.json()).next}))()}hasErrors(){var e=this;return _async_to_generator$r((function*(){return void 0!==(yield e.json()).errors}))()}data(){var e=this;return _async_to_generator$r((function*(){return(yield e.json()).data}))()}next(){var e=this;return _async_to_generator$r((function*(){return(yield e.json()).next}))()}errors(){var e=this;return _async_to_generator$r((function*(){return(yield e.json()).errors}))()}constructor(e,t){_define_property$q(this,"__brand__","MediaAPIResponse"),_define_property$q(this,"config",void 0),_define_property$q(this,"response",void 0),_define_property$q(this,"textPayload",void 0),_define_property$q(this,"jsonPayload",void 0),this.response=e,this.config=function(e){return null!=e&&"MediaAPIRequest"===e.__brand__}(t)?t.config:t}}function asyncGeneratorStep$q(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$q(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$q(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$q(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MediaAPIRequest extends Request{static builder(){return _async_to_generator$q((function*(){return MediaAPIRequestBuilder.create()}))()}send(e){var t=this;return _async_to_generator$q((function*(){return sendRequest(t,e)}))()}constructor(e){var t,r;const n=new URL(buildURLString(`${null!==(t=e.scheme)&&void 0!==t?t:"https"}://${e.host}`,e.path,buildURLQueryString(null!==(r=e.params)&&void 0!==r?r:{},{prefix:"?"})));var i;const o={method:e.method,headers:new Headers(null!==(i=e.headers)&&void 0!==i?i:{}),body:void 0};void 0!==e.body&&("string"==typeof e.body?o.body=e.body:(o.body=JSON.stringify(e.body),o.headers.has("Content-Type")||o.headers.set("Content-Type","application/json"))),super(n,o),_define_property$p(this,"__brand__","MediaAPIRequest"),_define_property$p(this,"config",void 0),this.config=e}}function sendRequest(e,t){return _sendRequest.apply(this,arguments)}function _sendRequest(){return(_sendRequest=_async_to_generator$q((function*(e,t){var r,n;const i=(null!==(n=null==t?void 0:t.fetch)&&void 0!==n?n:void 0!==(null===(r=globalThis)||void 0===r?void 0:r.fetch))?fetch.bind(globalThis):void 0;if(void 0===i)throw new MACError("CONFIGURATION_ERROR","Unable to find valid fetch implementation");let o;try{o=yield i(e)}catch(xe){throw new MACError("NETWORK_ERROR","Unable to complete request for "+e.url,xe)}return new MediaAPIResponse(o,e)}))).apply(this,arguments)}var En=Object.freeze({__proto__:null,MediaAPIRequest:MediaAPIRequest,sendRequest:sendRequest});function asyncGeneratorStep$p(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$p(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$p(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$p(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$o(e,t,r[t])}))}return e}function _object_spread_props$a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _define_property1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function parameterizeString(e,t){return function(e){try{return function recursiveTokenizeParameterizedString(e,t=[]){if(e.startsWith("{{")){const r=e.indexOf("}}");if(-1===r)throw new Error("UNCLOSED_PARAMETER");const n={type:1,value:e.slice(2,r)};return r+2<e.length?recursiveTokenizeParameterizedString(e.slice(r+2),[...t,n]):[...t,n]}{const r=e.indexOf("{{");return-1===r?[...t,{type:0,value:e}]:recursiveTokenizeParameterizedString(e.slice(r),[...t,{type:0,value:e.slice(0,r)}])}}(e)}catch(xe){if("UNCLOSED_PARAMETER"===xe.message)throw new Error(`Unclosed parameter in path: "${e}"`);throw xe}}(e).map(e=>{switch(e.type){case 1:return e.value in t?encodeURIComponent(""+t[e.value]):`{{${e.value}}}`;case 0:default:return e.value}}).join("")}function asyncGeneratorStep$o(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MKMediaAPIClient extends class{get fetch(){if(void 0===this.fetchFunction)throw new MACError("CONFIGURATION_ERROR","Could not find a fetch implementation");return this.fetchFunction}resolvePath(e){return new URL(buildURLString(`${this.scheme}://${this.host}`,e))}createRequest(e,t){const r=_object_spread_props$a(_object_spread$d({},null==t?void 0:t.headers),{Authorization:"Bearer "+this.developerToken});void 0!==this.mediaUserToken&&(r["Media-User-Token"]=this.mediaUserToken);const n=_object_spread$d({},null==t?void 0:t.params);if(e instanceof URL||/^http?s/i.test(e)){const t=new URL(e);if(t.hostname!==this.host)throw new MACError("VALUE_ERROR","URL host does not match configured API host");e=t.pathname;for(const[e,r]of t.searchParams.entries())n[e]=r}var i;return new MediaAPIRequest({method:null!==(i=null==t?void 0:t.method)&&void 0!==i?i:"GET",scheme:this.scheme,host:this.host,path:e,headers:r,params:n,body:null==t?void 0:t.body})}get(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("GET",e,t)}))()}post(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("POST",e,t)}))()}put(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("PUT",e,t)}))()}patch(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("PATCH",e,t)}))()}delete(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("DELETE",e,t)}))()}head(e,t){var r=this;return _async_to_generator$p((function*(){return r.makeRequest("HEAD",e,t)}))()}makeRequest(e,t,r){var n=this;return _async_to_generator$p((function*(){return sendRequest(n.createRequest(t,_object_spread_props$a(_object_spread$d({},r),{method:e})),{fetch:n.fetch})}))()}constructor(e){var t,r,n,i;if(_define_property1(this,"scheme",void 0),_define_property1(this,"host",void 0),_define_property1(this,"developerToken",void 0),_define_property1(this,"mediaUserToken",void 0),_define_property1(this,"fetchFunction",void 0),void 0===e.developerToken||""===e.developerToken.trim())throw new Error("Missing or empty developer token");this.developerToken=e.developerToken.trim(),this.scheme=null!==(r=e.scheme)&&void 0!==r?r:"https",this.host=null!==(n=e.host)&&void 0!==n?n:"api.music.apple.com",this.mediaUserToken=e.mediaUserToken,this.fetchFunction=(null!==(i=e.fetch)&&void 0!==i?i:void 0!==(null===(t=globalThis)||void 0===t?void 0:t.fetch))?globalThis.fetch.bind(globalThis):void 0}}{get fetch(){return this.services.request.fetch}get parameters(){return{storefront:this.storefrontId,storefrontId:this.storefrontId,storefrontID:this.storefrontId}}configure(e){void 0!==e.host&&(this.host=e.host),void 0!==e.developerToken&&(this.developerToken=e.developerToken),void 0!==e.mediaUserToken&&(this.mediaUserToken=e.mediaUserToken),void 0!==e.storefrontId&&(this.storefrontId=e.storefrontId)}createRequest(e,...t){return"string"==typeof e&&(e=parameterizeString(e,this.parameters)),super.createRequest(e,...t)}constructor(e){if(isEmptyString$3(e.host))throw new MKUniqueError("mk-114",MKUniqueError.Reason.CONFIGURATION_ERROR,"Invalid API Host for MediaAPIClient");if(isEmptyString$3(e.developerToken))throw new MKUniqueError("mk-115",MKUniqueError.Reason.CONFIGURATION_ERROR,"Invalid developerToken for MediaAPIClient");super({host:e.host,developerToken:e.developerToken,mediaUserToken:e.mediaUserToken}),_define_property$n(this,"isConfigured",!0),_define_property$n(this,"services",void 0),_define_property$n(this,"storefrontId","us"),this.services=e.services,void 0!==e.storefrontId&&(this.storefrontId=e.storefrontId);const t=["get","post","put","patch","delete","head"];for(const r of t){const e=this[r].bind(this);this[r]=function(){var t,r=(t=function*(t,...r){return e("string"==typeof t?parameterizeString(t,this.parameters):t,...r)},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$o(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$o(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))});return function(e){return r.apply(this,arguments)}}().bind(this)}}}function asyncGeneratorStep$n(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$n(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$n(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$n(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const wn=["https://play.itunes.apple.com/","https://linear.tv.apple.com/","https://play-edge.itunes.apple.com"],In=fe.createChild("manifest"),An=BooleanDevFlag.register("mk-load-manifest-once");class MKManifestManager{get fetch(){return this.services.request.fetch}fetchManifest(e){var t=this;return _async_to_generator$n((function*(){return In.info("fetching manifest at",e),t.personalizedManifests?t.fetchForCache(e):t.fetchOnly(e)}))()}getManifest(e){var t=this;return _async_to_generator$n((function*(){return t.cache.get(e)}))()}setManifest(e,t){var r=this;return _async_to_generator$n((function*(){r.cache.set(e,t)}))()}clearManifest(e){var t=this;return _async_to_generator$n((function*(){const r=t.cache.get(e);return t.cache.delete(e),r}))()}clearAll(){var e=this;return _async_to_generator$n((function*(){e.cache.clear()}))()}clear(e){e?this.clearManifest(e):this.clearAll()}fetchForCache(e){var t=this;return _async_to_generator$n((function*(){const r=new Headers;wn.some(t=>e.startsWith(t))&&void 0!==t.mediaUserToken&&(r.set("Authorization","Bearer "+t.developerToken),r.set("media-user-token",t.mediaUserToken));const n=yield t.fetch(e,{headers:r}),i=((e,t)=>{In.info("converting manifest URIs to absolute paths");const r=new URL(e);let n=t.replace(/URI="([^"]*)"/g,(function(e,t){return`URI="${new URL(t,r).href}"`}));return n=n.replace(/^(#EXT-X-STREAM-INF:[^\n]*\n)(.*$)/gim,(function(e,t,n){return`${t}${new URL(n,r).href}`})),n})(e,yield n.text());var o;const a=null!==(o=n.headers.get("content-type"))&&void 0!==o?o:void 0,s={url:e,content:i,contentType:a};return t.cache.set(e,s),s}))()}fetchOnly(e){var t=this;return _async_to_generator$n((function*(){const r=yield t.fetch(e),n=yield r.text();var i;const o=null!==(i=r.headers.get("content-type"))&&void 0!==i?i:void 0;return{url:e,content:n,contentType:o}}))()}configure(e){void 0!==e.developerToken&&(this.developerToken=e.developerToken),hasOwn(e,"mediaUserToken")&&(this.mediaUserToken=e.mediaUserToken),void 0!==e.personalizedManifests&&(this.personalizedManifests=e.personalizedManifests),void 0!==e.cache&&(this.cache=e.cache)}constructor(e){var t,r;_define_property$m(this,"cache",void 0),_define_property$m(this,"services",void 0),_define_property$m(this,"personalizedManifests",!0),_define_property$m(this,"developerToken",void 0),_define_property$m(this,"mediaUserToken",void 0),_define_property$m(this,"isConfigured",!0),this.services=e.services,this.developerToken=e.developerToken,this.mediaUserToken=e.mediaUserToken,this.cache=null!==(t=e.cache)&&void 0!==t?t:new Map,this.personalizedManifests=null===(r=e.personalizedManifests)||void 0===r||r,An.configured&&(this.personalizedManifests=An.enabled)}}function asyncGeneratorStep$m(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$m(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$m(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$m(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class MKMediaAPIAccess{get client(){return this.services.mediaAPI}request(e,t,r){var n=this;return _async_to_generator$m((function*(){return apiResult(yield n.client.createRequest(e,{params:t,headers:null==r?void 0:r.headers,method:null==r?void 0:r.method,body:null==r?void 0:r.body}).send())}))()}music(e,t,r){var n=this;return _async_to_generator$m((function*(){const i=yield n.request(e,t,r);return i.data=i.json,i}))()}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"services",void 0),this.services=e.services;const t=["get","post","put","patch","delete","head"];for(const r of t)this[r]=function(){var e=_async_to_generator$m((function*(e,...t){return apiResult(yield this.client[r](e,...t))}));return function(t){return e.apply(this,arguments)}}().bind(this)}}function apiResult(e){return _apiResult.apply(this,arguments)}function _apiResult(){return(_apiResult=_async_to_generator$m((function*(e){return{url:e.url,status:e.status,statusText:e.statusText,text:yield e.text(),json:yield e.json(),data:yield e.data(),errors:yield e.errors()}}))).apply(this,arguments)}function asyncGeneratorStep$l(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$l(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$l(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$l(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$k(e,t,r[t])}))}return e}function _object_spread_props$9(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function fetchRadioStationAssets(e,t){return _fetchRadioStationAssets.apply(this,arguments)}function _fetchRadioStationAssets(){return(_fetchRadioStationAssets=_async_to_generator$l((function*(e,t){var r;const{mediaAPI:n}=t,i=yield n.get("/v1/play/assets",{params:_object_spread_props$9(_object_spread$c({},e.playParams),{keyFormat:"web"})});if(500===i.status)throw new MKUniqueError("mk-153",MKUniqueError.Reason.SERVER_ERROR,{data:e});if(403===i.status){const t=yield i.json(),r="40303"===(null==t?void 0:t.code)?MKUniqueError.Reason.SUBSCRIPTION_ERROR:MKUniqueError.Reason.ACCESS_DENIED;var o,a;throw new MKUniqueError("mk-154",r,{description:null!==(a=null!==(o=null==t?void 0:t.title)&&void 0!==o?o:null==t?void 0:t.detail)&&void 0!==a?a:"",data:e})}if(200!==i.status)throw new MKUniqueError("mk-155",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{data:e});const s=yield i.json();var l;return null!==(l=null==s||null===(r=s.results)||void 0===r?void 0:r.assets)&&void 0!==l?l:[]}))).apply(this,arguments)}function asyncGeneratorStep$k(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$k(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$k(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$k(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _fetchMZPlayWebAsset(){return(_fetchMZPlayWebAsset=_async_to_generator$k((function*(e,t){const r=new Headers({Authorization:"Bearer "+t.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+t.mediaUserToken}),i=String(e.playParams.id),o=e.isLibraryItem?Object.fromEntries([["purchaseAdamId",e.playParams.purchasedId],["subscriptionAdamId",n(i)?i.slice(2):e.playParams.catalogId],["universalLibraryId",isLibraryType(i)?i:void 0]].filter((e,t)=>void 0!==t)):{salableAdamId:i},a=t.request,s=a.buildRequest(t.endpoint,{method:"POST",body:JSON.stringify(o),headers:r}),l=yield a.fetchJSON(s);if(void 0===(null==l?void 0:l.songList)||0===l.songList.length)throw new MKUniqueError("mk-160",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Unable to load assets for MediaItem",data:e});const c=l.songList[0];let d;if(isPlaylistAsset(c))d={url:c["hls-playlist-url"],playlist:!0,keyServerURL:c["hls-key-server-url"],fairplayCertURL:c["hls-key-cert-url"],widevineCertURL:c["widevine-cert-url"]};else if(isUploadedAsset(c))d={url:c.assets[0].URL,playlist:!1,keyServerURL:c["hls-key-server-url"],fairplayCertURL:c["hls-key-cert-url"],widevineCertURL:c["widevine-cert-url"]};else{var u,p;const e=null!==(p=t.bitrate)&&void 0!==p?p:64;var h;const r=null!==(h=t.encoding)&&void 0!==h?h:"cbcp",n=null===(u=c.assets.find(t=>{var n;return(null!==(n=t.flavor)&&void 0!==n?n:"").endsWith(`${r}${e}`)}))||void 0===u?void 0:u.URL;void 0!==n&&(d={url:n,playlist:!1,bitrate:e,encoding:r,keyServerURL:c["hls-key-server-url"],fairplayCertURL:c["hls-key-cert-url"],widevineCertURL:c["widevine-cert-url"]})}if(void 0===d)throw new MKUniqueError("mk-161",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Unable to fetch asset from MZPlay",data:e});return d}))).apply(this,arguments)}function isPlaylistAsset(e){const t=e["hls-playlist-url"];return void 0!==t&&!isEmptyString$3(t)}function isUploadedAsset(e){const t=e.assets[0];return 1===e.assets.length&&void 0!==t&&void 0===t.flavor&&!isEmptyString$3(t.URL)}function asyncGeneratorStep$j(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$j(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$j(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$j(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const On=/^(?:#EXT-X-SESSION-DATA:?)DATA-ID="([^"]+)".+VALUE="([^"]+)".*$/,Rn=/^com\.apple\.hls\./i;function _fetchHLSPlaylistMetadata(){return(_fetchHLSPlaylistMetadata=_async_to_generator$j((function*(e,t){if(!e.isUTS||!e.assetURL)throw new MKUniqueError("mk-167",MKUniqueError.Reason.INVALID_ARGUMENTS,{description:"Item is not an UTS item",data:e});const r=generateAssetUrl(e,t.playOptions);let n;try{n=yield t.manifestManager.fetchManifest(r)}catch(xe){throw new MKUniqueError("mk-168",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Unable to fetch HLS Playlist",data:e,origin:xe})}const i={};for(const o of n.content.split("\n")){const e=o.match(On);null!==e&&(i[e[1].replace(Rn,"")]=e[2])}return i}))).apply(this,arguments)}function asyncGeneratorStep$i(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$i(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$i(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$i(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$j(e,t,r[t])}))}return e}function _object_spread_props$8(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const $n=BooleanDevFlag.register("mk-broadcast-radio-playback"),Cn=BooleanDevFlag.register("mk-hlsjs-song-playback"),Mn=Or.createChild("asset");class MKPlayableAssetResolver{get mzplayAssetEndpoint(){if(void 0===this._mzplayAssetEndpoint)throw new MKUniqueError("mk-147",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"MZPlay assets URL is not configured"});return this._mzplayAssetEndpoint}get staticKeyURLs(){if(void 0===this._staticKeyURLs)throw new MKUniqueError("mk-143",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"Static Key URLs not configured"});return this._staticKeyURLs}get keySystem(){if(void 0===this.services.runtime.preferredKeySystem)throw new MKUniqueError("mk-140",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{description:"No DRM KeySytem available"});return this.services.runtime.preferredKeySystem}configure(e){var t=this;return _async_to_generator$i((function*(){Mn.trace("MKPlayableAssetResolver.configure(...)",e),void 0!==(null==e?void 0:e.mzplayAssetEndpoint)&&(t._mzplayAssetEndpoint=e.mzplayAssetEndpoint),void 0!==(null==e?void 0:e.staticKeyURLs)&&(t._staticKeyURLs=e.staticKeyURLs)}))()}resolveAsset(e,t){var r=this;return _async_to_generator$i((function*(){if(Mn.info("Resolving asset for "+e,e,t),yield r.shouldPlayPreview(e,t)){Mn.debug("Resolving preview asset for "+e,e,t);const n=yield r.resolvePreviewAsset(e,t);return Mn.debug("Resolved preview asset for "+e,n),n}var n;if(!isEmptyString$3(null!==(n=e.rawAssetUrl)&&void 0!==n?n:"")){Mn.debug("Resolving direct asset for "+e,e,t);const n=yield r.resolveDirectURLAsset(e,t);return Mn.debug("Resolved direct asset for "+e,n),n}if(function(e){return isLive(e)&&isStream(e)&&void 0!==e.attributes.stationProviderName&&"Shoutcast"===e.attributes.streamingRadioSubType}(e)){Mn.debug("Resolving Broadcast Radio asset for "+e,e,t);const n=yield r.resolveBroadcastRadioAsset(e,t);return Mn.debug("Resolved Broadcast Radio asset for "+e,n),n}if(e.isUTS){Mn.debug("Resolving UTS asset for "+e,e,t);const n=yield r.resolveUTSAsset(e,t);return Mn.debug("Resolved UTS asset for "+e,n),n}if((isPodcastFreePremiumEpisode(e)||isPodcastPremiumEpisode(e))&&e.hasOffersHlsUrl){Mn.debug("Resolving HLS Offer asset for "+e,e,t);const n=yield r.resolveHLSOffersAsset(e,t);return Mn.debug("Resolved HLS Offer asset for "+e,n),n}if(e.isLiveRadioStation||e.isRadioEpisode||e.isLiveVideoStation){Mn.debug("Resolving Live Radio asset for "+e,e,t);const n=yield r.resolveRadioStationAsset(e,t);return Mn.debug("Resolved Live Radio asset for "+e,n),n}if("song"===e.type&&Cn.enabled){Mn.debug("Resolving Catalog Song asset for "+e,e,t);const n=yield r.resolveCatalogSongAsset(e,t);return Mn.debug("Resolved Catalog Song asset for "+e,n),n}if(yield r.isMediaAPIContentType(e,t)){Mn.debug("Resolving MZPlay asset for "+e,e,t);const n=yield r.resolveMZPlayWebAsset(e,t);return Mn.debug("Resolved MZPlay asset for "+e,n),n}throw new MKUniqueError("mk-145",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{description:"Could not resolve asset for content type "+e.type,data:e})}))()}resolvePreviewAsset(e,t){var r=this;return _async_to_generator$i((function*(){if(Mn.debug("Resolving preview asset for "+e,e,t),void 0===e.previewURL||isEmptyString$3(e.previewURL))throw new MKUniqueError("mk-150",MKUniqueError.Reason.INVALID_ARGUMENTS,{description:"Missing previewURL for MediaItem",data:e});var n;return{id:null!==(n=e.catalogId)&&void 0!==n?n:e.id,encrypted:!1,assetURL:e.previewURL,contentType:r.assetContentType(e),item:e,preview:!0}}))()}resolveDirectURLAsset(e,t){var r=this;return _async_to_generator$i((function*(){var t,n;if(isEmptyString$3(null!==(t=e.rawAssetUrl)&&void 0!==t?t:""))throw new MKUniqueError("mk-151",MKUniqueError.Reason.INVALID_ARGUMENTS,{description:"Missing rawAssetURL for MediaItem",data:e});return{id:null!==(n=e.catalogId)&&void 0!==n?n:e.id,encrypted:!1,assetURL:e.rawAssetUrl,contentType:r.assetContentType(e),item:e,preview:!1}}))()}resolveBroadcastRadioAsset(e,t){var r=this;return _async_to_generator$i((function*(){if(!$n.enabled)throw new MKUniqueError("mk-152",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{data:e});const t=yield fetchRadioStationAssets(e,{mediaAPI:r.services.mediaAPI});if(void 0===t||0===t.length)throw new MKUniqueError("mk-156",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"No Broadcast RadioStation assets returned from the server",data:e});var n;return{id:null!==(n=e.catalogId)&&void 0!==n?n:e.id,encrypted:!1,assetURL:t[0].url,contentType:r.assetContentType(e),item:e,preview:!1}}))()}resolveHLSOffersAsset(e,t){var r=this;return _async_to_generator$i((function*(){yield r.assertSubscription(e,t);try{var n,i,o,a;return{id:null!==(o=e.catalogId)&&void 0!==o?o:e.id,encrypted:!0,assetURL:null!==(a=null===(n=e.attributes)||void 0===n?void 0:n.assetUrl)&&void 0!==a?a:null===(i=e.attributes.offers)||void 0===i?void 0:i[0].hlsUrl,contentType:r.assetContentType(e),keySystem:r.keySystem,keyServerURL:r.staticKeyURLs["hls-key-server-url"],keyCertURL:"fairplay"===r.keySystem?r.staticKeyURLs["hls-key-cert-url"]:r.staticKeyURLs["widevine-cert-url"],item:e,preview:!1}}catch(xe){throw new MKUniqueError("mk-144",MKUniqueError.Reason.CONTENT_UNSUPPORTED,{description:"Unable to play HLS offers",data:e,origin:xe})}}))()}resolveRadioStationAsset(e,t){var r=this;return _async_to_generator$i((function*(){const t=yield fetchRadioStationAssets(e,{mediaAPI:r.services.mediaAPI});if(void 0===t||0===t.length)throw new MKUniqueError("mk-148",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"No RadioStation assets returned from the server",data:e});const n=t[0];var i;return t.length>1&&Mn.warn("Multiple RadioStation assets returned from the server"),{id:null!==(i=e.catalogId)&&void 0!==i?i:e.id,encrypted:!0,assetURL:n.url,contentType:r.assetContentType(e),keySystem:r.keySystem,keyServerURL:n.keyServerUrl,keyCertURL:"fairplay"===r.keySystem?n.fairPlayKeyCertificateUrl:n.widevineKeyCertificateUrl,item:e,preview:!1}}))()}resolveCatalogSongAsset(e,t){var r=this;return _async_to_generator$i((function*(){yield r.assertSubscription(e,t);const n=r.keySystem;var i;const o=yield r.services.mediaAPI.get("/v1/play/assets",{params:_object_spread$b(_object_spread_props$8(_object_spread$b({},e.playParams),{includeLicenseUrls:!0,hlsEncryption:null!==(i=null==t?void 0:t.hlsEncryption)&&void 0!==i?i:"CBC"}),(null==t?void 0:t.hlsEnhancedAsset)?{hlsProfile:"enhancedHls"}:{})}),{results:a}=yield o.json();if(void 0===(null==a?void 0:a.assets)||0===a.assets.length)throw new MKUniqueError("mk-169",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{data:e});const s=a.assets[0];var l;return a.assets.length>1&&Mn.warn("Multiple MediaAPI assets returned from the server"),{id:null!==(l=e.catalogId)&&void 0!==l?l:e.id,encrypted:!0,assetURL:s.url,contentType:r.assetContentType(e),keySystem:n,keyServerURL:s.keyServerUrl,keyCertURL:"fairplay"===n?s.fairPlayKeyCertificateUrl:s.widevineKeyCertificateUrl,item:e,preview:!1}}))()}resolveMZPlayWebAsset(e,t){var r=this;return _async_to_generator$i((function*(){yield r.assertSubscription(e,t);const n=r.keySystem,i=yield function(e,t){return _fetchMZPlayWebAsset.apply(this,arguments)}(e,{bitrate:null==t?void 0:t.bitrate,request:r.services.request,endpoint:r.mzplayAssetEndpoint,encoding:"fairplay"===n?"cbcp":"ctrp",developerToken:r.services.mediaAPI.developerToken,mediaUserToken:r.services.mediaAPI.mediaUserToken});var o;return{id:null!==(o=e.catalogId)&&void 0!==o?o:e.id,encrypted:!0,assetURL:i.url,contentType:r.assetContentType(e),keySystem:n,keyServerURL:i.keyServerURL,keyCertURL:"fairplay"===n?i.fairplayCertURL:i.widevineCertURL,item:e,preview:!1}}))()}resolveUTSAsset(e,t){var r=this;return _async_to_generator$i((function*(){var t;if(!e.isUTS)throw new MKUniqueError("mk-162",MKUniqueError.Reason.INVALID_ARGUMENTS,{description:"MediaItem is not an UTS item",data:e});const n=null===(t=e.attributes)||void 0===t?void 0:t.assets;if(void 0===n)throw new MKUniqueError("mk-163",MKUniqueError.Reason.INVALID_ARGUMENTS,{description:"Missing UTS asset data",data:e});const i={webbrowser:!0};BooleanDevFlag.register("mk-hlsjs-interstitial-playback").enabled&&(i.supportsInterstitials=!0);const o=buildURL(e.assetURL,i);e.assetURL=o;const a=yield function(e,t){return _fetchHLSPlaylistMetadata.apply(this,arguments)}(e,{manifestManager:r.services.manifest,playOptions:{}});return{id:e.id,encrypted:!0,assetURL:o,contentType:r.assetContentType(e),keySystem:r.keySystem,keyServerURL:n.fpsKeyServerUrl,keyCertURL:"fairplay"===r.keySystem?n.fpsCertificateUrl:n.wideVineCertificateUrl,item:e,meta:a,preview:!1}}))()}isMediaAPIContentType(e,t){return _async_to_generator$i((function*(){return Ee.includes(e.type)}))()}assetContentType(e){return isAudio(e)?"audio":"video"}isPlayable(e,t){var r=this;return _async_to_generator$i((function*(){return!!e.isUTS||!!(yield r.isMediaAPIContentType(e,t))&&(!!(e.isLiveRadioStation||e.isRadioEpisode||e.hasOffersHlsUrl)||(["song","musicVideo","musicMovie"].includes(e.type)?void 0!==e.playParams:!isEmptyString$3(null!==(n=e.rawAssetUrl)&&void 0!==n?n:"")||!isEmptyString$3(null!==(i=e.previewURL)&&void 0!==i?i:"")));var n,i}))()}shouldPlayPreview(e,t){var r=this;return _async_to_generator$i((function*(){var n,i,o;return!(e.isLiveRadioStation||e.isRadioEpisode||e.isLiveVideoStation)&&(!e.rawAssetUrl&&(!(e.isPodcastEpisode&&isPodcastFreePremiumEpisode(e)&&e.hasOffersHlsUrl)&&(!e.isUTS&&(!0===(null==t?void 0:t.previewOnly)||!(yield r.isPlayable(e))||!!isEmptyString$3(null!==(i=e.rawAssetUrl)&&void 0!==i?i:"")&&(!0!==(null==t?void 0:t.subscription)||!1!==(null===(n=e.playParams)||void 0===n?void 0:n.hasDrm)&&(!r.services.runtime.isDRMAvailable&&!isEmptyString$3(null!==(o=e.previewURL)&&void 0!==o?o:"")))))))}))()}assertSubscription(e,t){var r=this;return _async_to_generator$i((function*(){if(void 0===r.services.mediaAPI.mediaUserToken)throw new MKUniqueError("mk-159",MKUniqueError.Reason.AUTHORIZATION_ERROR,{description:"Authorization required",data:e});if(!(e.isPodcastEpisode&&isPodcastFreePremiumEpisode(e)&&e.hasOffersHlsUrl)&&!0!==(null==t?void 0:t.subscription))throw new MKUniqueError("mk-149",MKUniqueError.Reason.SUBSCRIPTION_ERROR,{description:"Subscription required for content",data:e})}))()}constructor(e){_define_property$j(this,"services",void 0),_define_property$j(this,"isConfigured",!0),_define_property$j(this,"_mzplayAssetEndpoint",void 0),_define_property$j(this,"_staticKeyURLs",void 0),this.services=e.services,this._mzplayAssetEndpoint=e.mzplayAssetEndpoint,this._staticKeyURLs=e.staticKeyURLs}}function asyncGeneratorStep$h(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$i(e,t,r[t])}))}return e}function _object_spread_props$7(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Dn=Or.createChild("license");class BaseLicenseManager{get developerToken(){return this._developerToken}get mediaUserToken(){return this._mediaUserToken}get keySystem(){return this.services.runtime.preferredKeySystem}get keySystemId(){return w[this.keySystem]}configure(e){void 0!==e.developerToken&&(this._developerToken=e.developerToken),this._mediaUserToken=e.mediaUserToken}createChallengeHeaders(e,t,r){const n=_object_spread$a({Authorization:"Bearer "+this.developerToken,Accept:"application/json","Content-Type":"application/json"},this.mediaUserToken?{"X-Apple-Music-User-Token":this.mediaUserToken}:{});return"widevine"===this.services.runtime.preferredKeySystem&&(n["X-Apple-Renewal"]=!0),new Headers(n)}assertDeveloperToken(){if(void 0===this.developerToken||isEmptyString$3(this.developerToken))throw new MKUniqueError("mk-175",MKUniqueError.Reason.CONTENT_RESTRICTED,{description:"No developer token configured for resolving playback licenses"})}assertUserToken(){if(void 0===this.mediaUserToken||isEmptyString$3(this.mediaUserToken))throw new MKUniqueError("mk-176",MKUniqueError.Reason.CONTENT_RESTRICTED,{description:"No user token configured for resolving playback licenses"})}makeServerRequest(e,t,r){var n,i=this;return(n=function*(){let n;try{i.logger.debug(`Making license request to ${e} with URI ${t}`),n=yield i.services.request.fetch(new Request(e,r))}catch(xe){throw i.logger.error(`Failed to make license request to ${e} with URI ${t}`),new MKUniqueError("mk-174",MKUniqueError.Reason.MEDIA_LICENSE,{data:{url:e,keyuri:t},origin:xe})}if(!n.ok)try{i.handleServerError(yield n.json())}catch(o){i.handleServerError()}return yield n.json()},function(){var e=this,t=arguments;return new Promise((function(r,i){var o=n.apply(e,t);function _next(e){asyncGeneratorStep$h(o,r,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$h(o,r,i,_next,_throw,"throw",e)}_next(void 0)}))})()}handleServerError(e){var t,r;const n=null!==(r=null!==(t=null==e?void 0:e.status)&&void 0!==t?t:null==e?void 0:e.errorCode)&&void 0!==r?r:0,i=m[n]||MKUniqueError.Reason.MEDIA_LICENSE;const o=null==e?void 0:e.dialog;var a,s,l;const c=null!==(l=null!==(s=null!==(a=null==e?void 0:e.message)&&void 0!==a?a:null==e?void 0:e.customerMessage)&&void 0!==s?s:null==e?void 0:e.errorMessage)&&void 0!==l?l:i;if(void 0!==o)throw new MKServerDialogError(_object_spread_props$7(_object_spread$a({},e),{status:n,message:c,dialog:o}));throw new MKUniqueError("mk-183",i,{description:c,data:{status:n,message:c,context:e}})}constructor(e){_define_property$i(this,"isConfigured",!0),_define_property$i(this,"logger",Dn),_define_property$i(this,"services",void 0),_define_property$i(this,"_developerToken",void 0),_define_property$i(this,"_mediaUserToken",void 0),this.services=e.services,this._developerToken=e.developerToken,this._mediaUserToken=e.mediaUserToken}}function asyncGeneratorStep$g(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$g(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$g(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$g(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class HLSBatchLicenseManager extends BaseLicenseManager{isCompatible(e,t){return _async_to_generator$g((function*(){var t,r;return(null!==(r=null===(t=e.keyURLs)||void 0===t?void 0:t["hls-key-server-url"])&&void 0!==r?r:"").endsWith("/podcast/hls/license/streaming/start")||e.hasOffersHlsUrl}))()}requestLicense(e,t,r){var n=this;return _async_to_generator$g((function*(){var i,o;n.assertDeveloperToken(),n.assertUserToken();const a=null===(i=e.keyURLs)||void 0===i?void 0:i["hls-key-server-url"],s=yield n.makeServerRequest(a,t.keyuri,{method:"POST",headers:n.createChallengeHeaders(e,t,null!=r?r:{}),body:JSON.stringify(n.createChallengeBody(e,t,null!=r?r:void 0))}),l=null===(o=s["license-responses"])||void 0===o?void 0:o[0];if(void 0===l)throw new MKUniqueError("mk-179",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Server did not return any license keys",data:{body:s}});var c;if(0!==l.status)throw new MKUniqueError("mk-184",MKUniqueError.Reason.SERVER_ERROR,{description:`License server responded with code '${null!==(c=l.status)&&void 0!==c?c:"unknown"}'`,data:{body:s}});return l}))()}revokeLicense(e,t,r){return _async_to_generator$g((function*(){}))()}createChallengeBody(e,t,r){const n=this.lastKeyId+=1,i="string"==typeof t.licenseChallenge?t.licenseChallenge:l(t.licenseChallenge);var o;return{version:1,"license-requests":[{id:n,"adam-id":null!==(o=e.catalogId)&&void 0!==o?o:e.id,challenge:i,uri:t.keyuri,"key-system":this.keySystemId}]}}constructor(...e){super(...e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"lastKeyId",0)}}function asyncGeneratorStep$f(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$f(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$f(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$f(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$9(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$g(e,t,r[t])}))}return e}function _object_spread_props$6(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class HLSStreamingLicenseManager extends BaseLicenseManager{isCompatible(e,t){return _async_to_generator$f((function*(){var t,r;const n=null!==(r=null===(t=e.keyURLs)||void 0===t?void 0:t["hls-key-server-url"])&&void 0!==r?r:"";return n.endsWith("/WebObjects/MZPlay.woa/wa/fpsRequest")||n.endsWith("/WebObjects/MZPlay.woa/hls/anonymous/fpsRequest")||n.endsWith("/v1/hls/streaming-key-delivery")||n.endsWith("/v1/hls/anonymous/streaming-key-delivery")}))()}requestLicense(e,t,r){var n=this;return _async_to_generator$f((function*(){var i,o;n.assertDeveloperToken(),n.isAnonymousPlayback(e)||n.assertUserToken();const a=null===(i=e.keyURLs)||void 0===i?void 0:i["hls-key-server-url"],s=yield n.makeServerRequest(a,t.keyuri,{method:"POST",headers:n.createChallengeHeaders(e,t,r),body:JSON.stringify(n.createChallengeBody(e,t,_object_spread_props$6(_object_spread$9({},r),{"lease-action":"start"})))}),l=null===(o=s["streaming-response"])||void 0===o?void 0:o["streaming-keys"][0];if(void 0===l)throw new MKUniqueError("mk-180",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Server did not return any license keys",data:{body:s}});if(0!==l.status)throw new MKServerDialogError({status:l.status,dialog:{message:"Error acquiring license"}},MKUniqueError.Reason.MEDIA_LICENSE);return l}))()}revokeLicense(e,t,r){var n=this;return _async_to_generator$f((function*(){var i;n.assertDeveloperToken(),n.isAnonymousPlayback(e)||n.assertUserToken();const o=null===(i=e.keyURLs)||void 0===i?void 0:i["hls-key-server-url"];try{yield n.makeServerRequest(o,t.keyuri,{method:"POST",headers:n.createChallengeHeaders(e,t,r),body:JSON.stringify(n.createChallengeBody(e,t,_object_spread_props$6(_object_spread$9({},r),{"lease-action":"stop"})))})}catch(xe){n.logger.warn("Revoke license request failed",xe)}}))()}createChallengeBody(e,t,r){const n=this.lastKeyId+=1,i="string"==typeof t.licenseChallenge?t.licenseChallenge:l(t.licenseChallenge);return{"streaming-request":{version:1,"streaming-keys":[_object_spread$9({"lease-action":r["lease-action"],id:n,challenge:i,uri:t.keyuri,"key-system":this.keySystemId,stkn:r.stkn},e.keyServerQueryParameters)]}}}isAnonymousPlayback(e){var t,r;const n=null!==(r=null===(t=e.keyURLs)||void 0===t?void 0:t["hls-key-server-url"])&&void 0!==r?r:"";return""===n||n.includes("/hls/anonymous")}constructor(...e){super(...e),_define_property$g(this,"lastKeyId",0)}}function asyncGeneratorStep$e(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$e(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$e(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$e(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class WebPlaybackLicenseManager extends BaseLicenseManager{isCompatible(e,t){return _async_to_generator$e((function*(){var t,r;const n=null!==(r=null===(t=e.keyURLs)||void 0===t?void 0:t["hls-key-server-url"])&&void 0!==r?r:"";return n.includes("/WebObjects/MZPlay.woa/wa/acquireWebPlaybackLicense")||n.includes("/WebObjects/MZPlay.woa/web/radio/versions/1/license")||n.includes("/v1/radio/streaming-key-delivery")}))()}requestLicense(e,t,r){var n=this;return _async_to_generator$e((function*(){var i;n.assertDeveloperToken(),n.assertUserToken();const o={userInitiated:null!==(i=null==r?void 0:r.userInitiated)&&void 0!==i&&i},a=e.keyURLs["hls-key-server-url"];return yield n.makeServerRequest(a,t.keyuri,{method:"POST",headers:n.createChallengeHeaders(e,t,o),body:JSON.stringify(n.createChallengeBody(e,t,o))})}))()}revokeLicense(e,t,r){return _async_to_generator$e((function*(){}))()}createChallengeBody(e,t,r){const n="string"==typeof t.licenseChallenge?t.licenseChallenge:l(t.licenseChallenge);var i;return{adamId:null!==(i=e.catalogId)&&void 0!==i?i:"-1",isLibrary:e.isLibrary,"user-initiated":r.userInitiated,challenge:n,uri:t.keyuri,"key-system":this.keySystemId}}}function asyncGeneratorStep$d(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$d(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$d(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$d(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MKProxyLicenseManager{configure(e){for(const t of this.children.values())t.configure(e)}isCompatible(...e){var t=this;return _async_to_generator$d((function*(){return void 0!==(yield t.findManager(...e))}))()}requestLicense(e,t,r){var n=this;return _async_to_generator$d((function*(){const i=yield n.findManager(e,t,r);if(void 0===i)throw new MKUniqueError("mk-177",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to request license for "+e});return i.requestLicense(e,t,r)}))()}revokeLicense(e,t,r){var n=this;return _async_to_generator$d((function*(){const i=yield n.findManager(e,t,r);if(void 0===i)throw new MKUniqueError("mk-178",MKUniqueError.Reason.MEDIA_LICENSE,{description:"Unable to revoke license for "+e});return i.revokeLicense(e,t,r)}))()}findManager(e,t,r){var n=this;return _async_to_generator$d((function*(){for(const i of n.children)if(yield i.isCompatible(e,t,r))return i}))()}constructor(e){var t;_define_property$f(this,"isConfigured",!0),_define_property$f(this,"children",void 0),this.children=new Set(null!==(t=e.managers)&&void 0!==t?t:[])}}function asyncGeneratorStep$c(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$c(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$c(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$c(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$8(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$e(e,t,r[t])}))}return e}function _object_spread_props$5(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function configureServicesTree(e,t){return void 0!==t.storefrontId&&(e.mediaAPIClient.configure({storefrontId:t.storefrontId}),e.itemLoader.configure({storefrontId:t.storefrontId})),void 0!==t.mediaUserToken&&(e.mediaAPIClient.configure({mediaUserToken:t.mediaUserToken}),e.manifest.configure({mediaUserToken:t.mediaUserToken}),e.license.configure({mediaUserToken:t.mediaUserToken})),e}function createPlayerConfig(e){const{services:t}=e;var r;return{tokens:e.tokens,bag:e.bag,context:null!==(r=e.context)&&void 0!==r?r:{},autoplayEnabled:e.autoplayEnabled,privateEnabled:e.privateEnabled,siriInitiated:e.siriInitiated,services:{runtime:t.runtime,request:t.request,dispatcher:t.dispatcher,manifest:t.manifest,license:t.license,bitrateCalculator:t.bitrateCalculator,timing:t.timing},playbackServices:{getRTCStreamingTracker:()=>t.playActivity.getTrackerByType(RTCStreamingTracker),hasMusicSubscription:_async_to_generator$c((function*(){var e,r,n;return null!==(n=null===(r=t.store)||void 0===r||null===(e=r.storekit)||void 0===e?void 0:e.hasMusicSubscription())&&void 0!==n&&n}))}}}function asyncGeneratorStep$b(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$b(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$b(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$b(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$7(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$d(e,t,r[t])}))}return e}function _object_spread_props$4(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$3(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$3(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const xn=[MKError.Reason.CONTENT_EQUIVALENT,MKError.Reason.CONTENT_RESTRICTED,MKError.Reason.CONTENT_UNAVAILABLE,MKError.Reason.CONTENT_UNSUPPORTED,MKError.Reason.SERVER_ERROR,MKError.Reason.SUBSCRIPTION_ERROR,MKError.Reason.UNSUPPORTED_ERROR,MKError.Reason.USER_INTERACTION_REQUIRED],Ln=JsonDevFlag.register("mk-bag-features-overrides");class MKInstance{get playbackController(){return this._playbackController}setOptions(e){}get developerToken(){return Fr.developerToken}get api(){return this.services.mediaAPIAccess}get audioTracks(){return this._mediaItemPlayback.audioTracks}get authorizationStatus(){return Fr.authorizationStatus}get bitrate(){return this.services.bitrateCalculator.bitrate}set bitrate(e){this.services.bitrateCalculator.bitrate=e}get browserSupportsPictureInPicture(){return detectPictureInPictureSupport()}get browserSupportsVideoDrm(){return this.services.runtime.isDRMAvailable}get cid(){return(this.realm===F.TV||this.sourceType!==ke.MUSICKIT)&&Fr.cid}get continuous(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.continuous)&&void 0!==t&&t}set continuous(e){this.getPlaybackController().continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this.realm!==F.MUSIC&&(e=!1),e!==this.autoplayEnabled&&(this._autoplayEnabled=e,this.services.dispatcher.publish(Ar.autoplayEnabledDidChange,this.autoplayEnabled))}get currentAudioTrack(){return this._mediaItemPlayback.currentAudioTrack}set currentAudioTrack(e){this._mediaItemPlayback.currentAudioTrack=e}get currentPlaybackDuration(){return this._mediaItemPlayback.currentPlaybackDuration}get currentPlaybackProgress(){return this._mediaItemPlayback.currentPlaybackProgress}get currentPlaybackTime(){return this._mediaItemPlayback.currentPlaybackTime}get currentPlayingDate(){return this._mediaItemPlayback.currentPlayingDate}get isPlayingAtLiveEdge(){return this._mediaItemPlayback.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._mediaItemPlayback.seekableTimeRanges}get currentPlaybackTimeRemaining(){return this._mediaItemPlayback.currentPlaybackTimeRemaining}get currentTextTrack(){return this._mediaItemPlayback.currentTextTrack}set currentTextTrack(e){this._mediaItemPlayback.currentTextTrack=e}get isAuthorized(){return Fr.isAuthorized}get isPlaying(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.isPlaying)&&void 0!==t&&t}get isRestricted(){return Fr.isRestricted}get isU13(){return Fr.isU13}get metricsClientId(){return Fr.metricsClientId}set metricsClientId(e){Fr.metricsClientId=e}get musicUserToken(){return Fr.musicUserToken}set musicUserToken(e){e&&Fr.musicUserToken===e||(Fr.musicUserToken=e)}updateUserTokenFromStorage(){return Fr.updateUserTokenFromStorage()}get needsGDPR(){return Fr.needsGDPR}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get currentTimedMetadata(){return this._mediaItemPlayback.currentTimedMetadata}get nowPlayingItemIndex(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.nowPlayingItemIndex)&&void 0!==t?t:-1}get playbackMode(){return this._playbackMode}set playbackMode(e){if(-1===Object.values(Ir).indexOf(e))return;const t=e===Ir.PREVIEW_ONLY,r=this.services.mediaItemPlayback;r&&(r.previewOnly=t),this._playbackMode!==e&&(this._playbackMode=e,void 0!==this._playbackController&&(this._playbackController.playbackMode=e))}get playbackRate(){return this._mediaItemPlayback.playbackRate}set playbackRate(e){this._mediaItemPlayback.playbackRate=e}get defaultPlaybackRate(){return this._mediaItemPlayback.defaultPlaybackRate}set defaultPlaybackRate(e){this._mediaItemPlayback.defaultPlaybackRate=e}get playbackState(){return this._mediaItemPlayback.playbackState}get playbackTargetAvailable(){return this._mediaItemPlayback.playbackTargetAvailable}get playbackTargetIsWireless(){return this._mediaItemPlayback.playbackTargetIsWireless}get previewOnly(){return this.playbackMode===Ir.PREVIEW_ONLY}set previewOnly(e){this.playbackMode=e?Ir.PREVIEW_ONLY:Ir.MIXED_CONTENT}get queue(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.queue}get queueIsEmpty(){var e,t,r;return null===(r=null===(t=this._playbackController)||void 0===t||null===(e=t.queue)||void 0===e?void 0:e.isEmpty)||void 0===r||r}get realm(){return Fr.realm}get repeatMode(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.repeatMode)&&void 0!==t?t:Nr.none}set repeatMode(e){this.getPlaybackController().repeatMode=e}set requestUserToken(e){Fr.requestUserToken=e}get restrictedEnabled(){return Fr.restrictedEnabled}set restrictedEnabled(e){Fr.restrictedEnabled=e}get supportsPreviewImages(){return this._mediaItemPlayback.supportsPreviewImages}get seekSeconds(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.seekSeconds}set shuffle(e){this.getPlaybackController().shuffle=e}get shuffleMode(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.shuffleMode)&&void 0!==t?t:nn.off}set shuffleMode(e){this.getPlaybackController().shuffleMode=e}get storefrontCountryCode(){return Fr.storefrontCountryCode}get subscribeURL(){return Fr.subscribeURL}get subscribeFamilyURL(){return Fr.subscribeFamilyURL}get subscribeIndividualURL(){return Fr.subscribeIndividualURL}get subscribeStudentURL(){return Fr.subscribeStudentURL}get textTracks(){return this._mediaItemPlayback.textTracks}get videoContainerElement(){return this.context.videoContainerElement}set videoContainerElement(e){this.context.videoContainerElement=e}get volume(){return this._mediaItemPlayback.volume}set volume(e){this._mediaItemPlayback.volume=e}get storefrontId(){return Fr.storefrontId}set storefrontId(e){Fr.storefrontId=e}get _mediaItemPlayback(){return this.services.mediaItemPlayback}getPlaybackController(){if(xr.trace("MKInstance.getPlaybackController()",this._playbackController),void 0===this._playbackController)throw new MKError(MKError.Reason.INTERNAL_ERROR,"No PlaybackController active");return this._playbackController}setPlaybackController(e){var t=this;return _async_to_generator$b((function*(){return xr.trace("MKInstance.setPlaybackController()",e),t._playbackController===e||(void 0!==t._playbackController&&(yield t._playbackController.deactivate()),e.autoplayEnabled=t._autoplayEnabled,yield e.activate(),t.capabilities.controller=e,t.capabilities.updateChecker(e.hasCapabilities),t._playbackController=e),e}))()}addEventListener(e,t,r={}){adaptAddEventListener(this.services.dispatcher,e,t,r)}authorize(){var e=this;return _async_to_generator$b((function*(){return e.deferPlayback(),Fr.authorize()}))()}canAuthorize(){return this.services.runtime.isDRMAvailable&&!this.isAuthorized}canUnauthorize(){return this.services.runtime.isDRMAvailable&&this.isAuthorized}changeToMediaAtIndex(e){var t=this;return _async_to_generator$b((function*(){t._isPlaybackSupported()&&(yield t.validateAuthorization(),t.signalChangeItemIntent(),yield t.getPlaybackController().changeToMediaAtIndex(e))}))()}changeToMediaItem(e){var t=this;return _async_to_generator$b((function*(){xr.debug("instance.changeToMediaItem",e),t._isPlaybackSupported()&&(yield t.validateAuthorization(),t.signalChangeItemIntent(),yield t.getPlaybackController().changeToMediaItem(e))}))()}changeUserStorefront(e){var t=this;return _async_to_generator$b((function*(){t.storefrontId=e}))()}cleanup(){var e=this;return _async_to_generator$b((function*(){e.services.mediaItemPlayback.destroy(),e.signalIntent({endReasonType:be.EXITED_APPLICATION});const t=Object.keys(e.playbackControllers).map(t=>e.playbackControllers[t].destroy());try{yield Promise.all(t)}catch(r){xr.error("Error cleaning up controller",r)}e.services.dispatcher.clear()}))()}configure(e){var t=this;return _async_to_generator$b((function*(){yield t.setPlaybackController(t.getPlaybackControllerByType(an.serial));const{promise:r,resolve:n}=deferred();t._whenConfigured=r,yield Fr.storekit.whenAuthCompleted,void 0!==(null==e?void 0:e.storefrontId)&&(t.storefrontId=e.storefrontId),void 0!==(null==e?void 0:e.utsAPIClient)&&(t.services.utsAPIClient=e.utsAPIClient),yield t.configurePlayActivity(),t._initializeExternalEventPublishing(),n()}))()}deferPlayback(){xr.debug("deferPlayback",this._playbackController),deferPlayback()}me(){return _async_to_generator$b((function*(){try{return yield Fr.storekit.me()}catch(e){return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized"))}}))()}musicSubscriptionOffers(){return Fr.storekit.musicSubscriptionOffers(this.storefrontId)}musicSubcriptionOffers(){return deprecationWarning("musicSubcriptionOffers",{message:"musicSubcriptionOffers has been deprecated, use musicSubscriptionOffers instead"}),this.musicSubscriptionOffers()}hasMusicSubscription(){return function(e){return _hasMusicSubscription.apply(this,arguments)}(Fr.storekit)}mute(){return this._mediaItemPlayback.mute()}pause(e){var t=this;return _async_to_generator$b((function*(){if(t._isPlaybackSupported()){try{t.signalIntent({endReasonType:be.PLAYBACK_MANUALLY_PAUSED}),yield t.getPlaybackController().pause(e)}catch(xe){t._handlePlaybackError(xe)}return Promise.resolve()}}))()}play(){var e=this;return _async_to_generator$b((function*(){if(xr.debug("instance.play()"),e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().play()}catch(xe){e._handlePlaybackError(xe)}return Promise.resolve()}}))()}playMediaItem(e,t){var r=this;return _async_to_generator$b((function*(){var n,i;if(xr.trace("MKInstance.playMediaItem()",e,t),(null==t?void 0:t.bingeWatching)||r.deferPlayback(),t=_object_spread$7({},t),(null==e?void 0:e.playEvent)&&!hasOwn(t,"startTime")){const{playEvent:r}=e;r.isDone||void 0===r.playCursorInSeconds||(t.startTime=r.playCursorInSeconds)}r.services.dispatcher.publish(Ar.playInitiated,{item:e,timestamp:null!==(i=null===(n=t.meta)||void 0===n?void 0:n.initiatedTimestamp)&&void 0!==i?i:Date.now()});try{t&&r._mediaItemPlayback.playOptions.set(e.id,t);const n=yield r.getPlaybackController().playSingleMediaItem(e,t);return r.services.dispatcher.publish(Ar.capabilitiesChanged),n}catch(xe){xr.error("mk:playMediaItem error",xe),r._handlePlaybackError(xe)}}))()}removeEventListener(e,t){!function(e,t,r){const n=getCallbacksForName(t);let i;for(let o=n.length-1;o>=0;o--){const[e,t]=n[o];if(e===r){i=t,n.splice(o,1);break}}i&&e.unsubscribe(t,i)}(this.services.dispatcher,e,t)}shouldDisplayPrivacyLink(e){return _async_to_generator$b((function*(){return Fr.shouldDisplayPrivacyLink(e)}))()}exitFullscreen(){return this._mediaItemPlayback.exitFullscreen()}requestFullscreen(e){return this._mediaItemPlayback.requestFullscreen(e)}loadPreviewImage(e){var t=this;return _async_to_generator$b((function*(){return t._mediaItemPlayback.loadPreviewImage(e)}))()}getNewSeeker(){return this.getPlaybackController().getNewSeeker()}seekToTime(e,t=Se.Manual){var r=this;return _async_to_generator$b((function*(){if(r._isPlaybackSupported()){yield r.validateAuthorization();try{yield r.getPlaybackController().seekToTime(e,t)}catch(xe){r._handlePlaybackError(xe)}return Promise.resolve()}}))()}setPresentationMode(e){var t=this;return _async_to_generator$b((function*(){return t._mediaItemPlayback.setPresentationMode(e)}))()}skipToNextItem(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:be.TRACK_SKIPPED_FORWARDS,direction:be.TRACK_SKIPPED_FORWARDS});try{yield e.getPlaybackController().skipToNextItem()}catch(xe){e._handlePlaybackError(xe)}}}))()}skipToPreviousItem(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:be.TRACK_SKIPPED_BACKWARDS,direction:be.TRACK_SKIPPED_BACKWARDS});try{yield e.getPlaybackController().skipToPreviousItem()}catch(xe){e._handlePlaybackError(xe)}}}))()}seekForward(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{e.signalIntent({endReasonType:be.TRACK_SKIPPED_FORWARDS,direction:be.TRACK_SKIPPED_FORWARDS}),yield e.getPlaybackController().seekForward()}catch(xe){e._handlePlaybackError(xe)}}}))()}seekBackward(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().seekBackward()}catch(xe){e._handlePlaybackError(xe)}}}))()}showPlaybackTargetPicker(){this.getPlaybackController().showPlaybackTargetPicker()}stop(e){var t=this;return _async_to_generator$b((function*(){if(t._isPlaybackSupported()){var r;t.signalIntent({endReasonType:null==e?void 0:e.endReasonType,userInitiated:null===(r=null==e?void 0:e.userInitiated)||void 0===r||r});try{yield t.getPlaybackController().stop(e)}catch(xe){t._handlePlaybackError(xe)}}}))()}resetSubscribeViewEligibility(){Fr.storekit.resetSubscribeViewEligibility()}unauthorize(){return _async_to_generator$b((function*(){return Fr.unauthorize()}))()}unmute(){return this._mediaItemPlayback.unmute()}getPlaybackControllerByType(e){let t=this.playbackControllers[e];if(void 0!==t)return t;const{services:r}=this,n={services:{runtime:r.runtime,request:r.request,dispatcher:r.dispatcher,store:Fr,itemLoader:r.itemLoader,manifest:r.manifest,mediaItemPlayback:r.mediaItemPlayback,playActivity:r.playActivity},playbackMode:this.playbackMode};switch(e){case an.serial:t=new SerialPlaybackController(n);break;case an.continuous:t=new ContinuousPlaybackController(n);break;default:throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Unsupported controller requested: "+e)}return this.playbackControllers[e]=t,t}playbackControllerForItems(e){const t=e[0];return(null==t?void 0:t.isRadioStation)&&!(null==t?void 0:t.isRadioEpisode)?this.getPlaybackControllerByType(an.continuous):this.getPlaybackControllerByType(an.serial)}_handlePlaybackError(e){if(xr.error("mediaPlaybackError",e),MKError.isMKError(e)&&xn.includes(e.reason))throw e}_initializeInternalEventHandling(){const e=this.services;Fr.storekit.addEventListener(Ar.userTokenDidChange,({userToken:t})=>{this._whenConfigured&&this._whenConfigured.then(()=>this.configurePlayActivity().catch()).catch(),xr.debug("Updating services with mediaUserToken: "+this.musicUserToken),configureServicesTree(e,{mediaUserToken:t})}),e.dispatcher.subscribe(me.apiStorefrontChanged,(function(t,{storefrontId:r}){xr.debug("Updating services with storefrontId: "+r),configureServicesTree(e,{storefrontId:r})})),e.dispatcher.subscribe(Ar.mediaPlaybackError,(e,t)=>this._handlePlaybackError(t)),e.dispatcher.subscribe(Ar.playbackVolumeDidChange,(e,t)=>{const r=null==t?void 0:t.target;((null==r?void 0:r.muted)||(null==r?void 0:r.volume))&&(this.volume=(null==r?void 0:r.muted)?0:null==r?void 0:r.volume)}),e.dispatcher.subscribe(Ar.playbackStateDidChange,(e,t)=>{t.state===he.paused&&(xr.debug("mk: playbackStateDidChange callback - calling storekit.presentSubscribeViewForEligibleUsers"),Fr.storekit.presentSubscribeViewForEligibleUsers({state:t.state,item:this.nowPlayingItem},!1))}),e.dispatcher.subscribe(Kt,(t,{metadata:r,item:n,position:i,playingDate:o})=>{if(r.blob){const t={item:null!=n?n:this.nowPlayingItem,position:null!=i?i:this.currentPlaybackTime,playingDate:null!=o?o:this.currentPlayingDate,storefrontId:this.storefrontId.toUpperCase(),metadata:r};xr.debug('Dispatching TimedMetadata "ping"',t),e.dispatcher.publish(me.timedMetadata,t)}})}_initializeExternalEventPublishing(){[Ar.authorizationStatusDidChange,Ar.needsGDPRDidChange,Ar.storefrontCountryCodeDidChange,Ar.storefrontIdentifierDidChange,Ar.userTokenDidChange,Ar.eligibleForSubscribeView].forEach(e=>{Fr.storekit.addEventListener(e,t=>this.services.dispatcher.publish(e,t))}),this.services.dispatcher.subscribe(Kt,(e,{metadata:t})=>{xr.debug("Dispatching TimedMetadata change",t),this.services.dispatcher.publish(Ar.timedMetadataDidChange,t)})}configureLogger(e){var t;xr.level===Mr&&(!0===e.debug?setRootLoggingLevel(G.DEBUG):void 0!==e.logLevel&&setRootLoggingLevel(e.logLevel)),$r.enabled&&setConsoleOutput($r.enabled),void 0!==Cr.value&&applyLoggingLevels(Cr.value),void 0!==e.logHandler&&(t=e.logHandler,xr.handlers.external=new CallbackHandler(t))}configurePlayActivity(){var e=this;return _async_to_generator$b((function*(){const{services:t}=e;yield t.playActivity.configure({instance:e,services:{runtime:t.runtime,request:t.request,dispatcher:t.dispatcher,mediaAPIClient:t.mediaAPIClient,utsAPIClient:t.utsAPIClient,playActivity:t.playActivity}})}))()}_isPlaybackSupported(){return!this.services.runtime.isNodeEnvironment||(xr.warn("Media playback is not supported in Node environments."),!1)}signalChangeItemIntent(){this.signalIntent({endReasonType:be.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM})}signalIntent(e){this.services.dispatcher.publish(me.userActivityIntent,_object_spread$7({userInitiated:!0},e))}validateAuthorization(e=!1){var t=this;return _async_to_generator$b((function*(){(e||t.playbackMode===Ir.FULL_PLAYBACK_ONLY)&&(void 0!==t._playbackController&&t._playbackController.isReady&&t._playbackController.isPlaying||(yield t.authorize()))}))()}constructor(t){_define_property$d(this,"app",void 0),_define_property$d(this,"capabilities",void 0),_define_property$d(this,"context",{}),_define_property$d(this,"_playbackMode",Ir.MIXED_CONTENT),_define_property$d(this,"_autoplayEnabled",!1),_define_property$d(this,"id",void 0),_define_property$d(this,"prefix",void 0),_define_property$d(this,"privateEnabled",!1),_define_property$d(this,"siriInitiated",!1),_define_property$d(this,"sourceType",ke.MUSICKIT),_define_property$d(this,"version",e.version),_define_property$d(this,"playbackActions",void 0),_define_property$d(this,"guid",void 0),_define_property$d(this,"_bag",jr),_define_property$d(this,"playbackControllers",{}),_define_property$d(this,"_playbackController",void 0),_define_property$d(this,"_queue",void 0),_define_property$d(this,"services",void 0),_define_property$d(this,"_whenConfigured",void 0),this.id=generateUUID();const{developerToken:r}=t;if("string"!=typeof r||""===r.trim())throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Missing or empty developer token");Object.assign(jr.features,function(e=[]){const t={};return e.forEach(e=>{"-"===e.charAt(0)?(e=e.substr(1),t[e]=!1):t[e]=!0}),t}(t.features));const n=Ln.get();n&&(xr.warn("Overriding bag.features with",n),jr.features=_object_spread$7({},jr.features,n)),Object.assign(jr.autoplay,t.autoplay),Object.assign(jr.app,t.app),Object.assign(jr.urls,t.urls),xr.debug("Instance Configuration: ",jr);const i=["playbackActions","guid","playbackMode","privateEnabled","siriInitiated","sourceType"];for(const e of i)e in t&&(hasOwn(this,"_"+e)?this["_"+e]=t[e]:this[e]=t[e]);"prefix"in t&&/^(?:web|preview)$/.test(t.prefix||"")&&(this.prefix=jr.prefix=t.prefix),this.configureLogger(t);const o=function(e,t){return Fr=new Store(e,t),Fr}(r,t);let a="amp-api.music.apple.com",s={"hls-key-cert-url":"https://s.mzstatic.com/skdtool_2021_certbundle.bin","hls-key-server-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/acquireWebPlaybackLicense","widevine-cert-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/widevineCert"};if(this.realm===F.PODCAST&&(a="amp-api.podcasts.apple.com",s={"hls-key-cert-url":"https://s.mzstatic.com/skdtool_2021_certbundle.bin","hls-key-server-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/podcast/hls/license/streaming/start","widevine-cert-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/widevineCert"}),this.services=function(e){var t,r;const n=e.configurations,{runtime:i,request:o,dispatcher:a,store:s}=e.services,l=new MKMediaAPIClient(_object_spread_props$5(_object_spread$8({},n.mediaAPIClient),{services:{request:o}})),c=new MKMediaAPIAccess(_object_spread_props$5(_object_spread$8({},n.mediaAPIAccess),{services:{mediaAPI:l}})),d=new MKManifestManager(_object_spread_props$5(_object_spread$8({},n.manifestManager),{services:{request:o}})),u={streaming:HLSStreamingLicenseManager,batch:HLSBatchLicenseManager,web:WebPlaybackLicenseManager};var p;const h=(null!==(p=n.licenseManager.include)&&void 0!==p?p:["streaming","batch","web"]).map((function(e){return new u[e]({services:{runtime:i,request:o},developerToken:n.licenseManager.developerToken,mediaUserToken:n.licenseManager.mediaUserToken})})),y=new MKProxyLicenseManager({services:{runtime:i,request:o},developerToken:n.licenseManager.developerToken,mediaUserToken:n.licenseManager.mediaUserToken,managers:h}),f=new MKPlayableAssetResolver(_object_spread_props$5(_object_spread$8({},n.assetResolver),{services:{runtime:i,request:o,mediaAPI:l,manifest:d}})),_=new TimingAccuracy,v=new BitrateCalculator(a,null===(t=n.bitrateCalculator)||void 0===t?void 0:t.bitrate),m=new MKPlayerManager({services:{runtime:i}}),g=new MusicItemLoader(_object_spread_props$5(_object_spread$8({},n.itemLoader),{services:{mediaAPI:l}}));var b;const S=new PlayActivityService({services:{dispatcher:a},trackers:null!==(b=null===(r=n.playActivity)||void 0===r?void 0:r.trackers)&&void 0!==b?b:[]}),P=new MediaItemPlayback({services:{runtime:i,request:o,dispatcher:a,store:s,player:m,manifest:d,assetResolver:f,bitrateCalculator:v,timing:_},playerOptions:createPlayerConfig(_object_spread$8({services:{runtime:i,request:o,dispatcher:a,manifest:d,license:y,bitrateCalculator:v,timing:_,playActivity:S,store:s}},n.mediaItemPlayback))});return{runtime:i,request:o,dispatcher:a,mediaAPIClient:l,mediaAPIAccess:c,playActivity:S,itemLoader:g,manifest:d,license:y,assetResolver:f,player:m,mediaItemPlayback:P,timing:_,bitrateCalculator:v}}({services:_object_spread_props$4(_object_spread$7({},t.services),{store:o}),configurations:{mediaAPIClient:{host:a,developerToken:r,mediaUserToken:o.musicUserToken,storefrontId:this.storefrontId},itemLoader:{storefrontId:null==o?void 0:o.storefrontId,fetchContainerPages:this.realm===F.MUSIC},manifestManager:{developerToken:r,mediaUserToken:o.musicUserToken},licenseManager:{developerToken:r,mediaUserToken:o.musicUserToken},assetResolver:{staticKeyURLs:s,mzplayAssetEndpoint:`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa/webPlayback`},bitrateCalculator:{bitrate:t.bitrate},playActivity:{trackers:t.playActivityAPI},mediaItemPlayback:{bag:jr,tokens:Fr,context:this.context,autoplayEnabled:this.autoplayEnabled,privateEnabled:this.privateEnabled,siriInitiated:this.siriInitiated,playbackMode:this.playbackMode}}}),this.capabilities=new Capabilities(this.services.dispatcher),this._initializeInternalEventHandling(),xr.info("MusicKit JS Version: "+this.version),xr.info("InstanceId",this.id),xr.debug("Link Parameters",t.linkParameters),jr.app&&xr.debug("App",jr.app),t.userToken){const{userToken:e}=t;"function"==typeof e?Fr.dynamicMusicUserToken=e:this.musicUserToken=e}}}function asyncGeneratorStep$a(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$a(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$a(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$a(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function dispatchDocumentEvent(e){if(detectNodeEnvironment())return;const t=new Event(e,{bubbles:!0,cancelable:!0});setTimeout(()=>document.dispatchEvent(t))}function _loadWebComponents(){return(_loadWebComponents=_async_to_generator$a((function*(){var e;if(detectNodeEnvironment())return;const t=findScript("musickit.js");if(""!==(null==t||null===(e=t.dataset)||void 0===e?void 0:e.webComponents))return;const r="noModule"in t,n=`components/musickit-components/musickit-components${r?".esm":""}.js`,i="https:"+cdnBaseURL(n)+n,o={};r&&(o.type="module"),t.hasAttribute("async")&&(o.async=""),t.hasAttribute("defer")&&(o.defer=""),yield loadScript(i,o),dispatchDocumentEvent(Ar.webComponentsLoaded)}))).apply(this,arguments)}function asyncGeneratorStep$9(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$9(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$9(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$9(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$6(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$c(e,t,r[t])}))}return e}function _object_spread_props$3(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",["undefined"==typeof ActivityNotificationOptions?Object:ActivityNotificationOptions]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"pause",null),_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"play",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToNextItem",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToPreviousItem",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekForward",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekBackward",null);const Nn="undefined"!=typeof window&&"undefined"!=typeof document;let Un=!1;const jn=[];function cleanupInstances(){return _cleanupInstances.apply(this,arguments)}function _cleanupInstances(){return(_cleanupInstances=_async_to_generator$9((function*(){const e=jn.map(e=>e.cleanup());yield Promise.all(e),jn.splice(0,jn.length)}))).apply(this,arguments)}function configure$1(e){return _configure$1.apply(this,arguments)}function _configure$1(){return(_configure$1=_async_to_generator$9((function*(e,t=MKInstance,r){if(!e)throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"configuration required");const n=_object_spread$6({},e);n.mergeQueryParams&&Nn&&window.location&&(n.linkParameters=_object_spread$6({},e.linkParameters||{},parseQueryParams(window.location.href)));const i=new t(_object_spread_props$3(_object_spread$6({},n),{services:_object_spread$6({runtime:yield RuntimeEnvironment.detect(),dispatcher:new PubSub,request:new RequestManager},e.services)}));return Un||(yield cleanupInstances()),r&&(yield r(i)),jn.push(i),dispatchDocumentEvent(Ar.configured),i}))).apply(this,arguments)}function getInstance(e){if(0!==jn.length)return void 0===e?jn[jn.length-1]:jn.find(t=>t.id===e)}Nn&&(asAsync(function(){return _loadWebComponents.apply(this,arguments)}()),dispatchDocumentEvent(Ar.loaded));var Kn=function(e){return e.MEDIA_API="media-api",e.UTS_CLIENT="uts-client",e}({});function asyncGeneratorStep$8(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class NpPlay{getNpPayloadContent(e,t,r,n="com.apple.tv"){var i,o,a,s;const l={context:{user:{id:r,keyspace:"cid"},userAgent:navigator.userAgent,appleStoreFront:null===(s=this.utsClient)||void 0===s||null===(a=s.configuration)||void 0===a||null===(o=a.applicationProps)||void 0===o||null===(i=o.storefront)||void 0===i?void 0:i.storefrontId,source:"Client_Device",cadence:"Contract",bundleId:n,millisecondsSinceEvent:0},event:{}};return"vod"===e?l.event.vodEvent=t:"live"===e&&(l.event.liveEvent=t),l}send(e,t,r,n="com.apple.tv"){var i,o=this;return(i=function*(){var i;return o.request.fetch("/api/np/play/json",{headers:{Authorization:"Bearer "+o.tokens.developerToken,"Media-User-Token":null!==(i=o.tokens.musicUserToken)&&void 0!==i?i:""},method:"POST",body:JSON.stringify(o.getNpPayloadContent(e,t,r,n))})},function(){var e=this,t=arguments;return new Promise((function(r,n){var o=i.apply(e,t);function _next(e){asyncGeneratorStep$8(o,r,n,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$8(o,r,n,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e){_define_property$b(this,"tokens",void 0),_define_property$b(this,"utsClient",void 0),_define_property$b(this,"request",void 0),this.tokens=e.tokens,this.utsClient=e.services.utsClient,this.request=e.services.request}}function asyncGeneratorStep$7(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PlayMetadata{get isDestroyed(){return this._isDestroyed}destroy(){var e;this._isDestroyed=!0,null===(e=this.watcher)||void 0===e||e.stopMonitor(),this.watcher=void 0}trackActivity(e,t){return(r=function*(){return Promise.resolve()},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$7(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$7(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})();var r}getAppBundleIds(e,t){var r;const n=null==t?void 0:t.channels;if(!Array.isArray(n)||void 0===(null==e?void 0:e.channelId))return;const i=n.find(t=>t.id===e.channelId);var o;return null!==(o=null==i||null===(r=i.appBundleIds)||void 0===r?void 0:r[0])&&void 0!==o?o:void 0}determineRelativePosition(e,t){return e<=t.mainContentStarts?0:e>=t.mainContentEnds?t.mainContentEnds:e-t.mainContentStarts}constructor(e,t,r,n,i,o,a){_define_property$a(this,"appBundleIds",void 0),_define_property$a(this,"dispatcher",void 0),_define_property$a(this,"item",void 0),_define_property$a(this,"itemTiming",void 0),_define_property$a(this,"instance",void 0),_define_property$a(this,"npPlay",void 0),_define_property$a(this,"playable",void 0),_define_property$a(this,"pldfltcid",void 0),_define_property$a(this,"utsClient",void 0),_define_property$a(this,"watcher",void 0),_define_property$a(this,"_isDestroyed",!1),this.dispatcher=e,this.item=r,this.instance=t,this.npPlay=a,this.playable=n,this.pldfltcid=i,this.utsClient=o,this.appBundleIds=this.getAppBundleIds(n,r),this.itemTiming=function(e){const t=parseRollItems(e,["pre-roll"]),r=parseRollItems(e,["post-roll"]),n=t.reduce(addRollItemDuration,0),i=r.reduce(addRollItemDuration,0);var o,a;const s=null!==(a=null!==(o=e.hlsMetadata["up-next.start"])&&void 0!==o?o:e.hlsMetadata["watched.time"])&&void 0!==a?a:e.hlsMetadata["feature.duration"],l=parseFloat(s);return{mainContentStarts:n,mainContentEnds:l,mainContentLength:l-n,totalContentLength:l+i}}(r)}}function asyncGeneratorStep$6(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$6(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$6(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$6(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$9(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$2(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$2(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class Live extends PlayMetadata{init(){var e=this;return _async_to_generator$6((function*(){var t;const{playable:r}=e,n=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataLive",{brandId:r.channelId,externalServiceId:r.externalServiceId});var i;e.playMetadataLive=null!==(i=null==n?void 0:n.data)&&void 0!==i?i:n,e.resetListening()}))()}destroy(){this.unsubscribe()}trackActivity(e,t){var r=this;return _async_to_generator$6((function*(){"scrub"!==e&&"seek"!==e||r.resetListening()}))()}handleTimeChange(){var e;const{scheduleItems:t}=this;var r;const n=null!==(r=null===(e=this.instance.currentPlayingDate)||void 0===e?void 0:e.getTime())&&void 0!==r?r:0;if(0!==n&&t){for(let e=0;e<t.length;e++){const r=t[e],i=r.eventTime.liveBadgeTime.startTime,o=r.eventTime.liveBadgeTime.endTime;if(n>=i&&n<=o)t.splice(e,1),e-=1,this.onLiveEvent(r);else if(n>i)t.splice(e,1),e-=1;else if(n<i)return}0===t.length&&this.unsubscribe()}}onLiveEvent(e){var t=this;return _async_to_generator$6((function*(){var r;const n=t.pldfltcid,{appBundleIds:i,playable:o,utsClient:a}=t;if(!n||!a||!o)return;const s=t.generateEventStartEvent(e);yield null===(r=t.npPlay)||void 0===r?void 0:r.send("live",s,n,null!=i?i:"com.apple.tv")}))()}generateEventStartEvent(e){return{bundleId:"com.apple.tv",millisecondsSinceEvent:0,cause:"Event_Start",passThrough:null==e?void 0:e.nowPlayingPassThrough}}resetListening(){var e;const t=null===(e=this.playMetadataLive)||void 0===e?void 0:e.schedule;t&&t.length&&(this.scheduleItems=[...t],this.unsubscribe(),this.subscribe())}subscribe(){this.dispatcher.subscribe(Ar.playbackTimeDidChange,this.handleTimeChange)}unsubscribe(){this.dispatcher.unsubscribe(Ar.playbackTimeDidChange,this.handleTimeChange)}constructor(...e){super(...e),_define_property$9(this,"playMetadataLive",void 0),_define_property$9(this,"scheduleItems",[])}}function asyncGeneratorStep$5(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$5(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$5(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$5(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$8(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$2(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$1(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$2([Bind(),_ts_metadata$2("design:type",Function),_ts_metadata$2("design:paramtypes",[]),_ts_metadata$2("design:returntype",void 0)],Live.prototype,"handleTimeChange",null),_ts_decorate$2([Bind(),_ts_metadata$2("design:type",Function),_ts_metadata$2("design:paramtypes",["undefined"==typeof PlayMetadataLiveSchedule?Object:PlayMetadataLiveSchedule]),_ts_metadata$2("design:returntype",Promise)],Live.prototype,"onLiveEvent",null);const Fn=new Set(["exit","pause","play","scrub","seek","skip","stop"]),Bn=Or.createChild("bookmark");class Vod extends PlayMetadata{init(){var e=this;return _async_to_generator$5((function*(){var t;const{item:r,playable:n}=e;if(hasContentCompletionThresholdData(r)){const t=(e=>Math.min(Math.round(getUpNextStart(e)),Math.round(getWatchedTime(e))))(r);e.setupVodWatcher(t,Number.POSITIVE_INFINITY)}const i={externalId:n.externalId,brandId:n.channelId,hlsAssetDuration:Math.round(e.instance.currentPlaybackDuration),playablePassThrough:n.playablePassThrough},o=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataVOD",i);var a;e.metadata=null!==(a=null==o?void 0:o.data)&&void 0!==a?a:o}))()}setupVodWatcher(e,t){this.watcher=new SpanWatcher(this.dispatcher,this.onContentCompletionThreshhold,e,t,!0),this.watcher.startMonitor()}onContentCompletionThreshhold(e){var t=this;return _async_to_generator$5((function*(){yield t.trackActivity("exit",e),t.dispatcher.publish(me.mediaContentComplete,t.item)}))()}trackActivity(e,t){var r=this;return _async_to_generator$5((function*(){var n;const{appBundleIds:i,metadata:o,playable:a,pldfltcid:s}=r;let{itemTiming:l}=r;if(!(o&&a&&l&&Fn.has(e)))return;if("stop"===e){var c;const e=r.itemTiming.totalContentLength;if(!(null===(c=r.item)||void 0===c?void 0:c.isLinearStream)&&void 0!==e&&void 0!==t){const r=e-t;r>=0&&r<5&&(t=e+.5)}}const d=r.instance.currentPlaybackDuration;if(isNaN(l.totalContentLength)||d&&d<l.totalContentLength){const e=null!=d?d:NaN;isNaN(e)||(r.itemTiming=l=_object_spread_props$2(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$8(e,t,r[t])}))}return e}({},l),{mainContentEnds:e,mainContentLength:e,totalContentLength:e}))}Bn.info(`Bookmarking VOD progress at ${t}/${l.mainContentLength}`);const u=r.generateVodEvent(a,o,l,t);yield null===(n=r.npPlay)||void 0===n?void 0:n.send("vod",u,s,null!=i?i:"com.apple.tv")}))()}generateVodEvent(e,t,r,n){var i,o;return{playHeadInMilliseconds:Math.floor(1e3*n),mediaLengthInMilliseconds:Math.floor(1e3*r.totalContentLength),mainContentInfo:{isDone:n>=r.mainContentEnds?"Done":"Not_Done",playHeadInMilliseconds:Math.floor(1e3*this.determineRelativePosition(n,r)),lengthInMilliseconds:Math.floor(1e3*r.mainContentLength),passThrough:null!==(o=null===(i=this.metadata)||void 0===i?void 0:i.nowPlayingPassThrough)&&void 0!==o?o:""}}}constructor(...e){super(...e),_define_property$8(this,"metadata",void 0)}}function asyncGeneratorStep$4(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$4(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$4(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$4(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$7(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[Number]),_ts_metadata$1("design:returntype",Promise)],Vod.prototype,"onContentCompletionThreshhold",null);class Ebs extends PlayMetadata{init(){var e=this;return _async_to_generator$4((function*(){var t;const{playable:r}=e,n=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataEBS",{brandId:r.channelId,externalId:r.externalId});var i;const o=null!==(i=null==n?void 0:n.data)&&void 0!==i?i:n;e.playMetadataEbs=o}))()}trackActivity(e,t){var r=this;return _async_to_generator$4((function*(){if("exit"!==e&&"stop"!==e){if("play"===e&&!r.sentEventStart){var t;const e=r.pldfltcid,{appBundleIds:n,playable:i,utsClient:o}=r;if(!e||!o||!i)return;const a=r.generateEventStartEvent();yield null===(t=r.npPlay)||void 0===t?void 0:t.send("live",a,e,null!=n?n:"com.apple.tv"),r.sentEventStart=!0}}else r.sentEventStart=!1}))()}generateEventStartEvent(){var e,t;return{bundleId:"com.apple.tv",millisecondsSinceEvent:0,cause:"Event_Start",passThrough:null!==(t=null===(e=this.playMetadataEbs)||void 0===e?void 0:e.nowPlayingPassThrough)&&void 0!==t?t:""}}constructor(...e){super(...e),_define_property$7(this,"playMetadataEbs",void 0),_define_property$7(this,"sentEventStart",!1)}}function asyncGeneratorStep$3(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$3(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$3(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$3(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$6(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Vn=new Map([[me.playbackPlay,"play"],[me.playbackPause,"pause"],[me.playbackScrub,"scrub"],[me.playbackSeek,"seek"],[me.playbackSkip,"skip"],[me.playbackStop,"stop"],[me.playerExit,"exit"]]),qn=Or.createChild("bookmark");class BookmarkTracker{get requestedEvents(){return Array.from(Vn.keys())}get isConfigured(){return void 0!==this.npPlay}configure(e){var t=this;return _async_to_generator$3((function*(){if(!t.shouldConfigure(e.instance))return;const r=t.instance=e.instance;t.dispatcher=e.services.dispatcher,t.request=e.services.request,t.utsClient=e.services.utsAPIClient,t.npPlay=new NpPlay({tokens:{get developerToken(){return r.developerToken},get musicUserToken(){var e;return null!==(e=r.musicUserToken)&&void 0!==e?e:""}},services:{utsClient:t.utsClient,request:t.request}})}))()}cleanup(){var e=this;return _async_to_generator$3((function*(){e.clearItem()}))()}shouldConfigure(e){return _async_to_generator$3((function*(){return!!jr.features.bookmarking&&e.isAuthorized}))()}shouldTrackPlayActivity(e,t){if(!t||!this.utsClient)return!1;const{type:r,contentType:n}=t,i="Bonus"!==r&&!!n&&"Extra"!==n;return qn.debug("Bookmark shouldTrackPlayActivity",i,e),i}handleEvent(e,t,r){if(!this.shouldTrackPlayActivity(e,r))return;const n=Vn.get(e);void 0!==n&&"function"==typeof this[n]&&(qn.trace(`Dispatching ${e} to method ${n}`),this[n](r,t))}exit(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("exit",void 0,t.position),r.clearItem()}))()}pause(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("pause",e,t.position)}))()}play(e,t={}){var r=this;return _async_to_generator$3((function*(){const n=void 0===t.position?0:t.position;yield r.trackActivity("play",e,n)}))()}scrub(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("scrub",e,t.position)}))()}seek(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("seek",e,t.position)}))()}skip(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("skip",e,t.position)}))()}stop(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("stop",e,t.position),r.clearItem()}))()}clearItem(){var e;this.currentItem=void 0,null===(e=this.playMetadata)||void 0===e||e.destroy(),this.playMetadata=void 0}trackActivity(e,t,r){var n=this;return _async_to_generator$3((function*(){var i,o;if(void 0!==r&&void 0!==n.utsClient&&(void 0!==t&&t.id!==(null===(i=n.currentItem)||void 0===i?void 0:i.id)&&(yield n.updateItem(t)),void 0!==n.currentItem))return null===(o=n.playMetadata)||void 0===o?void 0:o.trackActivity(e,r)}))()}updateItem(e){var t=this;return _async_to_generator$3((function*(){var r,n;const i=yield Fr.storekit.pldfltcid();if(void 0===t.utsClient||!t.dispatcher||!i)return;if(t.currentItem&&t.currentItem.id!==e.id&&t.clearItem(),void 0!==t.currentItem)return;t.currentItem=e;const o=e.defaultPlayable;if(void 0===o)return;let a;null===(r=t.playMetadata)||void 0===r||r.destroy(),a=e.isLinearStream?"EbsEvent"===o.type?Ebs:Live:Vod,t.playMetadata=new a(t.dispatcher,t.instance,e,o,i,t.utsClient,t.npPlay),yield null===(n=t.playMetadata)||void 0===n?void 0:n.init()}))()}constructor(){_define_property$6(this,"currentItem",void 0),_define_property$6(this,"playMetadata",void 0),_define_property$6(this,"dispatcher",void 0),_define_property$6(this,"request",void 0),_define_property$6(this,"utsClient",void 0),_define_property$6(this,"npPlay",void 0),_define_property$6(this,"instance",void 0)}}var Gn={setDelegate:!0};function isDefined(e){return void 0!==e}function isDefinedNonNull(e){return isDefined(e)&&null!==e}function isEmptyString(e){return isString(e)&&0===e.length}function isEmptyArray(e){return isArray(e)&&0===e.length}function isEmptyObject(e){return isObject(e)&&0===Object.keys(e).length}function isFunction$1(e){return"function"==typeof e}function isNumber$1(e){return"number"==typeof e}function isInteger$1(e){return isNumber$1(e)&&e%1==0}function isString(e){return"string"==typeof e||e instanceof String}function isArray(e){return!!e&&e.constructor===Array}function isObject(e){return!!e&&e.constructor===Object}function hasGetterAndSetterMethods(e){return isObject(e)&&isFunction$1(e.__lookupGetter__)&&isFunction$1(e.__lookupSetter__)&&isFunction$1(e.__defineGetter__)&&isFunction$1(e.__defineSetter__)}function extend$2(e){var t=[!0,!0,!0].concat(Array.prototype.slice.call(arguments));return copyKeysAndValues.apply(null,t)}function copyKeysAndValues(e,t,r,n){for(var i,o=r&&n||{},a=3;a<arguments.length;a++)for(var s in i=arguments[a])if(Object.prototype.hasOwnProperty.call(i,s)){var l=i[s];(e||null!=l)&&(t||"function"!=typeof l)&&(o[s]=l)}return o}function attachMethods(e,t,r,n){var i=!1;if(e&&t){n=n||{},r=r||t;var captureFunction=function(e,t,r,n,i){var returnValue=function(){return r[i].apply(e,arguments)};return t&&(returnValue.origFunction=t),returnValue.attachedMethod=!0,returnValue};for(var o in t)if(!(o in n)&&t[o]&&isFunction$1(t[o])){var a=e[o],s=null;a&&isFunction$1(a)&&(s=!0===a.attachedMethod?a:a.bind(e)),e[o]=captureFunction(r,s,t,0,o),i=!0}}return i}function detachMethods(e){var t=!1;for(var r in e){if(isFunction$1(e[r])&&!0===e[r].attachedMethod)if(e[r].origFunction)for(;e[r].origFunction;)e[r]=e[r].origFunction,t=!0;else delete e[r]}return t}function globalScope(){return"undefined"!=typeof globalThis?globalThis:void 0!==t?t:"undefined"!=typeof window?window:{}}var Hn=Object.freeze({__proto__:null,_utResetNonOverridableFunctions:function(){Gn={setDelegate:!0}},shallowClone:function(e){var t,r,n={},i=hasGetterAndSetterMethods(e);for(var o in e)t=null,r=null,i&&(t=e.__lookupGetter__(o),r=e.__lookupSetter__(o)),t||r?(t&&n.__defineGetter__(o,t),r&&n.__defineSetter__(o,r)):n[o]=e[o];return n},isDefined:isDefined,isDefinedNonNull:isDefinedNonNull,isDefinedNonNullNonEmpty:function(e){return isDefinedNonNull(e)&&!isEmptyString(e)&&!isEmptyArray(e)&&!isEmptyObject(e)},isEmptyString:isEmptyString,isEmptyArray:isEmptyArray,isEmptyObject:isEmptyObject,isFunction:isFunction$1,isNumber:isNumber$1,isInteger:isInteger$1,isString:isString,isElement:function(e){return!!e&&1==e.nodeType},isArray:isArray,isObject:isObject,values:function(e){var t=[];for(var r in e){var n=e[r];e.hasOwnProperty(r)&&!isFunction$1(n)&&t.push(n)}return t},keys:function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&!isFunction$1(e[r])&&t.push(r);return t},hasAnyKeys:function(e){for(var t in e)if(e.hasOwnProperty(t))return!0},hasAnyNonNullKeys:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!0},hasGetterAndSetterMethods:hasGetterAndSetterMethods,methods:function(e){var t=[];for(var r in e){var n=e[r];e.hasOwnProperty(r)&&isFunction$1(n)&&t.push(n)}return t},invert:function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&!isFunction$1(e[r])&&(t[e[r]]=r);return t},extend:extend$2,copyKeysAndValues:copyKeysAndValues,addNonOverrideableFunctions:function(e){for(var t=0;t<e.length;t++){var r=e[t];Gn[r]=!0}},attachMethods:attachMethods,detachMethods:detachMethods,attachDelegate:function(e,t,r){var n=!1;if(r=r||!1,e&&t&&e!==t){var i={};Object.keys(t).forEach((function(t){e[t]||(i[t]=!0)})),extend$2(i,Gn),n=attachMethods(e,t,r?e:null,i)}return n},setDelegates:function(e,t){var r={};for(var n in e)t[n]&&isFunction$1(e[n].setDelegate)&&(r[n]=e[n].setDelegate.apply(e[n],[t[n]].concat(Array.prototype.slice.call(arguments,2))));return r},resetDelegates:function(e){var t=!1;for(var r in e){var n=e[r];n&&"object"==typeof n&&isFunction$1(n.setDelegate)&&(t|=detachMethods(n))}return!!t},copyDelegatedFunctions:function(e,t){var r=null;if(e&&t&&t.setDelegate){var n,i={};for(n in e)isFunction$1(e[n])&&e[n].origFunction&&(i[n]=e[n]);r=t.setDelegate(i)}return r},dedupedArray:function(e,t){var r={};if(e)for(var n=0;n<e.length;n++)r[e[n]]=0;if(t)for(var i=0;i<t.length;i++)r[t[i]]=0;return Object.keys(r)},globalScope:globalScope}),Wn={maxWait:1500,initialDelay:100,factor:2},ExponentialStrategy=function(e,t,r){this.delay=e||Wn.initialDelay,this.maxWait=isNumber$1(t)?t:Wn.maxWait,this.factor=r||Wn.factor,this.timeWaited=0};ExponentialStrategy.prototype.nextDelay=function(){var e=null,t=this.maxWait-this.timeWaited;return t>0&&(this.delay=Math.min(this.delay,t),this.timeWaited+=this.delay),(0===this.maxWait||t>0)&&(e=this.delay,this.delay=this.delay*this.factor),e};var zn=Object.freeze({__proto__:null,exponentialBackoff:function(e,t,r,n,i,o){!function _backoff(e,t,r,n){t.call(t,r,(function(){var i=e.nextDelay();i?setTimeout(_backoff.bind(null,e,t,r,n),i):n.apply(n,arguments)}))}(new ExponentialStrategy(n,i,o),e,t,r)}});var Yn=Object.freeze({__proto__:null,deResNumber:function(e,t,r){var n=void 0;if(isDefined(e))if(isDefined(t)||(t=1048576),isDefined(r)||(r=2),isNumber$1(e)&&isNumber$1(t)&&t>0&&isInteger$1(r)&&r>=0){var i=Math.pow(10,r);n=Math[e>0?"floor":"ceil"](e/t/i)*i}else n=NaN;return n}}),Qn="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy",Jn=Qn+"z";function snakeCaseToCamelCase(e,t){var r="";if(e)for(var n,i=e.toLowerCase().split("_"),o=0;o<i.length;o++)n=i[o][0],(0!==o||t)&&(n=n.toUpperCase()),r+=n+i[o].slice(1);return r}function randomHexCharacter(e,t,r){var n,i=globalScope(),o=i.crypto||i.msCrypto;return n=e?(16*e()|0).toString(16):o&&o.getRandomValues?(15&o.getRandomValues(new Uint8Array(1))[0]).toString(16):o&&o.randomBytes?o.randomBytes(1).toString("hex")[0]:(16*Math.random()|0).toString(16),t&&r&&(n<t||n>r)&&(n=randomHexCharacter(e,t,r)),n}var Xn=Object.freeze({__proto__:null,base10Alphabet:"0123456789",base16Alphabet:"0123456789ABCDEF",base36Alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base61Alphabet:Qn,base62Alphabet:Jn,startsWith:function(e,t,r){var n=!1;return e&&t&&(e=e.substr(0,t.length),r&&(e=e.toLowerCase(),t=t.toLowerCase()),n=0===e.indexOf(t)),n},endsWith:function(e,t,r){var n=!1;if(e&&t){r&&(e=e.toLowerCase(),t=t.toLowerCase());var i=e.length-t.length;n=i>=0&&e.lastIndexOf(t)===i}return n},trim:function(e,t,r){var n=null,i=new RegExp("^[\t\n\v\f\r \u2028\u2029]+"),o=new RegExp("[\t\n\v\f\r \u2028\u2029]+$");if(e)if(r||t&&"\t\n\v\f\r \u2028\u2029"!=t||!e.trim){var a=null,s=null,l=null;t&&void 0!==t?(a="["+(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"))+"]",s=new RegExp("^"+a+"+"),l=new RegExp(a+"+$")):(a="\t\n\v\f\r \u2028\u2029",s=i,l=o),n=e.replace(s,"").replace(l,"")}else n=e.trim();return n},snakeCaseToCamelCase:snakeCaseToCamelCase,snakeCaseToUpperCamelCase:function(e){return snakeCaseToCamelCase(e,!0)},exceptionString:function(e,t){return"The function "+e+"."+t+"() must be overridden with a platform-specific delegate function.If you have no data for this function, have your delegate return null or undefined (no 'return')"},paramString:function(e){var t="",r="",n=!0;for(var i in e){var o=e[i];(o||0===o||!1===o)&&(t+=r+i+"="+encodeURIComponent(o),n&&(r="&",n=!1))}return t},versionStringFromUserAgent:function(e,t){var r=null;t=t||"\\S+";var n=new RegExp("\\b"+t+"/(\\S+)\\b","i").exec(e);return n&&n[1]&&(r=n[1]),r},requestId:function(e){var t=Date.now(),r=Math.floor(1e5*Math.random());return e+"z"+(t=t.toString(36).toUpperCase())+"z"+(r=r.toString(36).toUpperCase())},uuid:function(e){for(var t,r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",n="",i=0,o=r.length;i<o;i++)n+="x"===(t=r.charAt(i))?randomHexCharacter(e):"y"===t?randomHexCharacter(e,"8","b"):t;return n},randomHexCharacter:randomHexCharacter,convertNumberToBaseAlphabet:function(e,t){var r="",n=t.length;if(n<=36)r=e.toString(n).toUpperCase();else{for(var i,o,a=[];e>0;)i=e%n,o=t.charAt(i),a.push(o),e=(e-i)/n;r=a.reverse().join("")}return""===r&&(r="0"),r},cryptoRandomBase62String:function(e){var t;if(16777215==Math.floor(4294967295/256)){var r,n,i,o,a,s=globalScope(),l=s.crypto||s.msCrypto;if(l&&l.getRandomValues)r=l.getRandomValues(new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT)),a=!0;else if(l&&l.randomBytes){var c=l.randomBytes(16);r=new Uint32Array(c.buffer,c.byteOffset,c.byteLength/Uint32Array.BYTES_PER_ELEMENT),a=!0}else for(r=new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT),n=0;n<r.length;n++)r[n]=Math.floor(Math.random()*Math.floor(4294967295));if(r){for(t="",n=0;n<r.length;n++)for(o=r[n],i=0;i<6;i++)t+=Jn[o%62],o=Math.floor(o/62);e&&(t="1_"+(a?"1":"2")+"_"+t)}}return t}});function _valueForKeyPath(e,t,r){var n=t;if(e&&t)for(var i=e.split("."),o=0;n&&o<i.length;o++){var a=i[o];!(a in n)&&r&&(n[a]={}),n=a in n?n[a]:null}return n}function valueForKeyPath(e){var t=null;if(e&&arguments.length>1)for(var r=sourcesArray(Array.prototype.slice.call(arguments,1)),n=r.length-1;n>=0;n--){var i=r[n];if(isDefinedNonNull(t=_valueForKeyPath(e,i)))break}return t}function sourcesArray(e){var t=[],r=[];r=r.concat(e),arguments&&arguments.length>1&&(r=r.concat(Array.prototype.slice.call(arguments,1)));for(var n=0;n<r.length;n++){var i=r[n];t=t.concat(i)}return t}var Zn=Object.freeze({__proto__:null,valueForKeyPath:valueForKeyPath,createObjectAtKeyPath:function(e,t){return _valueForKeyPath(e,t,!0)},sourcesArray:sourcesArray});function mergeAndCleanEventFields(e){for(var t=[!1,!1,!1].concat(Array.prototype.slice.call(arguments)),r=[],n=0;n<t.length;n++){var i=t[n];if(i&&i.constructor===Array)for(var o=0;o<i.length;o++)r.push(i[o]);else r.push(i)}return copyKeysAndValues.apply(null,r)}var ei=Object.freeze({__proto__:null,mergeAndCleanEventFields:mergeAndCleanEventFields,processMetricsData:function(e,t,r,n){var i=mergeAndCleanEventFields(n),o=i;if(e&&t){var a={};if(r||(t=t.filter((function(e){return e in i}))),t.length)for(var s=0;s<t.length;s++){var l=t[s],c=e[l];isFunction$1(c)&&(a[l]=c.call(e,i))}o=mergeAndCleanEventFields(o,a)}return o},applyFieldsMap:function(e,t,r,n){var i,o,a;if(e&&t&&r){var s,l;if(o={},i=valueForKeyPath(t,r,r.custom))if(isArray(i))for(s=0;s<i.length;++s)isDefinedNonNull(l=e[i[s]])&&(o[i[s]]=l);else if(isObject(i)){for(var c in i)for(s=0;s<i[c].length;++s)if(isDefinedNonNull(l=valueForKeyPath(i[c][s],e))){o[c]=l;break}}else a="metrics: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)";else a="metrics: unable to get "+t+" section from fieldsMap"}else{var d=[];e||d.push("data"),t||d.push("sectionName"),r||d.push("fieldsMap"),a="metrics: missing argument(s): "+d.join(",")+" not provided to applyFieldsMap"}return a&&isFunction$1(n)&&n(a),o}});function makeAjaxRequest(e,t,r,n,i,o){var a=new XMLHttpRequest;r=r||void 0,o=o||{},n=isFunction$1(n)?n:function(){},i=isFunction$1(i)?i:function(){};var s=!1!==o.async;o.timeout&&s&&(a.timeout=o.timeout),a.onload=function(){a.status>=200&&a.status<300?n(a.response):i(new Error("XHR error: server responded with status "+a.status+" "+a.statusText),a.status)},a.onerror=function(){i(new Error("XHR error"))},a.open(t,e,s),a.withCredentials="boolean"!=typeof o.withCredentials||o.withCredentials,a.setRequestHeader("Content-type","application/json"),a.send(r)}var ti=Object.freeze({__proto__:null,makeAjaxGetRequest:function(e,t,r){makeAjaxRequest(e,"GET",null,t,r)},makeAjaxRequest:makeAjaxRequest}),ri={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},_storageObject=function(e){var t=null,r=!1;return function(){return e?t=e:(r||(console.error("storageObject: storage object not found. Override this function if there is a platform-specific implementation"),r=!0),t||(t={storage:{},getItem:function(e){return this.storage[e]},setItem:function(e,t){this.storage[e]=t},removeItem:function(e){delete this.storage[e]}})),t}};function _defaultStorageObject(e){var t=null,r=e===ri.LOCAL_STORAGE;try{t="undefined"!==(r?typeof localStorage:typeof sessionStorage)?r?localStorage:sessionStorage:null}catch(n){t=null,console.error("_utils.storage._defaultStorageObject: Unable to retrieve storage object: "+n)}return t}var ni=_storageObject(_defaultStorageObject(ri.LOCAL_STORAGE)),ii=_storageObject(_defaultStorageObject(ri.SESSION_STORAGE));var oi=Object.freeze({__proto__:null,_utDefaultStorageObject:function(e){return _defaultStorageObject(e)},localStorageObject:ni,sessionStorageObject:ii,saveObjectToStorage:function(e,t,r){var n=null;if(r)try{e.setItem(t,JSON.stringify(r)),n=r}catch(i){}else n=e.removeItem(t);return n},objectFromStorage:function(e,t){var r=null,n=e.getItem(t);if(n)try{r=JSON.parse(n)}catch(i){r=void 0}return r}});function FlagSymbol(e){this.key=e}FlagSymbol.prototype.toString=function(){return this.key};var ai={flagArguments:{INCLUDE_CALL_STACK:new FlagSymbol("INCLUDE_CALL_STACK"),MIRROR_TO_SERVER:new FlagSymbol("MIRROR_TO_SERVER"),SUPPRESS_CLIENT_OUTPUT:new FlagSymbol("SUPPRESS_CLIENT_OUTPUT")},setDelegate:function(e){return Hn.attachDelegate(this,e)},execute:function(e,t,r){var n=e.levelStringToIntMap[t];if(e.level()!==e.NONE&&e.level()<=n){var i=Array.prototype.slice.call(r),o=ai.nonFlagLogArguments(i),a=ai.logOptions(e,n,i),s=a.includeCallStack?(new Error).stack:null,l=s?o.concat("\n"+s):o;if(e[t]._lastLog=l,a.mirrorToServer,a.throwInsteadOfPrint)throw new Error(o.toString());a.suppressClientOutput||(console[t]?console[t].apply(console,l):console.log.apply(console,l))}},isFlagObject:function(e){return e&&e===ai.flagArguments[e.toString()]},nonFlagLogArguments:function(e){return e.filter((function(e){return!ai.isFlagObject(e)}))},logOptions:function(e,t,r){var n,i={};return r.forEach((function(e){ai.isFlagObject(e)&&(n=Xn.snakeCaseToCamelCase(e.toString()),i[n]=!0)})),Hn.isFunction(e.mirrorToServerLevel)&&e.mirrorToServerLevel()!==e.NONE&&e.mirrorToServerLevel()<=t&&(i.mirrorToServer=!0),e.throwLevel()!==e.NONE&&e.throwLevel()<=t&&(i.throwInsteadOfPrint=!0),i},sendToServer:function(e,t,r,n){}},si={NONE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4},li={MIN_LEVEL:si.NONE,MAX_LEVEL:si.ERROR,levelIntToStringMap:{0:"none",1:"debug",2:"info",3:"warn",4:"error"},levelStringToIntMap:{none:0,debug:1,info:2,warn:3,error:4}};Hn.extend(li,si);var ci={loggerName:"defaultLogger",level:li.INFO,throwLevel:li.NONE},di=!1,ui={};function Logger(e){this._loggerName=e,this._level,this._throwLevel,di||(di=!0,Hn.extend(Logger.prototype,li),Hn.extend(Logger.prototype,ai.flagArguments))}function loggerNamed(e){var t=ui[e=e||ci.loggerName];return t||(t=new Logger(e),ui[e]=t),t}Logger.level=function(){return ci.level},Logger.throwLevel=function(){return ci.throwLevel},Logger.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Logger.prototype.loggerName=function(){return this._loggerName},Logger.prototype.levelParameterAsInt=function(e){var t,r=null;return Hn.isString(e)?t=this.levelStringToIntMap[e.toLowerCase()]:Hn.isNumber(e)&&(t=e),t>=this.MIN_LEVEL&&t<=this.MAX_LEVEL&&(r=t),r},Logger.prototype.setLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._level=t)},Logger.prototype.setThrowLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._throwLevel=t)},Logger.prototype.level=function(){var e=this._level;return Hn.isNumber(e)?e:Logger.level()},Logger.prototype.levelString=function(){return this.levelIntToStringMap[this.level()]},Logger.prototype.throwLevel=function(){var e=this._throwLevel;return Hn.isNumber(e)?e:Logger.throwLevel()},Logger.prototype.debug=function(){ai.execute(this,"debug",arguments)},Logger.prototype.info=function(){ai.execute(this,"info",arguments)},Logger.prototype.warn=function(){ai.execute(this,"warn",arguments)},Logger.prototype.error=function(){ai.execute(this,"error",arguments)},Logger.prototype.lastLog=function(e){return this[e]?this[e]._lastLog:null},Logger.level,Logger.throwLevel;var Environment$4=function(){};Environment$4.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Environment$4.prototype.localStorageObject=oi.localStorageObject,Environment$4.prototype.sessionStorageObject=oi.sessionStorageObject;var Network=function(){};Network.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Network.prototype.makeAjaxRequest=ti.makeAjaxRequest;var pi,hi={configBaseUrl:"https://xp.apple.com/config/1/report",disabled:!0},_appendSectionAndSubsectionToConfigSources=function(e,t,r){if(r){e.push(r);var n=r[t];n&&Hn.hasAnyKeys(n)&&e.push(n)}},Config=function(e){this.environment=new Environment$4,this.network=new Network,this.logger=new Logger("mt-client-config"),this._topic=e||"noTopicConfig",this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._keyPathsThatSuppressWarning={configBaseUrl:!0},this._configFetchPromise=null,this.DEBUG_SOURCE_KEY="mtClientConfig_debugSource_"+this._topic,this.CACHED_SOURCE_KEY="mtClientConfig_cachedSource_"+this._topic};Config.defaultConfig=function(){return pi||(pi=new Config("noTopicConfig")),pi},Config.prototype._defaults=function(){return hi},Config.prototype._setInitialized=function(e){this._initialized=e},Config.prototype._setInitCalled=function(e){this._initCalled=e},Config.prototype._setShowedDebugWarning=function(e){this._showedDebugWarning=e},Config.prototype._setShowedNoProvidedSourceWarning=function(e){this._showedNoProvidedSourceWarning=e},Config.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Config.prototype.resetDelegate=function(){Hn.detachMethods(this),Hn.resetDelegates(this)},Config.prototype.topic=function(){return this._topic},Config.prototype.configHostname=function(){},Config.prototype.configUrl=function(){var e=this.configHostname();return(e?Promise.resolve("https://"+e+"/config/1/report"):this.value("configBaseUrl")).then(function(e){return"noTopicConfig"!==this._topic?e+="/"+this.topic():this.logger.error("config.configUrl(): Topic must be provided"),e}.bind(this))},Config.prototype.sources=function(){},Config.prototype.value=function(e,t){var r=function(){var r,n=this.cachedSource(),i=this.serviceSource(),o=this.sources(),a=this.debugSource(),s=n||i||o||a;return o||i||e in this._keyPathsThatSuppressWarning||this._showedNoProvidedSourceWarning||(this._showedNoProvidedSourceWarning=!0,this.logger.warn("Metrics config: No config provided via delegate or fetched via init(), using cached config values.")),a&&(this._showedDebugWarning||(this._showedDebugWarning=!0,this.logger.warn('"debugSource" found.\nThis will override any same-named client-supplied configSource fields.\nThis setting "sticks" across session, use "setDebugSource(null)" to clear'))),Hn.isArray(o)||(o=[o]),r="disabled"===e?s?[n,i,o,a]:[hi]:[hi,n,i,o,a],r=this.configSourcesWithOverrides(r,t||this.topic()),Zn.valueForKeyPath.apply(null,[e].concat(r))}.bind(this);if(this._configFetchPromise)return this._configFetchPromise.then(r);var n=r();return Promise.resolve(n)},Config.prototype.configSourcesWithOverrides=function(e,t){var r=e;if(e&&e.length&&t){r=[];for(var n=0;n<e.length;n++){var i=e[n];if(i)if(Hn.isArray(i)&&i.length){for(var o=[],a=0;a<i.length;a++)_appendSectionAndSubsectionToConfigSources(o,t,i[a]);r.push(o)}else _appendSectionAndSubsectionToConfigSources(r,t,i)}}return r},Config.prototype.setDebugSource=function(e){return this._debugSource=e||null,oi.saveObjectToStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY,this._debugSource)},Config.prototype.debugSource=function(){return this._debugSource||(this._debugSource=oi.objectFromStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY)),this._debugSource},Config.prototype.setCachedSource=function(e){return this._cachedSource=e||null,oi.saveObjectToStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY,this._cachedSource)},Config.prototype.cachedSource=function(){return this._cachedSource||(this._cachedSource=oi.objectFromStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY)),this._cachedSource},Config.prototype.setServiceSource=function(e){return this._serviceSource=e,this._serviceSource},Config.prototype.serviceSource=function(){return this._serviceSource},Config.prototype.init=function(e){var t="noTopicConfig"===this._topic||!Hn.isFunction(e);if(t&&this.logger.warn("config.init(): Falling back to default config because configSourcesFn or a valid topic was not provided"),this._initCalled||t)return Promise.resolve(this);this._initCalled=!0;var r=this;return this._configFetchPromise=Promise.resolve(e()).then((function(e){return r.setDelegate({sources:function(){return e}}),r._initialized=!0,r})).catch((function(e){throw r._initCalled=!1,r._initialized=!1,e})),this._configFetchPromise},Config.prototype.cleanup=function(){this._initCalled=this._initialized=!1,this.setCachedSource(),this.setDebugSource(),this.resetDelegate(),this.environment=null,this.network=null,this.logger=null,this._topic=null,this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._configFetchPromise=null},Config.prototype.initialized=function(){return this._initialized};var MetricsConfig=function(e){Config.call(this,e)};function dedupedArray(e,t){var r={};if(e)for(var n=0;n<e.length;n++)r[e[n]]=0;if(t)for(var i=0;i<t.length;i++)r[t[i]]=0;return Object.keys(r)}(MetricsConfig.prototype=Object.create(Config.prototype)).constructor=MetricsConfig,MetricsConfig.prototype.disabled=function(e){return this.value("disabled",e).then((function(e){return!!e}))},MetricsConfig.prototype.blacklistedEvents=function(e){return this.denylistedEvents(e)},MetricsConfig.prototype.denylistedEvents=function(e){var t=this.value("blacklistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]})),r=this.value("denylistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([t,r]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.blacklistedFields=function(e){return this.denylistedFields(e)},MetricsConfig.prototype.denylistedFields=function(e){var t=this.value("blacklistedFields",e).then((function(e){return e||[]})).catch((function(){return[]})),r=this.value("denylistedFields",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([t,r]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.removeBlacklistedFields=function(e,t){return this.removeDenylistedFields(e,t)},MetricsConfig.prototype.removeDenylistedFields=function(e,t){return e?this.denylistedFields(t).then((function(t){for(var r=0;r<t.length;r++){var n=t[r];n&&n in e&&delete e[n]}return e})):Promise.resolve(e)},MetricsConfig.prototype.metricsDisabledOrBlacklistedEvent=function(e,t){return this.metricsDisabledOrDenylistedEvent(e,t)},MetricsConfig.prototype.metricsDisabledOrDenylistedEvent=function(e,t){return this.disabled(t).then(function(r){return r||!!e&&this.denylistedEvents(t).then((function(t){return t.indexOf(e)>-1}))}.bind(this))},MetricsConfig.prototype.deResFields=function(e){return this.value("deResFields",e).then((function(e){return e||[]}))},MetricsConfig.prototype.applyDeRes=function(e,t){return e?this.deResFields(t).then((function(t){var r;return t.forEach((function(t){(r=t.fieldName)in e&&(e[r]=Yn.deResNumber(e[r],t.magnitude,t.significantDigits))})),e})):Promise.resolve(e)};var Delegates=function(e,t){if(!Hn.isDefinedNonNullNonEmpty(e)||!Hn.isString(e))throw new Error("No valid topic was provided to Delegates.");this.config=this.getOrCreateConfig(e),Hn.isDefinedNonNull(t)&&(this.environment=t.environment,this.eventRecorder=t.eventRecorder),this._useOrginalContextForDelegateFunc=!1};function AbstractEventRecorder(){this._operationPromiseChain=Promise.resolve()}Delegates.prototype.init=function(){if(!Hn.isDefinedNonNull(this.environment))throw new Error("No environment was provided to Delegate options.");if(!Hn.isDefinedNonNull(this.eventRecorder))throw new Error("No eventRecorder was provided to Delegate options.");this.config.environment.setDelegate(this.environment),this.config.logger.setDelegate(this.logger),this.config.network.setDelegate(this.network);var e=Hn.isFunction(this.configSources)?this.configSources.bind(this):null;return this.config.init(e)},Delegates.prototype.mergeDelegates=function(e){for(var t in e)this[t]||(this[t]=e[t]);this.config.setDelegate(e.config)},Delegates.prototype.cleanup=function(){Hn.isFunction(this.eventRecorder.cleanup)&&this.eventRecorder.cleanup(),this.config=null,this.eventRecorder=null,this.environment=null},Delegates.prototype.setEventRecorder=function(e){return Hn.isDefinedNonNull(e)&&(Hn.isDefinedNonNull(this.eventRecorder)?(Hn.setDelegates(this.eventRecorder,e),this.eventRecorder.setDelegate(e)):this.eventRecorder=e),this},Delegates.prototype.setEnvironment=function(e){if(Hn.isDefinedNonNull(this.environment)){var t=Object.create(this.environment);Hn.extend(t,e),this.environment=t}else this.environment=e;return this},Delegates.prototype.setConfig=function(e){return this.config.setDelegate(e),this},Delegates.prototype.getOrCreateConfig=function(e){return Hn.isDefinedNonNull(this.config)||(this.config=new MetricsConfig(e)),this.config},Delegates.prototype.configSources=function(){throw new Error("This method should be implemented by subdelegates.")},AbstractEventRecorder.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},AbstractEventRecorder.prototype.recordEvent=function(e,t){var r=Array.prototype.slice.call(arguments,2),n=this;return this._operationPromiseChain=this._operationPromiseChain.then((function(){return Promise.resolve(t).then((function(t){return n._recordEvent.apply(n,[e,t].concat(r))}))})),this._operationPromiseChain},AbstractEventRecorder.prototype.flushUnreportedEvents=function(){var e=Array.prototype.slice.call(arguments),t=this;return this._operationPromiseChain.then((function(){return t._operationPromiseChain=Promise.resolve(),t._flushUnreportedEvents.apply(t,e)}))},AbstractEventRecorder.prototype._recordEvent=function(e,t){},AbstractEventRecorder.prototype._flushUnreportedEvents=function(e){};var yi={setDelegate:function(e){return Hn.attachDelegate(this,e)},globalScope:function(){return Hn.globalScope()}},fi={AJAX:"ajax",AJAX_SYNCHRONOUS:"ajaxSynchronous",IMAGE:"image",BEACON:"beacon",BEACON_SYNCHRONOUS:"beaconSynchronous"},_i=["dsId","consumerId"];function cloneTopicConfigWithTopic(e,t){var r={_topic:t};return Object.setPrototypeOf(r,e),r}var Base$3=function(e){this._validateConfig(e),this._config=e,this._topicConfigCache={},this._topicPropsCache={},this.logger=loggerNamed("mt-event-queue")};Base$3.prototype._validateConfig=function(e){var t="please call constructor with a valid Config instance first.";if(!e)throw new TypeError("Unable to find config, "+t);if(!e.topic||!Hn.isFunction(e.topic))throw new TypeError("Unable to find config.topic function, "+t);if(!e.metricsDisabledOrDenylistedEvent||!Hn.isFunction(e.metricsDisabledOrDenylistedEvent))throw new TypeError("Unable to find config.metricsDisabledOrDenylistedEvent function, "+t);if(!e.removeDenylistedFields||!Hn.isFunction(e.removeDenylistedFields))throw new TypeError("Unable to find config.removeDenylistedFields function, "+t)},Base$3.prototype._removeIdentifiableFieldsForTopic=function(e,t){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e].anonymous&&_i.forEach((function(e){delete t[e]}))},Base$3.prototype._record=function(e){},Base$3.prototype.cleanup=function(){this._config=null,this._topicConfigCache=null,this._topicPropsCache={}},Base$3.prototype.recordEvent=function(e,t){if(!this._config||!t)return Promise.resolve(null);var r=this._config,n=this,i=arguments;return Hn.isDefinedNonNullNonEmpty(e)&&e!==r.topic()&&((r=this._topicConfigCache[e])||(r=this._topicConfigCache[e]=cloneTopicConfigWithTopic(this._config,e))),r.metricsDisabledOrDenylistedEvent(t.eventType).then((function(o){return o?null:r.removeDenylistedFields(t).then((function(){return n._removeIdentifiableFieldsForTopic(e,t),n._record.apply(n,[r].concat(Array.prototype.slice.call(i,1)))})).then((function(){return t}))})).catch((function(e){return n.logger.error(e),null}))},Base$3.prototype.sendMethod=function(){return"javascript"},Base$3.prototype.setProperties=function(e,t){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e]=t};var vi={setDelegate:function(e){return Hn.attachDelegate(this,e)},makeAjaxRequest:ti.makeAjaxRequest};function _isIOS(){var e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&-1==e.indexOf("IEMobile")}function _logger(){return loggerNamed("mt-event-queue")}var mi=1e4,gi="events",bi="1.0",Si=100,Pi=2,ki=fi,Ti=2,Ei="properties",wi={eventQueues:{},postIntervalEnabled:!0,enqueueEvent:function(e,t){if(e&&t&&e.topic()){var r=e.topic();return wi.eventQueues=wi.eventQueues||{},wi.eventQueues[r]=wi.eventQueues[r]||{},wi.eventQueues[r].topicConfig=e,wi.eventQueues[r].flushConfig=wi.eventQueues[r].flushConfig||{},wi.eventQueues[r][gi]=wi.eventQueues[r][gi]||[],wi.eventQueues[r][gi].push(t),0===Object.keys(wi.eventQueues[r].flushConfig).length&&Promise.all([e.value("metricsUrl"),e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var t=wi.eventQueues[r].flushConfig;t.metricsUrl=e[0],t.requestTimeout=e[1],t.postFrequency=e[2]})),e.value("maxPersistentQueueSize").then((function(e){return e=e||Si,wi.trimEventQueues(wi.eventQueues,e),t}))}return Promise.resolve(null)},trimEventQueues:function(e,t){var r=Object.keys(e);r.length&&r.forEach((function(r){var n=e[r][gi];n&&n.length&&n.length>t&&(_logger().warn("eventQueue overflow, deleting LRU events: size is: "+n.length+" which is over max size: "+t),e[r][gi]=n.slice(-t))}))},resetTopicQueue:function(e){wi.eventQueues[e]&&(wi.eventQueues[e][gi]=null)},resetTopicRetryAttempts:function(e){wi.eventQueues[e]&&(wi.eventQueues[e].retryAttempts=0)},scheduleNextTopicRetryAttempt:function(e){var t=e.topic();return wi.eventQueues[t]&&this.postIntervalEnabled?e.value("postFrequency").then((function(r){var n=wi.eventQueues[t];n.retryAttempts=n.retryAttempts||0,n.retryAttempts++;var i=Math.pow(Pi,n.retryAttempts)*r;wi.resetTopicPostInterval(t),wi.setTopicPostInterval(e,i)})):Promise.resolve()},sendEvents:function(e,t){var r=[];for(var n in wi.eventQueues){var i=wi.eventQueues[n].topicConfig,o=wi.sendEventsForTopicConfig(i,e,t);r.push(o)}return Promise.all(r)},sendEventsForTopicConfig:function(e,t,r){var n=e.topic(),i=wi.eventQueues[n];return Promise.all([e.value("testExponentialBackoff"),e.value("metricsUrl"),e.disabled(),e.value("postFrequency")]).then((function(o){var a=o[0],s=o[1],l=o[2],c=o[3];if(i&&s&&!l&&!a){if(!i.retryAttempts||!r){var d;switch(wi.resetTopicPostInterval(n),wi.setTopicPostInterval(e,c),t){case ki.IMAGE:d=wi.sendEventsViaImage(e);break;case ki.BEACON:d=wi.sendEventsViaBeacon(e);break;case ki.AJAX_SYNCHRONOUS:d=wi.sendEventsViaAjax(e,!1);break;case ki.AJAX:default:d=wi.sendEventsViaAjax(e,!0)}return d}}else if(a)return wi.scheduleNextTopicRetryAttempt(e)}))},sendEventsViaImage:function(e){var t=e.topic(),r=Promise.resolve();return wi.eventQueues[t]&&(r=resolveTopicConfigWithCallback(e,(function(e){var r=e.metricsUrl,n=-1==r.indexOf("?")?"?":"&",i=r+n+"responseType=image",o=wi.eventQueues[t][gi];o&&o.length&&o.forEach((function(e){var r=wi.createQueryParams(e);if(r){var n=i+"&"+r,o=new Image,a=wi.eventQueues[t][Ei];a&&a.anonymous&&o.setAttribute("crossOrigin","anonymous"),o.src=n}})),wi.resetTopicQueue(t)}))),r},createQueryParams:function(e){var t,r,n="";return Object.keys(e).forEach((function(i,o,a){t=e[i],r=Hn.isString(t)?t:JSON.stringify(t),n+=i+"="+encodeURIComponent(r),o<a.length-1&&(n+="&")})),n.length?n:null},sendEventsViaAjax:function(e,t){var r=Promise.resolve(),n=e.topic();if(wi.eventQueues[n]&&wi.eventQueues[n][gi]){var i=wi.eventQueues[n][gi],o=enrichAndSerializeEvents(i);wi.resetTopicQueue(n),o&&(r=resolveTopicConfigWithCallback(e,(function(r){var a=r.metricsUrl,s=r.requestTimeout,resetRetryAttempts=function(){wi.resetTopicRetryAttempts(n)},l=wi.eventQueues[n][Ei]||{},c={async:t,timeout:s};l.anonymous&&(c.withCredentials=!1),vi.makeAjaxRequest(a,"POST",o,resetRetryAttempts,(function(t,r){if(r>=400&&r<500)resetRetryAttempts();else{var o=wi.eventQueues[n][gi]||[];wi.eventQueues[n][gi]=i.concat(o),wi.scheduleNextTopicRetryAttempt(e)}}),c)})))}return r},sendEventsViaBeacon:function(e){var t=Promise.resolve();if(!Hn.isFunction(navigator.sendBeacon))return _logger().error("navigator.sendBeacon() is not available in the environment"),t;var r=e.topic(),n=wi.eventQueues[r];if(n){var i=n[Ei];if(i&&i.anonymous)t=Hn.isFunction(yi.globalScope().fetch)&&!/Firefox/.test(navigator.userAgent)?wi.sendEventsViaFetch(e,{keepalive:!0}):_isIOS()?wi.sendEventsViaAjax(e,!1):wi.sendEventsViaImage(e);else{var o=enrichAndSerializeEvents(n[gi]);o&&(wi.resetTopicQueue(r),t=resolveTopicConfigWithCallback(e,(function(e){var t=e.metricsUrl,r=new(0,yi.globalScope().Blob)([o],{type:"application/json"});navigator.sendBeacon(t,r)||_logger().error("navigator.sendBeacon() was unable to queue the data for transfer")})))}}return t},sendEventsViaFetch:function(e,t){var r=Promise.resolve(),n=e.topic(),i=wi.eventQueues[n],o=Hn.isDefinedNonNull(t)?t.keepalive:null;if(Hn.isDefinedNonNull(i)){var a=enrichAndSerializeEvents(i[gi]);if(a){wi.resetTopicQueue(n);var s=i[Ei]||{};r=resolveTopicConfigWithCallback(e,(function(e){var t=e.metricsUrl;Hn.globalScope().fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:a,credentials:!0===s.anonymous?"omit":"same-origin",keepalive:!Hn.isDefinedNonNull(o)||o})}))}}return r},setTopicPostInterval:function(e,t){var r=e.topic();wi.eventQueues[r]&&t&&this.postIntervalEnabled&&(this.resetTopicPostInterval(r),wi.eventQueues[r].postIntervalToken=yi.globalScope().setInterval((function(){_logger().debug("MetricsKit: triggering postIntervalTimer for "+r+" at "+(new Date).toString()),wi.sendEventsForTopicConfig(e)}),t))},resetTopicPostInterval:function(e){wi.eventQueues[e]&&(yi.globalScope().clearInterval(wi.eventQueues[e].postIntervalToken),wi.eventQueues[e].postIntervalToken=null)},resetQueuePostIntervals:function(){for(var e in wi.eventQueues)wi.resetTopicPostInterval(e)},setQueuePostIntervals:function(){var e=[],setTopicPostIntervalFn=function(e){return function(t){wi.setTopicPostInterval(e,t)}};for(var t in wi.eventQueues){var r=wi.eventQueues[t][gi],n=wi.eventQueues[t].topicConfig;if(r&&r.length){var i=n.value("postFrequency").then(setTopicPostIntervalFn(n));e.push(i)}}return Promise.all(e)},objectContainsValue:function(e,t){var r=!1;for(var n in e){var i=e[n];if(e.hasOwnProperty(n)&&!Hn.isFunction(i)&&i===t){r=!0;break}}return r},setProperties:function(e,t){wi.eventQueues=wi.eventQueues||{},wi.eventQueues[e]=wi.eventQueues[e]||{},wi.eventQueues[e][Ei]=t}};function _utQueue(){return wi}function enrichAndSerializeEvents(e){var t=null;if(e&&e.length){var r={};r.deliveryVersion=bi,r.postTime=Date.now(),r[gi]=e;try{t=JSON.stringify(r)}catch(n){_logger().error("Error stringifying events as JSON: "+n)}}return t}function metricsUrlForConfig(e){return e.value("metricsUrl").then((function(t){return t+"/"+Ti+"/"+e.topic()}))}function resolveTopicConfigWithCallback(e,t){if(Hn.isFunction(t)){if(Hn.isString(e.metricsUrl)&&!Hn.isFunction(e.value)){var r=Hn.isFunction(e.topic)?e.topic():e.topic,n=e.metricsUrl+"/"+Ti+"/"+r,i=e.requestTimeout||mi,o=e.postFrequency;return t({requestTimeout:Math.min(i,o),metricsUrl:n})}return Promise.all([e.value("requestTimeout"),e.value("postFrequency"),metricsUrlForConfig(e)]).then((function(e){var r=e[0]||mi,n=e[1],i=e[2];return t({requestTimeout:Math.min(r,n),metricsUrl:i})}))}_logger().warn("No callback function is provided for resolveTopicConfigWithCallback()")}function requestTimeoutForConfig(e){return Promise.all([e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var t=e[0]||mi,r=e[1];return Math.min(t,r)}))}function flushUnreportedEvents(e,t){return e?t===fi.BEACON_SYNCHRONOUS?function(){for(var e in wi.eventQueues){var t=wi.eventQueues[e].flushConfig,r=Hn.extend({},t,{_topic:e,topic:function(){return this._topic}});wi.sendEventsViaBeacon(r)}}():Hn.isString(t)&&wi.objectContainsValue(fi,t)?wi.sendEvents(t,!0):Hn.isFunction(navigator.sendBeacon)?wi.sendEvents(ki.BEACON,!0):_isIOS()?wi.sendEvents(ki.AJAX_SYNCHRONOUS,!0):wi.sendEvents(ki.IMAGE,!0):wi.sendEvents(ki.AJAX,!0)}var QueuedEventRecorder=function(e){Base$3.apply(this,arguments)};(QueuedEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=QueuedEventRecorder,QueuedEventRecorder.prototype._utResetQueue=function(){for(var e in _utQueue().eventQueues)_utQueue().resetTopicPostInterval(e);_utQueue().eventQueues={}},QueuedEventRecorder.prototype._record=function(e,t,r){return function(e,t,r){var n=e.topic();return e.disabled().then((function(i){if(!i)return e.value("postFrequency").then((function(n){return 0===n&&(r=!0),wi.enqueueEvent(e,t).then((function(){return n}))})).then((function(t){if(r)return wi.sendEvents(ki.AJAX,!0);!wi.eventQueues[n].postIntervalToken&&wi.postIntervalEnabled&&wi.setTopicPostInterval(e,t)}))}))}(e,t,r)},QueuedEventRecorder.prototype.SEND_METHOD=fi,QueuedEventRecorder.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},QueuedEventRecorder.prototype.flushUnreportedEvents=function(e,t){return flushUnreportedEvents.apply(null,arguments)},QueuedEventRecorder.prototype.setProperties=function(e,t){Object.getPrototypeOf(QueuedEventRecorder.prototype).setProperties.call(this,e,t),_utQueue().setProperties(e,t)},QueuedEventRecorder.prototype.cleanup=function(){Object.getPrototypeOf(QueuedEventRecorder.prototype).cleanup.call(this),this._utResetQueue()};var ImmediateEventRecorder=function(e){Base$3.apply(this,arguments)};(ImmediateEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=ImmediateEventRecorder,ImmediateEventRecorder.prototype._record=function(e,t){var r=enrichAndSerializeEvents([t]);if(r)return Promise.all([metricsUrlForConfig(e),requestTimeoutForConfig(e)]).then(function(t){var n=t[0],i={timeout:t[1]};this._topicPropsCache[e.topic()]&&this._topicPropsCache[e.topic()].anonymous&&(i.withCredentials=!1),vi.makeAjaxRequest(n,"POST",r,null,null,i)}.bind(this))};var Ii=loggerNamed("mt-event-queue");function Environment$3(e){this._config=e}function EventRecorder$1(e){AbstractEventRecorder.call(this),this._proxyEventRecorder=e,this.SEND_METHOD=e.SEND_METHOD}Environment$3.prototype._document=function(){if("undefined"!=typeof document)return document;throw"metricskit-delegates-html.environment HTML delegate 'document' object not found"},Environment$3.prototype._window=function(){if("undefined"!=typeof window)return window;throw"metricskit-delegates-html.environment HTML delegate 'window' object not found"},Environment$3.prototype.browser=function(){var e=this._window().navigator.userAgent;return Hn.isDefinedNonNull(this._config)&&Hn.isDefinedNonNullNonEmpty(e)?this._config.value("browserMaps").then((function(t){if(!Hn.isDefinedNonNull(t))return null;for(var r=t.specifiedBrowsers||[],n=t.browserMap||{},i=null,o=0;o<r.length;o++){var a=r[o];if(e.indexOf(a)>-1){i=a;break}}if(!Hn.isDefinedNonNull(i)){var s=e.match(/Mozilla\/5.0 \((.*?)\)(\s|$)((.*?)\/(.*?)(\s)\(.*\))?(.*?)\/(.*?)(\s|$)/);Hn.isDefinedNonNullNonEmpty(s)&&s.length>=8&&(i=s[7])}return n[i=Hn.isDefinedNonNull(i)?i.trim():"unknown"]||i})):null},Environment$3.prototype.cookie=function(){return this._window().document.cookie},Environment$3.prototype.pageUrl=function(){return this._window().location.href},Environment$3.prototype.parentPageUrl=function(){var e,t=this._window(),r=t.parent;if(r!==t)try{e=r.location.href}catch(n){e=this._document().referrer}return e},Environment$3.prototype.pixelRatio=function(){return this._window().devicePixelRatio},Environment$3.prototype.screenHeight=function(){return this._window().screen.height},Environment$3.prototype.screenWidth=function(){return this._window().screen.width},Environment$3.prototype.userAgent=function(){return this._window().navigator.userAgent},Environment$3.prototype.windowInnerHeight=function(){return this._window().innerHeight},Environment$3.prototype.windowInnerWidth=function(){return this._window().innerWidth},Environment$3.prototype.windowOuterHeight=function(){return this._window().outerHeight},Environment$3.prototype.windowOuterWidth=function(){return this._window().outerWidth},Environment$3.prototype.timeOriginOffset=function(){var e=null,t=this._window().performance;return t&&t.timing&&(e=t.timing.navigationStart),e},Environment$3.prototype.app=function(){},Environment$3.prototype.appVersion=function(){},Environment$3.prototype.capacityData=function(){},Environment$3.prototype.capacityDataAvailable=function(){},Environment$3.prototype.capacityDisk=function(){},Environment$3.prototype.capacitySystem=function(){},Environment$3.prototype.capacitySystemAvailable=function(){},Environment$3.prototype.connectionType=function(){},Environment$3.prototype.dsId=function(){},Environment$3.prototype.hardwareBrand=function(){},Environment$3.prototype.hardwareFamily=function(){},Environment$3.prototype.hardwareModel=function(){},Environment$3.prototype.hostApp=function(){},Environment$3.prototype.hostAppVersion=function(){},Environment$3.prototype.os=function(){},Environment$3.prototype.osBuildNumber=function(){},Environment$3.prototype.osLanguages=function(){},Environment$3.prototype.osVersion=function(){},Environment$3.prototype.resourceRevNum=function(){},Environment$3.prototype.storeFrontCountryCode=function(){},Environment$3.prototype.storeFrontHeader=function(){},Environment$3.prototype.storeFrontLanguage=function(){},Environment$3.prototype.userType=function(){},EventRecorder$1.prototype=Object.create(AbstractEventRecorder.prototype),EventRecorder$1.prototype.constructor=EventRecorder$1,EventRecorder$1.prototype._recordEvent=function(e,t){return this._proxyEventRecorder.recordEvent.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.flushUnreportedEvents=function(e,t){var r=this,n=Array.prototype.slice.call(arguments);return Hn.isDefinedNonNull(this._proxyEventRecorder.SEND_METHOD)&&t===this._proxyEventRecorder.SEND_METHOD.BEACON_SYNCHRONOUS?this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments):this._operationPromiseChain.then((function(){return r._operationPromiseChain=Promise.resolve(),r._proxyEventRecorder.flushUnreportedEvents.apply(r._proxyEventRecorder,n)}))},EventRecorder$1.prototype._flushUnreportedEvents=function(){return this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.sendMethod=function(){return this._proxyEventRecorder.sendMethod.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.setProperties=function(e,t){return this._proxyEventRecorder.setProperties.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.cleanup=function(){return this._proxyEventRecorder.cleanup.apply(this._proxyEventRecorder,arguments)};var WebDelegates=function(e,t){var r=this.getOrCreateConfig(e);Delegates.call(this,e,{environment:new Environment$3(r),eventRecorder:new EventRecorder$1(new QueuedEventRecorder(r))}),this.immediateEventRecorder=new EventRecorder$1(new ImmediateEventRecorder(r)),this.network=null,this.logger=null,t&&(this.mergeDelegates(t),t.environment&&this.setEnvironment(t.environment),t.eventRecorder&&this.setEventRecorder(t.eventRecorder),t.network&&this.setNetwork(t.network),t.logger&&this.setLogger(t.logger),t.config&&(t.config.url&&this.config.setDelegate({configUrl:t.config.url}),this.setConfig(t.config)))};(WebDelegates.prototype=Object.create(Delegates.prototype)).constructor=WebDelegates,WebDelegates.prototype.setEnvironment=function(e){return yi.setDelegate(e),Delegates.prototype.setEnvironment.call(this,e)},WebDelegates.prototype.setNetwork=function(e){return e&&(this.network=e,vi.setDelegate(e)),this},WebDelegates.prototype.setLogger=function(e){return e&&(this.logger=e,Ii.setDelegate(e)),this},WebDelegates.prototype.setImmediateEventRecorder=function(e){if(e){var t=Object.create(this.immediateEventRecorder);Object.assign(t,e),this.immediateEventRecorder=t}return this},WebDelegates.prototype.configSources=function(){var e=this;return new Promise((function(t,r){var onFetchSuccess=function(r){try{var n=JSON.parse(r);e.config.setCachedSource(n),e.config.setServiceSource(n),t(n)}catch(xe){onFetchFailure(xe)}},onFetchFailure=function(t){e.config.setCachedSource(e.config.cachedSource()),r(t)};Promise.resolve(e.config.configUrl()).then((function(t){zn.exponentialBackoff(e.config.network.makeAjaxRequest.bind(e.config.network,t,"GET",null),onFetchSuccess,onFetchFailure)})).catch(onFetchFailure)}))};var Environment$2=function(){};Environment$2.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Environment$2.prototype.localStorageObject=oi.localStorageObject,Environment$2.prototype.sessionStorageObject=oi.sessionStorageObject,Environment$2.prototype.platformIdentifier=function(e,t,r){};var System$1=function(){this.environment=new Environment$2,this.logger=loggerNamed("mt-client-constraints")};function lookForKeyPath(e,t,r,n){return Hn.isDefined(e)&&Hn.isDefinedNonNullNonEmpty(t)&&Hn.isFunction(n)?function _lookForKeyPath(e,t,r,n,i,o,a){if(Hn.isFunction(e))return i||e;if(n.push(r),0===t.length)return a(e,r,n.slice(1).join("."),i),i||e;if(!Hn.isDefined(e))return i||e;var s=o?e:{},l=t.shift();if(l.length>2&&l.indexOf("[]")===l.length-2){l=l.slice(0,-2),n.push(l),Hn.extend(s,e);var c=s[l];if(Hn.isDefinedNonNull(c)){var d=c.map((function(e,r){var i=o?c:c.slice();return _lookForKeyPath(e,t.slice(),r,n,i,o,a),n.pop(),i[r]}));s[l]=d}}else{var u=e[l];Hn.extend(s,e),s=_lookForKeyPath(u,t,l,n,s,o,a)}return n.pop(),i?(i[r]=s,i):s}(e,t.split("."),null,[],null,r,n):e}var Ai={all:{initMatchValue:!0,accumulateMatchResult:function(e,t){return e&&t}},any:{initMatchValue:!1,accumulateMatchResult:function(e,t){return e||t}}};var Oi={nonEmpty:function(e,t){return!!Hn.isObject(t)&&t.hasOwnProperty(e)&&Hn.isDefinedNonNullNonEmpty(t[e])},valueMatches:function(e,t,r){if(!Hn.isObject(t))return!1;var n=t[e];return t.hasOwnProperty(e)&&r.indexOf(n)>-1},nonValueMatches:function(e,t,r){if(!Hn.isObject(t)||!Hn.isArray(r))return!1;var n=t[e];return t.hasOwnProperty(e)&&-1===r.indexOf(n)},nestedFieldMatches:function(e,t,r){if(!Hn.isObject(t)||!Hn.isObject(r))return!1;var n=r.matchType,i=r.matches;if(!Hn.isDefinedNonNullNonEmpty(i))return!1;var o=function(e){var t=Ai[e];return Hn.isDefinedNonNull(t)||(t=Ai.all),t}(n),a=o.initMatchValue;return lookForKeyPath(t,e,!1,(function(e,t,r,n){var s=Object.keys(i).every((function(e){var r=i[e];return!!Hn.isDefinedNonNull(Oi[e])&&Oi[e](t,n,r)}));a=o.accumulateMatchResult(a,s)})),!!a}},Ri="overrideFieldValue",Base$2=function(){};Base$2.prototype.constrainedValue=function(e,t,r){var n=e&&e.hasOwnProperty(r)?e[r]:null;return this.applyConstraintRules(n,t)},Base$2.prototype.applyConstraintRules=function(e,t){var r=e;t&&(t.denylisted||t.blacklisted?r=null:t.hasOwnProperty(Ri)&&(r=t.overrideFieldValue));return r};var $i=Xn.exceptionString,Base$1$1=function(e){this._constraintsInstance=e};function hostname(e){var t,r=withoutParams(e=e||"").split("/");return(t=-1===e.indexOf("//")?r[0]:r[2]).substring(t.indexOf("@")+1).split(":")[0]}function withoutParams(e,t){var r=(e||"").split("?"),n=r[0],i=function(e){return(e||"").split("#")[0]}(r[1]).split("&").filter((function(e){var r=e.split("="),n=r[0],i=r[1];return Hn.isArray(t)?-1!==t.indexOf(n):!!Hn.isObject(t)&&(Hn.isObject(t[n])&&Hn.isArray(t[n].allowedValues)&&-1!==t[n].allowedValues.indexOf(i))})).join("&");return i.length>0?n+"?"+i:n}Base$1$1.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},Base$1$1.prototype.constrainedValue=function(e,t,r,n){throw $i("field_actions.Base","constrainedValue")},Base$1$1.prototype.performAction=function(e,t,r,n){return Hn.isDefinedNonNull(n)&&!Hn.isEmptyObject(n)&&(e=this.constrainedValue(e,n,r,t)),e};function generateId(e){if(!Hn.isDefinedNonNull(e)||!Hn.isInteger(e.idVersion))return"0";var t=Xn.uuid(),r=e.generatedIdSeparator||"z";return(function(e){var t=[e.idVersion];e.time&&t.push(e.time);return t.map((function(e){return e.toString(16)})).join("-")}(e)+"-"+t||"").split("-").map((function(e){var t=parseInt(e,16);return Xn.convertNumberToBaseAlphabet(t,Xn.base61Alphabet)})).join(r)}function constrainedValue(e,t,r,n){var i=this.storageKey(n,r,t),o=this._constraintsInstance.system.environment,a=oi.objectFromStorage(o.localStorageObject(),i)||{};return a.value=this.idString(a,t),!this.rulesHaveLifespan(t)||Hn.isNumber(a.expirationTime)&&!this.timeExpired(a.expirationTime)||(a.expirationTime=this.expirationTime(t.lifespan)),oi.saveObjectToStorage(o.localStorageObject(),i,a),a.value}var Ci={};function constrainedValue$1(e,t,r,n){var i=this.storageKey(n,r,t),o=Ci[i];return o||(o=constrainedValue.apply(this,arguments),Ci[i]=o),o}var IdAction=function(){Base$1$1.apply(this,arguments)};(IdAction.prototype=Object.create(Base$1$1.prototype)).constructor=IdAction,IdAction.prototype.SCOPE_STRATEGIES={ALL:"all",MAIN_DOMAIN:"mainDomain"},IdAction.prototype.rulesHaveLifespan=function(e){return e=e||{},Hn.isNumber(e.lifespan)},IdAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},IdAction.prototype.storageKey=function(e,t,r){var n=this.scope(t,r);return this.storageKeyPrefix(r,e)+(n?"_"+n:"")},IdAction.prototype.storageKeyPrefix=function(e,t){return e&&Hn.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtId_"+t},IdAction.prototype.scope=function(e,t){var r,n,i,o,a,s="";if(t&&(t.namespace&&(s+=t.namespace),t.scopeStrategy)){var l;switch(t.scopeStrategy){case this.SCOPE_STRATEGIES.MAIN_DOMAIN:var c=t.scopeFieldName;r=e[c],n=hostname(r).split("."),i=n[n.length-1],o=n[n.length-2],a=2,i&&2===i.length&&o&&(2===o.length||o in{com:!0,org:!0,net:!0,edu:!0,gov:!0})&&(a=3),l=n.slice(-1*a).join(".")||"unknownDomain";break;case this.SCOPE_STRATEGIES.ALL:default:l=this.SCOPE_STRATEGIES.ALL}s.length&&(s+="_"),s+=l}return s},IdAction.prototype.idString=function(e,t){var r=e?e.value:null,n=r;return(!r||Hn.isNumber(e.expirationTime)&&this.timeExpired(e.expirationTime))&&(n=this.generateId(t)),n},IdAction.prototype.generateId=function(e){return e=e||{},generateId({idVersion:this.generatedIdVersion(),time:this.expirationTime(e.lifespan),generatedIdSeparator:this.generatedIdSeparator(e.tokenSeparator)})},IdAction.prototype.generatedIdVersion=function(){return 4},IdAction.prototype.idTokenSeparator=function(){return"-"},IdAction.prototype.generatedIdSeparator=function(e){return e||"z"},IdAction.prototype.timeExpired=function(e){return e<=Date.now()},IdAction.prototype.constrainedValue=function(e,t,r,n){return r&&t&&!Hn.isEmptyObject(t)&&(e=!0===t.persistIdForSession?constrainedValue$1.apply(this,arguments):constrainedValue.apply(this,arguments)),e};var ClientId=function(e,t){this._base=e,this._idAction=new IdAction(t),this._idAction.setDelegate({storageKey:function(e,t,r){return this.storageKeyPrefix()+"_"+this.scope(t,r)}.bind(this._idAction),storageKeyPrefix:function(){return"mtClientId"}})};ClientId.prototype.constrainedValue=function(e,t){var r=t;t&&Hn.isNumber(t.expirationPeriod)&&((r=Hn.extend({},t)).lifespan=r.expirationPeriod,delete r.expirationPeriod);var n=e?e.clientId:null,i=this._idAction.performAction(n,"clientId",e,r);return this._base.applyConstraintRules(i,t)};var UrlAction=function(){Base$1$1.apply(this,arguments)};(UrlAction.prototype=Object.create(Base$1$1.prototype)).constructor=UrlAction,UrlAction.prototype.SCOPES={HOSTNAME:"hostname",FULL:"full",FULL_WITHOUT_PARAMS:"fullWithoutParams",FULL_WITH_REPLACEMENTS:"fullWithReplacements"},UrlAction.prototype.constrainedValue=function(e,t){if(e&&t&&t.scope)switch(t.scope){case this.SCOPES.HOSTNAME:e=hostname(e);break;case this.SCOPES.FULL_WITHOUT_PARAMS:e=withoutParams(e,t.allowedParams);break;case this.SCOPES.FULL_WITH_REPLACEMENTS:e=function(e,t){var r=e||"";return(t||[]).reduce((function(e,t){var r=new RegExp(t.searchPattern,t.flags),n=t.replaceVal;return e.replace(r,n)}),r)}(e,t.replacements);break;case this.SCOPES.FULL:}return e};var ParentPageUrl=function(e){this._base=e,this._urlAction=new UrlAction};ParentPageUrl.prototype.constrainedValue=function(e,t){var r=e?e.parentPageUrl:null,n=this._urlAction.performAction(r,"parentPageUrl",e,t);return this._base.applyConstraintRules(n,t)};var FieldHandlers=function(e){this.base=new Base$2,this.clientId=new ClientId(this.base,e),this.parentPageUrl=new ParentPageUrl(this.base)},LegacyTreatment=function(e){this._fieldHandlers=new FieldHandlers(e)};function updateFieldRulesets(e,t,r,n){var i=e||{};if(n=n||function(e,t,r){return e[r]||{}},t&&t[r]){var o,a,s=i[r]||{};for(o in i[r]=s,t[r]){var l=n(s,t[r],o);for(a in s[o]=l,t[r][o])l[a]=t[r][o][a]}}return i}LegacyTreatment.prototype.applyConstraints=function(e,t){return t&&t.fieldConstraints&&(e=this.applyFieldConstraints(e,t.fieldConstraints)),e},LegacyTreatment.prototype.applyFieldConstraints=function(e,t){if(t){var r,n,i,o={};for(i in t)n=t[i],(e.hasOwnProperty(i)||!0===n.generateValue||n.hasOwnProperty(Ri))&&(r=i in this._fieldHandlers?this._fieldHandlers[i].constrainedValue(e,n):this._fieldHandlers.base.constrainedValue(e,n,i),o[i]=r);for(i in o)e[i]=o[i];e=ei.mergeAndCleanEventFields(e)}return e};var LegacyConstraintGenerator=function(e){this.treatment=new LegacyTreatment(e)};LegacyConstraintGenerator.prototype.constraintsForEvent=function(e,t,r){if(!t)return Promise.resolve(null);var n=this;return Promise.resolve(t.constraintProfile(r)).then((function(e){if(!e)return null;var n="constraints.profiles."+e;return t.value(n,r)})).then((function(t){var r=null;return t&&t.precedenceOrderedRules&&(r=t.precedenceOrderedRules.reduce((function(t,r){return n.eventMatchesRule(e,r)&&(t=n.updateRules(t,r)),t}),{})),r}))},LegacyConstraintGenerator.prototype.eventMatchesRule=function(e,t){var r=!1;return e&&t.filters&&("any"===t.filters?r=!0:Hn.isObject(t.filters)&&(r=this.eventMatchesNonEmptyFields(e,t.filters.nonEmptyFields)&&this.eventMatchesFieldValues(e,t.filters.valueMatches))),r},LegacyConstraintGenerator.prototype.eventMatchesNonEmptyFields=function(e,t){var r=!1;return e&&(r=!t||!Hn.isArray(t)||t.every((function(t){return Oi.nonEmpty(t,e)}))),r},LegacyConstraintGenerator.prototype.eventMatchesFieldValues=function(e,t){var r=!1;return e&&(r=!(t&&Hn.isObject(t)&&!Hn.isEmptyObject(t))||Object.keys(t).every((function(r){var n=t[r];return Oi.valueMatches(r,e,n)}))),r},LegacyConstraintGenerator.prototype.updateRules=function(e,t){return updateFieldRulesets(e,t,"fieldConstraints")};var DenylistedEventAction=function(){};DenylistedEventAction.prototype.performAction=function(e,t,r){return!0!==r?e:null};var DenylistedFieldsAction=function(){};DenylistedFieldsAction.prototype.performAction=function(e,t,r){return e&&Hn.isArray(r)&&!Hn.isEmptyArray(r)?(e=Hn.extend({},e),r.forEach((function(t){delete e[t]})),Hn.isEmptyObject(e)?null:e):e};var AllowlistedFieldsAction=function(){};AllowlistedFieldsAction.prototype.performAction=function(e,t,r){if(!e||!Hn.isArray(r)||Hn.isEmptyArray(r))return e;var n={};return r.forEach((function(t){Hn.isDefinedNonNull(e[t])&&(n[t]=e[t])})),Hn.isEmptyObject(n)?null:n};var SessionizationFieldsAction=function(e){this._constraintsInstance=e};SessionizationFieldsAction.prototype.performAction=function(e,t,r){if(!Hn.isDefinedNonNull(e)||!Hn.isDefined(r))return e;if(Hn.isDefinedNonNull(r.sessionResetOptions)){if(!Hn.isDefinedNonNull(r.sessionResetOptions.filters))throw new SyntaxError('sessionizationFields Action: unable to find the required config "filters"');if(!0!==this._resetSession(e,t,r))return e}e=Hn.extend({},e);var n=this._storageKey(e,r),i=this._constraintsInstance.system.environment,o=oi.objectFromStorage(i.localStorageObject(),n)||{};this._shouldCreateNewSession(t,o,r)&&(o.sessionId=this._generateSessionId(r),o.rawFirstEventTimeInSession=t.eventTime,o.firstEventTimeInSession=e.eventTime,o.eventCount=0),o.rawLastEventTimeInSession=t.eventTime,o.lastEventTimeInSession=e.eventTime,o.eventCount+=1,oi.saveObjectToStorage(i.localStorageObject(),n,o);var a=this._getSessionFieldNames(r);return e[a.sessionId]=o.sessionId,r.sessionStartTime&&(e[a.sessionStartTime]=o.firstEventTimeInSession),e},SessionizationFieldsAction.prototype._storageKey=function(e,t){var r=this._scope(e,t);return this._storageKeyPrefix(t)+(Hn.isEmptyString(r)?"":"_"+r)},SessionizationFieldsAction.prototype._storageKeyPrefix=function(e){return e&&Hn.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtSessionization"},SessionizationFieldsAction.prototype._scope=function(e,t){var r="";return Hn.isDefined(t)&&(Hn.isString(t.namespace)&&(r+=t.namespace),Hn.isString(t.scopeFieldName)&&Hn.isDefinedNonNull(e[t.scopeFieldName])&&(r+="_",r+=e[t.scopeFieldName].toString())),r},SessionizationFieldsAction.prototype._generateSessionId=function(e){return generateId({idVersion:1,time:Date.now(),idTokenSeparator:"-",generatedIdSeparator:e.tokenSeparator})},SessionizationFieldsAction.prototype._shouldCreateNewSession=function(e,t,r){var n=!1;return n|=!Hn.isDefinedNonNull(t.sessionId),Hn.isDefinedNonNull(r.endSessionConditions)&&(Hn.isDefinedNonNull(r.endSessionConditions.lifespan)&&(n|=e.eventTime>=t.rawFirstEventTimeInSession+r.endSessionConditions.lifespan),Hn.isDefinedNonNull(r.endSessionConditions.idleSpan)&&(n|=e.eventTime>=t.rawLastEventTimeInSession+r.endSessionConditions.idleSpan),Hn.isDefinedNonNull(r.endSessionConditions.eventCount)&&(n|=t.eventCount>=r.endSessionConditions.eventCount)),n},SessionizationFieldsAction.prototype._resetSession=function(e,t,r){var n=r.sessionResetOptions,i=this._constraintsInstance._constraintGenerator;if(Hn.isDefinedNonNull(i)&&Hn.isDefinedNonNull(i.eventMatchesTreatment)&&i.eventMatchesTreatment(t,n)){var o=this._storageKey(e,r),a=this._constraintsInstance.system.environment;return oi.saveObjectToStorage(a.localStorageObject(),o,void 0),n.newSessionAfterReset}return!0},SessionizationFieldsAction.prototype._getSessionFieldNames=function(e){var t={sessionId:"sessionId",sessionStartTime:"sessionStartTime"};return Hn.isDefinedNonNull(e.sessionFields)&&(Hn.isDefinedNonNullNonEmpty(e.sessionFields.sessionId)&&(t.sessionId=e.sessionFields.sessionId),Hn.isDefinedNonNullNonEmpty(e.sessionFields.sessionStartTime)&&(t.sessionStartTime=e.sessionFields.sessionStartTime)),t};var ClampingEventAction=function(){};ClampingEventAction.prototype.performAction=function(e,t,r){if(!(e&&r&&Hn.isString(r.timeReference)&&Hn.isNumber(r.bucketInterval)&&Hn.isArray(r.fields)))return e;var n=e[r.timeReference];if(!Hn.isNumber(n))return e;var i=this._clampToBoundary(n,r.bucketInterval),o=i-n;return e[r.timeReference]=i,r.fields.forEach((function(t){var r=e[t];Hn.isNumber(r)&&(e[t]+=o)})),e},ClampingEventAction.prototype._clampToBoundary=function(e,t){var r=e%t,n=e-r;return r<=t/2?n:n+t};var Mi="blacklisted",Di="denylisted",xi="blacklistedFields",Li="denylistedFields",Ni="whitelistedFields",Ui="allowlistedFields",ji="sessionizationFields",Ki="clamping",EventActions=function(e){var t=new DenylistedEventAction,r=new DenylistedFieldsAction,n=new AllowlistedFieldsAction,i=new SessionizationFieldsAction(e),o=new ClampingEventAction;this._actions={},this._actions[Mi]=t,this._actions[Di]=t,this._actions[xi]=r,this._actions[Li]=r,this._actions[Ni]=n,this._actions[Ui]=n,this._actions[ji]=i,this._actions[Ki]=o};EventActions.prototype.getAction=function(e){return this._actions[e]};var NumberAction=function(){Base$1$1.apply(this,arguments)};(NumberAction.prototype=Object.create(Base$1$1.prototype)).constructor=NumberAction,NumberAction.prototype.constrainedValue=function(e,t){var r=t?t.precision:0,n=t?t.buckets:null;if(Hn.isDefinedNonNullNonEmpty(n)){var i=(n=n.slice().sort((function(e,t){return e.start-t.start})))[function(e,t){var r=-1;if(!Hn.isDefinedNonNull(t)||0===e.length||Hn.isDefinedNonNull(e[0])&&t<e[0].start)return-1;if(e[e.length-1].start<t)r=e.length-1;else for(var n=0;n<e.length;n++){var i=e[n].start;if(i===t){r=n;break}if(i>t){r=n-1;break}}return r}(n,e)];Hn.isDefinedNonNull(i)&&(e=i.value)}else Hn.isNumber(e)&&Hn.isNumber(r)&&r>0&&(e=Math.floor(e/r)*r);return e};var SerialNumberGenerator=function(e){e=e||{},this._nextRotationTime=e.nextRotationTime||Number.POSITIVE_INFINITY,this._storageKey=e.namespace||"mt_serial_number",this._initialSerialNumber=e.initialSerialNumber||0,this._rotationPeriod=e.rotationPeriod||Number.POSITIVE_INFINITY};SerialNumberGenerator.prototype.setDelegate=function(e){Hn.attachDelegate(this,e)},SerialNumberGenerator.prototype.localStorageObject=function(){return oi.localStorageObject()},SerialNumberGenerator.prototype.getNextSerialNumber=function(e){var t=this._storageKey,r=this._getCurrentSerialNumberData(t),n=r.sn;return e=Hn.isNumber(e)?e:1,n=parseInt(n,10),isNaN(n)&&(n=this._initialSerialNumber),n=this._increaseSerialNumber(n,e),r.sn=n,oi.saveObjectToStorage(this.localStorageObject(),this._storageKey,r),n},SerialNumberGenerator.prototype.resetSerialNumber=function(){var e=oi.objectFromStorage(this.localStorageObject(),this._storageKey);Hn.isDefinedNonNull(e)&&this._resetSerialNumber(e.exp)},SerialNumberGenerator.prototype.getTime=function(){return Date.now()},SerialNumberGenerator.prototype._increaseSerialNumber=function(e,t){return e+t},SerialNumberGenerator.prototype._getCurrentSerialNumberData=function(e){var t,r,n=oi.objectFromStorage(this.localStorageObject(),e);for(n?(t=n.exp,t=parseInt(t,10),n.exp=t=isNaN(t)?this._nextRotationTime:t):t=this._nextRotationTime-this._rotationPeriod;!n||this.getTime()>=t;)t=r=t+this._rotationPeriod,n=this._resetSerialNumber(r);return n},SerialNumberGenerator.prototype._resetSerialNumber=function(e){var t={};return t.exp=e,t.sn=this._initialSerialNumber,oi.saveObjectToStorage(this.localStorageObject(),this._storageKey,t),t};var TimeAction=function(){Base$1$1.apply(this,arguments),this._storage=this._constraintsInstance.system.environment.localStorageObject(),this._precisionEndTimeCache={},this._serialNumberGenerator=null};(TimeAction.prototype=Object.create(Base$1$1.prototype)).constructor=TimeAction,TimeAction.prototype.constrainedValue=function(e,t,r,n){var i=e;if(Hn.isNumber(e)&&Hn.isObject(t)&&Hn.isNumber(t.precision)&&t.precision>0){var o=this._computePrecisionStartTime(e,t);this._serialNumberGenerator=new SerialNumberGenerator({namespace:this._persistentStorageKey(t,n),nextRotationTime:o+t.precision,rotationPeriod:t.precision}),this._serialNumberGenerator.setDelegate(this._constraintsInstance.system.environment),this._serialNumberGenerator.setDelegate({getTime:function(){return e}});var a=this._serialNumberGenerator.getNextSerialNumber();i=this._computeTimestamp(o,a),this._serialNumberGenerator=null}return i},TimeAction.prototype._computeTimestamp=function(e,t){return e+t},TimeAction.prototype._persistentStorageKey=function(e,t){var r=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtTimestamp")+r+"_"+t},TimeAction.prototype._computePrecisionStartTime=function(e,t){var r=t.precision;return Math.floor(e/r)*r};var HashAction=function(){Base$1$1.apply(this,arguments)};function buildSaltStorageKey(e,t){var r=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtHash")+r+"_salt_"+t}(HashAction.prototype=Object.create(Base$1$1.prototype)).constructor=HashAction,HashAction.prototype.constrainedValue=function(e,t,r,n){return Hn.isDefinedNonNullNonEmpty(e)?this._loadPlatformBasedSalt(t,n).then((function(t){return function(e,t){return[e,t].map((function(e){var t=0;if(Hn.isDefinedNonNullNonEmpty(e))for(var r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r)}var n=Math.abs(t);return n=parseInt(n,16),Xn.convertNumberToBaseAlphabet(n,Xn.base62Alphabet)})).join("")}(e,t)})):e},HashAction.prototype.timeExpired=function(e){return!!e&&e<=Date.now()},HashAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},HashAction.prototype._loadPlatformBasedSalt=function(e,t){var r=null,n=this,i=e.platformBasedSalt;return Hn.isDefinedNonNull(i)?(r=this._constraintsInstance.system.environment.platformIdentifier(i.saltNamespace,"userid",i.crossDeviceSync||!0),r=Hn.isDefinedNonNull(r)?r.then((function(r){return Hn.isDefinedNonNull(r)||(n._constraintsInstance.system.logger.warn("Hash: platform returned an empty salt. Will use default salt generator to generate the salt."),r=n._getSalt(e,t)),r})):Promise.resolve(this._getSalt(e,t))):r=Promise.resolve(this._getSalt(e,t)),r},HashAction.prototype._getSalt=function(e,t){var r=this._retrieveSaltFromStorage(e,t),n=e.saltLifespan;if(!Hn.isDefinedNonNull(r)||this.timeExpired(r.expirationTime)){var i=this._constraintsInstance.system.environment.localStorageObject();r={salt:function(){for(var e="";e.length<10;)e+=Xn.randomHexCharacter();return e}(),expirationTime:this.expirationTime(n)},oi.saveObjectToStorage(i,buildSaltStorageKey(e,t),r)}return r.salt},HashAction.prototype._retrieveSaltFromStorage=function(e,t){var r=this._constraintsInstance.system.environment.localStorageObject();return oi.objectFromStorage(r,buildSaltStorageKey(e,t))};var Fi="idGenerator",Bi="numberDeres",Vi="timeDeres",qi="urlDeres",Gi="hash",FieldActions=function(e){this.actions={},this.actions[Fi]=new IdAction(e),this.actions[Bi]=new NumberAction(e),this.actions[Vi]=new TimeAction(e),this.actions[qi]=new UrlAction(e),this.actions[Gi]=new HashAction(e)};FieldActions.prototype.getAction=function(e){return this.actions[e]};var ActionTreatment=function(e){this._eventActions=new EventActions(e),this._fieldActions=new FieldActions(e)};ActionTreatment.prototype.applyConstraints=function(e,t){var r=e;if(t&&!Hn.isEmptyObject(t)){var n=[],i=this;if(t.fieldActions&&!Hn.isEmptyObject(t.fieldActions)){var o=!1,a=r;a=Object.keys(t.fieldActions).reduce((function(e,s){var l=t.fieldActions[s];if(l){var c=l.denylisted||l.blacklisted,d=l.treatmentType,u=i._fieldActions.getAction(d);e=lookForKeyPath(e,s,!1,(function(e,t,i,d){if(c)delete d[t],o=!0;else if(l.hasOwnProperty(Ri))d[t]=l[Ri],o=!0;else if(u){var p=u.performAction(e,s,r,l);d[t]=p,p instanceof Promise&&n.push(p.then((function(e){lookForKeyPath(a,s,!0,(function(t,r,n,o){n===i&&(o[r]=e)}))}))),o=!0}}))}return e}),a),o&&(r=n.length>0?Promise.all(n).then((function(){return a})):a)}if(t.eventActions&&!Hn.isEmptyObject(t.eventActions)){var s=Object.keys(t.eventActions),processEventActions=function(r){return s.forEach((function(n){var o=i._eventActions.getAction(n);if(o){var a=t.eventActions[n];r=o.performAction(r,e,a)}})),r};r=r instanceof Promise?Promise.resolve(r).then((function(e){return processEventActions(e)})):processEventActions(r)}}return r};function _updateTreatment(e,t){var r=e||{};return function(e,t){e.eventActions||(e.eventActions={});var r=e.eventActions,n=t.eventActions;n&&Object.keys(n).reduce((function(e,t){var r=e[t],i=n[t];return Hn.isArray(r)?Hn.isArray(i)&&i.forEach((function(e){-1===r.indexOf(e)&&r.push(e)})):Hn.isArray(i)?e[t]=i.slice():(Hn.isObject(i)||!Hn.isObject(i)&&!Hn.isFunction(i))&&(e[t]=i),e}),r)}(r,t),function(e,t){e.fieldActions||(e.fieldActions={});updateFieldRulesets(e,t,"fieldActions",(function(e,t,r){return e[r]&&e[r].treatmentType===t[r].treatmentType?e[r]:{}}))}(r,t),r}var TreatmentGenerator=function(e){this._constraintsInstance=e,this.treatment=new ActionTreatment(e)};TreatmentGenerator.prototype._combineTreatments=function(e,t,r){var n,i=[];return Hn.isArray(e)?(e.forEach((function(e){if(e){var n="treatmentProfiles."+e,o=t.value(n,r).then((function(e){return e&&e.treatments?e.treatments:[]}));i.push(o)}})),n=Promise.all(i).then((function(e){var t=[];return e.forEach((function(e){t=t.concat(e)})),t}))):n=Promise.resolve([]),n},TreatmentGenerator.prototype.constraintsForEvent=function(e,t,r){if(!t)return Promise.resolve(null);var n=this;return Promise.resolve(t.constraintProfiles(r)).then((function(e){return Hn.isDefinedNonNull(e)?e:Promise.resolve(t.constraintProfile(r)).then((function(e){return Hn.isDefinedNonNull(e)?[e]:null}))})).then((function(e){if(Hn.isDefinedNonNull(e)){if(!Hn.isArray(e))throw new TypeError('"constraintProfiles" should be an Array, but got: '+(e?e.constructor:e));return n._combineTreatments(e,t,r).then((function(t){if(0===t.length)throw new SyntaxError("The constraintProfiles: "+e.join(", ")+" are not found in the topic config");return t}))}return Promise.resolve([])})).then((function(t){return t.reduce((function(t,r){return n.eventMatchesTreatment(e,r)&&(t=_updateTreatment(t,r)),t}),null)}))},TreatmentGenerator.prototype.eventMatchesTreatment=function(e,t){var r=t.filters;if(!Hn.isDefinedNonNull(r))return!0;if(Hn.isString(r))return"any"===r;if(0===Object.keys(r).length)throw new SyntaxError("Unable to find the filter in \n"+JSON.stringify(t));return Object.keys(r).every((function(n){var i=r[n];if(i&&Hn.isString(i))return!1;if(!i||!Hn.isObject(i)||Hn.isEmptyObject(i))throw new SyntaxError("Invalid filter object for field ("+n+") in \n"+JSON.stringify(t));return Object.keys(i).every((function(r){var o=i[r];if(Oi[r])return Oi[r](n,e,o);throw new SyntaxError("Unable to find the filter ("+r+") for field ("+n+")in \n"+JSON.stringify(t))}))}))};var Hi={constraintProfile:function(e){return this.value("constraints.defaultProfile",e)},constraintProfiles:function(e){return this.value("defaultTreatmentProfiles",e)}};var Constraints=function(e,t){if(r=e,n=!0,(n&=Hn.isDefinedNonNull(r))&&(n&=!Hn.isEmptyObject(r),n&=Hn.isFunction(r.initialized),n&=Hn.isFunction(r.value),n&=Hn.isFunction(r.constraintProfile)),!n)throw new Error('The topic config is not a valid instance of "mt-client-config".');var r,n;this._isInitialized=!1,this._topicConfig=e,this._constraintGenerator=null,this.system=new System$1,Hn.setDelegates(this.system,t||{})};Constraints.prototype._getConstraintGenerator=function(){var e=this;return this._constraintGenerator?Promise.resolve(this._constraintGenerator):this._topicConfig.value("treatmentProfiles").then((function(t){return Hn.isDefinedNonNull(t)?e._constraintGenerator=new TreatmentGenerator(e):e._constraintGenerator=new LegacyConstraintGenerator(e),e._constraintGenerator}))},Constraints.prototype.constraintsForEvent=function(e,t){var r=this;return this._getConstraintGenerator().then((function(n){return n.constraintsForEvent(e,r._topicConfig,t)}))},Constraints.prototype.applyConstraintTreatments=function(e,t){var r=t?Promise.resolve(t):this.constraintsForEvent(e),n=this;return Promise.all([r,this._getConstraintGenerator()]).then((function(t){var r=t[0];return t[1].treatment.applyConstraints(e,r)})).catch((function(e){return n.system.logger.warn("An error occurred while applying constraints: "+e.message||e),null}))};var Wi,zi,Yi=Constraints;function environmentBaseFieldNames(){return zi||(zi=["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].concat(["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"])),zi}var Qi,Ji=Hn.attachDelegate,Xi=Xn.cryptoRandomBase62String,Zi=Xn.exceptionString;function Base$1(e){if(!Hn.isDefinedNonNull(e))throw new Error("A processor instance is required for creating BaseEventHandler.");this._processor=e,Qi||(Qi=!0,environmentBaseFieldNames().forEach((function(e){Base$1.prototype[e]=function(t){return t&&t.hasOwnProperty(e)?t[e]:this.environment()[e]()}})))}Base$1._className="eventHandlers.base",Base$1.prototype.setDelegate=function(e){return Ji(this,e)},Base$1.prototype.environment=function(){throw Zi(Base$1._className,"environment")},Base$1.prototype.eventRecorder=function(){throw Zi(Base$1._className,"eventRecorder")},Base$1.prototype.metricsData=function(){throw Zi(Base$1._className,"metricsData")},Base$1.prototype.processMetricsData=function(){throw Zi(Base$1._className,"processMetricsData")},Base$1.prototype.knownFields=function(){return Wi||(Wi=environmentBaseFieldNames().concat(["baseVersion","clientEventId","connection","eventTime","eventType","eventVersion","timezoneOffset","xpPostFrequency","xpSendMethod"])),Wi},Base$1.prototype.baseVersion=function(){return 1},Base$1.prototype.clientEventId=function(e){return e&&e.clientEventId||Xi(!0)},Base$1.prototype.connection=function(e){return e&&e.connection||this.environment().connectionType()},Base$1.prototype.dsId=function(e){return e&&e.dsId||this.environment().dsId()},Base$1.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},Base$1.prototype.eventVersion=function(e){return e&&e.eventVersion||null},Base$1.prototype.timezoneOffset=function(e){return e&&e.timezoneOffset||(new Date).getTimezoneOffset()},Base$1.prototype.xpPostFrequency=function(e){return e&&e.xpPostFrequency||this._processor.config.value("postFrequency")},Base$1.prototype.xpSendMethod=function(e){return e&&e.xpSendMethod||this.eventRecorder().sendMethod()};var eo,to=Base$1,ro=Hn.attachDelegate,no=Xn.exceptionString,io=oi.localStorageObject,oo=oi.sessionStorageObject;function Environment$1(){eo||(eo=!0,["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].forEach((function(e){Environment$1.prototype[e]=function(){throw no(Environment$1._className,e)}})),["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"].forEach((function(e){Environment$1.prototype[e]=function(){}})))}Environment$1._className="system.environment",Environment$1.prototype.setDelegate=function(e){return ro(this,e)},Environment$1.prototype.connectionType=function(){throw no(Environment$1._className,"connectionType")},Environment$1.prototype.dsId=function(){},Environment$1.prototype.localStorageObject=io,Environment$1.prototype.sessionStorageObject=oo,Environment$1.prototype.platformIdentifier=function(){};var ao=Environment$1;function MetricsData$2(){this._eventData={}}MetricsData$2.prototype.updateData=function(){Hn.extend.apply(null,[this._eventData].concat(Array.prototype.slice.call(arguments)))};var so=MetricsData$2,lo=ao;function PlayActivityEnvironment(){lo.apply(this,arguments)}PlayActivityEnvironment.prototype=Object.create(lo.prototype),PlayActivityEnvironment.prototype.constructor=PlayActivityEnvironment,PlayActivityEnvironment.prototype.consumerId=function(){},PlayActivityEnvironment.prototype.consumerNs=function(){},PlayActivityEnvironment.prototype.isOffline=function(){},PlayActivityEnvironment.prototype.videoViewportHeight=function(){},PlayActivityEnvironment.prototype.videoViewportWidth=function(){};var co=Hn.attachDelegate,uo=Xn.exceptionString,po="PlayActivityProcessor.system.eventRecorder",EventRecorder=function(){};EventRecorder.prototype.setDelegate=function(e){return co(this,e)},EventRecorder.prototype.recordEvent=function(e,t){throw uo(po,"recordEvent")},EventRecorder.prototype.sendMethod=function(){throw uo(po,"sendMethod")},EventRecorder.prototype.flushUnreportedEvents=function(e){};var ho=loggerNamed("mt-metricskit-processor-play-activity"),System=function(){this.environment=new PlayActivityEnvironment,this.eventRecorder=new EventRecorder,this.logger=ho},EventFields=function(e){this._processor=e};EventFields.prototype.applyFieldsMap=function(e,t){return this._processor.config.value("fieldsMap").then((function(r){return ei.applyFieldsMap(e,t,r)}))};var Utils=function(e){this.eventFields=new EventFields(e)},yo="unknown",fo="next",_o="previous",vo="location",mo="interval",go="playhead",bo="scrub",So="transition",Po="interruption",ko="buffering",To="play",Eo="seek",wo="playOther",Io="skipIntro",Ao="skipToLive",Oo="actionType",Ro="consumerId",$o="consumerNs",Co="dsId",Mo="eventType",Do="eventVersion",xo="isOffline",Lo="videoViewportHeight",No="videoViewportWidth",Uo={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:yo},ASSET_PLACEMENT:{PRE_ROLL:"preroll",POST_ROLL:"postroll",MID_ROLL:"midroll",FEATURE:"feature",CATCH_UP_TO_LIVE:"catchUpToLive"},PLAY_START_REASON:{PLAY:To,PLAY_OTHER:wo,UNPAUSE:"unpause",NEXT:fo,PREVIOUS:_o,SEEK:Eo,TRANSITION:So,INTERRUPTION:Po,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:ko,UNKNOWN:yo,SKIP_TO_LIVE:Ao},PLAY_START_REASON_TYPE:{SKIP_INTRO:Io,SKIP_TO_LIVE:Ao},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:So,PLAY_OTHER:wo,PAUSE:"pause",SEEK:Eo,NEXT:fo,INTERRUPTION:Po,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:ko,ERROR:"error",FAILURE:"failure",UNKNOWN:yo,CLOSE_PLAYER:"closePlayer",SKIP_TO_LIVE:Ao},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:Io,SKIP_TO_LIVE:Ao},SEEK_START_REASON:{NEXT:fo,PREVIOUS:_o,LOCATION:vo,INTERVAL:mo,PLAYHEAD:go,SCRUB:bo,UNKNOWN:yo,SKIP_INTRO:Io},SEEK_STOP_REASON:{NEXT:fo,PREVIOUS:_o,LOCATION:vo,INTERVAL:mo,PLAYHEAD:go,SCRUB:bo,UNKNOWN:yo,SEEK:Eo,SKIP_INTRO:Io},SEEK_STOP_REASON_TYPE:{SKIP_INTRO:Io}},jo={ACTIVITY_TYPE:{PLAY:To,SEEK:Eo},ACTION_TYPE:{START:"start",STOP:"stop"},EVENT_TYPE:{PLAY_ACTIVITY:"playActivity",SEEK_ACTIVITY:"seekActivity"}},Ko={INCLUDES_START_POSITIONS:"includesStartPositions",INCLUDES_END_POSITIONS:"includesEndPositions"},MediaActivity=function(e,t){this._processor=e,this._activityType=t,this._startMetricsDataPromise=Promise.resolve(null),this._isStopped=!1};MediaActivity.ACTIVITY_TYPE=jo.ACTIVITY_TYPE,Object.defineProperties(MediaActivity.prototype,{isStopped:{get:function(){return this._isStopped}},type:{get:function(){return this._activityType}},startOverallPosition:{get:function(){return this._startMetricsDataPromise?this._startMetricsDataPromise.then((function(e){return e.overallPosition})):Promise.resolve(null)}}}),Hn.extend(MediaActivity.prototype,Uo),MediaActivity.prototype.started=function(e,t,r,n){var i=this._startEventHandler(),o=this;if(i){if(this._startMetricsDataPromise=i.metricsData.apply(i,arguments),this.type!=MediaActivity.ACTIVITY_TYPE.SEEK)return this._processor.system.eventRecorder.recordEvent(this._processor.config.topic(),this._startMetricsDataPromise)}else o._processor.system.logger.error('Failed to record the start event with activityType: "'+r+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"');return Promise.resolve(null)},MediaActivity.prototype.stopped=function(e,t,r,n){var i=Array.prototype.slice.call(arguments),o=this._stopEventHandler(),a=this;if(o){this._isStopped=!0;var s=this._startMetricsDataPromise.then((function(a){var s=[e,t,r,n,a].concat(Array.prototype.slice.call(i,4));return o.metricsData.apply(o,s)}));return a._processor.system.eventRecorder.recordEvent(a._processor.config.topic(),s)}return a._processor.system.logger.error('Failed to record the stop event with activityType: "'+r+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"'),Promise.resolve(null)},MediaActivity.prototype._startEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStart;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStart}return e},MediaActivity.prototype._stopEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStop;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStop}return e};var Fo=Hn.isInteger,TimeTracker=function(e,t,r){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e,this._logger=r};Object.defineProperties(TimeTracker.prototype,{playbackRate:{get:function(){return this._playbackRate}}}),TimeTracker.prototype.update=function(e,t){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e},TimeTracker.prototype.estimatedTime=function(e){var t;Fo(e)?t=e:(this._logger.error("VPAFKit error: position should be an integer"),t=Math.round(e));var r=(t-this._position)/(0==this.playbackRate?1:this.playbackRate);return this._date.getTime()+Math.round(r)},TimeTracker.prototype._validatePlaybackRate=function(e){0==e&&this._logger.error("VPAFKit error: playbackRate should not be zero.")};var Bo=Hn.attachDelegate,Vo=Hn.extend,qo=Hn.isFunction,Go=Hn.isNumber,Ho=so,Wo=Ko.INCLUDES_START_POSITIONS,zo=Ko.INCLUDES_END_POSITIONS,MediaActivityTracker=function(e,t){Ho.apply(this,arguments),this._processor=e,this._playlist=t,this._playActivity=null,this._playStartPlaylistItem=null,this._seekActivity=null,this._timeTracker=null,this._shouldGenerateTransitions=!0};(MediaActivityTracker.prototype=Object.create(Ho.prototype)).constructor=MediaActivityTracker,Vo(MediaActivityTracker.prototype,Uo),Object.defineProperties(MediaActivityTracker.prototype,{shouldGenerateTransitions:{get:function(){return this._shouldGenerateTransitions},set:function(e){this._shouldGenerateTransitions=e}}}),MediaActivityTracker.prototype.setDelegate=function(e){return Bo(this,e)},MediaActivityTracker.prototype.playStarted=function(e,t,r){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},MediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,t,r,n){var i=Promise.resolve(),o=this;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var a=this._playlistItem(t,Wo);a?i=this._playStarted.apply(this,[a].concat(Array.prototype.slice.call(arguments,1))).then((function(){o.shouldGenerateTransitions&&(o._timeTracker=new TimeTracker(e,t,o._processor.system.logger))})).catch((function(e){o._error(e)})):this._error('Failed to record play start event due to no active playlist item for the overall position "'+t+'".')}return i},MediaActivityTracker.prototype.playStopped=function(e,t,r){var n=this._generatePlaylistTransitionsIfNecessary(e),i=this,o=Array.prototype.slice.call(arguments);return this._hasUnstoppedActivity(this._playActivity)?n=n.then((function(){var e=i._playStopped.apply(i,Array.prototype.slice.call(o));return i._playStartPlaylistItem=null,i._timeTracker=null,e})).catch((function(e){i._error(e)})):this._error("inconsistent state: did you forget to call playStarted?"),n},MediaActivityTracker.prototype.playTransitioned=function(e){var t=this,r=Array.prototype.slice.call(arguments,1);return this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION].concat(r)).then((function(){return t.playStarted.apply(t,[e,t.TYPE.AUTOMATIC,t.PLAY_START_REASON.TRANSITION].concat(r))})).catch((function(e){t._error(e)}))},MediaActivityTracker.prototype.seekStarted=function(e,t,r){var n=Promise.resolve();if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var i=this._playlistItem(e,Wo);if(i){var o=this._activityArguments.apply(this,[i].concat(Array.prototype.slice.call(arguments)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var a=this;n=this._seekActivity.started.apply(this._seekActivity,o).catch((function(e){a._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the overall position "'+e+'".')}return n},MediaActivityTracker.prototype.seekStopped=function(e,t,r){var n=Promise.resolve(),i=this._playlistItem(e,zo);if(i&&this._hasUnstoppedActivity(this._seekActivity)){var o=this._activityArguments.apply(this,[i].concat(Array.prototype.slice.call(arguments))),a=this;n=this._seekActivity.stopped.apply(this._seekActivity,o).catch((function(e){a._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return n},MediaActivityTracker.prototype.synchronize=function(e,t){if(this.shouldGenerateTransitions){var r=e>0,n=this._hasUnstoppedActivity(this._playActivity),i=Promise.resolve(),o=this;return n&&r?i=this._generatePlaylistTransitionsIfNecessary(t).then((function(){o._timeTracker.update(e,t)})).catch((function(e){o._error(e)})):n&&!r?this._error("inconsistent state: did you forget to call playStopped?"):!n&&r&&this._error("inconsistent state: did you forget to call playStarted?"),i}},MediaActivityTracker.prototype._playStarted=function(e,t,r,n){var i=this._activityArguments.apply(this,[e].concat(Array.prototype.slice.call(arguments,1)));return this._playStartPlaylistItem=e,this._playActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.PLAY),this._playActivity.started.apply(this._playActivity,i)},MediaActivityTracker.prototype._playStopped=function(e,t,r){var n=this._playStartPlaylistItem,i=this._activityArguments.apply(this,[n].concat(Array.prototype.slice.call(arguments)));return this._playActivity.stopped.apply(this._playActivity,i)},MediaActivityTracker.prototype._playlistItem=function(e,t){var r;return this._playlist&&qo(this._playlist.getItem)&&(r=this._playlist.getItem(e,t)),r||this._error("unable to get item from playlist"),r},MediaActivityTracker.prototype._playlistItems=function(e,t){var r=[];return this._playlist&&qo(this._playlist.getItems)?r=this._playlist.getItems(e,t):this._error("unable to get items from playlist"),r},MediaActivityTracker.prototype._relativePosition=function(e,t){var r;return(t=t||this._playlistItem(e))&&Go(t.startOverallPosition)&&(r=e-t.startOverallPosition+(t.startPosition||0)),r},MediaActivityTracker.prototype._combineEventData=function(e,t){var r=this._playlist?this._playlist.eventData:null,n=e?e.eventData:null,i=[];return r&&i.push(r),n&&i.push(n),this._eventData&&i.push(this._eventData),t&&(i=i.concat(t)),i},MediaActivityTracker.prototype._activityArguments=function(e,t,r,n){var i=this._relativePosition(t,e),o=this._combineEventData(e,Array.prototype.slice.call(arguments,4)),a=[i,t,r,n].concat(o);return a},MediaActivityTracker.prototype._generatePlaylistTransitionsIfNecessary=function(e){var t=this,r=Promise.resolve();return this.shouldGenerateTransitions&&this._hasUnstoppedActivity(this._playActivity)&&(r=this._playActivity.startOverallPosition.then((function(e){return e||0})).then((function(r){var n,i,o=t._playlistItems(r,e),a=Promise.resolve();t._playlist._returnsOrderedItems||o.sort(t._playlistItemComparator);for(var s=0;s+1<o.length;s++)if(!((n=(i=o[s+1]).startOverallPosition)<=r)){if(n>=e)break;a=a.then(function(){var e=this,r=e.startOverallPosition,n={eventTime:t._timeTracker?t._timeTracker.estimatedTime(r):null};return t._playStopped(r,t.TYPE.AUTOMATIC,t.PLAY_STOP_REASON.TRANSITION,n).then((function(){return t._playStarted(e,r,t.TYPE.AUTOMATIC,t.PLAY_START_REASON.TRANSITION,n)}))}.bind(i))}return a}))),r},MediaActivityTracker.prototype._hasUnstoppedActivity=function(e){return e&&!e.isStopped},MediaActivityTracker.prototype._error=function(e){this._processor.system.logger.error(this.constructor.name+" error: "+e)},MediaActivityTracker.prototype._playlistItemComparator=function(e,t){return e.startOverallPosition==t.startOverallPosition?0:e.startOverallPosition<t.startOverallPosition?-1:1};var HLSRollItemsMediaActivityTracker=function(e,t){MediaActivityTracker.apply(this,arguments)};(HLSRollItemsMediaActivityTracker.prototype=Object.create(MediaActivityTracker.prototype)).constructor=HLSRollItemsMediaActivityTracker,Object.defineProperty(HLSRollItemsMediaActivityTracker.prototype,"shouldGenerateTransitions",{get:function(){return!1},set:function(){this._error('Changing "shouldGenerateTransitions" is not allowed in HLSRollItemsMediaActivityTracker. Please use correct play activity tracker if you need to automatically generate transition play activity events ')}}),HLSRollItemsMediaActivityTracker.prototype.playStarted=function(e,t,r,n){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},HLSRollItemsMediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,t,r,n,i){var o=Promise.resolve(),a=this;if(t<1e3*i.start||t>1e3*(i.start+i.duration))return this._error("The giving overallPosition("+t+") is not in the given roll item's timeframe."),o;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var s=this._playlistItem(i);s?o=this._playStarted.apply(this,[s,t,r,n].concat(Array.prototype.slice.call(arguments,5))).catch((function(e){a._error(e)})):this._error('Failed to record play start event due to no active playlist item for the roll item info startOverallPos("'+i.start+'"), duration("'+i.duration+'").')}return o},HLSRollItemsMediaActivityTracker.prototype.jumpFromOverallPosition=function(e,t,r){var n=Promise.resolve(),i=Array.prototype.slice.call(arguments,3),o=this;return e<1e3*t.start||e>1e3*(t.start+t.duration)?(this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),n):(this._hasUnstoppedActivity(this._playActivity)&&(n=this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.NEXT].concat(i))),n=n.then((function(){return o.seekStarted.apply(o,[e,o.TYPE.AUTOMATIC,o.SEEK_START_REASON.NEXT,t].concat(i))})).then((function(){return o.seekStopped.apply(o,[1e3*r.start,o.TYPE.AUTOMATIC,o.SEEK_STOP_REASON.NEXT,r].concat(i))})).then((function(){return o.playStarted.apply(o,[1e3*r.start,o.TYPE.AUTOMATIC,o.PLAY_START_REASON.NEXT,r].concat(i))})))},HLSRollItemsMediaActivityTracker.prototype.playStopped=function(e,t,r){var n=this,i=Promise.resolve();if(this._hasUnstoppedActivity(this._playActivity)){if(e<this._playStartPlaylistItem.startOverallPosition||e>this._playStartPlaylistItem.endOverallPosition)return this._error("inconsistent state: the stop-overall-position("+e+") is out of the active rollItem("+this._playStartPlaylistItem.startOverallPosition+","+this._playStartPlaylistItem.endOverallPosition+")."),i;var o=Array.prototype.slice.call(arguments);i=i.then((function(){var e=n._playStopped.apply(n,Array.prototype.slice.call(o));return n._playStartPlaylistItem=null,n._timeTracker=null,e})).catch((function(e){n._error(e)}))}else this._error("inconsistent state: did you forget to call playStarted?");return i},HLSRollItemsMediaActivityTracker.prototype.seekStarted=function(e,t,r,n){var i=Promise.resolve();if(e<1e3*n.start||e>1e3*(n.start+n.duration))return this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),i;if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var o=this._playlistItem(n);if(o){var a=this._activityArguments.apply(this,[o,e,t,r].concat(Array.prototype.slice.call(arguments,4)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var s=this;i=this._seekActivity.started.apply(this._seekActivity,a).catch((function(e){s._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the roll item info startOverallPos("'+n.start+'"), duration("'+n.duration+'").')}return i},HLSRollItemsMediaActivityTracker.prototype.seekStopped=function(e,t,r,n){var i=Promise.resolve(),o=this._playlistItem(n);if(o&&this._hasUnstoppedActivity(this._seekActivity)){var a=this._activityArguments.apply(this,[o,e,t,r].concat(Array.prototype.slice.call(arguments,4))),s=this;i=this._seekActivity.stopped.apply(this._seekActivity,a).catch((function(e){s._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return i},HLSRollItemsMediaActivityTracker.prototype._playlistItem=function(e){var t;return this._playlist&&Hn.isFunction(this._playlist.getItemForRollItem)&&(t=this._playlist.getItemForRollItem(1e3*e.start,1e3*e.duration)),t||this._error("unable to get item from playlist"),t},HLSRollItemsMediaActivityTracker.prototype._relativePosition=function(e,t){var r;return Hn.isDefinedNonNull(t)?(t&&Hn.isNumber(t.startOverallPosition)&&(r=e-t.startOverallPosition+(t.startPosition||0)),r):(this._error("please provide the active playlist item for calculating the relative position."),r)};var Yo=so,MediaPlaylistItem=function(e){Yo.apply(this,arguments),this._startOverallPosition=e,this._startPosition=0};(MediaPlaylistItem.prototype=new Yo).constructor=MediaPlaylistItem,Object.defineProperties(MediaPlaylistItem.prototype,{startOverallPosition:{get:function(){return this._startOverallPosition}},startPosition:{get:function(){return this._startPosition},set:function(e){this._startPosition=e}},eventData:{get:function(){return this._eventData}}});var HLSRollItem=function(e,t){MediaPlaylistItem.apply(this,arguments),this._duration=t};(HLSRollItem.prototype=new MediaPlaylistItem).constructor=HLSRollItem,Object.defineProperties(HLSRollItem.prototype,{duration:{get:function(){return this._duration}},endOverallPosition:{get:function(){return this.startOverallPosition+this.duration}}}),HLSRollItem.prototype.containsOverallPosition=function(e){return this.startOverallPosition<=e&&this.endOverallPosition>e};var MediaPlaylist=function(){};MediaPlaylist.prototype.RANGE_OPTIONS=Ko,Object.defineProperties(MediaPlaylist.prototype,{eventData:{get:function(){}}}),MediaPlaylist.prototype.getItem=function(e,t){},MediaPlaylist.prototype.getItems=function(e,t){};var HLSVideoPlaylist=function(e){MediaPlaylist.apply(this,arguments),this._startPosition=e,this._mainFeatureMetricsData=Hn.copyKeysAndValues.apply(null,[!1,!1,!1,null].concat(Array.prototype.slice.call(arguments,1))),this._rollItems=[]};(HLSVideoPlaylist.prototype=new MediaPlaylist).constructor=HLSVideoPlaylist,HLSVideoPlaylist.prototype.setDelegate=function(e){return Hn.attachDelegate(this,e)},HLSVideoPlaylist.prototype.addRollInfoItems=function(e){e&&e.length&&e.forEach((function(e){this.addRollInfoItem(e)}),this)},HLSVideoPlaylist.prototype.addRollInfoItem=function(e){e&&this.addRollItem(1e3*e.start,1e3*e.duration,e.metricsData)},HLSVideoPlaylist.prototype.addRollItem=function(e,t){var r=new HLSRollItem(e,t);r.updateData.apply(r,Array.prototype.slice.call(arguments,2)),this._addRollItem(r)},HLSVideoPlaylist.prototype.updateMainFeatureMetricsData=function(){Hn.extend.apply(null,[this._mainFeatureMetricsData].concat(Array.prototype.slice.call(arguments)))},HLSVideoPlaylist.prototype.getItemForRollItem=function(e,t){var r=this._indexOfLastRollItemWithStartBeforePosition(e),n=this._rollItems[r];return Hn.isDefinedNonNull(n)&&n.duration===t?n:null},HLSVideoPlaylist.prototype.getItem=function(e,t){var r,n=this._indexOfLastRollItemWithStartBeforePosition(e);if(Hn.isInteger(n)){for(;t!=this.RANGE_OPTIONS.INCLUDES_START_POSITIONS&&this._rollItems[n].startOverallPosition==e&&n>0;)n--;(r=this._rollItems[n]).containsOverallPosition(e)||t==this.RANGE_OPTIONS.INCLUDES_END_POSITIONS&&r.endOverallPosition==e||(r=this._mainFeatureItemWithStartOverallPosition(r.endOverallPosition))}else r=this._mainFeatureItemWithStartOverallPosition(this._startPosition);return r},HLSVideoPlaylist.prototype.getItems=function(e,t){var r=[];if(this._rollItems.length){var n=this._indexOfLastRollItemWithStartBeforePosition(e);for(Hn.isInteger(n)||(r.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition)),n=0);n<this._rollItems.length;){var i=this._rollItems[n];if(i.startOverallPosition>t)break;if(i.endOverallPosition>=e&&r.push(i),n++,i.endOverallPosition<t)if(n<this._rollItems.length){var o=this._rollItems[n];o.startOverallPosition&&o.startOverallPosition>i.endOverallPosition&&r.push(this._mainFeatureItemWithStartOverallPosition(i.endOverallPosition))}else r.push(this._mainFeatureItemWithStartOverallPosition(i.endOverallPosition))}}else r.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition));return r},HLSVideoPlaylist.prototype._addRollItem=function(e){if(e){var t=this._insertionIndexForItemWithPosition(e.startOverallPosition);this._rollItems.splice(t,0,e)}},HLSVideoPlaylist.prototype._indexOfLastRollItemWithStartBeforePosition=function(e){var t,r=this._rollItems[0];return r&&Hn.isInteger(e)&&r.startOverallPosition<=e&&(t=this._insertionIndexForItemWithPosition(e)-1),t},HLSVideoPlaylist.prototype._insertionIndexForItemWithPosition=function(e){for(var t=0,r=this._rollItems.length;t<r;){var n=Math.floor((t+r)/2);this._rollItems[n].startOverallPosition>e?r=n:t=n+1}return t},HLSVideoPlaylist.prototype._mainFeatureItemWithStartOverallPosition=function(e){var t=new MediaPlaylistItem(e);return t.startPosition=this._featurePlayheadProgress(e),t.updateData(this._mainFeatureMetricsData),t},HLSVideoPlaylist.prototype._featurePlayheadProgress=function(e){e=e||0;var t,r,n=this._indexOfLastRollItemWithStartBeforePosition(e),i=this._startPosition||0;Hn.isInteger(n)||(n=-1);for(var o=n;o>=0;o--)t=this._rollItems[o],0===o?i+=t.startOverallPosition:(r=this._rollItems[o-1],i+=t.startOverallPosition-r.endOverallPosition);return i};var MediaActivityTrackerGenerator=function(e){this._processor=e};MediaActivityTrackerGenerator.prototype.createTracker=function(e){var t=new MediaActivityTracker(this._processor,e);return t.updateData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createHLSRollItemsMediaActivityTracker=function(e){var t=new HLSRollItemsMediaActivityTracker(this._processor,e);return t.updateData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createHLSVideoPlaylist=function(e){var t=new HLSVideoPlaylist(e);return t.updateMainFeatureMetricsData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createMediaPlaylist=function(e){return this.createHLSVideoPlaylist.apply(this,arguments)};var Qo=Xn.exceptionString,PlayActivityEventHandler=function(e){this._processor=e};PlayActivityEventHandler.prototype.knownFields=function(){throw Qo("PlayActivityEventHandler","knownFields")},PlayActivityEventHandler.prototype.eventType=function(e){throw Qo("PlayActivityEventHandler","eventType")},PlayActivityEventHandler.prototype.processMetricsData=function(){var e=Array.prototype.slice.call(arguments),t=this.eventType(e),r=this._processor.config,n=this._processor._constraints,i=this;return r.metricsDisabledOrBlacklistedEvent(t).then((function(e){if(e)throw"event was disabled"})).then((function(){var t=i._processor.eventHandlers.base;return t.metricsData.apply(t,e)})).then((function(t){var r=[];e=[t].concat(e);var n=ei.processMetricsData(i,i.knownFields(),!0,e),o={};return Object.keys(n).forEach((function(e){var t=n[e],i=Promise.resolve(t).then((function(t){o[e]=t}));r.push(i)})),Promise.all(r).then((function(){return o}))})).then((function(e){return n.applyConstraintTreatments(e)})).then((function(e){return r.removeBlacklistedFields(e)})).catch((function(t){return i._processor.system.logger.error("PlayActivity Processor: Unable to generate the event ("+i.eventType(e)+") for the topic "+r.topic()+", due to "+t),null}))};var Jo=Hn.attachDelegate,Xo=Hn.extend,MediaActivity$1=function(e,t,r){PlayActivityEventHandler.call(this,e),this._defaultEventType=t,this._reasonConstants=r,this._defaultActionType};(MediaActivity$1.prototype=Object.create(PlayActivityEventHandler.prototype)).constructor=MediaActivity$1,Xo(MediaActivity$1,jo),Object.defineProperties(MediaActivity$1.prototype,{TYPE:{get:function(){return Uo.TYPE}},REASON:{get:function(){return this._reasonConstants}}}),MediaActivity$1.prototype.setDelegate=function(e){return Jo(this,e)},MediaActivity$1.prototype.knownFields=function(){var e=[Oo,Mo,Do];return e},MediaActivity$1.prototype.eventType=function(e){return this._defaultEventType},MediaActivity$1.prototype.eventVersion=function(e){var t=this._processor.eventHandlers.base.eventVersion(e);return null!==t?t:1},MediaActivity$1.prototype.actionType=function(e){return this._defaultActionType};var StartMediaActivity=function(e,t,r){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.START};(StartMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StartMediaActivity,StartMediaActivity.prototype.metricsData=function(e,t,r,n){var i={position:e,overallPosition:t,startType:r,startReason:n},o=Array.prototype.slice.call(arguments,4);return this.processMetricsData.apply(this,[i].concat(o))};var StopMediaActivity=function(e,t,r){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.STOP};(StopMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StopMediaActivity,StopMediaActivity.prototype.metricsData=function(e,t,r,n,i){var o=this.eventType(),a={position:e,overallPosition:t,stopType:r,stopReason:n,startPosition:(i=i||{}).position,startOverallPosition:i.overallPosition,startTime:i.eventTime,startType:i.startType,startReason:i.startReason,startReasonType:i.startReasonType};o===MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY&&(a.startAssetId=i.assetId);var s=Array.prototype.slice.call(arguments,5);return this.processMetricsData.apply(this,[a].concat(s))};var Zo=to,PlayActivityProcessorBase=function(e){Zo.apply(this,arguments)};(PlayActivityProcessorBase.prototype=Object.create(Zo.prototype)).constructor=PlayActivityProcessorBase,PlayActivityProcessorBase.prototype.environment=function(){return this._processor.system.environment},PlayActivityProcessorBase.prototype.eventRecorder=function(){return this._processor.system.eventRecorder},PlayActivityProcessorBase.prototype.knownFields=function(){var e=Zo.prototype.knownFields().concat([Oo,Ro,$o,Co,xo,Lo,No]);return e},PlayActivityProcessorBase.prototype.consumerId=function(e){var t=Ro;return e&&t in e?e[t]:this.environment().consumerId()},PlayActivityProcessorBase.prototype.consumerNs=function(e){var t=$o;return e&&t in e?e[t]:this.environment().consumerNs()},PlayActivityProcessorBase.prototype.isOffline=function(e){var t=xo;return e&&t in e?e[t]:this.environment().isOffline()},PlayActivityProcessorBase.prototype.videoViewportHeight=function(e){var t=Lo;return e&&t in e?e[t]:this.environment().videoViewportHeight()},PlayActivityProcessorBase.prototype.videoViewportWidth=function(e){var t=No;return e&&t in e?e[t]:this.environment().videoViewportWidth()},PlayActivityProcessorBase.prototype.metricsData=function(){var e=Array.prototype.slice.call(arguments),t=ei.processMetricsData(this,this.knownFields(),!0,e);return t};var EventHandlers=function(e){this.base=new PlayActivityProcessorBase(e),this.playStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,Uo.PLAY_START_REASON),this.playStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,Uo.PLAY_STOP_REASON),this.seekStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,Uo.SEEK_START_REASON),this.seekStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,Uo.SEEK_STOP_REASON)},PlayActivityProcessor=function(e){if(!Hn.isDefinedNonNull(e))throw new Error("No delegate is provided to PlayActivityProcessor");this._initCalled=!1,this._delegatePackage=e,this.system=new System,this.config=this._delegatePackage.config,this.eventHandlers=new EventHandlers(this),this.utils=new Utils(this),this.mediaActivityTracker=new MediaActivityTrackerGenerator(this)};PlayActivityProcessor.prototype.init=function(){var e,t=Promise.resolve();return this._initCalled||(this._initCalled=!0,this._delegatePackage&&(Hn.setDelegates(this.eventHandlers,this._delegatePackage),Hn.setDelegates(this.system,this._delegatePackage)),e=this.config,Hn.isFunction(e.constraintProfile)&&Hn.isFunction(e.constraintProfiles)||Hn.attachMethods(e,Hi,e),t=this._delegatePackage.init(),this._constraints=new Yi(this.config,{environment:this.system.environment})),t},PlayActivityProcessor.prototype.cleanup=function(){this._delegatePackage&&Hn.isFunction(this._delegatePackage.cleanup)&&this._delegatePackage.cleanup(),this.config.cleanup(),Hn.resetDelegates(this.eventHandlers),Hn.resetDelegates(this.system),Hn.resetDelegates(this.utils),this.config=null,this.system=null,this.eventHandlers=null,this.utils=null,this._delegatePackage=null,this._constraints=null,this._initCalled=!1};const ea={"ac-3":"AC3","mp4a.a5":"AC3",alac:"Apple Lossless","ec-3":"EC3","mp4a.a6":"EC3",flac:"Free Lossless","mp4a.40.2":"AAC","mp4a.40.5":"AAC","mp4a.40.29":"AAC","mp4a.40.34":"MP3","mp4a.40.42":"AAC"},ta=/^[0-9]+\/JOC$/,isAtmos=(e,t)=>"EC3"===ea[e]&&(e=>ta.test(e))(t),ra=["dvh1.05.01","dvhe.05.06"],na={PQ:"HDR",HLG:"HDR",SDH:"SDH"},convertToVideoColorRange=(e,t)=>(e=>-1!==ra.indexOf(e))(e)?"DolbyVision":(e=>{var t;return null!==(t=na[e])&&void 0!==t?t:e})(t);function _define_property$5(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ia=function(e){return e.buffering="buffering",e.idle="idle",e.paused="paused",e.playing="playing",e}({}),oa=function(e){return e.bufferStart="BUFFER_START",e.bufferStop="BUFFER_STOP",e.exit="EXIT",e.play="PLAY",e.pause="PAUSE",e.stop="STOP",e.next="NEXT",e.newItem="NEW",e}({});const aa={initial:"idle",states:{idle:{on:{PLAY:{target:"playing",context:{reason:"PLAY",manual:"MANUAL",fromInitialPlay:!0}}}},playing:{on:{BUFFER_START:{target:"buffering",context:{reason:"BUFFERING",manual:"AUTOMATIC",fromInitialPlay:"~~previous~~"}},EXIT:{target:"idle",context:{reason:"EXIT"}},PAUSE:{target:"paused",context:{reason:"PAUSE"}},STOP:{target:"idle",context:{}},NEXT:{target:"idle",context:{reason:"NEXT"}},NEW:{target:"idle",context:{}}}},paused:{on:{PLAY:{target:"playing",context:{reason:"UNPAUSE"}},NEW:{target:"idle",context:{}},EXIT:{target:"idle",context:{reason:"EXIT"}}}},buffering:{on:{BUFFER_STOP:{target:"playing",context:{reason:"BUFFERING",manual:"AUTOMATIC"}},EXIT:{target:"idle",context:{reason:"EXIT"}}}}}},sa={manual:"UNKNOWN",reason:"UNKNOWN",fromInitialPlay:!1};class VPAFStateMachine{isAllowedTransition(e){return void 0!==this.getNextState(e)}transition(e,t={}){const r=this.getNextState(e);if(!r)return;Or.debug(`[mk/activity/vpaf] Transitioning from ${this.currentState} to ${r.target} because ${e}`);const n={};return hasOwn(t,"manual")&&(void 0!==t.manual?n.manual=t.manual?"MANUAL":"AUTOMATIC":n.manual="UNKNOWN"),void 0!==t.reason&&(n.reason=t.reason),this.currentContext=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$5(e,t,r[t])}))}return e}({},sa,r.context,n,this.preservePreviousContext(r.context)),this.currentState=r.target,this.currentContext}reset(){this.currentState=aa.initial,this.currentContext=sa}getNextState(e){return aa.states[this.currentState].on[e]}preservePreviousContext(e){const t={};return["manual","reason","reasonType","fromInitialPlay"].forEach(r=>{"~~previous~~"===e[r]&&(t[r]=this.currentContext[r])}),t}constructor(){_define_property$5(this,"currentState",aa.initial),_define_property$5(this,"currentContext",sa)}}const la=new Map([[me.playbackPlay,"play"],[me.playbackPause,"pause"],[me.playbackScrub,"scrub"],[me.playbackSeek,"seek"],[me.playbackSkip,"skip"],[me.playbackStop,"stop"],[me.playerExit,"exit"]]),ca={[be.EXITED_APPLICATION]:"EXIT",[be.FAILED_TO_LOAD]:"FAILURE",[be.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM]:"PLAY_OTHER",[be.NATURAL_END_OF_TRACK]:"COMPLETE",[be.PLAYBACK_PAUSED_DUE_TO_INACTIVITY]:"INACTIVITY",[be.SCRUB_BEGIN]:"SEEK",[be.TRACK_SKIPPED_BACKWARDS]:"SEEK",[be.TRACK_SKIPPED_FORWARDS]:"SEEK",[be.PLAYBACK_SUSPENDED]:"CLOSE_PLAYER",[en.NEXT_ITEM]:"NEXT"};var da=function(e){return e.SEEK_STARTED="seekStarted",e.SEEK_STOPPED="seekStopped",e.PLAY_STARTED="playStarted",e.PLAY_STOPPED="playStopped",e}({});const ua="xp_amp_tv_vpaf",pa={[me.playbackPause]:oa.pause,[me.playbackPlay]:oa.play,[me.playbackStop]:oa.stop,[me.playerExit]:oa.exit},ha={[ye.pictureinpicture]:"pictureInPicture",[ye.inline]:"foreground",_default:"foreground"};function asMilliseconds(e){return Math.round(1e3*e)}function determineDelegatedPlayback(e){return{delegatedPlayback:e.playbackTargetIsWireless?"Airplay":"None"}}function isSeekingInterval(e){return e.seekReasonType===Se.Interval}function assertIsDefined(e,t){if(null==e)throw new Error(t)}function assertTracker(e,t){assertIsDefined(e,(null!=t?t:"PAF")+" Tracker: Attempted to track event without first calling createTracker()")}function assertProcessor(e,t){assertIsDefined(e,(null!=t?t:"PAF")+" Tracker: Attempted to create tracker without first calling configure()")}function _define_property$4(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function calculateOverallLength(e,t){const r=e.defaultPlayable;if("EbsEvent"===r.type)return;var n;let i=parseFloat(null!==(n=e.hlsMetadata["feature.duration"])&&void 0!==n?n:r.duration);for(const o of t)i+=o.duration;return asMilliseconds(i)}function getMainFeatureData(e){var t;const r={url:e.attributes.url,assetId:null==e||null===(t=e.hlsMetadata)||void 0===t?void 0:t["feature.adam-id"]};return e.isLinearStream||(r.assetPlacement="feature"),!0===e.attributes.isAdultContent&&(r.sensitiveContentType="adult"),r}function currentAudioData(e){const{currentAudioTrack:t,nowPlayingItem:r}=e;let n,i;var o,a,s;"description"===(null==t?void 0:t.kind)?(i=null==t?void 0:t.language,n=void 0):(i=void 0,n=null!==(s=null==t?void 0:t.language)&&void 0!==s?s:null==r||null===(a=r.defaultPlayable)||void 0===a||null===(o=a.primaryLocale)||void 0===o?void 0:o.locale);let l;if((null==r?void 0:r.isLinearStream)&&t){const e=null===(c=t.characteristics)||void 0===c?void 0:c.find(e=>e.startsWith("com.apple.amp.appletv.identifier"));isHomeRadioTrack(t)?l=rt.Home:isAwayRadioTrack(t)?l=rt.Away:e&&(l=e)}var c;return{audioLocale:n,audioDescriptionLocale:i,audioVariantId:l}}function additionalTrackingData(e,t){return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$4(e,t,r[t])}))}return e}({},{downloadState:"streaming",playbackFocus:"foreground",topic:ua},function(e){return{programmingType:e.isLinearStream?"live":"videoOnDemand"}}(t),function(e){return e.defaultPlayable.vpafMetrics}(t),function(e){var t;const r=null===(t=e.videoContainerElement)||void 0===t?void 0:t.querySelector("video");return{videoViewportHeight:null==r?void 0:r.clientHeight,videoViewportWidth:null==r?void 0:r.clientWidth}}(e),currentAudioData(e),function(e){var t;const{language:r,kind:n}=null!==(t=e.currentTextTrack)&&void 0!==t?t:{};return"captions"===n?{subtitleLocale:void 0,closedCaptionLocale:r}:"subtitles"===n?{subtitleLocale:r,closedCaptionLocale:void 0}:{subtitleLocale:void 0,closedCaptionLocale:void 0}}(e),determineDelegatedPlayback(e))}function ensurePositionData(e,t){if(null==t?void 0:t.isLinearStream){if(void 0===e.playingDate)throw new Error('VPAFTracker: The property `playingDate` is required on data for "linear" content');return e}if(void 0===e.position)throw new Error('VPAFTracker: The property `position` is required on data "vod" content');return e}function calculatePlaybackPosition(e,t){if(null==e?void 0:e.isLinearStream){if(void 0===t.playingDate)throw new Error("VPAF: Can't report playback position for linear stream without playingDate value");return t.playingDate.getTime()}var r;return asMilliseconds(null!==(r=t.position)&&void 0!==r?r:0)}function isSkippingIntro(e){return e.seekReasonType===Se.SkipIntro}function getMappedStopReason(e){if(void 0!==e.endReasonType)return ca[e.endReasonType]}function getExplicitStateContext(e){return{manual:e.userInitiated,reason:getMappedStopReason(e)}}function formatKeyPlayRollItem(e){return{start:e.startTime,duration:e.endTime-e.startTime,metricsData:{assetId:e.id,assetPlacement:"catchUpToLive",isSkippable:!0}}}function formatKeyPlayRollItemInSeconds(e){const t=formatKeyPlayRollItem(e);return t.start=t.start/1e3,t.duration=t.duration/1e3,t}function asyncGeneratorStep$2(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator$2(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$2(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$2(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$3(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$3(e,t,r[t])}))}return e}function _object_spread_props$1(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const ya=Or.createChild("vpaf");class VPAFTracker{get requestedEvents(){return Array.from(la.keys())}get isConfigured(){return void 0!==this.instance}get currentItem(){return this._currentItem}set currentItem(e){this._currentItem=e,this.currentSkipItems=e?parseSkipItems(e):void 0}configure(e){var t=this;return _async_to_generator$2((function*(){if(t.instance=e.instance,t.dispatcher=e.services.dispatcher,!Fr.storekit.cid)try{yield Fr.storekit.infoRefresh()}catch(o){}const r=e.services.utsAPIClient,n=Array.isArray(navigator.languages)?navigator.languages:"string"==typeof navigator.language?[navigator.language]:[],i=new WebDelegates(ua,{config:{configHostname:()=>"daf.xp.apple.com"},environment:{app:()=>"com.apple.tv",appVersion:()=>"1.0",consumerId:()=>Fr.storekit.cid,consumerNs:()=>"TV",isOffline:()=>!1,delegateApp:()=>"web-tv-player",osLanguages:()=>n,resourceRevNum:()=>jr.app.build,storeFrontCountryCode(){var e,t,n;return null!==(n=null==r||null===(t=r.configuration)||void 0===t||null===(e=t.userProps)||void 0===e?void 0:e.country)&&void 0!==n?n:""}}});i.eventRecorder.setProperties(ua,{anonymous:!Fr.isAuthorized}),t.playActivityProcessor=new PlayActivityProcessor(i),yield t.playActivityProcessor.init(),t.setupListeners()}))()}cleanup(){var e=this;return _async_to_generator$2((function*(){e.tracker=void 0,e.isScrubbing=!1,e.scrubStopPosition=void 0,e.teardownListeners(),e.stopSynchronizing()}))()}shouldTrackPlayActivity(e,t){if(!t)return!1;const r=t.defaultPlayable;if(!r||!r.vpafMetrics)return!1;const n=pa[e];return void 0===n||this.state.isAllowedTransition(n)}handleEvent(e,t,r){if(!this.shouldTrackPlayActivity(e,r))return;const n=la.get(e);void 0!==n&&"function"==typeof this[n]&&this[n](r,t)}bufferStart(e,t){var r=this;return _async_to_generator$2((function*(){var n;if(ya.debug("VPAFTracker: handling bufferStart()"),!(yield r.canTrackItem(e)))return void ya.debug("VPAFTracker: aborting bufferStart, no tracker");if(r.state.currentState!==ia.playing)return void ya.debug("VPAFTracker: aborting bufferStart, not playing");if("seek"===(null===(n=r.lastTrackedEvent)||void 0===n?void 0:n.reason))return void ya.debug("VPAFTracker: aborting bufferStart, after a seek");const i=r.state.currentContext.fromInitialPlay,o=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(oa.bufferStart),i?ya.debug("VPAFTracker: bufferStart() not tracking PLAY_STOPPED, it is from initial play"):yield r.trackEvent(da.PLAY_STOPPED,o)}))()}bufferEnd(e,t){var r=this;return _async_to_generator$2((function*(){var n;if(ya.debug("VPAFTracker: handling bufferEnd()"),!(yield r.canTrackItem(e)))return;if(r.state.currentState!==ia.buffering)return void ya.debug("VPAFTracker: aborting bufferEnd, not buffering");if("seek"===(null===(n=r.lastTrackedEvent)||void 0===n?void 0:n.reason))return void ya.debug("VPAFTracker: aborting bufferEnd, after a seek");const i=r.state.currentContext.fromInitialPlay,o=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(oa.bufferStop),i?ya.debug("VPAFTracker: bufferEnd() not tracking PLAY_STARTED, it is from initial play"):yield r.trackEvent(da.PLAY_STARTED,o)}))()}exit(e,t={}){var r=this;return _async_to_generator$2((function*(){(yield r.canTrackItem(r.currentItem))&&(ya.debug("VPAFTracker.exit()"),r.state.transition(oa.exit),yield r.trackEvent(da.PLAY_STOPPED,calculatePlaybackPosition(void 0,ensurePositionData(t,t.item))),r.stopSynchronizing(),r.currentItem=void 0)}))()}pause(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ya.debug("VPAFTracker.pause()");const n=calculatePlaybackPosition(e,ensurePositionData(t,e)),i=t.endReasonType===en.NEXT_ITEM?oa.next:oa.pause;r.state.transition(i,getExplicitStateContext(t)),yield r.trackEvent(da.PLAY_STOPPED,n)}))()}play(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ya.debug("VPAFTracker.play()");const n=calculatePlaybackPosition(e,_object_spread$2({position:0},t));r.state.transition(oa.play,getExplicitStateContext(t)),yield r.trackEvent(da.PLAY_STARTED,n)}))()}scrub(e,t={}){var r=this;return _async_to_generator$2((function*(){if(void 0===e||void 0===t.position)return;const n=calculatePlaybackPosition(e,ensurePositionData(t,e));r.isScrubbing&&void 0===t.endReasonType?r.scrubStopPosition=n:r.isScrubbing&&r.scrubEnd(e,n)}))()}seek(e,t={}){var r=this;return _async_to_generator$2((function*(){if(void 0!==e&&(!e.isLinearStream||void 0!==t.playingDate&&void 0!==t.startPlayingDate)&&(e.isLinearStream||void 0!==t.position&&void 0!==t.startPosition))return function(e){return e.seekReasonType===Se.SkipToLiveManual||e.seekReasonType===Se.SkipToLiveAutomatic}(t)?r.trackJumpToLive(e,t):e.currentKeyPlay?r.currentKeyPlay?r.trackJumpToKeyPlay(e,t):r.trackEnterKeyPlay(e):r.currentKeyPlay?r.trackExitKeyPlay(e,t):void(isSkippingIntro(t)||isSeekingInterval(t)?yield r.trackSeek(e,t):yield r.trackScrub(e,t))}))()}skip(e,t={}){return _async_to_generator$2((function*(){}))()}stop(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ya.debug("VPAFTracker.stop()");const n=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(oa.stop,getExplicitStateContext(t)),yield r.trackEvent(da.PLAY_STOPPED,n),r.stopSynchronizing(),r.currentItem=void 0}))()}lyricsPlay(e,t){return _async_to_generator$2((function*(){}))()}lyricsStop(){return _async_to_generator$2((function*(){}))()}trackSeek(e,t){var r=this;return _async_to_generator$2((function*(){const n={},i=r.getSkipActionName(t.position);isSkippingIntro(t)&&"string"==typeof i&&(n.actionName=i);const o=_object_spread_props$1(_object_spread$2({},t),{position:t.startPosition,playingDate:t.startPlayingDate});yield r.trackSeekStart(e,o,n),yield r.trackSeekStop(e,t,n)}))()}trackEnterKeyPlay(e){var t=this;return _async_to_generator$2((function*(){if(ya.debug("VPAFTracker.trackEnterKeyPlay"),!(yield t.canTrackItem(e)))return;yield t.createRollItemsTracker(e),t.assertRollItemsTracker(t.rollItemsTracker),t.currentKeyPlay=formatKeyPlayRollItemInSeconds(e.currentKeyPlay);const r=1e3*t.currentKeyPlay.start;yield t.rollItemsTracker.playStarted(r,t.rollItemsTracker.TYPE.MANUAL,t.rollItemsTracker.PLAY_START_REASON.PLAY,_object_spread$2({},t.currentKeyPlay))}))()}trackExitKeyPlay(e,t){var r=this;return _async_to_generator$2((function*(){ya.debug("VPAFTracker.trackExitKeyPlay"),r.assertRollItemsTracker(r.rollItemsTracker),assertTracker(r.tracker,"VPAF");const n=calculatePlaybackPosition(e,ensurePositionData(t,e));yield r.rollItemsTracker.playStopped(n,r.rollItemsTracker.TYPE.MANUAL,r.rollItemsTracker.PLAY_STOP_REASON.PLAY_OTHER,r.currentKeyPlay),yield r.tracker.playStarted(n,r.rollItemsTracker.TYPE.MANUAL,r.rollItemsTracker.PLAY_STOP_REASON.PLAY_OTHER),r.currentKeyPlay=void 0}))()}trackJumpToLive(e,t){var r=this;return _async_to_generator$2((function*(){ya.debug("VPAFTracker.trackJumpToLive"),r.assertRollItemsTracker(r.rollItemsTracker);const n=calculatePlaybackPosition(e,ensurePositionData(t,e)),i=t.startPlayingDate.getTime(),o=t.seekReasonType===Se.SkipToLiveManual?r.rollItemsTracker.TYPE.MANUAL:r.rollItemsTracker.TYPE.AUTOMATIC;yield r.rollItemsTracker.playStopped(i,o,r.rollItemsTracker.PLAY_STOP_REASON.SEEK,_object_spread_props$1(_object_spread$2({},r.currentKeyPlay),{stopReasonType:r.rollItemsTracker.PLAY_STOP_REASON_TYPE.SKIP_TO_LIVE})),r.currentKeyPlay=void 0,yield r.trackEvent(da.SEEK_STARTED,i,o,r.rollItemsTracker.PLAY_START_REASON.SKIP_TO_LIVE),yield r.trackEvent(da.SEEK_STOPPED,n,o,r.rollItemsTracker.PLAY_START_REASON.SKIP_TO_LIVE),yield r.trackEvent(da.PLAY_STARTED,n,o,r.rollItemsTracker.PLAY_START_REASON.SEEK,{startReasonType:r.rollItemsTracker.PLAY_START_REASON_TYPE.SKIP_TO_LIVE})}))()}trackJumpToKeyPlay(e,t){var r=this;return _async_to_generator$2((function*(){ya.debug("VPAFTracker.trackJumpToKeyPlay"),r.assertRollItemsTracker(r.rollItemsTracker);const n=t.seekReasonType===Se.Automatic?r.rollItemsTracker.TYPE.AUTOMATIC:r.rollItemsTracker.TYPE.MANUAL,i=1e3*(r.currentKeyPlay.start+r.currentKeyPlay.duration),o=Math.min(t.startPlayingDate.getTime(),i),a=formatKeyPlayRollItemInSeconds(e.currentKeyPlay),s=1e3*a.start,l=r.rollItemsTracker.PLAY_STOP_REASON.NEXT;yield r.rollItemsTracker.playStopped(o,n,l,r.currentKeyPlay),yield r.rollItemsTracker.playStarted(s,n,l,a),r.currentKeyPlay=a}))()}trackSeekStart(e,t,r={}){var n=this;return _async_to_generator$2((function*(){assertTracker(n.tracker,"VPAF");const i=t.seekReasonType===Se.SkipIntro?n.tracker.SEEK_START_REASON.SKIP_INTRO:n.tracker.SEEK_START_REASON.INTERVAL,o=calculatePlaybackPosition(e,ensurePositionData(t,e)),a=n.tracker.TYPE.MANUAL;if(n.state.currentState===ia.playing){const e=isSkippingIntro(t)?_object_spread_props$1(_object_spread$2({},r),{stopReasonType:n.tracker.PLAY_STOP_REASON_TYPE.SKIP_INTRO}):r;yield n.trackEvent(da.PLAY_STOPPED,o,a,n.tracker.PLAY_STOP_REASON.SEEK,e)}yield n.trackEvent(da.SEEK_STARTED,o,a,i,r)}))()}trackSeekStop(e,t,r={}){var n=this;return _async_to_generator$2((function*(){assertTracker(n.tracker,"VPAF");const i=isSeekingInterval(t)?n.tracker.SEEK_STOP_REASON.INTERVAL:n.tracker.SEEK_STOP_REASON.SKIP_INTRO,o=calculatePlaybackPosition(e,ensurePositionData(t,e)),a=n.tracker.TYPE.AUTOMATIC;if(yield n.trackEvent(da.SEEK_STOPPED,o,a,i,r),n.state.currentState===ia.playing){const e=isSkippingIntro(t)?_object_spread_props$1(_object_spread$2({},r),{startReasonType:n.tracker.PLAY_START_REASON_TYPE.SKIP_INTRO}):r;yield n.trackEvent(da.PLAY_STARTED,o,a,n.tracker.PLAY_START_REASON.SEEK,e)}}))()}trackScrub(e,t){var r=this;return _async_to_generator$2((function*(){const n=e.isLinearStream?t.playingDate.getTime():asMilliseconds(t.position),i=e.isLinearStream?t.startPlayingDate.getTime():asMilliseconds(t.startPosition);yield r.scrubStart(e,i),yield r.scrubEnd(e,n)}))()}scrubStart(e,t){var r=this;return _async_to_generator$2((function*(){(yield r.canTrackItem(e))&&(assertTracker(r.tracker,"VPAF"),r.isScrubbing=!0,r.scrubStopPosition=t,r.state.currentState===ia.playing&&(yield r.trackEvent(da.PLAY_STOPPED,r.scrubStopPosition,r.tracker.TYPE.AUTOMATIC,r.tracker.PLAY_STOP_REASON.SEEK)),yield r.trackEvent(da.SEEK_STARTED,t,r.tracker.TYPE.MANUAL,r.tracker.SEEK_START_REASON.SCRUB))}))()}scrubEnd(e,t){var r=this;return _async_to_generator$2((function*(){assertTracker(r.tracker,"VPAF"),yield r.trackEvent(da.SEEK_STOPPED,t,r.tracker.TYPE.MANUAL,r.tracker.SEEK_STOP_REASON.SCRUB),r.state.currentState===ia.playing&&(yield r.trackEvent(da.PLAY_STARTED,t,r.tracker.TYPE.AUTOMATIC,r.tracker.PLAY_START_REASON.SEEK)),r.isScrubbing=!1,r.scrubStopPosition=void 0}))()}trackEvent(e,t,r,n,i){var o=this;return _async_to_generator$2((function*(){assertTracker(o.tracker,"VPAF"),void 0===r&&(r=o.tracker.TYPE[o.state.currentContext.manual]),void 0===n&&(n=e===da.PLAY_STARTED?o.tracker.PLAY_START_REASON[o.state.currentContext.reason]:o.tracker.PLAY_STOP_REASON[o.state.currentContext.reason]),ya.debug(`VPAFTracker.trackEvent(${e}, ${t}, ${r}, ${n})`,i),yield o.tracker[e].call(o.tracker,Math.round(t),r,n,i),o.lastTrackedEvent={eventType:e,position:t,type:r,reason:n,namedArgs:i}}))()}createTracker(e){var t=this;return _async_to_generator$2((function*(){assertProcessor(t.playActivityProcessor,"VPAF");const{mediaActivityTracker:r}=t.playActivityProcessor,n=getMainFeatureData(e),i=parseRollItems(e).map(e=>{const t={start:e.start,duration:e.duration,metricsData:{assetPlacement:e.type.replace("-",""),assetId:e["adam-id"],isSkippable:e.skippable}};return void 0!==e["dynamic-id"]&&(t.metricsData["data.dynamicSlot.dataSetId"]=e["dynamic-id"]),t});ya.debug("VPAF: Creating HLS Playlist",n);const o=r.createHLSVideoPlaylist(0,n);return ya.debug("VPAF: adding roll items",i),o.addRollInfoItems(i),ya.debug("VPAFTracker.createTracker: creating new tracker for "+(null==e?void 0:e.id)),t.tracker=r.createTracker(o,...yield t.getMappedPlaybackFields(e),additionalTrackingData(t.instance,e),{overallLength:calculateOverallLength(e,i),featureAssetId:n.assetId}),t.startSynchronizing(),t.tracker}))()}createRollItemsTracker(e){var t=this;return _async_to_generator$2((function*(){var r,n;assertProcessor(t.playActivityProcessor,"VPAF");const i=getMainFeatureData(e),o=t.playActivityProcessor.mediaActivityTracker.createHLSVideoPlaylist(0,i);return e.keyPlayShelf.forEach(e=>{const t=formatKeyPlayRollItem(e);o.addRollItem(t.start,t.duration,t.metricsData);o.getItemForRollItem(t.start,t.duration).startPosition=t.start}),t.rollItemsTracker=null===(n=t.playActivityProcessor)||void 0===n?void 0:n.mediaActivityTracker.createHLSRollItemsMediaActivityTracker(o,...yield t.getMappedPlaybackFields(e),additionalTrackingData(t.instance,e),{extraType:"CatchUpToLive",featureAssetId:i.assetId,featureCanonicalId:null===(r=e.defaultPlayable)||void 0===r?void 0:r.canonicalId}),t.rollItemsTracker}))()}onPlaybackStateChange(e,t){var r=this;return _async_to_generator$2((function*(){const{state:e}=t,n=r.currentItem;var i;const o={position:r.instance.currentPlaybackTime,playingDate:r.instance.currentPlayingDate,userInitiated:null!==(i=t.userInitiated)&&void 0!==i&&i},a="PlaybackStates."+he[t.oldState],s="PlaybackStates."+he[t.state];ya.debug(`onPlaybackStateChange: ${a} -> ${s}`,o),e===he.waiting?(r.isBuffering=!0,ya.debug("VPAFTracker.onPlaybackStateChange: triggering bufferStart()",o),yield r.bufferStart(n,o)):e===he.playing?r.isBuffering&&(r.isBuffering=!1,ya.debug("VPAFTracker.onPlaybackStateChange: triggering bufferEnd()",o),yield r.bufferEnd(n,o)):e!==he.stalled&&(ya.debug("VPAFTracker.onPlaybackStateChange: resetting isBuffering=false"),r.isBuffering=!1)}))()}handleLevelUpdated(e,t){var r,n;const{level:i,channels:o}=t;if(!i)return;const{audioCodec:a,videoRange:s,videoCodec:l}=i;if(!(a&&o||s&&l))return;const c={};a&&o&&(c.audioFormat=((e,t)=>{var r;const n=null!==(r=null==e?void 0:e.toLowerCase())&&void 0!==r?r:"";var i;return isAtmos(n,t)?"Atmos":null!==(i=ea[n])&&void 0!==i?i:e})(a,o)),s&&l&&(c.videoColorRange=convertToVideoColorRange(l,s)),null===(r=this.tracker)||void 0===r||r.updateData(c),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(c)}handleAudioTrackChange(){if(void 0===this.tracker||void 0===this.instance)return;const e=currentAudioData(this.instance);var t;e&&(ya.debug("Updating AudioData",e),this.tracker.updateData(e),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(e))}handleForcedTextTrackChange(e,t){var r,n;const i={forcedSubtitleLocale:null==t?void 0:t.language};null===(r=this.tracker)||void 0===r||r.updateData(i),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(i)}handlePresentationModeChange(e,{mode:t}){var r,n,i;const o={playbackFocus:null!==(i=ha[t])&&void 0!==i?i:ha._default};null===(r=this.tracker)||void 0===r||r.updateData(o),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(o)}handleTargetWirelessChange(){if(void 0!==this.instance){var e,t;const r=determineDelegatedPlayback(this.instance);null===(e=this.tracker)||void 0===e||e.updateData(r),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(r)}}handleTextTrackChange(){var e,t;const{tracker:r}=this;if(void 0===r)return;const n=null===(e=this.instance)||void 0===e?void 0:e.currentTextTrack;if(!n||"captions"!==n.kind&&"subtitles"!==(null==n?void 0:n.kind))return;const i=""===n.language?void 0:n.language,o={closedCaptionLocale:"captions"===n.kind?i:void 0,subtitleLocale:"subtitles"===n.kind?i:void 0};r.updateData(o),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(o)}handleNowPlayingItemDidChange(e,t){const{item:r}=t;r||(ya.debug("handleNowPlayingItemDidChange: calling exit and clearing currentItem"),this.state.transition(oa.exit),this.stopSynchronizing(),this.currentItem=void 0)}canTrackItem(e){var t=this;return _async_to_generator$2((function*(){var r;return void 0!==e&&void 0!==e.defaultPlayable&&((null===(r=t.currentItem)||void 0===r?void 0:r.id)!==e.id&&(t.state.transition(oa.newItem),t.currentItem=e,yield t.createTracker(e)),void 0!==t.tracker)}))()}getSkipActionName(e){var t;const r=(null!==(t=this.currentSkipItems)&&void 0!==t?t:[]).find(t=>t.target===e);return null==r?void 0:r.label}setupListeners(){void 0!==this.dispatcher&&(this.dispatcher.subscribe(Ar.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.subscribe(Ar.textTrackChanged,this.handleTextTrackChange),this.dispatcher.subscribe(Ar.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.subscribe(Ar.nowPlayingItemDidChange,this.handleNowPlayingItemDidChange),this.dispatcher.subscribe(Ar.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.subscribe(me.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.subscribe(Ar.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.subscribe(Ar.presentationModeDidChange,this.handlePresentationModeChange))}teardownListeners(){void 0!==this.dispatcher&&(this.dispatcher.unsubscribe(Ar.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.unsubscribe(Ar.textTrackChanged,this.handleTextTrackChange),this.dispatcher.unsubscribe(Ar.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.unsubscribe(Ar.nowPlayingItemDidChange,this.handleNowPlayingItemDidChange),this.dispatcher.unsubscribe(Ar.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.unsubscribe(me.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.unsubscribe(Ar.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.unsubscribe(Ar.presentationModeDidChange,this.handlePresentationModeChange))}startSynchronizing(){void 0===this.synchronizeTimeout&&(this.synchronizeTimeout=setInterval(this.synchronize,6e4))}stopSynchronizing(){void 0!==this.synchronizeTimeout&&(clearInterval(this.synchronizeTimeout),this.synchronizeTimeout=void 0)}synchronize(){if(void 0===this.tracker||void 0===this.instance||void 0===this.currentItem)return void this.stopSynchronizing();const e=this.state.currentState===ia.paused,{playbackRate:t,currentPlaybackTime:r}=this.instance,n=e?0:t,i=Math.round(1e3*r);ya.debug(`VPAF: synchronize rate: ${n} and current time: ${i}`),this.tracker.synchronize(n,i)}assertRollItemsTracker(e){assertIsDefined(e,"VPAFTracker: Attempted to track roll item event before `trackerEnterKeyPlay` was called")}getMappedPlaybackFields(e){var t=this;return _async_to_generator$2((function*(){assertProcessor(t.playActivityProcessor,"VPAF");const{utils:r}=t.playActivityProcessor,n=e.defaultPlayable;return[yield r.eventFields.applyFieldsMap(n,"utsVpafPlayable"),yield r.eventFields.applyFieldsMap(e.attributes,"utsVpafContent")]}))()}constructor(){_define_property$3(this,"_currentItem",void 0),_define_property$3(this,"playActivityProcessor",void 0),_define_property$3(this,"currentKeyPlay",void 0),_define_property$3(this,"currentSkipItems",void 0),_define_property$3(this,"dispatcher",void 0),_define_property$3(this,"instance",void 0),_define_property$3(this,"isScrubbing",!1),_define_property$3(this,"isBuffering",!1),_define_property$3(this,"rollItemsTracker",void 0),_define_property$3(this,"scrubStopPosition",void 0),_define_property$3(this,"tracker",void 0),_define_property$3(this,"synchronizeTimeout",void 0),_define_property$3(this,"state",void 0),_define_property$3(this,"lastTrackedEvent",void 0),this.state=new VPAFStateMachine}}function _object_without_properties(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function createMediaItemFromPlayable(e){const{id:t,type:r,contentType:n}=e,i={id:t,type:r,contentType:n,attributes:_object_without_properties(e,["id","type","contentType"]),playables:[e]};return function(e,t){var r;if(!t.assets||"Preview"===e.type)return void(e.attributes.assetUrl=t.hlsUrl||(null===(r=t.assets)||void 0===r?void 0:r.hlsUrl));const{assets:n}=t;n.fpsKeyServerUrl&&(e.keyServerQueryParameters=n.fpsKeyServerQueryParameters,e.keyURLs={"hls-key-cert-url":n.fpsCertificateUrl,"hls-key-server-url":n.fpsKeyServerUrl,"widevine-cert-url":n.wideVineCertificateUrl}),e.assetURL=n.hlsUrl}(i,e),new MediaItem(i)}_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",Promise)],VPAFTracker.prototype,"onPlaybackStateChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleLevelUpdated",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleAudioTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleForcedTextTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,void 0]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handlePresentationModeChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleTargetWirelessChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleTextTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleNowPlayingItemDidChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"synchronize",null);const fa=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];function asyncGeneratorStep$1(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _define_property$2(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const _a=Or.createChild("ctp");class ClickToPlayTracker{get active(){return void 0!==this.rtcTracker}get isConfigured(){return this._isConfigured}configure(e){var t,r=this;return(t=function*(){var t;r.instance=e.instance,r.rtcTracker=null===(t=e.services.playActivity)||void 0===t?void 0:t.getTrackerByType(RTCStreamingTracker),r._isConfigured=!0},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$1(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}handleEvent(e,t,r){e===Ar.playInitiated?(_a.debug("ClickToPlayTracker.handleEvent",e,t),this.registerPlay(t.item,t.timestamp)):e===Ar.mediaCanPlay&&(_a.debug("ClickToPlayTracker.handleEvent",e,t),this.trackPlay(this.instance.nowPlayingItem,t.timestamp))}registerPlay(e,t){if(this.active&&void 0!==e){if(void 0!==t)return void 0!==this.tracking&&_a.warn(`Replacing item ${this.tracking.item.id} with item ${e.id}`),_a.debug(`Registering ${e.id} initiated at ${t}`),this.tracking={item:e,initiatedTimestamp:t},this.tracking;_a.warn(`registerPlay timestamp value for item ${e.id} is missing, discarding`)}else _a.debug("Not registring play: inactive")}trackPlay(e,t){if(!this.active||void 0===e)return void _a.debug("Not tracking play: inactive");if(void 0===this.tracking)return void _a.warn("ClickToPlayTracker.trackPlay called without a registered tracking item");const r=null!=t?t:Date.now(),n=this.tracking.initiatedTimestamp,i=r-n;if(_a.debug(`trackPlay: item=${e.id}, initiated=${n}, started=${r}, timestampDiff=${i}`),n>r)return void _a.warn("Initiated timestamp is not before started timestamp, ignoring");const o=this.getReportingAgent(e);if(void 0!==o)return _a.info(`Reporting playback success after ${i}ms`),o.issueReportingEvent(ClickToPlayTracker.EVENT_ID,{event:"playbackStartup",playbackStartupResult:"success",tapToFirstFrame:i,PlayType:e.isLinearStream?"LIVE":"VOD"}),this.tracking=void 0,{item:e,initiatedTimestamp:n,playbackTimestamp:r};_a.warn(`No reporting agent for ${e.id}, discarding`)}getReportingAgent(e){var t;if(void 0===this.rtcTracker)return void _a.warn("Could not get RTCReportingAgent from RTCStreamingTracker service");const r=this.rtcTracker.getMediaIdentifiers(e),n=null===(t=this.rtcTracker.reportingAgent)||void 0===t?void 0:t.SessionInfo;if(void 0===r||void 0===n)return;if(Object.entries(r).every((function([e,t]){return n[e]===t})))return this.rtcTracker.reportingAgent;_a.warn("RTCReportingAgent is not associated with item "+e.id)}constructor(){_define_property$2(this,"_isConfigured",!1),_define_property$2(this,"tracking",void 0),_define_property$2(this,"instance",void 0),_define_property$2(this,"rtcTracker",void 0),_define_property$2(this,"requestedEvents",[Ar.playInitiated,Ar.mediaCanPlay])}}function _define_property$1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$1(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1(e,t,r[t])}))}return e}function _object_spread_props(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}_define_property$2(ClickToPlayTracker,"EVENT_ID",4101);const va=_object_spread$1({get info(){return function(){var t,r,n,i,o,a,s,l,c,d,u;const p={};p.version=e.version;const h=getHlsJsCdnConfig();p.hlsJSURL=h.hls,p.rtcJSURL=h.rtc,p.hlsJSVersion=void 0!==window.Hls?window.Hls.version:"not-loaded";const y=getInstance();p.instanceId=null==y?void 0:y.id;const f=null==y?void 0:y.services.runtime;var _,v,m,g,b,S,P,k,T;return p.runtime=void 0===f?void 0:{browser:`${f.browser.name} ${f.browser.version}`,engine:`${f.engine.name} ${f.engine.version}`,os:`${f.os.name} ${f.os.version}`,mobile:f.isMobile,keysystems:f.availableKeySystems},p.controller=null!==(_=null==y||null===(t=y._playbackController)||void 0===t?void 0:t.constructor.name)&&void 0!==_?_:"none",p.player=null!==(v=null==y||null===(n=y._mediaItemPlayback)||void 0===n||null===(r=n.getCurrentPlayer())||void 0===r?void 0:r.constructor.name)&&void 0!==v?v:"none",p.queue={size:null!==(m=null==y||null===(i=y.queue)||void 0===i?void 0:i.length)&&void 0!==m?m:0,position:null!==(g=null==y||null===(o=y.queue)||void 0===o?void 0:o.position)&&void 0!==g?g:-1,currentItem:void 0===(null==y||null===(a=y.queue)||void 0===a?void 0:a.currentItem)?void 0:{id:null==y||null===(s=y.queue)||void 0===s?void 0:s.currentItem.id,type:null==y||null===(l=y.queue)||void 0===l?void 0:l.currentItem.type,title:null==y||null===(c=y.queue)||void 0===c?void 0:c.currentItem.title,attributes:null!==(b=null==y||null===(d=y.queue)||void 0===d?void 0:d.currentItem.attributes)&&void 0!==b?b:{}}},p.nowPlayingItem=void 0===(null==y?void 0:y.nowPlayingItem)?void 0:{id:y.nowPlayingItem.id,type:y.nowPlayingItem.type,title:y.nowPlayingItem.title,attributes:null!==(S=null==y||null===(u=y.queue)||void 0===u?void 0:u.currentItem.attributes)&&void 0!==S?S:{}},p.isPlaying=null!==(P=null==y?void 0:y.isPlaying)&&void 0!==P&&P,p.playbackModes={shuffle:["off","on"][null!==(k=null==y?void 0:y.shuffleMode)&&void 0!==k?k:0],repeat:["off","one","all"][null!==(T=null==y?void 0:y.repeatMode)&&void 0!==T?T:0],autoplay:!0===(null==y?void 0:y.autoplayEnabled)?"on":"off"},p.devFlags=Object.entries(O).reduce((function(e,[t,r]){return _object_spread_props(_object_spread$1({},e),{[t]:r.value})}),{}),p}()}},O);function asyncGeneratorStep(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(xe){return void r(xe)}s.done?t(l):Promise.resolve(l).then(n,i)}function _async_to_generator(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MediaKitInstance extends MKInstance{get api(){const e=this.services.utsAPIClient;if(void 0===e)throw new MKUniqueError("mk-116",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"No client configured for UTS API"});return e}insertInQueue(e,t){var r=this;return _async_to_generator((function*(){const n=null!=t?t:r.queue.length;return r.getPlaybackController().insertInQueue([createMediaItemFromPlayable(e)],n)}))()}enqueuePlayables(e,t){var r=this;return _async_to_generator((function*(){const n=ensureArray(e).map(e=>{var t;const n=null===(t=e.playEvent)||void 0===t?void 0:t.playCursorInSeconds;return void 0!==n&&r._mediaItemPlayback.playOptions.set(e.id,{startTime:n}),createMediaItemFromPlayable(e)});(null==t?void 0:t.bingeWatching)||r.deferPlayback();const i=(yield r.setPlaybackController(r.getPlaybackControllerByType(an.serial))).setQueue(new Queue({descriptor:{loaded:n},playbackMode:r.playbackMode,services:{dispatcher:r.services.dispatcher}}));if(t){var o;const e=null!==(o=r._mediaItemPlayback.playOptions.get(r.queue.nextPlayableItem.id))&&void 0!==o?o:{};r._mediaItemPlayback.playOptions.set(r.queue.nextPlayableItem.id,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property(e,t,r[t])}))}return e}({},e,t))}return i}))()}}function _configure(){return(_configure=_async_to_generator((function*(e){xr.linkChild(Or),xr.linkChild(fe),xr.linkChild(Z),e.playActivityAPI=[new VPAFTracker,new BookmarkTracker],e.realm=F.TV,e.rtcOptions&&(e.playActivityAPI=[...e.playActivityAPI,new RTCStreamingTracker(e.rtcOptions),new ClickToPlayTracker]);const t=yield configure$1(e,MediaKitInstance,function(){var t=_async_to_generator((function*(t){var r,n,i,o;const a=null===(i=e.apiOptions)||void 0===i||null===(n=i.utsClient)||void 0===n||null===(r=n.configureOptions)||void 0===r?void 0:r.client;if(void 0===a)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Missing UTS Client");let s;const l=null===(o=e.apiOptions)||void 0===o?void 0:o.mediaApi;var c;void 0!==l&&"configureOptions"in l&&(s=null!==(c=l.configureOptions.storefrontId)&&void 0!==c?c:"us");yield t.configure({storefrontId:s,utsAPIClient:a})}));return function(e){return t.apply(this,arguments)}}());return t.continuous=!0,t}))).apply(this,arguments)}e.Events=Ar,e.MKError=MKError,e.MediaKitInstance=MediaKitInstance,e.PlayActivityEndReasonType=en,e.PlaybackBitrate=ve,e.PlaybackMode=Ir,e.PlaybackStates=he,e.PlaybackType=h,e.PresentationMode=ye,e.SKRealm=F,e.SeekReasonType=Se,e.SupportedAPIs=Kn,e.__dev=va,e.__log=Lr,e.configure=function(e){return _configure.apply(this,arguments)},e.enableMultipleInstances=function(){Un=!0},e.formatArtworkURL=formatArtworkURL,e.formatMediaTime=function(e,t=":"){const{hours:r,minutes:n}=formattedSeconds(e);e=Math.floor(e%3600%60);const i=[];return r?(i.push(""+r),i.push(n<10?"0"+n:""+n)):i.push(""+n),i.push(e<10?"0"+e:""+e),i.join(t)},e.formattedMediaURL=formattedMediaURL,e.formattedMilliseconds=function(e){return formattedSeconds(e/1e3)},e.formattedSeconds=formattedSeconds,e.generateEmbedCode=function(e,t={height:"450",width:"660"}){if(!d.test(e))throw new Error("Invalid content url");var r;let n=null!==(r=t.height)&&void 0!==r?r:"450";var i;let o=null!==(i=t.width)&&void 0!==i?i:"660";const{kind:a,isUTS:s}=formattedMediaURL(e),l="post"===a||"musicVideo"===a||s;"song"===a||"episode"===a?n="175":l&&(n=""+Math.round(.5625*parseInt(o,10))),n=(""+n).replace(/(\d+)px/i,"$1"),o=(""+o).replace(/^(\d+)(?!px)%?$/i,"$1px");const c=(l?"width:"+o:"width:100%;"+(o?"max-width:"+o:""))+";overflow:hidden;border-radius:10px;";let h="https://embed.music.apple.com";return["podcast","episode"].includes(null!=a?a:"")&&!s&&(h="https://embed.podcasts.apple.com"),["movie","episode","season","show"].includes(null!=a?a:"")&&s&&(h="https://embed.tv.apple.com"),`<iframe ${[`allow="${p.join("; ")}"`,'frameborder="0"',n?`height="${n}"`:"",`style="${c}"`,`sandbox="${u.join(" ")}"`,`src="${e.replace(d,h)}"`].join(" ")}></iframe>`},e.getHlsJsCdnConfig=getHlsJsCdnConfig,e.getInstance=getInstance,e.getInstances=function(){return jn},e.getPlayerType=function(e){var t,r;return(null==e?void 0:e.isUTS)||fa.includes(null==e?void 0:e.type)?"video":null!==(r=null==e||null===(t=e.attributes)||void 0===t?void 0:t.mediaKind)&&void 0!==r?r:"audio"},Object.defineProperty(e,"__esModule",{value:!0})}));
